<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T-MAP Chat ‚Äî V5 Stable</title>

  <script src="https://cdn.tailwindcss.com">
// ======= RTC INBOX (global) =======
S.rtc = S.rtc || {};
S.rtc.inbox = null;
S.rtc.session = null;
function ensureInbox(){
  if (S.rtc.inbox) return;
  const ch = sb.channel('rtc:inbox', { config:{ broadcast:{ self:true }, presence:{ key: S.user.id } } });
  ch.on('broadcast', { event:'dm' }, onInboxDm);
  ch.subscribe((status)=>{ if(status==='SUBSCRIBED'){ ch.track({ uid:S.user.id }); } });
  S.rtc.inbox = ch;
}
async function onInboxDm(ev){
  const p = ev.payload||{};
  if (!S.user || !p || p.to!==S.user.id) return;
  if (p.kind==='invite'){
    if (S.call){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'busy', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    const ok = confirm(`${p.name||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'} –≤–∏ –∫–∞–Ω–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä. –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏?`);
    if(!ok){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'reject', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    S.rtc.session = { id:p.sessionId, peer:p.from };
    updateCallUI(true, '–°–≤—ä—Ä–∑–≤–∞–Ω–µ‚Ä¶'); await startDm(false);
    S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'accept', to:p.from, from:S.user.id, sessionId:p.sessionId } });
  } else if (p.kind==='accept' && S.rtc?.session?.id===p.sessionId){ await startDm(true); }
  else if (p.kind==='reject' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ–∫–∞–Ω–∞—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞'); endCall(); }
  else if (p.kind==='busy' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∑–∞–µ—Ç'); endCall(); }
  else if (p.kind==='sdp' && S.rtc?.session?.id===p.sessionId){
    await S.call.pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
    if (p.sdp.type==='offer'){ const ans = await S.call.pc.createAnswer(); await S.call.pc.setLocalDescription(ans);
      S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'sdp', to:S.rtc.session.peer, from:S.user.id, sessionId:p.sessionId, sdp: ans } });
    }
  } else if (p.kind==='ice' && S.rtc?.session?.id===p.sessionId && p.candidate){
    try{ await S.call.pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }catch(_){}
  } else if (p.kind==='hang' && S.rtc?.session?.id===p.sessionId){ showToast('–†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏'); endCall(); }
}
const _onLogin0 = onLogin; onLogin = async (u)=>{ await _onLogin0(u); ensureInbox(); };

// Floating tray actions
const $fabMobile = document.getElementById('fabMobile');
const $trayMobile = document.getElementById('trayMobile');
const $trayInvite = document.getElementById('trayInvite');
const $trayLive = document.getElementById('trayLive');
const $trayShare = document.getElementById('trayShare');
const $trayHang = document.getElementById('trayHang');
$fabMobile && ($fabMobile.onclick = ()=> $trayMobile.classList.toggle('open'));
$trayInvite && ($trayInvite.onclick = ()=>{ $trayMobile.classList.remove('open'); const uid=prompt('UID –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:'); if(uid) inviteToCall(uid.trim(),'–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'); });
$trayLive && ($trayLive.onclick = ()=>{ $trayMobile.classList.remove('open'); if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') stopLive(); else startLiveHost(); });
$trayShare && ($trayShare.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call&&typeof shareScreenDm==='function') shareScreenDm(); else if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') shareScreenLive(); else showToast('–ü—ä—Ä–≤–æ –∑–∞–ø–æ—á–Ω–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ LIVE'); });
$trayHang && ($trayHang.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call) endCall(); else if(typeof LIVE!=='undefined' && LIVE) stopLive(); });

// Ensure remote audio plays
try{ const rv=document.getElementById('remoteVideo'); if(rv){ rv.muted=false; } }catch(_){}
</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
// ======= RTC INBOX (global) =======
S.rtc = S.rtc || {};
S.rtc.inbox = null;
S.rtc.session = null;
function ensureInbox(){
  if (S.rtc.inbox) return;
  const ch = sb.channel('rtc:inbox', { config:{ broadcast:{ self:true }, presence:{ key: S.user.id } } });
  ch.on('broadcast', { event:'dm' }, onInboxDm);
  ch.subscribe((status)=>{ if(status==='SUBSCRIBED'){ ch.track({ uid:S.user.id }); } });
  S.rtc.inbox = ch;
}
async function onInboxDm(ev){
  const p = ev.payload||{};
  if (!S.user || !p || p.to!==S.user.id) return;
  if (p.kind==='invite'){
    if (S.call){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'busy', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    const ok = confirm(`${p.name||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'} –≤–∏ –∫–∞–Ω–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä. –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏?`);
    if(!ok){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'reject', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    S.rtc.session = { id:p.sessionId, peer:p.from };
    updateCallUI(true, '–°–≤—ä—Ä–∑–≤–∞–Ω–µ‚Ä¶'); await startDm(false);
    S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'accept', to:p.from, from:S.user.id, sessionId:p.sessionId } });
  } else if (p.kind==='accept' && S.rtc?.session?.id===p.sessionId){ await startDm(true); }
  else if (p.kind==='reject' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ–∫–∞–Ω–∞—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞'); endCall(); }
  else if (p.kind==='busy' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∑–∞–µ—Ç'); endCall(); }
  else if (p.kind==='sdp' && S.rtc?.session?.id===p.sessionId){
    await S.call.pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
    if (p.sdp.type==='offer'){ const ans = await S.call.pc.createAnswer(); await S.call.pc.setLocalDescription(ans);
      S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'sdp', to:S.rtc.session.peer, from:S.user.id, sessionId:p.sessionId, sdp: ans } });
    }
  } else if (p.kind==='ice' && S.rtc?.session?.id===p.sessionId && p.candidate){
    try{ await S.call.pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }catch(_){}
  } else if (p.kind==='hang' && S.rtc?.session?.id===p.sessionId){ showToast('–†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏'); endCall(); }
}
const _onLogin0 = onLogin; onLogin = async (u)=>{ await _onLogin0(u); ensureInbox(); };

// Floating tray actions
const $fabMobile = document.getElementById('fabMobile');
const $trayMobile = document.getElementById('trayMobile');
const $trayInvite = document.getElementById('trayInvite');
const $trayLive = document.getElementById('trayLive');
const $trayShare = document.getElementById('trayShare');
const $trayHang = document.getElementById('trayHang');
$fabMobile && ($fabMobile.onclick = ()=> $trayMobile.classList.toggle('open'));
$trayInvite && ($trayInvite.onclick = ()=>{ $trayMobile.classList.remove('open'); const uid=prompt('UID –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:'); if(uid) inviteToCall(uid.trim(),'–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'); });
$trayLive && ($trayLive.onclick = ()=>{ $trayMobile.classList.remove('open'); if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') stopLive(); else startLiveHost(); });
$trayShare && ($trayShare.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call&&typeof shareScreenDm==='function') shareScreenDm(); else if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') shareScreenLive(); else showToast('–ü—ä—Ä–≤–æ –∑–∞–ø–æ—á–Ω–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ LIVE'); });
$trayHang && ($trayHang.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call) endCall(); else if(typeof LIVE!=='undefined' && LIVE) stopLive(); });

// Ensure remote audio plays
try{ const rv=document.getElementById('remoteVideo'); if(rv){ rv.muted=false; } }catch(_){}
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js" crossorigin="anonymous">
// ======= RTC INBOX (global) =======
S.rtc = S.rtc || {};
S.rtc.inbox = null;
S.rtc.session = null;
function ensureInbox(){
  if (S.rtc.inbox) return;
  const ch = sb.channel('rtc:inbox', { config:{ broadcast:{ self:true }, presence:{ key: S.user.id } } });
  ch.on('broadcast', { event:'dm' }, onInboxDm);
  ch.subscribe((status)=>{ if(status==='SUBSCRIBED'){ ch.track({ uid:S.user.id }); } });
  S.rtc.inbox = ch;
}
async function onInboxDm(ev){
  const p = ev.payload||{};
  if (!S.user || !p || p.to!==S.user.id) return;
  if (p.kind==='invite'){
    if (S.call){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'busy', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    const ok = confirm(`${p.name||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'} –≤–∏ –∫–∞–Ω–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä. –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏?`);
    if(!ok){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'reject', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    S.rtc.session = { id:p.sessionId, peer:p.from };
    updateCallUI(true, '–°–≤—ä—Ä–∑–≤–∞–Ω–µ‚Ä¶'); await startDm(false);
    S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'accept', to:p.from, from:S.user.id, sessionId:p.sessionId } });
  } else if (p.kind==='accept' && S.rtc?.session?.id===p.sessionId){ await startDm(true); }
  else if (p.kind==='reject' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ–∫–∞–Ω–∞—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞'); endCall(); }
  else if (p.kind==='busy' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∑–∞–µ—Ç'); endCall(); }
  else if (p.kind==='sdp' && S.rtc?.session?.id===p.sessionId){
    await S.call.pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
    if (p.sdp.type==='offer'){ const ans = await S.call.pc.createAnswer(); await S.call.pc.setLocalDescription(ans);
      S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'sdp', to:S.rtc.session.peer, from:S.user.id, sessionId:p.sessionId, sdp: ans } });
    }
  } else if (p.kind==='ice' && S.rtc?.session?.id===p.sessionId && p.candidate){
    try{ await S.call.pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }catch(_){}
  } else if (p.kind==='hang' && S.rtc?.session?.id===p.sessionId){ showToast('–†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏'); endCall(); }
}
const _onLogin0 = onLogin; onLogin = async (u)=>{ await _onLogin0(u); ensureInbox(); };

// Floating tray actions
const $fabMobile = document.getElementById('fabMobile');
const $trayMobile = document.getElementById('trayMobile');
const $trayInvite = document.getElementById('trayInvite');
const $trayLive = document.getElementById('trayLive');
const $trayShare = document.getElementById('trayShare');
const $trayHang = document.getElementById('trayHang');
$fabMobile && ($fabMobile.onclick = ()=> $trayMobile.classList.toggle('open'));
$trayInvite && ($trayInvite.onclick = ()=>{ $trayMobile.classList.remove('open'); const uid=prompt('UID –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:'); if(uid) inviteToCall(uid.trim(),'–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'); });
$trayLive && ($trayLive.onclick = ()=>{ $trayMobile.classList.remove('open'); if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') stopLive(); else startLiveHost(); });
$trayShare && ($trayShare.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call&&typeof shareScreenDm==='function') shareScreenDm(); else if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') shareScreenLive(); else showToast('–ü—ä—Ä–≤–æ –∑–∞–ø–æ—á–Ω–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ LIVE'); });
$trayHang && ($trayHang.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call) endCall(); else if(typeof LIVE!=='undefined' && LIVE) stopLive(); });

// Ensure remote audio plays
try{ const rv=document.getElementById('remoteVideo'); if(rv){ rv.muted=false; } }catch(_){}
</script>

  <style>
    html,body{height:100%}
    html{scroll-behavior:smooth}
    :root{--emoji-stack:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","Segoe UI Symbol"}
    body,textarea,button{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,var(--emoji-stack)}

    .scroll::-webkit-scrollbar{width:8px;height:8px}
    .scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:9999px}

    .emoji-panel{position:absolute;bottom:72px;left:12px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:10px;width:min(90vw,360px);max-height:260px;overflow:auto;display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:6px}
    .emoji-btn{font-size:22px;line-height:1;padding:8px;border-radius:12px;display:grid;place-items:center}
    .emoji-btn:hover{background:#f1f5f9}
    img.twemoji{height:1.25em;width:1.25em;vertical-align:-.2em}

    /* Login card + aurora */
    .auth-card{position:relative;overflow:hidden}
    .auth-logo-wrap{position:relative;display:grid;place-items:center;margin-bottom:.5rem}
    .auth-logo{height:82px;width:auto;filter:drop-shadow(0 4px 14px rgba(2,6,23,.15))}
    .auth-logo-glow{position:absolute;inset:-60px;border-radius:9999px;z-index:0;
      background:conic-gradient(from 180deg at 50% 50%,#0ea5e9,#22d3ee,#34d399,#a78bfa,#0ea5e9);
      filter:blur(80px);opacity:.35;animation:auroraSpin 16s linear infinite}
    @keyframes auroraSpin{to{transform:rotate(360deg)}}
  
/* Floating mobile tray */
.fab-mobile{position:fixed;right:12px;bottom:calc(16px + var(--ios-safe));z-index:60}
.fab-btn{width:52px;height:52px;border-radius:9999px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
.tray-mobile{position:fixed;right:12px;bottom:calc(76px + var(--ios-safe));display:flex;flex-direction:column;gap:.5rem;z-index:60;transform:translateX(140%);transition:transform .25s ease}
.tray-mobile.open{transform:translateX(0)}
.tray-btn{border-radius:12px;padding:.5rem .7rem;background:#0b1220;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:.98}
@media(min-width:768px){.fab-mobile,.tray-mobile{display:none}}
</style>
  <script src="favicon-injector.js">
// ======= RTC INBOX (global) =======
S.rtc = S.rtc || {};
S.rtc.inbox = null;
S.rtc.session = null;
function ensureInbox(){
  if (S.rtc.inbox) return;
  const ch = sb.channel('rtc:inbox', { config:{ broadcast:{ self:true }, presence:{ key: S.user.id } } });
  ch.on('broadcast', { event:'dm' }, onInboxDm);
  ch.subscribe((status)=>{ if(status==='SUBSCRIBED'){ ch.track({ uid:S.user.id }); } });
  S.rtc.inbox = ch;
}
async function onInboxDm(ev){
  const p = ev.payload||{};
  if (!S.user || !p || p.to!==S.user.id) return;
  if (p.kind==='invite'){
    if (S.call){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'busy', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    const ok = confirm(`${p.name||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'} –≤–∏ –∫–∞–Ω–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä. –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏?`);
    if(!ok){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'reject', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    S.rtc.session = { id:p.sessionId, peer:p.from };
    updateCallUI(true, '–°–≤—ä—Ä–∑–≤–∞–Ω–µ‚Ä¶'); await startDm(false);
    S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'accept', to:p.from, from:S.user.id, sessionId:p.sessionId } });
  } else if (p.kind==='accept' && S.rtc?.session?.id===p.sessionId){ await startDm(true); }
  else if (p.kind==='reject' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ–∫–∞–Ω–∞—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞'); endCall(); }
  else if (p.kind==='busy' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∑–∞–µ—Ç'); endCall(); }
  else if (p.kind==='sdp' && S.rtc?.session?.id===p.sessionId){
    await S.call.pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
    if (p.sdp.type==='offer'){ const ans = await S.call.pc.createAnswer(); await S.call.pc.setLocalDescription(ans);
      S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'sdp', to:S.rtc.session.peer, from:S.user.id, sessionId:p.sessionId, sdp: ans } });
    }
  } else if (p.kind==='ice' && S.rtc?.session?.id===p.sessionId && p.candidate){
    try{ await S.call.pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }catch(_){}
  } else if (p.kind==='hang' && S.rtc?.session?.id===p.sessionId){ showToast('–†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏'); endCall(); }
}
const _onLogin0 = onLogin; onLogin = async (u)=>{ await _onLogin0(u); ensureInbox(); };

// Floating tray actions
const $fabMobile = document.getElementById('fabMobile');
const $trayMobile = document.getElementById('trayMobile');
const $trayInvite = document.getElementById('trayInvite');
const $trayLive = document.getElementById('trayLive');
const $trayShare = document.getElementById('trayShare');
const $trayHang = document.getElementById('trayHang');
$fabMobile && ($fabMobile.onclick = ()=> $trayMobile.classList.toggle('open'));
$trayInvite && ($trayInvite.onclick = ()=>{ $trayMobile.classList.remove('open'); const uid=prompt('UID –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:'); if(uid) inviteToCall(uid.trim(),'–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'); });
$trayLive && ($trayLive.onclick = ()=>{ $trayMobile.classList.remove('open'); if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') stopLive(); else startLiveHost(); });
$trayShare && ($trayShare.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call&&typeof shareScreenDm==='function') shareScreenDm(); else if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') shareScreenLive(); else showToast('–ü—ä—Ä–≤–æ –∑–∞–ø–æ—á–Ω–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ LIVE'); });
$trayHang && ($trayHang.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call) endCall(); else if(typeof LIVE!=='undefined' && LIVE) stopLive(); });

// Ensure remote audio plays
try{ const rv=document.getElementById('remoteVideo'); if(rv){ rv.muted=false; } }catch(_){}
</script>
</head>

<body class="h-screen overflow-hidden bg-slate-50 text-slate-800">
  <!-- AUTH -->
  <section id="auth" class="min-h-screen grid place-items-center p-6 hidden">
    <div class="w-full max-w-sm bg-white/95 backdrop-blur border rounded-2xl shadow-sm p-6 space-y-4 auth-card">
      <div class="auth-logo-wrap">
        <div class="auth-logo-glow"></div>
        <!-- –í–≥—Ä–∞–¥–µ–Ω–æ –ª–æ–≥–æ –æ—Ç —Ä–µ–ø–æ—Ç–æ -->
        <img id="authLogo" src="logo01082025.svg" alt="T-MAP" class="auth-logo relative z-10" onerror="this.src='favicon.svg'">
      </div>

      <h1 class="text-xl font-semibold relative z-10">–í—Ö–æ–¥ –≤ —á–∞—Ç–∞</h1>
      <p class="text-sm text-slate-500 relative z-10">–í–ª–µ–∑—Ç–µ —Å Google (Gmail), –∑–∞ –¥–∞ –ø–∏—à–µ—Ç–µ –≤ –æ–±—â–∞—Ç–∞ —Å—Ç–∞—è.</p>
      <button id="btnGoogle" class="relative z-10 w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-slate-700">
        –í—Ö–æ–¥ —Å Google
      </button>
    </div>
  </section>

  <!-- APP -->
  <div id="app" class="h-screen grid md:grid-cols-[280px,1fr] hidden">
    <aside class="border-r bg-white hidden md:block">
      <div class="p-4 border-b flex items-center gap-3">
        <img id="meAvatar" class="w-10 h-10 rounded-full ring-2 ring-slate-200" alt="">
        <div class="min-w-0">
          <div id="meName" class="font-semibold truncate">‚Äî</div>
          <div class="text-xs text-slate-500">UID <span id="meId">‚Äî</span></div>
        </div>
        <button id="btnSignOut" class="ml-auto px-3 py-1.5 rounded-xl border text-sm">–ò–∑—Ö–æ–¥</button>
      </div>

      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">–ê–∫—Ç–∏–≤–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</div>
          <span id="activeCount" class="text-xs text-slate-400">0</span>
        </div>
        <div id="users" class="scroll max-h-[calc(100vh-220px)] overflow-y-auto space-y-1 pr-1"></div>
      </div>
    </aside>

    <main class="grid grid-rows-[auto,1fr,auto] h-screen">
      <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b px-4 py-3 flex items-center gap-2">
        <button id="menu" class="md:hidden px-3 py-2 rounded-xl border">‚ò∞</button>
        <div class="font-semibold flex items-center gap-2">–û–±—â–∞ —Å—Ç–∞—è <span id="unread" class="hidden text-xs px-2 py-0.5 rounded-full bg-sky-100 text-sky-700">–Ω–æ–≤–∏</span></div>
        <div id="conn" class="ml-auto text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">–û–Ω–ª–∞–π–Ω</div>
      </header>

      <section id="callBar" class="hidden callbar border-b"><div class="px-3 py-2 flex items-center gap-2"><div class="text-sm font-medium">–†–∞–∑–≥–æ–≤–æ—Ä</div><div id="callState" class="text-xs opacity-80">‚Äî</div><div class="ml-auto flex items-center gap-2"><button id="btnMic" class="call-ctrl">üéôÔ∏è</button><button id="btnCam" class="call-ctrl">üì∑</button><button id="btnShare" class="call-ctrl">üñ•Ô∏è</button><button id="btnHang" class="px-3 py-1.5 rounded-lg bg-rose-500">–ó–∞—Ç–≤–æ—Ä–∏</button></div></div><div class="px-2 pb-2 video-grid"><video id="remoteVideo" class="video-el" autoplay playsinline></video><video id="localVideo" class="video-el" autoplay playsinline muted></video></div></section>
<section id="messages" class="scroll overflow-y-auto px-2 sm:px-4 py-4 space-y-3"></section>

      <!-- –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä—ä—Ç –µ —Ñ–∏–∫—Å–∏—Ä–∞–Ω –¥–æ–ª—É -->
      <form id="composer" class="sticky bottom-0 z-10 border-t bg-white px-2 sm:px-3 py-3 flex gap-2 items-end">
        <button id="btnEmoji" type="button" title="–ï–º–æ—Ç–∏–∫–æ–Ω–∏" class="px-3 py-2 rounded-xl border">üôÇ</button>
        <textarea id="input" rows="1" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ‚Ä¶" class="flex-1 resize-none rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-300"></textarea>
        <button class="px-4 py-3 rounded-2xl bg-slate-900 text-white">–ò–∑–ø—Ä–∞—Ç–∏</button>
        <div id="emojiPanel" class="emoji-panel hidden"></div>
      </form>

      <div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg text-sm"></div>
    </main>
  <!-- Floating mobile tray -->
  <div class="fab-mobile md:hidden">
    <button id="fabMobile" class="fab-btn bg-slate-900 text-white">‚ò∞</button>
  </div>
  <div id="trayMobile" class="tray-mobile md:hidden">
    <button id="trayInvite" class="tray-btn">üìû –ü–æ–∫–∞–Ω–∏</button>
    <button id="trayLive" class="tray-btn">üî¥ LIVE</button>
    <button id="trayShare" class="tray-btn">üñ•Ô∏è –ï–∫—Ä–∞–Ω</button>
    <button id="trayHang" class="tray-btn bg-rose-600">‚éã –ö—Ä–∞–π</button>
  </div>

  </div>

  <!-- —Ä–µ–∑–µ—Ä–≤–µ–Ω –∑–≤—É–∫ -->
  <audio id="ding" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAAACAAACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mp3">
  </audio>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";

    const HEARTBEAT_SEC = 20;
    const ONLINE_WINDOW_MS = 5 * 60 * 1000;
    const TWE_BASE = 'emoji/';              // –ª–æ–∫–∞–ª–Ω–∏ SVG –µ–º–æ–¥–∂–∏—Ç–∞
    const BRAND_LOGO = 'tmap_avatar_128.png'; // default –∞–≤–∞—Ç–∞—Ä (–º–æ–∂–µ –¥–∞ —Å–º–µ–Ω–∏—à)
    const USE_TWEMOJI = true;

    // >>> –†–µ–¥–∏—Ä–µ–∫—Ç –∫—ä–º –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å–ª–µ–¥ –∏–∑—Ö–æ–¥
    const HOME_URL = 'https://turizam123.github.io/uzunov/tmap_home.html';

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    const S = { user:null, me:{name:"", avatar:""}, messages:new Map() };
    const EMOJIS = ["üòÄ","üòÇ","üòä","üòâ","üòç","üòé","üò≠","üò°","üëç","üôè","üëè","üî•","‚ú®","üéâ","‚ù§Ô∏è","üíô","üíö","üíõ","üòÖ","ü§î"];
    let lastMsgAt = 0;

    // DOM
    const $auth = document.getElementById('auth');
    const $btnGoogle = document.getElementById('btnGoogle');
    const $app = document.getElementById('app');
    const $meAvatar = document.getElementById('meAvatar');
    const $meName = document.getElementById('meName');
    const $meId = document.getElementById('meId');
    const $users = document.getElementById('users');
    const $activeCount = document.getElementById('activeCount');
    const $messages = document.getElementById('messages');
    const $composer = document.getElementById('composer');
    const $input = document.getElementById('input');
    const $conn = document.getElementById('conn');
    const $btnSignOut = document.getElementById('btnSignOut');
    const $btnEmoji = document.getElementById('btnEmoji');
    const $emojiPanel = document.getElementById('emojiPanel');
    const $menu = document.getElementById('menu');
    const $toast = document.getElementById('toast');
    const $ding = document.getElementById('ding');

    $menu?.addEventListener('click', ()=>{ document.querySelector('aside').classList.toggle('hidden'); });

    // Boot
    boot();
    async function boot(){
      const { data } = await sb.auth.getUser();
      if (data?.user) onLoggedIn(data.user); else showAuth(true);
    }
    // >>> –ø—Ä–æ–º–µ–Ω–µ–Ω–æ: –≤–∑–∏–º–∞–º–µ –∏ event, –∑–∞ –¥–∞ —Ö–≤–∞–Ω–µ–º SIGNED_OUT –∏ –¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–Ω–µ–º
    sb.auth.onAuthStateChange((event, session) => {
      if (session?.user) onLoggedIn(session.user);
      else if (event === 'SIGNED_OUT') window.location.replace(HOME_URL);
      else showAuth(true);
    });

    function showAuth(show){ $auth.classList.toggle('hidden', !show); $app.classList.toggle('hidden', show); }

    $btnGoogle.addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({ provider:'google', options:{ scopes:'openid email profile', redirectTo: `${location.origin}${location.pathname}` } });
    });

    $btnSignOut.addEventListener('click', async ()=>{
      try{
        if (S.user){ await sb.from('online_users').update({ last_seen_at: new Date(Date.now()-10*60*1000).toISOString() }).eq('id', S.user.id); }
        await sb.auth.signOut();
      } finally {
        // >>> –≤–µ–¥–Ω–∞–≥–∞ –∫—ä–º –Ω–∞—á–∞–ª–Ω–∞—Ç–∞
        window.location.replace(HOME_URL);
      }
    });

    async function onLoggedIn(user){
      S.user = user;
      const m = user.user_metadata||{};
      S.me = { name: m.full_name || m.name || (user.email||'').split('@')[0] || '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª', avatar: m.avatar_url || m.picture || '' };
      $meAvatar.src = avatarUrl(S.me.name, S.me.avatar);
      $meName.textContent = S.me.name; $meId.textContent = (user.id||'').slice(0,8);
      showAuth(false);

      await upsertPresence();
      heartbeat();
      await refreshUsers();
      subscribePresence();
      subscribeMessages();
      await loadMessages();
      initEmoji();
      enableNotifications();

      $input.addEventListener('input', ()=>autoResize($input));
      autoResize($input);
    }

    // Presence
    async function upsertPresence(){
      const { error } = await sb.from('online_users').upsert(
        { id:S.user.id, username:S.me.name, avatar:S.me.avatar, last_seen_at:new Date().toISOString() },
        { onConflict:'id' }
      );
      if (error) console.warn('presence upsert', error);
    }
    function heartbeat(){ upsertPresence(); setTimeout(heartbeat, HEARTBEAT_SEC*1000); }
    function isOnline(iso){ return new Date(iso).getTime() > Date.now() - ONLINE_WINDOW_MS; }

    async function refreshUsers(){
      const { data, error } = await sb.from('online_users').select('*').order('last_seen_at',{ascending:false}).limit(200);
      if (error) return console.warn(error);
      $users.innerHTML=''; let count=0;
      (data||[]).forEach(u=>{
        const online=isOnline(u.last_seen_at); if(online) count++;
        const el=document.createElement('div'); el.className='flex items-center gap-3 px-2 py-2 rounded-xl hover:bg-slate-50';
        el.innerHTML=`<img src="${avatarUrl(u.username,u.avatar)}" class="w-8 h-8 rounded-full ring-2 ring-slate-200"/><div class='min-w-0'><div class='font-medium truncate'>${esc(u.username||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª')}</div><div class='text-xs ${online?'text-emerald-600':'text-slate-400'}'>${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>${u.id===S.user.id?'<span class="ml-auto text-xs px-2 py-1 rounded-full bg-slate-100">–í–∏–µ</span>':''}`;
        $users.appendChild(el);
      });
      $activeCount.textContent = count;
    }

    function subscribePresence(){
      sb.channel('online_users_changes').on('postgres_changes',{event:'*',schema:'public',table:'online_users'},refreshUsers).subscribe();
    }

    // Messages
    async function loadMessages(){
      let { data, error } = await sb.from('messages').select('*').order('created_at',{ascending:true}).limit(300);
      if (error){ ({ data, error } = await sb.from('messages').select('*').limit(300)); }
      if (error){ console.warn('loadMessages', error); return; }
      $messages.innerHTML=''; S.messages.clear();
      (data||[]).forEach(m=>{ S.messages.set(m.id,m); renderMessage(m); });
      renderTwemoji($messages);
      if (data && data.length){ lastMsgAt = Date.parse(data[data.length-1].created_at||new Date()); }
      $messages.scrollTop = $messages.scrollHeight;
    }

    function subscribeMessages(){
      const ch = sb.channel('realtime:messages');
      ch
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},({new:row})=>{
          S.messages.set(row.id,row);
          renderMessage(row);
          renderTwemoji(document.getElementById('msg-'+row.id));
          $messages.scrollTop=$messages.scrollHeight;
          lastMsgAt = Math.max(lastMsgAt, Date.parse(row.created_at||new Date()));
          notifyIfNeeded(row);
        })
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'messages'},({new:row})=>{
          S.messages.set(row.id,row);
          const el=document.getElementById('msg-'+row.id);
          if(el){ el.outerHTML = messageHtml(row); renderTwemoji(document.getElementById('msg-'+row.id)); }
        })
        .subscribe();
    }

    function messageHtml(m){
      const name = esc(m.sender_name || m.username || '');
      const avatar = avatarUrl(name, m.sender_avatar || m.avatar);
      const mine = m.sender_id ? (m.sender_id===S.user.id) : (name===S.me.name);
      const liked_by = Array.isArray(m.liked_by) ? m.liked_by : [];
      const liked = liked_by.includes?.(S.user?.id);
      const likeBtn = `<button class="inline-flex items-center gap-1 text-xs ${liked?'font-semibold':''}" onclick="toggleLike('${m.id}')">‚ù§ <span>${liked_by.length||0}</span></button>`;
      const time = m.created_at ? `<span class='text-[11px] opacity-70'>${formatTime(m.created_at)}</span>` : '';
      return `
        <div id="msg-${m.id}" class="flex items-start gap-3 ${mine?'justify-end':''}">
          ${mine?'':`<img src='${esc(avatar)}' class='w-8 h-8 rounded-full ring-2 ring-slate-200'/>`}
          <div class="max-w-[90%] sm:max-w-[80%] ${mine?'bg-gradient-to-br from-slate-900 to-slate-800 text-white':'bg-white'} rounded-2xl px-4 py-3 shadow-sm border ${mine?'border-slate-900':'border-slate-200'}">
            ${mine?'':`<div class='text-xs font-medium mb-1 text-slate-500'>${name}</div>`}
            <div class="whitespace-pre-wrap leading-relaxed">${linkify(esc(m.content||''))}</div>
            <div class="mt-2 flex items-center gap-3 ${mine?'text-slate-200':'text-slate-500'}">${likeBtn} ${time}</div>
          </div>
          ${mine?`<img src='${esc(avatar)}' class='w-8 h-8 rounded-full ring-2 ring-slate-200'/>`:''}
        </div>`;
    }
    function renderMessage(m){ $messages.insertAdjacentHTML('beforeend', messageHtml(m)); }

    // Send
    $composer.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const txt=$input.value.trim();
      if(!txt) return;
      $input.value=''; autoResize($input);
      const row={ username:S.me.name, avatar:S.me.avatar, content:txt, sender_id:S.user.id, sender_name:S.me.name, sender_avatar:S.me.avatar };
      const { error } = await sb.from('messages').insert(row);
      if (error){ alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: '+error.message); return; }
      await loadMessages();
    });

    // Likes
    window.toggleLike = async function(id){
      const msg = S.messages.get(id); if(!msg) return;
      const uid = S.user.id;
      const prev = Array.isArray(msg.liked_by) ? msg.liked_by.slice() : [];
      const had = prev.includes(uid);
      msg.liked_by = had ? prev.filter(x=>x!==uid) : prev.concat(uid);
      S.messages.set(id, msg);
      const mnt = document.getElementById('msg-'+id); if(mnt) mnt.outerHTML = messageHtml(msg);
      const { error } = await sb.rpc('toggle_like', { p_msg_id:id });
      if (error){ msg.liked_by = prev; S.messages.set(id,msg); if(mnt) mnt.outerHTML = messageHtml(msg); alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ö–∞—Ä–µ—Å–≤–∞–Ω–µ: '+error.message); }
    }

    // Emoji
    function initEmoji(){
      const base = TWE_BASE.endsWith('/') ? TWE_BASE : TWE_BASE + '/';
      $emojiPanel.innerHTML = EMOJIS.map(e=>{
        const cp = Array.from(e).map(s=>s.codePointAt(0).toString(16)).join('-');
        const safe = e.replace(/\"/g,'&quot;');
        return `<button type="button" class="emoji-btn" data-e="${safe}"><img class="twemoji" src="${base}${cp}.svg" alt="${safe}" onerror="this.parentElement.textContent='${safe}'"/></button>`;
      }).join('');
      $btnEmoji.addEventListener('click', ()=>{ $emojiPanel.classList.toggle('hidden'); });
      $emojiPanel.addEventListener('click', (ev)=>{ const btn=ev.target.closest('.emoji-btn'); if(btn){ $input.value += btn.dataset.e; $input.focus(); autoResize($input); }});
      document.addEventListener('click', (ev)=>{ if(!ev.composedPath().includes($emojiPanel) && !ev.composedPath().includes($btnEmoji)) $emojiPanel.classList.add('hidden'); });
    }

    // Notifications / sound
    function enableNotifications(){
      if ('Notification' in window && Notification.permission==='default'){
        try{ Notification.requestPermission(); }catch(e){}
      }
      const unlock = ()=>{ try{ $ding.play().then(()=>{ $ding.pause(); $ding.currentTime=0; }).catch(()=>{}); }catch(_){ }
        document.removeEventListener('pointerdown',unlock); };
      document.addEventListener('pointerdown', unlock, {passive:true});
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) clearUnread(); });
    }

    let audioCtx; let soundEnabled=false;
    function unlockAudio(){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        audioCtx.resume && audioCtx.resume();
        soundEnabled = true;
      }catch(_){ }
    }
    document.addEventListener('pointerdown', unlockAudio, {passive:true});
    $composer?.addEventListener('submit', unlockAudio);
    $btnEmoji?.addEventListener('click', unlockAudio);

    function playDing(){
      try{ $ding.volume=0.7; $ding.currentTime=0; $ding.play().catch(()=>{}); }catch(_){ }
      if(!soundEnabled) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=880; g.gain.value=0.08; o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime+0.12);
      }catch(_){ }
    }
    function vibrate(){ try{ navigator.vibrate && navigator.vibrate([25,30,25]); }catch(_){ } }

    function showToast(t){ if(!$toast) return; $toast.textContent=t; $toast.classList.remove('hidden'); setTimeout(()=>{$toast.classList.add('hidden')},2500); }
    function markUnread(){ const b=document.getElementById('unread'); b&&b.classList.remove('hidden'); document.title='‚Ä¢ –ù–æ–≤–∏ - T-MAP Chat'; }
    function clearUnread(){ const b=document.getElementById('unread'); b&&b.classList.add('hidden'); document.title='T-MAP Chat'; }

    function notifyIfNeeded(m){
      if(!S.user) return;
      const name = m.sender_name || m.username || '–ù–æ–≤o —Å—ä–æ–±—â–µ–Ω–∏–µ';
      const mine = m.sender_id ? (m.sender_id===S.user.id) : (name===S.me.name);
      if (mine) return;
      playDing(); vibrate();
      if (document.hidden){
        markUnread();
        if ('Notification' in window && Notification.permission==='granted'){
          try{ const n=new Notification('T-MAP —á–∞—Ç',{ body:`${name}: ${(m.content||'').slice(0,100)}`, icon:m.sender_avatar || m.avatar || undefined }); setTimeout(()=>n.close(),5000); }catch(_){ }
        }
      } else {
        showToast(`${name}: ${(m.content||'').slice(0,80)}`);
      }
    }

    // Fallback poll (–∞–∫–æ realtime –µ –±–ª–æ–∫–∏—Ä–∞–Ω)
    setInterval(async()=>{ try{ const { data, error } = await sb.from('messages').select('created_at').order('created_at',{ascending:false}).limit(1); if(!error && data && data[0]){ const ts=Date.parse(data[0].created_at); if(ts>lastMsgAt){ await loadMessages(); } } }catch(_){ } },7000);

    // Connection ping
    setInterval(async()=>{ const { error } = await sb.from('online_users').select('count').limit(1);
      $conn.textContent = error? '–û—Ñ–ª–∞–π–Ω':'–û–Ω–ª–∞–π–Ω';
      $conn.className = 'ml-auto text-xs px-2 py-1 rounded-full '+(error?'bg-red-100 text-red-700':'bg-emerald-100 text-emerald-700'); },5000);

    // Helpers
    function avatarUrl(name,url){ return (url&&url.trim())?url:BRAND_LOGO; }
    function renderTwemoji(el){ try{ if(USE_TWEMOJI&&window.twemoji){ twemoji.parse(el||document.body,{ base:TWE_BASE, folder:'', ext:'.svg' }); } }catch(_){ } }
    function esc(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");}
    function linkify(t){return t.replace(/https?:\/\/[^\s]+/g,u=>`<a class='underline' target='_blank' rel='noopener' href='${u}'>${u}</a>`);}
    function formatTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString('bg-BG',{hour:'2-digit',minute:'2-digit'}); }catch(_){ return ''; } }
    function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(140,el.scrollHeight)+'px'; }
  
// ======= RTC INBOX (global) =======
S.rtc = S.rtc || {};
S.rtc.inbox = null;
S.rtc.session = null;
function ensureInbox(){
  if (S.rtc.inbox) return;
  const ch = sb.channel('rtc:inbox', { config:{ broadcast:{ self:true }, presence:{ key: S.user.id } } });
  ch.on('broadcast', { event:'dm' }, onInboxDm);
  ch.subscribe((status)=>{ if(status==='SUBSCRIBED'){ ch.track({ uid:S.user.id }); } });
  S.rtc.inbox = ch;
}
async function onInboxDm(ev){
  const p = ev.payload||{};
  if (!S.user || !p || p.to!==S.user.id) return;
  if (p.kind==='invite'){
    if (S.call){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'busy', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    const ok = confirm(`${p.name||'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'} –≤–∏ –∫–∞–Ω–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä. –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏?`);
    if(!ok){ S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'reject', to:p.from, from:S.user.id, sessionId:p.sessionId } }); return; }
    S.rtc.session = { id:p.sessionId, peer:p.from };
    updateCallUI(true, '–°–≤—ä—Ä–∑–≤–∞–Ω–µ‚Ä¶'); await startDm(false);
    S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'accept', to:p.from, from:S.user.id, sessionId:p.sessionId } });
  } else if (p.kind==='accept' && S.rtc?.session?.id===p.sessionId){ await startDm(true); }
  else if (p.kind==='reject' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ–∫–∞–Ω–∞—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞'); endCall(); }
  else if (p.kind==='busy' && S.rtc?.session?.id===p.sessionId){ showToast('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∑–∞–µ—Ç'); endCall(); }
  else if (p.kind==='sdp' && S.rtc?.session?.id===p.sessionId){
    await S.call.pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
    if (p.sdp.type==='offer'){ const ans = await S.call.pc.createAnswer(); await S.call.pc.setLocalDescription(ans);
      S.rtc.inbox.send({ type:'broadcast', event:'dm', payload:{ kind:'sdp', to:S.rtc.session.peer, from:S.user.id, sessionId:p.sessionId, sdp: ans } });
    }
  } else if (p.kind==='ice' && S.rtc?.session?.id===p.sessionId && p.candidate){
    try{ await S.call.pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }catch(_){}
  } else if (p.kind==='hang' && S.rtc?.session?.id===p.sessionId){ showToast('–†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏'); endCall(); }
}
const _onLogin0 = onLogin; onLogin = async (u)=>{ await _onLogin0(u); ensureInbox(); };

// Floating tray actions
const $fabMobile = document.getElementById('fabMobile');
const $trayMobile = document.getElementById('trayMobile');
const $trayInvite = document.getElementById('trayInvite');
const $trayLive = document.getElementById('trayLive');
const $trayShare = document.getElementById('trayShare');
const $trayHang = document.getElementById('trayHang');
$fabMobile && ($fabMobile.onclick = ()=> $trayMobile.classList.toggle('open'));
$trayInvite && ($trayInvite.onclick = ()=>{ $trayMobile.classList.remove('open'); const uid=prompt('UID –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:'); if(uid) inviteToCall(uid.trim(),'–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'); });
$trayLive && ($trayLive.onclick = ()=>{ $trayMobile.classList.remove('open'); if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') stopLive(); else startLiveHost(); });
$trayShare && ($trayShare.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call&&typeof shareScreenDm==='function') shareScreenDm(); else if(typeof LIVE!=='undefined' && LIVE && LIVE.mode==='host') shareScreenLive(); else showToast('–ü—ä—Ä–≤–æ –∑–∞–ø–æ—á–Ω–µ—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ LIVE'); });
$trayHang && ($trayHang.onclick = ()=>{ $trayMobile.classList.remove('open'); if(S.call) endCall(); else if(typeof LIVE!=='undefined' && LIVE) stopLive(); });

// Ensure remote audio plays
try{ const rv=document.getElementById('remoteVideo'); if(rv){ rv.muted=false; } }catch(_){}
</script>
</body>
</html>
