<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T‑MAP Chat — simple</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html { scroll-behavior: smooth; }
    .scroll::-webkit-scrollbar{width:8px;height:8px}.scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:9999px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- AUTH GATE -->
  <section id="auth" class="min-h-screen grid place-items-center p-6 hidden">
    <div class="w-full max-w-sm bg-white border rounded-2xl shadow-sm p-6 space-y-4">
      <h1 class="text-xl font-semibold">Вход в чата</h1>
      <p class="text-sm text-slate-500">Влезте с Google (Gmail), за да пишете в общата стая.</p>
      <button id="btnGoogle" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-slate-700">Вход с Google</button>
    </div>
  </section>

  <!-- APP -->
  <div id="app" class="min-h-screen grid md:grid-cols-[280px,1fr] hidden">
    <aside class="border-r bg-white">
      <div class="p-4 border-b flex items-center gap-3">
        <img id="meAvatar" class="w-10 h-10 rounded-full ring-2 ring-slate-200" alt="" />
        <div class="min-w-0">
          <div id="meName" class="font-semibold truncate">—</div>
          <div class="text-xs text-slate-500">UID <span id="meId">—</span></div>
        </div>
        <button id="btnSignOut" class="ml-auto px-3 py-1.5 rounded-xl border text-sm">Изход</button>
      </div>

      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Активни потребители</div>
          <span id="activeCount" class="text-xs text-slate-400">0</span>
        </div>
        <div id="users" class="scroll max-h-[calc(100vh-220px)] overflow-y-auto space-y-1 pr-1"></div>
      </div>
    </aside>

    <main class="flex flex-col min-h-screen">
      <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b px-4 py-3 flex items-center">
        <div class="font-semibold">Обща стая</div>
        <div id="conn" class="ml-auto text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Онлайн</div>
      </header>

      <section id="messages" class="flex-1 scroll overflow-y-auto px-4 py-4 space-y-3"></section>

      <form id="composer" class="border-t bg-white px-3 py-3 flex gap-2 items-end">
        <textarea id="input" rows="1" placeholder="Напишете съобщение…" class="flex-1 resize-none rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-300"></textarea>
        <button class="px-4 py-3 rounded-2xl bg-slate-900 text-white">Изпрати</button>
      </form>
    </main>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";

    // presence
    const HEARTBEAT_SEC = 20;                 // на колко време да пишем last_seen_at
    const ONLINE_WINDOW_MS = 5 * 60 * 1000;   // считаме за онлайн до 5 мин след последната активност

    // ===== INIT =====
    const { createClient } = supabase; const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
    const S = { user:null, me:{name:"", avatar:""}, messages:new Map() };

    const $auth = document.getElementById('auth');
    const $btnGoogle = document.getElementById('btnGoogle');
    const $app = document.getElementById('app');
    const $meAvatar = document.getElementById('meAvatar');
    const $meName = document.getElementById('meName');
    const $meId = document.getElementById('meId');
    const $users = document.getElementById('users');
    const $activeCount = document.getElementById('activeCount');
    const $messages = document.getElementById('messages');
    const $composer = document.getElementById('composer');
    const $input = document.getElementById('input');
    const $conn = document.getElementById('conn');
    const $btnSignOut = document.getElementById('btnSignOut');

    boot();
    async function boot(){
      const { data } = await sb.auth.getUser();
      if (data?.user) onLoggedIn(data.user); else showAuth(true);
    }

    sb.auth.onAuthStateChange((_e, session) => { if (session?.user) onLoggedIn(session.user); else showAuth(true); });

    function showAuth(show){ $auth.classList.toggle('hidden', !show); $app.classList.toggle('hidden', show); }

    $btnGoogle.addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({ provider:'google', options:{ scopes:'openid email profile', redirectTo: `${location.origin}${location.pathname}` } });
    });

    // Sign out: маркираме офлайн и чистим сесията
    $btnSignOut.addEventListener('click', async ()=>{
      if (S.user){
        await sb.from('online_users').update({ last_seen_at: new Date(Date.now()-10*60*1000).toISOString() }).eq('id', S.user.id);
      }
      await sb.auth.signOut();
      S.user=null; S.me={name:"",avatar:""};
      showAuth(true);
    });

    async function onLoggedIn(user){
      S.user = user;
      const m = user.user_metadata||{};
      S.me = { name: m.full_name || m.name || (user.email||'').split('@')[0] || 'Потребител', avatar: m.avatar_url || m.picture || '' };
      $meAvatar.src = S.me.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(S.me.name)}&background=0D9488&color=fff`;
      $meName.textContent = S.me.name;
      $meId.textContent = (user.id||'').slice(0,8);
      showAuth(false);

      await upsertPresence();
      heartbeat();
      refreshUsers();
      subscribePresence();
      subscribeMessages();
      await loadMessages();
    }

    // ===== Presence =====
    async function upsertPresence(){
      const { error } = await sb.from('online_users').upsert({ id: S.user.id, username: S.me.name, avatar: S.me.avatar, last_seen_at: new Date().toISOString() }, { onConflict:'id' });
      if (error) console.warn('presence upsert', error);
    }
    function heartbeat(){ upsertPresence(); setTimeout(heartbeat, HEARTBEAT_SEC*1000); }
    function isOnline(iso){ return new Date(iso).getTime() > Date.now() - ONLINE_WINDOW_MS; }

    async function refreshUsers(){
      const { data, error } = await sb.from('online_users').select('*').order('last_seen_at', { ascending:false }).limit(200);
      if (error) return console.warn(error);
      $users.innerHTML='';
      let count=0;
      (data||[]).forEach(u=>{
        const online=isOnline(u.last_seen_at); if(online) count++;
        const el=document.createElement('div'); el.className='flex items-center gap-3 px-2 py-2 rounded-xl hover:bg-slate-50';
        el.innerHTML=`<img src="${esc(u.avatar||'')}" class="w-8 h-8 rounded-full ring-2 ring-slate-200"/><div class='min-w-0'><div class='font-medium truncate'>${esc(u.username||'Потребител')}</div><div class='text-xs ${online?'text-emerald-600':'text-slate-400'}'>${online?'онлайн':'офлайн'}</div></div>${u.id===S.user.id?'<span class="ml-auto text-xs px-2 py-1 rounded-full bg-slate-100">Вие</span>':''}`;
        $users.appendChild(el);
      });
      $activeCount.textContent = count;
    }

    function subscribePresence(){
      sb.channel('online_users_changes').on('postgres_changes', { event:'*', schema:'public', table:'online_users' }, refreshUsers).subscribe();
    }

    // ===== Messages =====
    async function loadMessages(){
      // опит 1: ако има created_at
      let q = sb.from('messages').select('*').order('created_at', {ascending:true}).limit(200);
      let { data, error } = await q;
      if (error){
        // опит 2: без order
        ({ data, error } = await sb.from('messages').select('*').limit(200));
      }
      if (error){ console.warn('loadMessages', error); return; }
      $messages.innerHTML=''; S.messages.clear();
      (data||[]).forEach(m=>{ S.messages.set(m.id, m); renderMessage(m); });
      $messages.scrollTop = $messages.scrollHeight;
    }

    function subscribeMessages(){
      sb.channel('realtime:messages')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages' }, ({new:row})=>{ S.messages.set(row.id,row); renderMessage(row); $messages.scrollTop=$messages.scrollHeight; })
        .subscribe();
    }

    function renderMessage(m){
      const name = esc(m.sender_name || m.username || '');
      const avatar = m.sender_avatar || m.avatar || '';
      const mine = m.sender_id ? (m.sender_id===S.user.id) : (name===S.me.name);
      const el = document.createElement('div');
      el.innerHTML = `
        <div class="flex items-start gap-3 ${mine?'justify-end':''}">
          ${mine?'':`<img src='${esc(avatar)}' class='w-8 h-8 rounded-full ring-2 ring-slate-200'/>`}
          <div class="max-w-[80%] ${mine?'bg-slate-900 text-white':'bg-white'} rounded-2xl px-4 py-3 shadow-sm border ${mine?'border-slate-900':'border-slate-200'}">
            ${mine?'':`<div class='text-xs font-medium mb-1 text-slate-500'>${name}</div>`}
            <div class="whitespace-pre-wrap leading-relaxed">${linkify(esc(m.content||''))}</div>
          </div>
          ${mine?`<img src='${esc(avatar)}' class='w-8 h-8 rounded-full ring-2 ring-slate-200'/>`:''}
        </div>`;
      $messages.appendChild(el);
    }

    // send
    $composer.addEventListener('submit', async (e)=>{
      e.preventDefault(); const txt=$input.value.trim(); if(!txt) return;
      $input.value=''; autoResize($input);
      const row={ username:S.me.name, avatar:S.me.avatar, content:txt, sender_id:S.user.id, sender_name:S.me.name, sender_avatar:S.me.avatar };
      const { error } = await sb.from('messages').insert(row);
      if (error){ alert('Грешка при изпращане: '+error.message); return; }
      // оптимистично
      await loadMessages();
    });

    // connection ping
    setInterval(async()=>{ const { error } = await sb.from('online_users').select('count').limit(1); $conn.textContent = error? 'Офлайн' : 'Онлайн'; $conn.className = 'ml-auto text-xs px-2 py-1 rounded-full ' + (error?'bg-red-100 text-red-700':'bg-emerald-100 text-emerald-700'); }, 5000);

    // utils
    function esc(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');}
    function linkify(t){return t.replace(/https?:\/\/[^\s]+/g,u=>`<a class='underline' target='_blank' rel='noopener' href='${u}'>${u}</a>`);}  
    function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(120, el.scrollHeight)+'px'; }
  </script>
</body>
</html>
