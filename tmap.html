<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T-MAP – Туристическа карта (SVG маркери + звук и нотификации)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #f7f7fb; }
    #map { height: 100%; width: 100%; }

    .leaflet-popup-content {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-img {
      display: block;
      width: 180px;
      max-width: 80vw;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }

    /* Toast контейнер (адаптивен) */
    .toast-container {
      position: fixed;
      top: env(safe-area-inset-top, 12px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
      padding: 0 8px;
      width: min(520px, 96vw);
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      background: rgba(255,255,255,0.92);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      transform: translateY(-12px);
      opacity: 0;
      animation: toast-in 220ms ease-out forwards;
    }
    @keyframes toast-in {
      to { transform: translateY(0); opacity: 1; }
    }
    .toast__icon {
      width: 36px; height: 36px; display: grid; place-items: center;
      border-radius: 12px;
      background: #e8f5e9;
      box-shadow: inset 0 0 0 1px rgba(46,125,50,0.15);
    }
    .toast__icon svg { width: 22px; height: 22px; }
    .toast__content { min-width: 0; }
    .toast__title {
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #0f172a;
      margin-bottom: 2px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .toast__desc {
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #334155;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .toast__actions { display: flex; align-items: center; gap: 8px; }
    .btn {
      appearance: none; border: 0; border-radius: 999px; padding: 8px 12px;
      font: 600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #2e7d32; color: #fff; cursor: pointer;
      box-shadow: 0 6px 16px rgba(46,125,50,0.3);
    }
    .btn:active { transform: translateY(1px); }
    .btn--ghost {
      background: transparent; color: #0f172a; box-shadow: none;
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* Бадж „нов“ върху маркера (изчезва след ~8s) */
    .new-marker-badge::after {
      content: "нов";
      position: absolute;
      top: -6px; right: -6px;
      font: 700 10px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #ef4444; color: #fff;
      border-radius: 999px;
      padding: 3px 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      animation: badge-fade 8s forwards;
    }
    @keyframes badge-fade {
      0% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Ореол за видимост около SVG маркера */
    .custom-logo-icon img {
      width: 48px; height: 48px; display: block;
      filter: drop-shadow(0 0 2px rgba(255,255,255,0.95))
              drop-shadow(0 2px 4px rgba(0,0,0,0.35));
      border-radius: 10px;
      -webkit-user-drag: none; user-select: none; pointer-events: none;
    }

    /* Малък помощен банер, ако браузърът блокира звук */
    .sound-hint {
      position: fixed; bottom: env(safe-area-inset-bottom, 12px); left: 50%; transform: translateX(-50%);
      background: rgba(15,23,42,0.92); color: #fff; border-radius: 999px; padding: 10px 14px;
      font: 600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 10px 26px rgba(0,0,0,0.25);
      z-index: 10000; display: none;
    }
    .sound-hint button { margin-left: 10px; border: 0; border-radius: 999px; padding: 8px 12px; background: #22c55e; color: #0f172a; font-weight: 700; cursor: pointer; }
  </style>
   <script src="favicon-injector.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
  <div class="sound-hint" id="soundHint">Включи звук за известия <button id="enableSoundBtn">Включи</button></div>

  <script>
    const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Карта
    const map = L.map('map').setView([42.7339, 25.4858], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);

    // SVG маркер (твоето лого)
    function makeDivIcon(url) {
      return L.divIcon({
        className: 'custom-logo-icon',
        html: `<img src="${url}" alt="marker">`,
        iconSize: [48, 48],
        iconAnchor: [24, 46],
        popupAnchor: [0, -42]
      });
    }
    const ICON_URL = 'logo01082025.svg';
    const customIcon = makeDivIcon(ICON_URL);

    // Държим маркерите по id
    const markersById = new Map();

    // Видени id-та (за да не свири за старите)
    const SEEN_KEY = 'tmap_seen_ids_v1';
    const seenIds = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || '[]'));
    function persistSeen() {
      localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seenIds)));
    }

    // WebAudio: единна AudioContext с graceful fallback
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') { return audioCtx.resume(); }
      return Promise.resolve();
    }
    function playChime() {
      ensureAudio().then(() => {
        const now = audioCtx.currentTime;
        const master = audioCtx.createGain();
        master.gain.setValueAtTime(0.0001, now);
        master.gain.exponentialRampToValueAtTime(0.5, now + 0.01);
        master.gain.exponentialRampToValueAtTime(0.0001, now + 1.1);
        master.connect(audioCtx.destination);
        const notes = [880, 1318.51, 987.77]; // A5, E6, B5
        notes.forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(freq, now);
          g.gain.setValueAtTime(0.0001, now + i*0.04);
          g.gain.exponentialRampToValueAtTime(0.5, now + i*0.04 + 0.03);
          g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.04 + 0.6);
          osc.connect(g).connect(master);
          osc.start(now + i*0.04);
          osc.stop(now + i*0.04 + 0.65);
        });
        document.getElementById('soundHint').style.display = 'none';
      }).catch(() => {
        // Браузърът блокира – покажи бутон за включване
        document.getElementById('soundHint').style.display = 'block';
      });
    }
    document.getElementById('enableSoundBtn').addEventListener('click', () => {
      ensureAudio().then(() => { playChime(); }).catch(() => {});
    }, { passive: true });

    // Toast
    const toastContainer = document.getElementById('toastContainer');
    function showToast({ title, desc, onPrimary, primaryText = 'Виж на картата', secondaryText = 'Затвори' }) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="toast__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 22s-7-4.5-7-10a7 7 0 0 1 14 0c0 5.5-7 10-7 10z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </div>
        <div class="toast__content">
          <div class="toast__title">${escapeHtml(title)}</div>
          <div class="toast__desc">${escapeHtml(desc || '')}</div>
        </div>
        <div class="toast__actions">
          <button class="btn">${primaryText}</button>
          <button class="btn btn--ghost">${secondaryText}</button>
        </div>`;
      toastContainer.appendChild(toast);
      const [primaryBtn, secondaryBtn] = toast.querySelectorAll('button');

      let hideTimer = setTimeout(() => hide(), 9000);
      function hide() {
        toast.style.transition = 'transform .2s ease, opacity .2s ease';
        toast.style.transform = 'translateY(-8px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 220);
      }
      primaryBtn.addEventListener('click', () => { onPrimary?.(); clearTimeout(hideTimer); hide(); });
      secondaryBtn.addEventListener('click', () => { clearTimeout(hideTimer); hide(); });

      // Закриване при swipe нагоре (мобилни)
      let startY = null;
      toast.addEventListener('touchstart', e => startY = e.touches[0].clientY, {passive:true});
      toast.addEventListener('touchmove', e => {
        if (startY === null) return;
        const dy = e.touches[0].clientY - startY;
        if (dy < -10) { toast.style.transform = `translateY(${dy}px)`; toast.style.opacity = String(1 + dy/120); }
      }, {passive:true});
      toast.addEventListener('touchend', () => {
        const style = getComputedStyle(toast);
        const matrix = new WebKitCSSMatrix(style.transform);
        if (matrix.m42 < -40) hide();
        startY = null;
      }, {passive:true});
    }

    // Escape помощник
    function escapeHtml(str) {
      return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Маркер + popup
    function addMarker(obj, { isNew }) {
      const lat = Number(obj.latitude), lng = Number(obj.longitude);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
      marker.bindPopup(`
        <div class="popup-title">${escapeHtml(obj.title ?? 'Без заглавие')}</div>
        ${obj.description ? '<div>' + escapeHtml(obj.description) + '</div>' : ''}
        ${obj.image_url ? '<img class="popup-img" src="' + escapeHtml(obj.image_url) + '" alt="">' : ''}
      `);
      markersById.set(obj.id, marker);

      if (isNew) {
        const el = marker._icon;
        if (el) { el.classList.add('new-marker-badge'); setTimeout(() => el.classList.remove('new-marker-badge'), 8000); }
      }
    }

    // Зареждане на текущи обекти
    async function loadExisting() {
      const { data, error } = await supabase
        .from('objects')
        .select('*')
        .order('created_at', { ascending: true });

      if (error) { console.error(error); return; }

      (data || []).forEach(obj => {
        addMarker(obj, { isNew: false });
        if (obj.id) seenIds.add(obj.id);
      });
      persistSeen();
    }

    // Реално време – нови INSERT-и
    function subscribeRealtime() {
      supabase.channel('public:objects')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'objects' }, payload => {
          const obj = payload.new || {};
          if (!obj.id || seenIds.has(obj.id)) return;

          addMarker(obj, { isNew: true });
          seenIds.add(obj.id);
          persistSeen();
          playChime();

          const title = obj.title || 'Нов обект';
          showToast({
            title: 'Нов обект добавен',
            desc: title,
            onPrimary: () => {
              const m = markersById.get(obj.id);
              if (m) { map.setView(m.getLatLng(), Math.max(map.getZoom(), 11), { animate: true }); m.openPopup(); }
            }
          });
        })
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') console.log('Realtime: subscribed.');
        });
    }

    // Старт
    (async function init() {
      await loadExisting();
      subscribeRealtime();
    })();
  </script>
</body>
</html>
