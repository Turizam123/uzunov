<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T-MAP – Fix: нормален размер на маркерите + „Отбележи се“</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>

.leaflet-popup-content-wrapper {
  max-width: 250px !important;
  padding: 8px;
}
.leaflet-popup-content {
  max-width: 250px !important;
}

    html, body { height: 100%; margin: 0; background: #f7f7fb; }
    #map { height: 100%; width: 100%; }

    .leaflet-popup-content { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-img { display:block; max-width:100%; height:auto; border-radius:8px; margin-top:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); }

    /* Мини-иконка (бейдж) с броя на отбелязванията */
    .visit-badge { background: transparent; border: none; }
    .visit-badge .badge {
      display: inline-block;
      min-width: 14px;
      height: 14px;
      padding: 0 4px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      font-size: 10px;
      line-height: 14px;
      text-align: center;
      user-select: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map">
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
  <div class="sound-hint" id="soundHint" style="display:none;position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.92);color:#fff;border-radius:999px;padding:10px 14px;box-shadow:0 10px 26px rgba(0,0,0,.25);z-index:10000;font:600 13px/1 system-ui;">
    Включи звук за известия <button id="enableSoundBtn" style="margin-left:10px;border:0;border-radius:999px;padding:8px 12px;background:#22c55e;color:#0f172a;font-weight:700;cursor:pointer;">Включи</button>
  </div>
</div>

  <script>
    const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Постоянен анонимен client_id
    function getClientId() {
      const k = 'tmap_client_id';
      let id = localStorage.getItem(k);
      if (!id) {
        id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random();
        localStorage.setItem(k, id);
      }
      return id;
    }
    const TMAP_CLIENT_ID = getClientId();

    // Карта
    const map = L.map('map').setView([42.7339, 25.4858], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

    // Икона чрез L.icon (фиксиран размер → няма гигантски SVG)
    const ICON_URL = 'logo01082025.svg'; // ако иконата липсва, Leaflet ще покаже празно; може да смениш на PNG
    const customIcon = L.icon({
      iconUrl: ICON_URL,
      iconSize: [52, 52],
      iconAnchor: [26, 48],
      popupAnchor: [0, -40],
      className: 'tmap-pin'
    });

    // Visits: кеш и бейджове
    const visitCountCache = new Map();
    const badgeRefs = new Map();

    async function getVisitCount(objectId) {
      const cached = visitCountCache.get(objectId);
      if (typeof cached === 'number') return cached;
      const { count, error } = await supabase
        .from('visits')
        .select('*', { count: 'exact', head: true })
        .eq('object_id', objectId);
      const safe = error ? 0 : (count || 0);
      visitCountCache.set(objectId, safe);
      return safe;
    }

    async function markVisit(objectId) {
      const { error } = await supabase
        .from('visits')
        .insert([{ object_id: objectId, client_id: TMAP_CLIENT_ID }]);
      if (error) return { ok:false, reason:'already_marked' };
      const next = (visitCountCache.get(objectId) || 0) + 1;
      visitCountCache.set(objectId, next);
      updateBadge(objectId, next);
      return { ok:true };
    }

    function createBadgeMarker(lat, lng, initial) {
      const html = '<span class="badge">' + initial + '</span>';
      // Леко отместване на бейджа надясно и нагоре спрямо пина
      const icon = L.divIcon({ className: 'visit-badge', html, iconSize: [1,1], iconAnchor: [42, 20] });
      return L.marker([lat, lng], { icon, interactive: false, zIndexOffset: 250 });
    }
    function setBadgeCount(badgeMarker, value) {
      const el = badgeMarker.getElement();
      if (!el) return;
      const span = el.querySelector('.badge');
      if (span) span.textContent = String(value);
    }
    function updateBadge(objectId, value) {
      const ref = badgeRefs.get(objectId);
      if (ref) setBadgeCount(ref, value);
    }

    async function attachVisitUIToPopup(containerEl, objectId) {
      if (containerEl.querySelector('.tmap-visit')) return;
      const count = await getVisitCount(objectId);
      containerEl.insertAdjacentHTML('beforeend',
        '<div class="tmap-visit" data-oid="' + objectId + '">          <div class="tmap-visit-row" style="margin-bottom:6px;">Посетили: <strong>' + count + '</strong> души</div>          <button class="tmap-visit-btn">Отбележи се</button>          <div class="tmap-visit-msg"></div>        </div>'
      );
      const root = containerEl.querySelector('.tmap-visit[data-oid="' + objectId + '"]');
      const btn  = root.querySelector('.tmap-visit-btn');
      const msg  = root.querySelector('.tmap-visit-msg');
      const cntEl= root.querySelector('.tmap-visit-row strong');
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        msg.textContent = 'Обработвам...';
        const res = await markVisit(objectId);
        if (res.ok) {
          cntEl.textContent = String(parseInt(cntEl.textContent, 10) + 1);
          msg.textContent = 'Успешно се отбелязахте!';
        } else if (res.reason === 'already_marked') {
          msg.textContent = 'Вече сте се отбелязали тук от това устройство.';
        } else {
          msg.textContent = 'Възникна грешка. Опитайте по-късно.';
        }
        btn.disabled = false;
      }, { passive: true });
    }

    async function addMarker(obj) {
      const lat = Number(obj.latitude), lng = Number(obj.longitude);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      const initialCount = await getVisitCount(obj.id);

      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
      markersById.set(obj.id, marker);
      marker.bindPopup(
        '<div id="popup-' + obj.id + '">          <div class="popup-title">' + (obj.title ? String(obj.title).replace(/</g,'&lt;').replace(/>/g,'&gt;') : 'Без заглавие') + '</div>          ' + (obj.description ? '<div>' + String(obj.description).replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>' : '') + '          ' + (obj.image_url ? '<img class="popup-img" src="' + String(obj.image_url).replace(/"/g,'&quot;') + '" alt="">' : '') + '        </div>'
      );
      marker.on('popupopen', async () => {
        const container = document.getElementById('popup-' + obj.id);
        if (container) await attachVisitUIToPopup(container, obj.id);
      });

      const badgeMarker = createBadgeMarker(lat, lng, initialCount).addTo(map);
      badgeRefs.set(obj.id, badgeMarker);
    }

    async function loadObjects() {
      const { data, error } = await supabase.from('objects').select('*').order('created_at', { ascending: true });
      if (error) { console.error('Грешка при objects:', error); return; }
      for (const obj of (data || [])) await addMarker(obj);
    }

    
    // Toast
    const toastContainer = document.getElementById('toastContainer');
    function escapeHtml(str) { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function showToast({ title, desc, onPrimary, primaryText = 'Виж на картата', secondaryText = 'Затвори' }) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.style.pointerEvents = 'auto';
      el.style.display = 'grid';
      el.style.gridTemplateColumns = 'auto 1fr auto';
      el.style.gap = '12px';
      el.style.alignItems = 'center';
      el.style.background = 'rgba(255,255,255,0.92)';
      el.style.backdropFilter = 'blur(6px)';
      el.style.border = '1px solid rgba(0,0,0,0.08)';
      el.style.borderRadius = '16px';
      el.style.padding = '12px 14px';
      el.style.boxShadow = '0 12px 30px rgba(0,0,0,0.15)';
      el.innerHTML = '<div style="width:36px;height:36px;display:grid;place-items:center;border-radius:12px;background:#e8f5e9;box-shadow:inset 0 0 0 1px rgba(46,125,50,0.15)"><svg viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22"><path d="M12 22s-7-4.5-7-10a7 7 0 0 1 14 0c0 5.5-7 10-7 10z"></path><circle cx="12" cy="12" r="3"></circle></svg></div><div><div style="font:600 15px/1.2 system-ui;color:#0f172a;margin-bottom:2px;">'+escapeHtml(title)+'</div><div style="font:13px/1.35 system-ui;color:#334155;">'+escapeHtml(desc||'')+'</div></div><div style="display:flex;gap:8px;"><button class="btn" style="appearance:none;border:0;border-radius:999px;padding:8px 12px;font:600 13px/1 system-ui;background:#2e7d32;color:#fff;cursor:pointer;box-shadow:0 6px 16px rgba(46,125,50,0.3)">'+primaryText+'</button><button class="btn-ghost" style="appearance:none;border:1px solid rgba(0,0,0,0.08);border-radius:999px;padding:8px 12px;font:600 13px/1 system-ui;background:transparent;color:#0f172a;cursor:pointer;">'+secondaryText+'</button></div>';
      toastContainer.appendChild(el);
      const [primaryBtn, secondaryBtn] = el.querySelectorAll('button');
      let hideTimer = setTimeout(hide, 9000);
      function hide(){ el.style.transition='transform .2s, opacity .2s'; el.style.transform='translateY(-8px)'; el.style.opacity='0'; setTimeout(()=>el.remove(), 220); }
      primaryBtn.addEventListener('click', ()=>{ onPrimary && onPrimary(); clearTimeout(hideTimer); hide(); });
      secondaryBtn.addEventListener('click', ()=>{ clearTimeout(hideTimer); hide(); });
    }

    // Sound
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') return audioCtx.resume();
      return Promise.resolve();
    }
    function playChime() {
      ensureAudio().then(()=>{
        const now = audioCtx.currentTime;
        const master = audioCtx.createGain();
        master.gain.setValueAtTime(0.0001, now);
        master.gain.exponentialRampToValueAtTime(0.5, now + 0.01);
        master.gain.exponentialRampToValueAtTime(0.0001, now + 1.1);
        master.connect(audioCtx.destination);
        [880, 1318.51, 987.77].forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          osc.type='sine'; osc.frequency.setValueAtTime(freq, now);
          g.gain.setValueAtTime(0.0001, now + i*0.04);
          g.gain.exponentialRampToValueAtTime(0.5, now + i*0.04 + 0.03);
          g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.04 + 0.6);
          osc.connect(g).connect(master);
          osc.start(now + i*0.04); osc.stop(now + i*0.04 + 0.65);
        });
        document.getElementById('soundHint').style.display='none';
      }).catch(()=>{ document.getElementById('soundHint').style.display='block'; });
    }
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'enableSoundBtn') {
        ensureAudio().then(()=>playChime());
      }
    }, { passive:true });

    // Realtime: нови INSERT-и в objects
    const markersById = new Map();
    const SEEN_KEY = 'tmap_seen_ids_v1';
    const seenIds = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || '[]'));
    function persistSeen(){ localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seenIds))); }

    function focusMarker(id){
      const m = markersById.get(id);
      if (m) { map.setView(m.getLatLng(), Math.max(map.getZoom(), 11), { animate:true }); m.openPopup(); }
    }

    function subscribeRealtime(){
      supabase.channel('public:objects')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'objects' }, async (payload)=>{
          const obj = payload.new || {};
          if (!obj.id || seenIds.has(obj.id)) return;
          // add marker for the new object
          await addMarker(obj);
          markersById.set(obj.id, markersById.get(obj.id) || null);
          seenIds.add(obj.id); persistSeen();
          playChime();
          showToast({
            title: 'Нов обект добавен',
            desc: obj.title || '',
            onPrimary: ()=>focusMarker(obj.id)
          });
        })
        .subscribe(()=>console.log('Realtime: subscribed'));
    }

    (async function init() {
      await loadObjects();
      subscribeRealtime();
    })();
  </script>
</body>
</html>
