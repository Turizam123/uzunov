<!DOCTYPE html>

<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>T-MAP</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f0f4f8;
  }
  #map {
    height: 100vh;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    border: none;
  }
  #notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #fff8dc;
    color: #7c2d12;
    border: 1px solid #facc15;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 500;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 9999;
  }

  #map { height: 100vh; margin: 10px; border-radius: 12px; border: 2px solid #cbd5e1; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
  #notification {
    background-color: #bae6fd;
    border: 1px solid #38bdf8;
    color: #0c4a6e;
    font-weight: 600;
    font-size: 15px;
  }
  button {
    font-size: 15px;
    font-weight: 600;
    background-color: #0ea5e9;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0369a1;
    transform: translateY(-1px);
  }
  
  #map {
    height: 100vh;
    margin: 20px auto;
    max-width: 95vw;
    border-radius: 16px;
    border: 2px solid #94a3b8;
    box-shadow: 0 0 14px rgba(0,0,0,0.1);
  }

  #notification {
    background-color: #fef3c7;
    border: 1px solid #facc15;
    color: #78350f;
    font-weight: 600;
    font-size: 16px;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: opacity 0.3s ease-in-out;
  }

  body {
    background: linear-gradient(to bottom, #e0f2fe, #f8fafc);
    font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="notification" style="display:none;"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const map = L.map('map').setView([42.7, 23.3], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const response = await fetch('https://cmiylzpmpwqbacjoqtkx.supabase.co/rest/v1/objects?select=*', {
    headers: {
      'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8',
      'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
    }
  });

  const data = await response.json();
  const seenIds = JSON.parse(localStorage.getItem('seenIds')) || [];
  const newMarkers = [];
  const oldMarkers = [];

  data.forEach(obj => {
    const isNew = !seenIds.includes(obj.id);
    const marker = L.marker([obj.latitude, obj.longitude], {
      title: obj.title
    }).bindPopup(
      '<b>' + obj.title + '</b><br>' +
      obj.description + '<br>' +
      '<img src="' + obj.image_url + '" style="width:100px;"><br>' +
      '<i>' + (obj.mountain || 'Неизвестна планина') + '</i>'
    );

    if (isNew) {
      marker.setIcon(L.icon({iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'}));
      newMarkers.push(marker);
    } else {
      marker.setIcon(L.icon({iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'}));
      oldMarkers.push(marker);
    }
  });

  if (newMarkers.length > 0) {
    const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3');
    audio.play();
    const note = document.getElementById("notification");
    note.textContent = `Имате ${newMarkers.length} нови обекта.`;
    note.style.display = "block";
    setTimeout(() => {
      note.style.display = "none";
    }, 6000);
  }

  const newGroup = L.layerGroup(newMarkers).addTo(map);
  const oldGroup = L.layerGroup(oldMarkers).addTo(map);

  const overlayMaps = {
    "Нови обекти": newGroup,
    "Съществуващи обекти": oldGroup
  };

  L.control.layers(null, overlayMaps).addTo(map);

  const allIds = data.map(obj => obj.id);
  localStorage.setItem('seenIds', JSON.stringify(allIds));
});
</script>
</body>
</html>
