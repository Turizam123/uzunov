<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>T-MAP с Google вход и коментари</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 100vh; }
  .user-bar { padding: 10px; background: #f5f5f5; text-align: right; }
  .comment-section { margin-top: 10px; }
  .comment { border-bottom: 1px solid #ccc; padding: 5px; }
  .visit-btn { margin-top: 5px; background: #28a745; color: white; padding: 5px; border: none; cursor: pointer; }
  .visit-btn:disabled { background: gray; cursor: default; }
</style>
</head>
<body>

<div class="user-bar">
  <span id="user-info"></span>
  <button id="login-btn">Вход с Google</button>
  <button id="logout-btn" style="display:none;">Изход</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let loadedPopups = new Set();

// UI логика за вход/изход
async function renderUserBar(user) {
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const userInfo = document.getElementById("user-info");

  if (user) {
    userInfo.textContent = `Влязъл като: ${user.user_metadata.full_name || user.email}`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    userInfo.textContent = "";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
}

document.getElementById("login-btn").addEventListener("click", async () => {
  await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
});

document.getElementById("logout-btn").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
});

// Следене на вход
supabaseClient.auth.onAuthStateChange((_event, session) => {
  currentUser = session?.user || null;
  renderUserBar(currentUser);
});

// Leaflet карта
const map = L.map('map').setView([42.7, 25.3], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// Зареждане на обекти
async function loadObjects() {
  const { data, error } = await supabaseClient.from('objects').select('*');
  if (error) {
    console.error(error);
    return;
  }
  data.forEach(obj => {
    const marker = L.marker([obj.latitude, obj.longitude]).addTo(map);
    marker.bindPopup(`<b>${obj.title}</b><br>${obj.description}<div id="popup-${obj.id}">Зареждане...</div>`);

    marker.on('popupopen', () => {
      if (!loadedPopups.has(obj.id)) {
        loadPopupContent(obj.id);
        loadedPopups.add(obj.id);
      }
    });
  });
}

// Зареждане на съдържание в popup
async function loadPopupContent(objectId) {
  const popupDiv = document.getElementById(`popup-${objectId}`);
  if (!popupDiv) return;

  let html = "";

  if (currentUser) {
    // Проверка дали вече е отбелязал
    const { data: visits } = await supabaseClient
      .from('visits')
      .select('*')
      .eq('object_id', objectId)
      .eq('user_id', currentUser.id);

    const visited = visits && visits.length > 0;
    html += `<button class="visit-btn" id="visit-btn-${objectId}" ${visited ? 'disabled' : ''}>
      ${visited ? 'Вече сте били тук' : 'Бил съм тук'}
    </button>`;

    // Секция коментари
    html += `<div class="comment-section">
      <textarea id="comment-input-${objectId}" placeholder="Вашият коментар"></textarea><br>
      <button onclick="postComment('${objectId}')">Публикувай</button>
      <div id="comments-${objectId}"></div>
    </div>`;

    popupDiv.innerHTML = html;

    // Слушател за "Бил съм тук"
    document.getElementById(`visit-btn-${objectId}`)?.addEventListener('click', async () => {
      await supabaseClient.from('visits').insert([
        { object_id: objectId, user_id: currentUser.id }
      ]);
      document.getElementById(`visit-btn-${objectId}`).textContent = "Вече сте били тук";
      document.getElementById(`visit-btn-${objectId}`).disabled = true;
    });

    // Зареждане на коментарите
    loadComments(objectId);

  } else {
    popupDiv.innerHTML = `<em>Впишете се с Google, за да отбележите посещение и да коментирате.</em>`;
  }
}

// Зареждане на коментари
async function loadComments(objectId) {
  const { data, error } = await supabaseClient
    .from('comments')
    .select('*')
    .eq('object_id', objectId)
    .order('created_at', { ascending: false });
  if (error) {
    console.error(error);
    return;
  }
  const commentsDiv = document.getElementById(`comments-${objectId}`);
  if (!commentsDiv) return;

  commentsDiv.innerHTML = data.map(c => 
    `<div class="comment"><strong>${c.username}:</strong> ${c.text}</div>`
  ).join("");
}

// Публикуване на коментар
async function postComment(objectId) {
  const textarea = document.getElementById(`comment-input-${objectId}`);
  if (!textarea || !textarea.value.trim()) return;
  await supabaseClient.from('comments').insert([
    { object_id: objectId, user_id: currentUser.id, username: currentUser.user_metadata.full_name || currentUser.email, text: textarea.value.trim() }
  ]);
  textarea.value = "";
  loadComments(objectId);
}

// Старт
(async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  currentUser = session?.user || null;
  renderUserBar(currentUser);
  loadObjects();
})();
</script>

</body>
</html>
