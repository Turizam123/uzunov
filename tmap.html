
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T-MAP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f0f4f8;
  }
  #map {
    height: 100vh;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    border: none;
  }
  #notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #fff8dc;
    color: #7c2d12;
    border: 1px solid #facc15;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 500;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 9999;
  }
  

#showAllBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  font-size: 13px;
  font-weight: 500;
  background-color: rgba(0, 123, 255, 0.65);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  cursor: grab;
  touch-action: none;
  transition: background-color 0.2s ease;
}
#showAllBtn:active {
  cursor: grabbing;
}
#showAllBtn:hover {
  background-color: rgba(0, 123, 255, 0.85);
}

  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  font-size: 14px;
  font-weight: 500;
  background-color: rgba(14, 165, 233, 0.8); /* синьо с прозрачност */
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: move;
  transition: background-color 0.2s ease-in-out;
}
#showAllBtn:hover {
  background-color: rgba(3, 105, 161, 0.9);
}

  width: auto;
  height: auto;
  font-size: 14px;
  background-color: rgba(0, 123, 255, 0.7);
  color: white;
  border-radius: 8px;
  border: none;
  padding: 8px 14px;
  cursor: move;
  position: fixed;
  top: 80px;
  left: 20px;
  z-index: 1001;
  transition: opacity 0.3s ease;
}
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1001;
    font-size: 16px;
    font-weight: 600;
    background-color: #2563eb;
    color: white;
    border: none;
    padding: 14px 22px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  #showAllBtn:hover {
    background-color: #1e40af;
    transform: scale(1.05);
  }



#showAllBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  font-size: 13px;
  font-weight: 500;
  background-color: rgba(0, 123, 255, 0.65);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  cursor: grab;
  touch-action: none;
  transition: background-color 0.2s ease;
}
#showAllBtn:active {
  cursor: grabbing;
}
#showAllBtn:hover {
  background-color: rgba(0, 123, 255, 0.85);
}

  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  font-size: 14px;
  font-weight: 500;
  background-color: rgba(14, 165, 233, 0.8); /* синьо с прозрачност */
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: move;
  transition: background-color 0.2s ease-in-out;
}
#showAllBtn:hover {
  background-color: rgba(3, 105, 161, 0.9);
}

  width: auto;
  height: auto;
  font-size: 14px;
  background-color: rgba(0, 123, 255, 0.7);
  color: white;
  border-radius: 8px;
  border: none;
  padding: 8px 14px;
  cursor: move;
  position: fixed;
  top: 80px;
  left: 20px;
  z-index: 1001;
  transition: opacity 0.3s ease;
}
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  font-size: 15px;
  font-weight: 600;
  background-color: #0ea5e9;
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 30px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  cursor: pointer;
}
#showAllBtn:hover {
  background-color: #0369a1;
  transform: scale(1.05);
}

  body {
    margin: 0;
    font-family: 'Helvetica Neue', sans-serif;
    background-color: #eef2f7;
  }
  #map {
    height: 100vh;
    margin: 10px;
    border-radius: 12px;
    border: 2px solid #cbd5e1;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
  }
  #notification {
    background-color: #bae6fd;
    border: 1px solid #38bdf8;
    color: #0c4a6e;
    font-weight: 600;
    font-size: 15px;
  }
  button {
    font-size: 15px;
    font-weight: 600;
    background-color: #0ea5e9;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0369a1;
    transform: translateY(-1px);
  }

    #map { height: 100vh; }
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffefc1;
      border: 1px solid #aaa;
      padding: 10px 15px;
      font-size: 16px;
      font-weight: bold;
      z-index: 9999;
      border-radius: 5px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
<button id="showAllBtn" onclick="showAllMarkers()" style="position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 10px 15px; background-color: #0a74da; color: white; border: none; border-radius: 5px; cursor: pointer;">Покажи всички</button>

<div id="map"></div>
<div id="notification" style="display:none;"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js">
function showAllMarkers() {
  const group = L.featureGroup([...oldMarkers, ...newMarkers]);
  map.fitBounds(group.getBounds());
}


function makeDraggableOLD(el) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  el.addEventListener("mousedown", function(e) {
    isDragging = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove", function(e) {
    if (isDragging) {
      el.style.left = `${e.clientX - offsetX}px`;
      el.style.top = `${e.clientY - offsetY}px`;
    }
  });

  document.addEventListener("mouseup", function() {
    isDragging = false;
    document.body.style.userSelect = "";
  });
}

makeDraggable(document.getElementById("showAllBtn"));

function makeDraggable(el) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  const onMouseDown = (e) => {
    isDragging = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    document.body.style.userSelect = "none";
  };

  const onMouseMove = (e) => {
    if (isDragging) {
      el.style.left = `${e.clientX - offsetX}px`;
      el.style.top = `${e.clientY - offsetY}px`;
    }
  };

  const onMouseUp = () => {
    isDragging = false;
    document.body.style.userSelect = "";
  };

  const onTouchStart = (e) => {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - el.getBoundingClientRect().left;
    offsetY = touch.clientY - el.getBoundingClientRect().top;
  };

  const onTouchMove = (e) => {
    if (isDragging) {
      const touch = e.touches[0];
      el.style.left = `${touch.clientX - offsetX}px`;
      el.style.top = `${touch.clientY - offsetY}px`;
    }
  };

  const onTouchEnd = () => {
    isDragging = false;
  };

  el.addEventListener("mousedown", onMouseDown);
  document.addEventListener("mousemove", onMouseMove);
  document.addEventListener("mouseup", onMouseUp);

  el.addEventListener("touchstart", onTouchStart);
  document.addEventListener("touchmove", onTouchMove);
  document.addEventListener("touchend", onTouchEnd);
}

makeDraggable(document.getElementById("showAllBtn"));

</script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const map = L.map('map').setView([42.7, 23.3], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const response = await fetch('https://cmiylzpmpwqbacjoqtkx.supabase.co/rest/v1/objects?select=*', {
    headers: {
      'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8',
      'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
    }
  });

  const data = await response.json();
  const seenIds = JSON.parse(localStorage.getItem('seenIds')) || [];
  const newMarkers = [];
  const oldMarkers = [];

  data.forEach(obj => {
    const isNew = !seenIds.includes(obj.id);
    const marker = L.marker([obj.latitude, obj.longitude], {
      title: obj.title
    }).bindPopup(
      '<b>' + obj.title + '</b><br>' +
      obj.description + '<br>' +
      '<img src="' + obj.image_url + '" style="width:100px;"><br>' +
      '<i>' + (obj.mountain || 'Неизвестна планина') + '</i>'
    );

    if (isNew) {
      marker.setIcon(L.icon({iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'}));
      newMarkers.push(marker);
    } else {
      marker.setIcon(L.icon({iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'}));
      oldMarkers.push(marker);
    }
  });

  if (newMarkers.length > 0) {
    const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3');
    audio.play();
    const note = document.getElementById("notification");
    note.textContent = `Имате ${newMarkers.length} нови обекта.`;
    note.style.display = "block";
    setTimeout(() => {
      note.style.display = "none";
    }, 6000);
  }

  const newGroup = L.layerGroup(newMarkers).addTo(map);
  const oldGroup = L.layerGroup(oldMarkers).addTo(map);

  const overlayMaps = {
    "Нови обекти": newGroup,
    "Съществуващи обекти": oldGroup
  };

  L.control.layers(null, overlayMaps).addTo(map);

  const allIds = data.map(obj => obj.id);
  localStorage.setItem('seenIds', JSON.stringify(allIds));
});

function showAllMarkers() {
  const group = L.featureGroup([...oldMarkers, ...newMarkers]);
  map.fitBounds(group.getBounds());
}


function makeDraggableOLD(el) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  el.addEventListener("mousedown", function(e) {
    isDragging = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove", function(e) {
    if (isDragging) {
      el.style.left = `${e.clientX - offsetX}px`;
      el.style.top = `${e.clientY - offsetY}px`;
    }
  });

  document.addEventListener("mouseup", function() {
    isDragging = false;
    document.body.style.userSelect = "";
  });
}

makeDraggable(document.getElementById("showAllBtn"));

function makeDraggable(el) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;

  const onMouseDown = (e) => {
    isDragging = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    document.body.style.userSelect = "none";
  };

  const onMouseMove = (e) => {
    if (isDragging) {
      el.style.left = `${e.clientX - offsetX}px`;
      el.style.top = `${e.clientY - offsetY}px`;
    }
  };

  const onMouseUp = () => {
    isDragging = false;
    document.body.style.userSelect = "";
  };

  const onTouchStart = (e) => {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - el.getBoundingClientRect().left;
    offsetY = touch.clientY - el.getBoundingClientRect().top;
  };

  const onTouchMove = (e) => {
    if (isDragging) {
      const touch = e.touches[0];
      el.style.left = `${touch.clientX - offsetX}px`;
      el.style.top = `${touch.clientY - offsetY}px`;
    }
  };

  const onTouchEnd = () => {
    isDragging = false;
  };

  el.addEventListener("mousedown", onMouseDown);
  document.addEventListener("mousemove", onMouseMove);
  document.addEventListener("mouseup", onMouseUp);

  el.addEventListener("touchstart", onTouchStart);
  document.addEventListener("touchmove", onTouchMove);
  document.addEventListener("touchend", onTouchEnd);
}

makeDraggable(document.getElementById("showAllBtn"));

</script>
</body>
</html>
