<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Резултати</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<div class="mx-auto max-w-4xl px-4 py-8 space-y-6">

  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-extrabold">Резултати</h1>
      <p id="who" class="text-sm text-slate-600"></p>
    </div>
    <a href="./dashboard.html"
       class="rounded-xl border px-4 py-2 font-semibold hover:bg-white">
      Назад
    </a>
  </div>

  <div id="resultsBox"
       class="rounded-2xl border bg-white p-6 shadow-sm space-y-4">
    <p class="text-slate-600">Зареждане…</p>
  </div>

</div>

<script src="./config.js"></script>
<script>
/* ================= INIT ================= */
const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.APP_CONFIG;
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const box = document.getElementById("resultsBox");
const who = document.getElementById("who");

async function guard(){
  const { data: { session } } = await sb.auth.getSession();
  if(!session){
    location.href = "./login.html";
    return null;
  }

  const email = session.user.email;

  const { data: userRow } = await sb
    .from("users")
    .select("access_code")
    .eq("email", email)
    .maybeSingle();

  if(!userRow?.access_code){
    location.href = "./login.html";
    return null;
  }

  who.textContent = "Курсист: " + email;
  return userRow.access_code;
}

/* ================= LOAD RESULTS ================= */
async function loadResults(accessCode){
  const { data, error } = await sb
    .from("exam_results")
    .select(`
      id,
      score_percent,
      passed,
      attempt,
      created_at,
      exams(title, min_score_percent)
    `)
    .eq("access_code", accessCode)
    .order("created_at", { ascending: false });

  if(error){
    box.innerHTML = `<p class="text-red-600">${error.message}</p>`;
    return;
  }

  if(!data || data.length === 0){
    box.innerHTML = `<p>Все още нямаш резултати.</p>`;
    return;
  }

  box.innerHTML = "";

  data.forEach(r => {
    const el = document.createElement("div");
    el.className = "rounded-xl border p-4 bg-slate-50";

    el.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="font-bold">${r.exams?.title || "Изпит"}</div>
          <div class="text-sm text-slate-600">
            Опит №${r.attempt} • ${new Date(r.created_at).toLocaleString()}
          </div>
        </div>
        <div class="text-right">
          <div class="text-xl font-extrabold">
            ${r.score_percent}%
          </div>
          <div class="${r.passed ? "text-green-700" : "text-red-700"} font-semibold">
            ${r.passed ? "ИЗДЪРЖАН" : "НЕИЗДЪРЖАН"}
          </div>
        </div>
      </div>

      ${
        !r.passed
        ? `<a href="./exam.html?module_id=${r.exams?.module_id || ""}"
             class="inline-block mt-3 rounded-xl bg-orange-600 px-4 py-2 text-sm font-semibold text-white hover:bg-orange-700">
             Повторно явяване
           </a>`
        : ``
      }
    `;
    box.appendChild(el);
  });
}

/* ================= BOOT ================= */
(async ()=>{
  const accessCode = await guard();
  if(accessCode) loadResults(accessCode);
})();
</script>

</body>
</html>
