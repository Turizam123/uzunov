<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Табло</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./config.js"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<nav id="mainNav"
class="mb-6 flex flex-wrap gap-2 items-center max-w-6xl mx-auto px-4 pt-6">
</nav>

<div class="max-w-6xl mx-auto px-4 py-8">

<div class="flex justify-between items-start">
<div>
<h1 class="text-2xl font-extrabold">Табло</h1>
<p id="who" class="text-sm text-slate-600"></p>
</div>
</div>

<div class="mt-6 grid lg:grid-cols-3 gap-4">

<div class="lg:col-span-2 bg-white rounded-2xl border p-5 shadow">
<h2 class="font-bold mb-4">Модули</h2>
<div id="modules" class="grid sm:grid-cols-2 gap-4"></div>
</div>

<div class="bg-white rounded-2xl border p-5 shadow">
<h2 class="font-bold mb-3">Информация</h2>
<p class="text-sm">• Изпитът се отключва автоматично</p>
<p class="text-sm">• Заключване при неуспешен опит</p>
<p class="text-sm">• Резултатите се пазят</p>
</div>

</div>
</div>

<script>

/* ================= INIT ================= */

const { SUPABASE_URL, SUPABASE_ANON_KEY, ADMIN_EMAIL } = APP_CONFIG;
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= ROLE GUARD ================= */

async function guard(){

const accessCode = localStorage.getItem("access_code");

const { data:{ session }} = await sb.auth.getSession();

// ===== ADMIN =====
if(session && session.user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()){

document.getElementById("who").textContent =
"Администратор: " + session.user.email;

renderNav(true);
return { isAdmin:true };

}

// ===== STUDENT =====
if(!accessCode){
location.href="./login.html";
return null;
}

// validate code
const { data } = await sb
.from("access_codes")
.select("status")
.eq("code",accessCode)
.maybeSingle();

if(!data || data.status !== "active"){
localStorage.removeItem("access_code");
location.href="./login.html";
return null;
}

document.getElementById("who").textContent =
"Курсист код: " + accessCode;

renderNav(false);
return { isAdmin:false, accessCode };

}

/* ================= NAV ================= */

function renderNav(isAdmin){

const nav = document.getElementById("mainNav");

nav.innerHTML = `
<a href="./dashboard.html"
class="border px-4 py-2 rounded-xl font-semibold">
Табло
</a>

<a href="./results.html"
class="border px-4 py-2 rounded-xl font-semibold">
${isAdmin ? "Всички резултати" : "Моите резултати"}
</a>

${isAdmin ? `
<a href="./admin/index.html"
class="border px-4 py-2 rounded-xl font-semibold">
Админ
</a>
` : ""}

<button id="logoutBtn"
class="ml-auto bg-slate-900 text-white px-4 py-2 rounded-xl font-semibold">
Изход
</button>
`;

document.getElementById("logoutBtn").onclick = async () => {

await sb.auth.signOut();
localStorage.removeItem("access_code");
location.href="./login.html";

};

}

/* ================= MODULE CARD ================= */

async function cardModule(m, ctx){

const el = document.createElement("div");
el.className = "border rounded-xl p-4 bg-slate-50";

let examUI = `<div class="text-sm text-slate-500">Няма активен изпит</div>`;

if(!ctx.isAdmin){

const { data: exam } = await sb
.from("exams")
.select("id")
.eq("module_id",m.id)
.eq("is_active",true)
.maybeSingle();

if(exam){

const res = await fetch(
`${SUPABASE_URL}/functions/v1/check_exam_lock`,
{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
exam_id:exam.id,
access_code:ctx.accessCode
})
}
);

const lock = await res.json();

if(lock.allowed){
examUI = `
<a href="./exam.html?module_id=${m.id}"
class="bg-green-600 text-white px-3 py-2 rounded-xl text-sm">
Изпит
</a>`;
}
else if(lock.reason==="passed"){
examUI = `<div class="text-green-700 font-semibold">Издържан</div>`;
}
else{
examUI = `<div class="text-red-600">Заключен</div>`;
}

}

}

el.innerHTML = `
<div class="flex justify-between">
<div>
<div class="font-bold">${m.title}</div>
</div>
<a class="underline text-sm" href="./module.html?id=${m.id}">
Теми
</a>
</div>
<div class="mt-3">${examUI}</div>
`;

return el;

}

/* ================= LOAD MODULES ================= */

async function loadModules(ctx){

const { data } = await sb
.from("modules")
.select("id,title")
.order("created_at");

const box = document.getElementById("modules");
box.innerHTML="";

for(const m of (data||[])){
box.appendChild(await cardModule(m,ctx));
}

}

/* ================= BOOT ================= */

(async()=>{

const ctx = await guard();
if(ctx) loadModules(ctx);

})();

</script>

</body>
</html>
