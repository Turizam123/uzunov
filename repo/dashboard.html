<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Табло – Курсист</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold">Табло</h1>
        <p id="who" class="mt-1 text-slate-600 text-sm">…</p>
      </div>
      <div class="flex gap-2">
        <a href="./modules.html" class="rounded-xl border px-4 py-2 font-semibold hover:bg-white">Модули</a>
        <button id="btnLogout" class="rounded-xl bg-slate-900 px-4 py-2 font-semibold text-white hover:bg-slate-800">Изход</button>
      </div>
    </div>

    <div class="mt-6 grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 rounded-2xl border bg-white p-5 shadow-sm">
        <h2 class="text-lg font-bold">Модули</h2>
        <div id="modules" class="mt-4 grid sm:grid-cols-2 gap-4"></div>
      </div>

      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <h2 class="text-lg font-bold">Бързи действия</h2>
        <div class="mt-4 space-y-2 text-sm text-slate-700">
          <p>• Отваряй темите от модулите и сваляй PDF/Word файловете.</p>
          <p>• Когато модулът има активен изпит, ще видиш бутон „Изпит“.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    const { SUPABASE_URL, SUPABASE_ANON_KEY, ADMIN_EMAIL } = window.APP_CONFIG;
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function guard(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session) return location.href = "./index.html";

      const email = session.user?.email || "";
      if(email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) return location.href = "./admin.html";

      // курсистът трябва да има users row с access_code
      const { data: userRow } = await supabase.from("users").select("access_code").eq("email", email).maybeSingle();
      if(!userRow?.access_code) return location.href = "./login.html";

      document.getElementById("who").textContent = "Влязъл курсист: " + email;

      return { session };
    }

    function cardModule(m){
      const el = document.createElement("div");
      el.className = "rounded-2xl border p-4 bg-slate-50";
      el.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-extrabold">${m.title}</div>
            <div class="mt-1 text-xs text-slate-600">${m.type || ""} ${m.is_mandatory ? "• задължителен" : ""}</div>
          </div>
          <a class="text-sm font-semibold underline" href="./module.html?id=${encodeURIComponent(m.id)}">Отвори</a>
        </div>
        <div class="mt-3 flex gap-2">
          <a class="rounded-xl bg-white border px-3 py-2 text-sm font-semibold hover:bg-white" href="./module.html?id=${encodeURIComponent(m.id)}">Теми</a>
          <a class="rounded-xl bg-green-600 px-3 py-2 text-sm font-semibold text-white hover:bg-green-700" href="./exam.html?module_id=${encodeURIComponent(m.id)}">Изпит</a>
        </div>
      `;
      return el;
    }

    async function loadModules(){
      const { data, error } = await supabase.from("modules").select("id,title,type,is_mandatory").order("created_at", { ascending: true });
      if(error) { alert(error.message); return; }
      const box = document.getElementById("modules");
      box.innerHTML = "";
      (data || []).forEach(m => box.appendChild(cardModule(m)));
    }

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      location.href = "./index.html";
    });

    (async () => {
      await guard();
      await loadModules();
    })();
  </script>
</body>
</html>
