<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Вход | Обучителна платформа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-100">

<div class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">

  <h1 class="text-2xl font-bold mb-4 text-center">
    Вход в платформата
  </h1>

  <p class="text-sm text-slate-600 mb-4 text-center">
    Въведи достъп код
  </p>

  <input
    id="accessCodeInput"
    type="text"
    class="w-full border rounded-lg px-3 py-2 mb-3"
    placeholder="PW-AX9K-7Q2M">

  <button
    id="loginBtn"
    class="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800">
    Вход
  </button>

  <p id="statusMsg"
     class="mt-4 text-center text-sm"></p>

</div>

<!-- CONFIG -->
<script src="./config.js"></script>

<script>

/* ================= INIT ================= */

if (!window.APP_CONFIG) {
  alert("config.js не е зареден");
  throw new Error("APP_CONFIG missing");
}

const {
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  BASE_PATH
} = APP_CONFIG;

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= ELEMENTS ================= */

const input = document.getElementById("accessCodeInput");
const btn = document.getElementById("loginBtn");
const msg = document.getElementById("statusMsg");

/* ================= UI ================= */

function setMsg(text, ok=true){
  msg.textContent = text;
  msg.className =
    "mt-4 text-center text-sm " +
    (ok ? "text-green-700" : "text-red-700");
}

/* ================= AUTO LOGIN CHECK ================= */

const savedCode = localStorage.getItem("access_code");
const savedRole = localStorage.getItem("role");

if(savedCode && savedRole){
  if(savedRole === "admin"){
    location.href = BASE_PATH + "admin/index.html";
  } else {
    location.href = BASE_PATH + "dashboard.html";
  }
}

/* ================= LOGIN ================= */

btn.onclick = async () => {

  const code = input.value.trim().toUpperCase();

  if(!code){
    setMsg("Моля въведи код", false);
    return;
  }

  btn.disabled = true;
  btn.textContent = "Проверка...";

  const { data, error } = await sb
    .from("access_codes")
    .select("code,role,status")
    .eq("code", code)
    .maybeSingle();

  if(error || !data){
    setMsg("Невалиден код", false);
    btn.disabled = false;
    btn.textContent = "Вход";
    return;
  }

  if(data.status !== "active"){
    setMsg("Кодът е неактивен", false);
    btn.disabled = false;
    btn.textContent = "Вход";
    return;
  }

  // SAVE SESSION
  localStorage.setItem("access_code", data.code);
  localStorage.setItem("role", data.role);

  // UPDATE LOGIN TIME
  await sb
    .from("access_codes")
    .update({ last_login_at: new Date() })
    .eq("code", data.code);

  // REDIRECT
  if(data.role === "admin"){
    location.href = BASE_PATH + "admin/index.html";
  } else {
    location.href = BASE_PATH + "dashboard.html";
  }
};

</script>

</body>
</html>
