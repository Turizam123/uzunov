<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Вход | Обучителна платформа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind (по желание, за стил) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-100">

  <div class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Вход в платформата</h1>

    <!-- Google Login -->
    <button
      id="googleLoginBtn"
      class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
    >
      Вход с Google
    </button>

    <!-- Access code section -->
    <div id="codeSection" class="hidden mt-6">
      <label class="block mb-2 font-semibold">Достъп код</label>
      <input
        id="accessCodeInput"
        type="text"
        placeholder="напр. PW-AX9K-7Q2M"
        class="w-full border rounded-lg px-3 py-2 mb-3"
      />
      <button
        id="submitCodeBtn"
        class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700"
      >
        Потвърди код
      </button>
    </div>

    <p id="statusMsg" class="mt-4 text-center text-sm text-red-600"></p>
  </div>

  <!-- Config -->
  <script src="./config.js"></script>

  <script>
    const ADMIN_EMAIL = "uzunov.ange@gmail.com";

    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const codeSection = document.getElementById("codeSection");
    const submitCodeBtn = document.getElementById("submitCodeBtn");
    const accessCodeInput = document.getElementById("accessCodeInput");
    const statusMsg = document.getElementById("statusMsg");

    // Google login
    googleLoginBtn.addEventListener("click", async () => {
      statusMsg.textContent = "";

      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.href
        }
      });

      if (error) {
        statusMsg.textContent = error.message;
      }
    });

    // Handle session after redirect
    async function handleSession() {
      const {
        data: { session }
      } = await supabase.auth.getSession();

      if (!session || !session.user) return;

      const email = session.user.email;

      // ADMIN → директно в админ панела
      if (email === ADMIN_EMAIL) {
        window.location.href = "./admin.html";
        return;
      }

      // Курсист → искаме код
      codeSection.classList.remove("hidden");
    }

    // Submit access code
    submitCodeBtn.addEventListener("click", async () => {
      statusMsg.textContent = "";

      const code = accessCodeInput.value.trim();
      if (!code) {
        statusMsg.textContent = "Моля, въведи достъп код.";
        return;
      }

      const {
        data: { session }
      } = await supabase.auth.getSession();

      if (!session) {
        statusMsg.textContent = "Няма активна сесия.";
        return;
      }

      try {
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/claim_access_code`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + session.access_token
            },
            body: JSON.stringify({ code })
          }
        );

        if (!res.ok) {
          const text = await res.text();
          statusMsg.textContent = text;
          return;
        }

        // Успех → към таблото
        window.location.href = "./dashboard.html";

      } catch (err) {
        console.error(err);
        statusMsg.textContent = "Грешка при връзка със сървъра.";
      }
    });

    handleSession();
  </script>
</body>
</html>
