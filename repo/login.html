<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Вход | Обучителна платформа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-100">

<div class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">

  <h1 class="text-2xl font-bold mb-6 text-center">
    Вход в платформата
  </h1>

  <button
    id="googleLoginBtn"
    class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
    Вход с Google
  </button>

  <div id="codeSection" class="hidden mt-6">
    <label class="block mb-2 font-semibold">Достъп код</label>
    <input
      id="accessCodeInput"
      type="text"
      class="w-full border rounded-lg px-3 py-2 mb-3"
      placeholder="PW-AX9K-7Q2M">
    <button
      id="submitCodeBtn"
      class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">
      Потвърди код
    </button>
  </div>

  <p id="statusMsg" class="mt-4 text-center text-sm text-red-600"></p>
</div>

<!-- CONFIG -->
<script src="./config.js"></script>

<script>
/* ================= INIT ================= */
if (!window.APP_CONFIG) {
  alert("config.js не е зареден");
  throw new Error("APP_CONFIG missing");
}

const {
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  ADMIN_EMAIL,
  BASE_PATH
} = window.APP_CONFIG;

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= ELEMENTS ================= */
const googleLoginBtn = document.getElementById("googleLoginBtn");
const codeSection = document.getElementById("codeSection");
const submitCodeBtn = document.getElementById("submitCodeBtn");
const accessCodeInput = document.getElementById("accessCodeInput");
const statusMsg = document.getElementById("statusMsg");

/* ================= GOOGLE LOGIN ================= */
googleLoginBtn.onclick = async () => {
  statusMsg.textContent = "";

  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: location.origin + BASE_PATH + "login.html"
    }
  });

  if (error) statusMsg.textContent = error.message;
};

/* ================= SESSION CHECK ================= */
async function handleSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) return;

  const email = session.user.email || "";

  // ✅ АДМИН → директно в админ панела
  if (email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    location.href = BASE_PATH + "admin.html";
    return;
  }

  // ✅ КУРСИСТ → показваме полето за код
  codeSection.classList.remove("hidden");
}
handleSession();

/* ================= CLAIM ACCESS CODE ================= */
submitCodeBtn.onclick = async () => {
  statusMsg.textContent = "";

  const code = accessCodeInput.value.trim();
  if (!code) {
    statusMsg.textContent = "Моля, въведи достъп код.";
    return;
  }

  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    statusMsg.textContent = "Няма активна сесия.";
    return;
  }

  const res = await fetch(
    `${SUPABASE_URL}/functions/v1/claim_access_code`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({ code })
    }
  );

  if (!res.ok) {
    statusMsg.textContent = await res.text();
    return;
  }

  // ✅ УСПЕХ → табло
  location.href = BASE_PATH + "dashboard.html";
};
</script>

</body>
</html>
