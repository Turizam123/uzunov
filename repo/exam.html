<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Изпит</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<div class="max-w-3xl mx-auto px-4 py-8">

  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 id="examTitle" class="text-2xl font-extrabold">Изпит</h1>
      <p id="meta" class="mt-1 text-slate-600 text-sm"></p>
    </div>

    <a href="./dashboard.html"
       class="rounded-xl border px-4 py-2 font-semibold hover:bg-white">
      Назад
    </a>
  </div>

  <div class="mt-6 rounded-2xl border bg-white p-5 shadow-sm">

    <div class="flex items-center justify-between">
      <div class="text-sm text-slate-600">Оставащо време:</div>
      <div id="timer" class="text-lg font-extrabold">--:--</div>
    </div>

    <form id="examForm" class="mt-5 space-y-5"></form>

    <button id="btnSubmit"
      class="mt-6 w-full rounded-xl bg-green-600 px-4 py-2.5
             font-semibold text-white hover:bg-green-700">
      Изпрати изпита
    </button>

    <p id="msg" class="mt-3 text-sm"></p>

  </div>
</div>

<script src="./config.js"></script>

<script>

/* ================= INIT ================= */

if (!window.APP_CONFIG) {
  alert("CONFIG missing");
  throw new Error("CONFIG missing");
}

const { SUPABASE_URL, SUPABASE_ANON_KEY, ADMIN_EMAIL } = APP_CONFIG;
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(location.search);
const moduleId = params.get("module_id");

/* ================= DOM ================= */

const examForm = document.getElementById("examForm");
const examTitle = document.getElementById("examTitle");
const meta = document.getElementById("meta");
const timerEl = document.getElementById("timer");
const btnSubmit = document.getElementById("btnSubmit");
const msg = document.getElementById("msg");

/* ================= UI ================= */

function setMsg(text, ok=true){
  msg.textContent = text;
  msg.className = "mt-3 text-sm " + (ok ? "text-green-700" : "text-red-700");
}

/* ================= STATE ================= */

let exam = null;
let questions = [];
let secondsLeft = 0;
let timerId = null;
let submitted = false;

/* ================= AUTH GUARD ================= */

async function guard(){

  const { data:{ session } } = await sb.auth.getSession();

  if(!session){
    location.href="./login.html";
    return null;
  }

  const email = session.user.email || "";

  if(email.toLowerCase() === ADMIN_EMAIL.toLowerCase()){
    setMsg("Администраторът няма достъп до изпити", false);
    btnSubmit.disabled = true;
    return null;
  }

  return session;
}

/* ================= TIMER ================= */

function startTimer(){

  function tick(){

    const m = Math.floor(secondsLeft / 60);
    const s = secondsLeft % 60;

    timerEl.textContent =
      String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");

    if(secondsLeft <= 0){
      clearInterval(timerId);
      setMsg("Времето изтече. Изпращане...", false);
      submitExam(true);
      return;
    }

    secondsLeft--;
  }

  tick();
  timerId = setInterval(tick, 1000);
}

/* ================= QUESTION UI ================= */

function renderQuestion(q, idx){

  const wrap = document.createElement("div");
  wrap.className = "rounded-xl border p-4 bg-slate-50";

  wrap.innerHTML = `<div class="font-bold">${idx+1}) ${q.question}</div>`;

  const list = document.createElement("div");
  list.className = "mt-3 space-y-2";

  const isMulti = (q.correct_answers || []).length > 1;

  q.answers.forEach((a,i)=>{

    const row = document.createElement("label");
    row.className = "flex items-center gap-2 text-sm";

    row.innerHTML = `
      <input type="${isMulti ? "checkbox" : "radio"}"
             name="q_${q.id}"
             value="${i}"
             class="accent-green-600"
             ${isMulti ? "" : "required"}>
      <span>${a}</span>
    `;

    list.appendChild(row);
  });

  wrap.appendChild(list);
  return wrap;
}

/* ================= LOAD EXAM ================= */

async function loadExam(){

  if(!moduleId){
    setMsg("Липсва module_id", false);
    btnSubmit.disabled = true;
    return;
  }

  const { data: ex } = await sb
    .from("exams")
    .select("id,title,duration_minutes,min_score_percent,is_active")
    .eq("module_id", moduleId)
    .eq("is_active", true)
    .maybeSingle();

  if(!ex){
    setMsg("Няма активен изпит", false);
    btnSubmit.disabled = true;
    return;
  }

  exam = ex;

  examTitle.textContent = ex.title;
  meta.textContent =
    `Време: ${ex.duration_minutes} мин • Минимум: ${ex.min_score_percent}%`;

  const { data: qs } = await sb
    .from("questions")
    .select("id,question,answers,correct_answers")
    .eq("exam_id", ex.id)
    .order("created_at");

  questions = qs || [];

  examForm.innerHTML = "";
  questions.forEach((q,i)=>{
    examForm.appendChild(renderQuestion(q,i));
  });

  secondsLeft = (ex.duration_minutes || 10) * 60;
  startTimer();
}

/* ================= COLLECT ================= */

function collectAnswers(){

  return questions.map(q=>{

    const checked = [...examForm.querySelectorAll(
      `input[name="q_${q.id}"]:checked`
    )];

    return {
      question_id: q.id,
      picked: checked.map(x=>Number(x.value))
    };
  });
}

/* ================= SUBMIT ================= */

async function submitExam(auto=false){

  if(submitted) return;
  submitted = true;

  clearInterval(timerId);
  btnSubmit.disabled = true;
  btnSubmit.textContent = "Изпращане...";

  const answers = collectAnswers();

  const { data, error } = await sb.functions.invoke("submit_exam", {
    body:{
      exam_id: exam.id,
      answers
    }
  });

  if(error){
    setMsg("Грешка: "+error.message, false);
    btnSubmit.disabled = false;
    btnSubmit.textContent = "Изпрати изпита";
    submitted = false;
    return;
  }

  if(!data?.ok){
    setMsg(data?.message || "Неуспешно изпращане", false);
    btnSubmit.disabled = false;
    btnSubmit.textContent = "Изпрати изпита";
    submitted = false;
    return;
  }

  setMsg(
    `Резултат: ${data.score_percent}% • ` +
    (data.passed ? "ИЗДЪРЖАН" : "НЕИЗДЪРЖАН"),
    data.passed
  );
}

/* ================= EVENTS ================= */

btnSubmit.onclick = e => {
  e.preventDefault();
  submitExam(false);
};

/* ================= BOOT ================= */

(async()=>{
  const ok = await guard();
  if(ok) await loadExam();
})();

</script>

</body>
</html>
