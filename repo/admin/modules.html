<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админ – Модули</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- GLOBAL NAV -->
<nav id="appNav"
     class="bg-white border-b px-6 py-3 flex flex-wrap gap-2 items-center">
</nav>

<!-- CONTENT -->
<main class="mx-auto max-w-7xl px-4 py-8 space-y-8">

  <!-- ADD MODULE -->
  <section class="rounded-2xl border bg-white p-6 shadow-sm">
    <h2 class="text-xl font-extrabold mb-4">Добави модул</h2>

    <div class="grid md:grid-cols-3 gap-4">

      <input
        id="modTitle"
        placeholder="Име на модул"
        class="border rounded-xl px-4 py-2"
      />

      <label class="flex items-center gap-2 text-sm">
        <input id="modMandatory" type="checkbox" class="accent-slate-900">
        Задължителен
      </label>

      <button
        id="btnAdd"
        class="rounded-xl bg-slate-900 text-white px-4 py-2 font-semibold hover:bg-slate-800">
        Добави
      </button>

    </div>

    <p id="msg" class="mt-3 text-sm"></p>
  </section>

  <!-- MODULES LIST -->
  <section class="rounded-2xl border bg-white p-6 shadow-sm">
    <h2 class="text-xl font-extrabold mb-4">Всички модули</h2>

    <table class="w-full text-sm border">
      <thead class="bg-slate-100">
        <tr>
          <th class="border p-2 text-left">Заглавие</th>
          <th class="border p-2 text-center">Задължителен</th>
          <th class="border p-2 text-center">Действия</th>
        </tr>
      </thead>
      <tbody id="modulesTable"></tbody>
    </table>
  </section>

</main>

<!-- CONFIG -->
<script src="../config.js"></script>

<!-- GLOBAL NAV -->
<script src="../nav.js"></script>

<script>

/* ================= SAFE INIT ================= */

if (!window.APP_CONFIG) {
  alert("CONFIG липсва");
  throw new Error("APP_CONFIG missing");
}

const { SUPABASE_URL, SUPABASE_ANON_KEY, ADMIN_EMAIL } = APP_CONFIG;
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= ELEMENTS ================= */

const modTitle = document.getElementById("modTitle");
const modMandatory = document.getElementById("modMandatory");
const btnAdd = document.getElementById("btnAdd");
const table = document.getElementById("modulesTable");
const msg = document.getElementById("msg");

/* ================= UI HELPERS ================= */

function setMsg(text, ok = true) {
  msg.textContent = text;
  msg.className = "mt-3 text-sm " + (ok ? "text-green-700" : "text-red-700");
}

/* ================= ADMIN GUARD ================= */

async function adminGuard() {

  const { data: { session } } = await sb.auth.getSession();

  if (!session) {
    location.href = "../login.html";
    return false;
  }

  if (session.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
    location.href = "../dashboard.html";
    return false;
  }

  return true;
}

/* ================= LOAD MODULES ================= */

async function loadModules() {

  const { data, error } = await sb
    .from("modules")
    .select("id,title,is_mandatory")
    .order("created_at", { ascending: true });

  if (error) {
    alert(error.message);
    return;
  }

  table.innerHTML = "";

  (data || []).forEach(m => {

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td class="border p-2 font-semibold">${m.title}</td>

      <td class="border p-2 text-center">
        ${m.is_mandatory ? "✅" : "—"}
      </td>

      <td class="border p-2 text-center">
        <button
          class="text-red-600 hover:text-red-800 underline text-sm"
          onclick="deleteModule('${m.id}')">
          Изтрий
        </button>
      </td>
    `;

    table.appendChild(tr);
  });
}

/* ================= ADD MODULE ================= */

btnAdd.onclick = async () => {

  const title = modTitle.value.trim();

  if (!title) {
    setMsg("Въведи име на модул", false);
    return;
  }

  btnAdd.disabled = true;
  btnAdd.textContent = "Запис...";

  const { error } = await sb.from("modules").insert({
    title,
    is_mandatory: modMandatory.checked
  });

  btnAdd.disabled = false;
  btnAdd.textContent = "Добави";

  if (error) {
    setMsg(error.message, false);
    return;
  }

  modTitle.value = "";
  modMandatory.checked = false;

  setMsg("Модулът е добавен успешно");
  loadModules();
};

/* ================= DELETE MODULE ================= */

async function deleteModule(id) {

  if (!confirm("Сигурен ли си, че искаш да изтриеш модула?")) return;

  const { error } = await sb
    .from("modules")
    .delete()
    .eq("id", id);

  if (error) {
    alert(error.message);
    return;
  }

  loadModules();
}

window.deleteModule = deleteModule;

/* ================= BOOT ================= */

(async () => {

  const ok = await adminGuard();
  if (!ok) return;

  loadModules();

})();

</script>

</body>
</html>
