<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админ – Изпити</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- CONFIG + NAV -->
<script src="../config.js"></script>
<script src="./_admin-nav.js"></script>

<main class="mx-auto max-w-7xl px-4 py-8 space-y-8">

  <!-- ADD EXAM -->
  <section class="rounded-2xl border bg-white p-6 shadow-sm">
    <h2 class="text-xl font-extrabold mb-4">Добави изпит</h2>

    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <select id="moduleSelect" class="border rounded-xl px-4 py-2">
        <option value="">-- избери модул --</option>
      </select>

      <input id="examTitle"
        placeholder="Заглавие на изпита"
        class="border rounded-xl px-4 py-2" />
    </div>

    <div class="grid md:grid-cols-3 gap-4 mb-4">
      <input id="duration"
        type="number"
        placeholder="Време (минути)"
        class="border rounded-xl px-4 py-2" />

      <input id="minScore"
        type="number"
        placeholder="Минимум %"
        class="border rounded-xl px-4 py-2" />

      <label class="flex items-center gap-2 text-sm">
        <input id="isActive" type="checkbox" class="accent-slate-900">
        Активен
      </label>
    </div>

    <button id="btnAdd"
      class="rounded-xl bg-slate-900 text-white px-6 py-2 font-semibold hover:bg-slate-800">
      Добави изпит
    </button>

    <p id="msg" class="mt-3 text-sm"></p>
  </section>

  <!-- EXAMS LIST -->
  <section class="rounded-2xl border bg-white p-6 shadow-sm">
    <h2 class="text-xl font-extrabold mb-4">Изпити</h2>

    <table class="w-full text-sm border">
      <thead class="bg-slate-100">
        <tr>
          <th class="border p-2">Модул</th>
          <th class="border p-2">Изпит</th>
          <th class="border p-2">Време</th>
          <th class="border p-2">Мин. %</th>
          <th class="border p-2">Активен</th>
          <th class="border p-2">Действия</th>
        </tr>
      </thead>
      <tbody id="examsTable"></tbody>
    </table>
  </section>

</main>

<script>
  const sb = window.__sb_admin;

  const moduleSelect = document.getElementById("moduleSelect");
  const examTitle = document.getElementById("examTitle");
  const duration = document.getElementById("duration");
  const minScore = document.getElementById("minScore");
  const isActive = document.getElementById("isActive");
  const btnAdd = document.getElementById("btnAdd");
  const table = document.getElementById("examsTable");
  const msg = document.getElementById("msg");

  function setMsg(text, ok=true){
    msg.textContent = text;
    msg.className = "mt-3 text-sm " + (ok ? "text-green-700" : "text-red-700");
  }

  // LOAD MODULES
  async function loadModules(){
    const { data } = await sb
      .from("modules")
      .select("id,title")
      .order("created_at");

    moduleSelect.innerHTML = `<option value="">-- избери модул --</option>`;
    (data || []).forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.title;
      moduleSelect.appendChild(opt);
    });
  }

  // LOAD EXAMS
  async function loadExams(){
    const { data, error } = await sb
      .from("exams")
      .select("id,title,duration_minutes,min_score_percent,is_active,modules(title)")
      .order("created_at", { ascending: false });

    if(error){
      alert(error.message);
      return;
    }

    table.innerHTML = "";
    (data || []).forEach(e => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-2">${e.modules?.title || "-"}</td>
        <td class="border p-2 font-semibold">${e.title}</td>
        <td class="border p-2 text-center">${e.duration_minutes} мин</td>
        <td class="border p-2 text-center">${e.min_score_percent}%</td>
        <td class="border p-2 text-center">${e.is_active ? "Да" : "Не"}</td>
        <td class="border p-2 text-center space-x-2">
          <button class="underline text-sm"
            onclick="toggleExam('${e.id}', ${!e.is_active})">
            ${e.is_active ? "Деактивирай" : "Активирай"}
          </button>
          <button class="text-red-600 underline text-sm"
            onclick="deleteExam('${e.id}')">
            Изтрий
          </button>
        </td>
      `;
      table.appendChild(tr);
    });
  }

  // ADD EXAM
  btnAdd.onclick = async () => {
    if(!moduleSelect.value || !examTitle.value || !duration.value || !minScore.value){
      setMsg("Попълни всички полета", false);
      return;
    }

    const { error } = await sb.from("exams").insert({
      module_id: moduleSelect.value,
      title: examTitle.value,
      duration_minutes: Number(duration.value),
      min_score_percent: Number(minScore.value),
      is_active: isActive.checked
    });

    if(error){
      setMsg(error.message, false);
      return;
    }

    examTitle.value = "";
    duration.value = "";
    minScore.value = "";
    isActive.checked = false;

    setMsg("Изпитът е добавен");
    loadExams();
  };

  async function toggleExam(id, active){
    await sb.from("exams").update({ is_active: active }).eq("id", id);
    loadExams();
  }

  async function deleteExam(id){
    if(!confirm("Изтриване на изпита?")) return;
    await sb.from("exams").delete().eq("id", id);
    loadExams();
  }

  window.toggleExam = toggleExam;
  window.deleteExam = deleteExam;

  loadModules();
  loadExams();
</script>

</body>
</html>
