<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Админ панел</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-100 min-h-screen">

<!-- GLOBAL NAV -->
<nav id="appNav"
     class="bg-white border-b px-6 py-3 flex flex-wrap gap-2 items-center">
</nav>

<!-- CONTENT -->
<main class="max-w-6xl mx-auto p-6 space-y-10">

  <!-- ACCESS CODES -->
  <section class="bg-white p-5 rounded-xl shadow">
    <h2 class="text-lg font-bold mb-4">Достъп кодове</h2>

    <div class="flex gap-2 mb-4">
      <input id="newCodeInput"
             placeholder="PW-AX9K-7Q2M"
             class="border px-3 py-2 rounded w-64">

      <button id="addCodeBtn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">
        Добави код
      </button>
    </div>

    <table class="w-full text-sm border">
      <thead class="bg-slate-200">
        <tr>
          <th class="border p-2">Код</th>
          <th class="border p-2">Имейл</th>
          <th class="border p-2">Статус</th>
          <th class="border p-2">Действие</th>
        </tr>
      </thead>
      <tbody id="codesTable"></tbody>
    </table>
  </section>

  <!-- LESSON UPLOAD -->
  <section class="bg-white p-5 rounded-xl shadow">
    <h2 class="text-lg font-bold mb-4">Добавяне на тема</h2>

    <div class="grid md:grid-cols-2 gap-4">

      <input id="lessonTitle"
             placeholder="Заглавие"
             class="border px-3 py-2 rounded">

      <input id="lessonDesc"
             placeholder="Описание"
             class="border px-3 py-2 rounded">

      <input type="file"
             id="lessonFile"
             accept=".pdf,.doc,.docx"
             class="border px-3 py-2 rounded">

      <button id="uploadLessonBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">
        Качи файл
      </button>

    </div>
  </section>

</main>

<!-- CONFIG -->
<script src="./config.js"></script>

<!-- GLOBAL NAV -->
<script src="./nav.js"></script>

<script>
/* ================= SAFE INIT ================= */

if (!window.APP_CONFIG) {
  alert("CONFIG липсва");
  throw new Error("APP_CONFIG missing");
}

const { SUPABASE_URL, SUPABASE_ANON_KEY, ADMIN_EMAIL } = APP_CONFIG;
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= ELEMENTS ================= */

const codesTable = document.getElementById("codesTable");
const newCodeInput = document.getElementById("newCodeInput");
const addCodeBtn = document.getElementById("addCodeBtn");

const uploadLessonBtn = document.getElementById("uploadLessonBtn");
const lessonFile = document.getElementById("lessonFile");
const lessonTitle = document.getElementById("lessonTitle");
const lessonDesc = document.getElementById("lessonDesc");

/* ================= ADMIN GUARD ================= */

async function adminGuard() {

  const { data: { session } } = await sb.auth.getSession();

  if (!session) {
    location.href = "./login.html";
    return false;
  }

  if (session.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
    location.href = "./dashboard.html";
    return false;
  }

  return true;
}

/* ================= LOAD ACCESS CODES ================= */

async function loadCodes() {

  const { data, error } = await sb
    .from("access_codes")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert(error.message);
    return;
  }

  codesTable.innerHTML = "";

  data.forEach(c => {
    codesTable.innerHTML += `
      <tr>
        <td class="border p-2">${c.code}</td>
        <td class="border p-2">${c.assigned_email || "-"}</td>
        <td class="border p-2">${c.status}</td>
        <td class="border p-2">
          <button
            onclick="resetCode('${c.code}')"
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">
            Reset
          </button>
        </td>
      </tr>
    `;
  });
}

/* ================= ADD CODE ================= */

addCodeBtn.onclick = async () => {

  const code = newCodeInput.value.trim();
  if (!code) return alert("Въведи код");

  const { error } = await sb
    .from("access_codes")
    .insert({ code, status: "active" });

  if (error) return alert(error.message);

  newCodeInput.value = "";
  loadCodes();
};

/* ================= RESET CODE ================= */

async function resetCode(code) {

  const { data: { session } } = await sb.auth.getSession();

  const res = await fetch(
    `${SUPABASE_URL}/functions/v1/reset_access_code`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({ code })
    }
  );

  if (!res.ok) return alert(await res.text());

  loadCodes();
}

window.resetCode = resetCode;

/* ================= UPLOAD LESSON ================= */

uploadLessonBtn.onclick = async () => {

  if (!lessonFile.files.length) return alert("Избери файл");

  uploadLessonBtn.disabled = true;
  uploadLessonBtn.textContent = "Качване...";

  const file = lessonFile.files[0];
  const ext = file.name.split(".").pop().toLowerCase();
  const filePath = `lessons/${crypto.randomUUID()}.${ext}`;

  const upload = await sb.storage
    .from("lesson_files")
    .upload(filePath, file);

  if (upload.error) {
    uploadLessonBtn.disabled = false;
    uploadLessonBtn.textContent = "Качи файл";
    return alert(upload.error.message);
  }

  const insert = await sb.from("lessons").insert({
    title: lessonTitle.value,
    description: lessonDesc.value,
    file_url: filePath,
    file_type: ext
  });

  uploadLessonBtn.disabled = false;
  uploadLessonBtn.textContent = "Качи файл";

  if (insert.error) return alert(insert.error.message);

  lessonTitle.value = "";
  lessonDesc.value = "";
  lessonFile.value = "";

  alert("Темата е качена успешно");
};

/* ================= BOOT ================= */

(async () => {
  const ok = await adminGuard();
  if (ok) loadCodes();
})();
</script>

</body>
</html>
