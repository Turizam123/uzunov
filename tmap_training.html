<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ T-MAP</title>
  <meta name="description" content="–û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ T-MAP ‚Äì –¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) –∏ –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)"> 
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üó∫Ô∏è</text></svg>"> 
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eef7ff', 100: '#d9edff', 200: '#b9dbff', 300: '#8fc2ff', 400: '#65a7ff',
              500: '#3a8aff', 600: '#256ee6', 700: '#1e56b4', 800: '#1a4690', 900: '#183b78'
            },
            accent: {
              50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c',800:'#9a3412',900:'#7c2d12'
            }
          },
          boxShadow: {
            soft: '0 10px 25px rgba(0,0,0,0.06)'
          }
        }
      }
    }
  </script>
  <style>
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    * { scrollbar-width: thin; scrollbar-color: #3a8aff #eef7ff; }
    *::-webkit-scrollbar { height: 8px; width: 8px; }
    *::-webkit-scrollbar-track { background: #eef7ff; }
    *::-webkit-scrollbar-thumb { background-color: #3a8aff; border-radius: 6px; }
    dialog::backdrop { background: rgba(0,0,0,.4); }
  </style>
</head>
<body class="bg-gradient-to-b from-brand-50 to-white text-slate-800">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 backdrop-blur border-b border-slate-200/60 bg-white/70">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 grid place-items-center rounded-xl bg-brand-600 text-white shadow-soft">üó∫Ô∏è</div>
          <div>
            <h1 class="font-bold leading-none">–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ <span class="text-brand-700">T‚ÄëMAP</span></h1>
            <p class="text-xs text-slate-500 -mt-1">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) ¬∑ –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</p>
          </div>
        </div>

        <!-- User section -->
        <div class="flex items-center gap-3">
          <span id="userEmail" class="text-sm text-slate-600 hidden sm:inline">–ì–æ—Å—Ç</span>
          <span id="adminBadge" class="hidden text-xs font-semibold px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">–ê–¥–º–∏–Ω</span>
          <button id="enterBtn" class="text-xs sm:text-sm px-3 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700 transition">–í—Ö–æ–¥</button>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="mt-2 border-t border-slate-200/60">
        <ul class="flex flex-wrap gap-2 py-2" role="tablist">
          <li><button data-tab="home" class="tab-btn px-3 py-1.5 rounded-full text-sm bg-brand-600 text-white shadow-soft">–ù–∞—á–∞–ª–æ</button></li>
          <li><button data-tab="my" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</button></li>
          <li><button data-tab="results" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100">–†–µ–∑—É–ª—Ç–∞—Ç–∏</button></li>
          <li><button data-tab="students" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100 hidden" id="studentsTabBtn">–ö—É—Ä—Å–∏—Å—Ç–∏</button></li>
          <li><button data-tab="admin" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100 hidden" id="adminTabBtn">–ê–¥–º–∏–Ω</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero -->
    <section class="tab-pane active" id="home" aria-labelledby="home-tab">
      <div class="grid lg:grid-cols-3 gap-6 items-stretch">
        <div class="lg:col-span-2">
          <div class="relative overflow-hidden rounded-2xl bg-white shadow-soft p-8">
            <div class="absolute -right-24 -top-24 w-72 h-72 rounded-full bg-brand-100 blur-3xl"></div>
            <div class="relative">
              <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –æ–±—É—á–∏—Ç–µ–ª–Ω–∏—è —Ü–µ–Ω—Ç—ä—Ä <span class="text-brand-700">T‚ÄëMAP</span></h2>
              <p class="mt-3 text-slate-600">–ü–æ–¥–≥–æ—Ç–≤–µ—Ç–µ —Å–µ –∑–∞ —Å–µ–∑–æ–Ω–∏—Ç–µ —Å –Ω–∞—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–∏: 
                <span class="font-semibold">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</span> –∏ <span class="font-semibold">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</span>. –ì—ä–≤–∫–∞–≤–∏ –≥—Ä–∞—Ñ–∏—Ü–∏, —Ä–µ–∞–ª–Ω–∏ —É–º–µ–Ω–∏—è, –ø–æ–¥–∫—Ä–µ–ø–∞ –æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏.</p>
              <div class="mt-6 flex flex-wrap gap-3">
                <a href="#courses" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–í–∏–∂ –∫—É—Ä—Å–æ–≤–µ—Ç–µ</a>
                <a href="#offers" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick info card -->
        <div class="rounded-2xl bg-white shadow-soft p-6">
          <h3 class="font-semibold text-lg">–ë—ä—Ä–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <ul class="mt-3 space-y-2 text-sm text-slate-600">
            <li>‚è±Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: 4‚Äì6 —Å–µ–¥–º–∏—Ü–∏</li>
            <li>üß≠ –§–æ—Ä–º–∞—Ç: –û–Ω–ª–∞–π–Ω + —Ç–µ—Ä–µ–Ω–Ω–∏ –∑–∞–Ω—è—Ç–∏—è</li>
            <li>üéØ –ù–∏–≤–æ: –ù–∞—á–∏–Ω–∞–µ—â–∏ –∏ –Ω–∞–ø—Ä–µ–¥–Ω–∞–ª–∏</li>
            <li>üìú –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–ª–µ–¥ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ</li>
          </ul>
        </div>
      </div>

      <!-- Courses section -->
      <section id="courses" class="mt-10">
        <div class="flex items-end justify-between gap-4">
          <h3 class="text-xl font-bold">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∫—É—Ä—Å–æ–≤–µ</h3>
          <button id="addToMyPlanBtns" class="text-sm px-3 py-2 rounded-lg border border-brand-200 hover:bg-brand-50">–ó–∞–ø–∏—à–∏ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ</button>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="courseCards">
          <!-- –ö–∞—Ä—Ç–∞: –¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="theory-winter">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700">–æ–Ω–ª–∞–π–Ω</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">–ù–∞–≤–∏–≥–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞, –ª–∞–≤–∏–Ω–Ω–∞ –ø—Ä–µ–≤–µ–Ω—Ü–∏—è, –µ–∫–∏–ø–∏—Ä–æ–≤–∫–∞.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: 15 –æ–∫—Ç ‚Äì 15 –Ω–æ–µ</li>
                <li>üïí –í–µ—á–µ—Ä–Ω–∏ –∑–∞–Ω—è—Ç–∏—è: –≤—Ç/—á—Ç 19:00</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium">8 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold">290 –ª–≤</span>
                  <span class="ml-2 line-through text-slate-400 text-sm">350 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-brand-50 to-white p-4 text-xs text-slate-600">üéÅ –†–∞–Ω–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è –¥–æ 1 –æ–∫—Ç–æ–º–≤—Ä–∏: –æ—â–µ <span class="font-semibold">-10%</span></div>
          </article>

          <!-- –ö–∞—Ä—Ç–∞: –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ) -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="practice-summer">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">–Ω–∞ —Ç–µ—Ä–µ–Ω</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">–ú–∞—Ä—à—Ä—É—Ç–∏, —Ä–∞–±–æ—Ç–∞ —Å GPS/GPX, –±–∏–≤–∞–∫—É–≤–∞–Ω–µ, –ø—ä—Ä–≤–∞ –ø–æ–º–æ—â –Ω–∞ —Ç–µ—Ä–µ–Ω.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: 10 —é–Ω–∏ ‚Äì 10 —é–ª–∏</li>
                <li>üìç –õ–æ–∫–∞—Ü–∏–∏: –†–∏–ª–∞ ¬∑ –ü–∏—Ä–∏–Ω ¬∑ –°—Ç–∞—Ä–∞ –ø–ª–∞–Ω–∏–Ω–∞</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium">12 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold">420 –ª–≤</span>
                  <span class="ml-2 line-through text-slate-400 text-sm">490 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-emerald-50 to-white p-4 text-xs text-slate-600">üåû –ö–æ–º–±–æ —Å –¢–µ–æ—Ä–∏—è: –æ–±—â–æ <span class="font-semibold">-15%</span></div>
          </article>

          <!-- –ö–∞—Ä—Ç–∞: –ò–Ω—Ç–µ–Ω–∑–∏–≤ -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="intensive-weekend">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">—Å–º–µ—Å–µ–Ω–æ</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">2 —É–∏–∫–µ–Ω–¥–∞ —Ç–µ–æ—Ä–∏—è + 1 —É–∏–∫–µ–Ω–¥ –ø—Ä–∞–∫—Ç–∏–∫–∞. –ó–∞ –∑–∞–µ—Ç–∏ —Ö–æ—Ä–∞.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: 23‚Äì24 –Ω–æ–µ ¬∑ 30 –Ω–æ–µ‚Äì1 –¥–µ–∫ ¬∑ 7‚Äì8 –¥–µ–∫</li>
                <li>üïí –ß–∞—Å–æ–≤–µ: 10:00‚Äì16:00</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium">5 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold">360 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-white p-4 text-xs text-slate-600">‚ö° –°–ø–µ—Ü–∏–∞–ª–Ω–æ –∑–∞–µ—Ç–∏: –±–æ–Ω—É—Å –∑–∞–ø–∏—Å –æ—Ç –ª–µ–∫—Ü–∏–∏—Ç–µ</div>
          </article>
        </div>
      </section>

      <!-- Offers -->
      <section id="offers" class="mt-10">
        <h3 class="text-xl font-bold">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</h3>
        <div class="mt-4 grid md:grid-cols-3 gap-6">
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–†–∞–Ω–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ</div>
            <div class="text-3xl font-extrabold mt-1">-10%</div>
            <p class="mt-2 text-sm text-slate-600">–ó–∞ –∑–∞–ø–∏—Å –¥–æ 1 –æ–∫—Ç–æ–º–≤—Ä–∏</p>
          </div>
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–ö–æ–º–±–æ –ø–∞–∫–µ—Ç</div>
            <div class="text-3xl font-extrabold mt-1">-15%</div>
            <p class="mt-2 text-sm text-slate-600">–¢–µ–æ—Ä–∏—è + –ü—Ä–∞–∫—Ç–∏–∫–∞</p>
          </div>
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–ì—Ä—É–ø–∏ 3+</div>
            <div class="text-3xl font-extrabold mt-1">-10%</div>
            <p class="mt-2 text-sm text-slate-600">–ó–∞ –≥—Ä—É–ø–æ–≤–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è</p>
          </div>
        </div>
      </section>
    </section>

    <!-- –ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ / –ü—Ä–æ—Ñ–∏–ª –Ω–∞ –∫—É—Ä—Å–∏—Å—Ç -->
    <section class="tab-pane" id="my" aria-labelledby="my-tab">
      <div class="rounded-2xl bg-white shadow-soft p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</h3>
          <button id="logoutBtn" class="text-xs px-2 py-1 rounded-md border hidden">–ò–∑—Ö–æ–¥</button>
        </div>
        <p class="mt-2 text-slate-600 text-sm">–¢—É–∫ –≤–∏–∂–¥–∞—Ç–µ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ –∫—É—Ä—Å–æ–≤–µ –∏ (–∞–∫–æ —Å—Ç–µ –∫—É—Ä—Å–∏—Å—Ç) –≤–∞—à–∏—è –ø—Ä–æ—Ñ–∏–ª.</p>

        <div id="studentProfile" class="mt-4 grid md:grid-cols-2 gap-6 hidden">
          <div class="rounded-xl border border-slate-200 p-5">
            <h4 class="font-semibold mb-3">–ü—Ä–æ—Ñ–∏–ª</h4>
            <dl class="grid grid-cols-3 gap-2 text-sm">
              <dt class="text-slate-500">–ò–º–µ</dt><dd class="col-span-2" id="pfName">‚Äî</dd>
              <dt class="text-slate-500">–ï–ì–ù</dt><dd class="col-span-2" id="pfEGN">‚Äî</dd>
              <dt class="text-slate-500">–ê–¥—Ä–µ—Å</dt><dd class="col-span-2" id="pfAddr">‚Äî</dd>
              <dt class="text-slate-500">–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</dt><dd class="col-span-2" id="pfQual">‚Äî</dd>
            </dl>
          </div>
          <div class="rounded-xl border border-slate-200 p-5">
            <h4 class="font-semibold mb-3">–ú–∏–Ω–∞–ª–∏ –ø–ª–∞–Ω–æ–≤–µ/–∫—É—Ä—Å–æ–≤–µ</h4>
            <ul id="pfCompleted" class="list-disc list-inside text-sm text-slate-700"></ul>
          </div>
          <div class="rounded-xl border border-slate-200 p-5 md:col-span-2">
            <h4 class="font-semibold mb-3">–û—Ü–µ–Ω–∫–∏ –∏ —Ö–æ—Ä–∞—Ä–∏—É–º</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-500"><th class="py-2 pr-4">–ö—É—Ä—Å/–º–æ–¥—É–ª</th><th class="py-2 pr-4">–û—Ü–µ–Ω–∫–∞</th><th class="py-2 pr-4">–ß–∞—Å–æ–≤–µ</th></tr>
                </thead>
                <tbody id="pfGrades"></tbody>
              </table>
            </div>
          </div>
          <div class="rounded-xl border border-slate-200 p-5 md:col-span-2">
            <h4 class="font-semibold mb-3">–ó–∞–ø–ª–∞—â–∞–Ω–µ</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-500"><th class="py-2 pr-4">–ú–æ–¥—É–ª</th><th class="py-2 pr-4">–°—É–º–∞</th><th class="py-2 pr-4">–°—Ç–∞—Ç—É—Å</th><th class="py-2 pr-4">–î–∞—Ç–∞</th></tr>
                </thead>
                <tbody id="pfPayments"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="myPlan" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6">
          <h4 class="font-semibold">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏</h4>
          <ul id="myMaterials" class="mt-2 text-sm text-brand-700 list-disc list-inside"></ul>
        </div>
      </div>
    </section>

    <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏ -->
    <section class="tab-pane" id="results" aria-labelledby="results-tab">
      <div class="rounded-2xl bg-white shadow-soft p-6">
        <h3 class="text-xl font-bold">–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
        <p class="mt-2 text-slate-600 text-sm">–í–∞—à–∏—Ç–µ –∏–∑–ø–∏—Ç–∏ –∏ –ø—Ä–∏—Å—ä—Å—Ç–≤–∏—è.</p>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">–î–∞—Ç–∞</th>
                <th class="py-2 pr-4">–ö—É—Ä—Å</th>
                <th class="py-2 pr-4">–¢–∏–ø</th>
                <th class="py-2 pr-4">–†–µ–∑—É–ª—Ç–∞—Ç</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –ö—É—Ä—Å–∏—Å—Ç–∏ (—Å–∞–º–æ –∑–∞ –ê–¥–º–∏–Ω) -->
    <section class="tab-pane" id="students" aria-labelledby="students-tab">
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white shadow-soft p-6">
          <div class="flex items-center justify-between"><h3 class="text-xl font-bold">–î–æ–±–∞–≤–∏ –∫—É—Ä—Å–∏—Å—Ç</h3><span class="text-xs text-slate-500">—Å–∞–º–æ –∑–∞ –ê–¥–º–∏–Ω</span></div>
          <form id="studentForm" class="mt-4 grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <label class="text-sm font-medium">–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è</label>
              <input required type="text" id="stName" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" />
            </div>
            <div>
              <label class="text-sm font-medium">–ï–ì–ù</label>
              <input required type="text" id="stEGN" maxlength="10" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="XXXXXXXXXX" />
            </div>
            <div>
              <label class="text-sm font-medium">–ê–¥—Ä–µ—Å</label>
              <input type="text" id="stAddr" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–≥—Ä./—Å., —É–ª., ‚Ññ" />
            </div>
            <div class="col-span-2">
              <label class="text-sm font-medium">–í–∏–¥ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</label>
              <input type="text" id="stQual" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. –ü–ª–∞–Ω–∏–Ω—Å–∫–∏ –≤–æ–¥–∞—á" />
            </div>
            <div class="col-span-2">
              <label class="text-sm font-medium">–ú–∏–Ω–∞–ª–∏ —É—Å–ø–µ—à–Ω–æ –ø–ª–∞–Ω–æ–≤–µ/–∫—É—Ä—Å–æ–≤–µ</label>
              <textarea id="stCompleted" rows="2" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="—Ä–∞–∑–¥–µ–ª—è–π—Ç–µ —Å—ä—Å –∑–∞–ø–µ—Ç–∞—è"></textarea>
            </div>
            <div>
              <label class="text-sm font-medium">–ù–∞—á–∞–ª–µ–Ω —Ö–æ—Ä–∞—Ä–∏—É–º (—á–∞—Å–æ–≤–µ)</label>
              <input type="number" id="stHours" class="mt-1 w-full rounded-lg border-slate-200" placeholder="0" />
            </div>
            <div>
              <label class="text-sm font-medium">–ü—ä—Ä–≤–∏ –º–æ–¥—É–ª ‚Äì —Ç–∞–∫—Å–∞ (–ª–≤)</label>
              <input type="number" id="stFirstPay" class="mt-1 w-full rounded-lg border-slate-200" placeholder="0" />
            </div>
            <div class="col-span-2">
              <button class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–ó–∞–ø–∏—à–∏ –∫—É—Ä—Å–∏—Å—Ç–∞</button>
            </div>
          </form>
        </div>

        <div class="rounded-2xl bg-white shadow-soft p-6">
          <h3 class="text-xl font-bold">–°–ø–∏—Å—ä–∫ –∫—É—Ä—Å–∏—Å—Ç–∏</h3>
          <div class="mt-3 flex gap-2">
            <input id="stSearch" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ/–ï–ì–ù" class="w-full rounded-lg border-slate-200">
            <button id="exportStudents" class="px-3 py-2 rounded-lg border hover:bg-slate-50">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
          </div>
          <ul id="studentsList" class="mt-4 space-y-2 text-sm"></ul>
        </div>
      </div>
    </section>

    <!-- –ö—É—Ä—Å–∏—Å—Ç ‚Äì –¥–µ—Ç–∞–π–ª–∏ (–ê–¥–º–∏–Ω) -->
    <dialog id="studentDetailDialog" class="rounded-xl p-0 w-full max-w-3xl">
      <form method="dialog">
        <div class="p-5 border-b flex items-center justify-between">
          <div>
            <h3 class="font-semibold">–ü—Ä–æ—Ñ–∏–ª –Ω–∞ –∫—É—Ä—Å–∏—Å—Ç</h3>
            <p class="text-xs text-slate-500" id="dlgStSub">‚Äî</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="printProfileBtn" type="button" class="text-xs px-2 py-1 rounded-md border">–ü–µ—á–∞—Ç</button>
            <button value="cancel" class="text-slate-500">‚úï</button>
          </div>
        </div>
      </form>
      <div class="p-5 space-y-6" id="dlgContent">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="rounded-xl border border-slate-200 p-4">
            <h4 class="font-semibold mb-3">–û—Å–Ω–æ–≤–Ω–∏ –¥–∞–Ω–Ω–∏</h4>
            <dl class="grid grid-cols-3 gap-2 text-sm" id="dlgBasics"></dl>
            <div class="mt-3 flex gap-2">
              <button id="editBasicsBtn" class="text-xs px-3 py-1 rounded-md border">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
            </div>
          </div>
          <div class="rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">–ú–∏–Ω–∞–ª–∏ –ø–ª–∞–Ω–æ–≤–µ/–∫—É—Ä—Å–æ–≤–µ</h4>
              <button id="addCompletedBtn" class="text-xs px-3 py-1 rounded-md border">–î–æ–±–∞–≤–∏</button>
            </div>
            <ul id="dlgCompleted" class="list-disc list-inside text-sm"></ul>
          </div>
          <div class="rounded-xl border border-slate-200 p-4 md:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">–û—Ü–µ–Ω–∫–∏ –∏ —Ö–æ—Ä–∞—Ä–∏—É–º</h4>
              <div class="flex gap-2">
                <button id="addGradeBtn" class="text-xs px-3 py-1 rounded-md border">–î–æ–±–∞–≤–∏ –æ—Ü–µ–Ω–∫–∞</button>
                <button id="addHoursBtn" class="text-xs px-3 py-1 rounded-md border">–î–æ–±–∞–≤–∏ —á–∞—Å–æ–≤–µ</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead><tr class="text-left text-slate-500"><th class="py-2 pr-4">–ö—É—Ä—Å/–º–æ–¥—É–ª</th><th class="py-2 pr-4">–û—Ü–µ–Ω–∫–∞</th><th class="py-2 pr-4">–ß–∞—Å–æ–≤–µ</th><th class="py-2 pr-4">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                <tbody id="dlgGrades"></tbody>
              </table>
            </div>
          </div>
          <div class="rounded-xl border border-slate-200 p-4 md:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">–ó–∞–ø–ª–∞—â–∞–Ω–∏—è</h4>
              <div class="flex gap-2">
                <button id="addPaymentBtn" class="text-xs px-3 py-1 rounded-md border">–ù–æ–≤–æ –ø–ª–∞—â–∞–Ω–µ</button>
                <button id="exportPaymentsCSV" class="text-xs px-3 py-1 rounded-md border">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead><tr class="text-left text-slate-500"><th class="py-2 pr-4">–ú–æ–¥—É–ª</th><th class="py-2 pr-4">–°—É–º–∞</th><th class="py-2 pr-4">–°—Ç–∞—Ç—É—Å</th><th class="py-2 pr-4">–î–∞—Ç–∞</th><th class="py-2 pr-4">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                <tbody id="dlgPayments"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="p-4 border-t text-right">
        <form method="dialog"><button class="px-3 py-1 rounded-md border">–ó–∞—Ç–≤–æ—Ä–∏</button></form>
      </div>
    </dialog>

    <!-- –î–∏–∞–ª–æ–∑–∏ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ/—Ä–µ–¥–∞–∫—Ü–∏—è -->
    <dialog id="gradeDialog" class="rounded-xl p-0 w-full max-w-md">
      <form method="dialog">
        <div class="p-4 border-b flex items-center justify-between"><h4 class="font-semibold">–û—Ü–µ–Ω–∫–∞</h4><button value="cancel" class="text-slate-500">‚úï</button></div>
      </form>
      <div class="p-4 grid gap-2">
        <input id="gdCourse" class="rounded-lg border-slate-200" placeholder="–ö—É—Ä—Å/–º–æ–¥—É–ª" />
        <input id="gdScore" class="rounded-lg border-slate-200" placeholder="–û—Ü–µ–Ω–∫–∞ (–Ω–∞–ø—Ä. 6.00 / 92%)" />
        <input id="gdHours" type="number" class="rounded-lg border-slate-200" placeholder="–ß–∞—Å–æ–≤–µ (–ø–æ –∏–∑–±–æ—Ä)" />
        <div class="text-right"><button id="gdSave" class="px-3 py-2 rounded-lg bg-brand-600 text-white">–ó–∞–ø–∞–∑–∏</button></div>
      </div>
    </dialog>

    <dialog id="hoursDialog" class="rounded-xl p-0 w-full max-w-md">
      <form method="dialog">
        <div class="p-4 border-b flex items-center justify-between"><h4 class="font-semibold">–ß–∞—Å–æ–≤–µ</h4><button value="cancel" class="text-slate-500">‚úï</button></div>
      </form>
      <div class="p-4 grid gap-2">
        <input id="hdCourse" class="rounded-lg border-slate-200" placeholder="–ö—É—Ä—Å/–º–æ–¥—É–ª" />
        <input id="hdHours" type="number" class="rounded-lg border-slate-200" placeholder="–ß–∞—Å–æ–≤–µ" />
        <div class="text-right"><button id="hdSave" class="px-3 py-2 rounded-lg bg-brand-600 text-white">–ó–∞–ø–∞–∑–∏</button></div>
      </div>
    </dialog>

    <dialog id="paymentDialog" class="rounded-xl p-0 w-full max-w-md">
      <form method="dialog">
        <div class="p-4 border-b flex items-center justify-between"><h4 class="font-semibold">–ü–ª–∞—â–∞–Ω–µ</h4><button value="cancel" class="text-slate-500">‚úï</button></div>
      </form>
      <div class="p-4 grid gap-2">
        <input id="pdModule" class="rounded-lg border-slate-200" placeholder="–ú–æ–¥—É–ª (–Ω–∞–ø—Ä. –¢–µ–æ—Ä–∏—è ‚Äì –º–æ–¥—É–ª 1)" />
        <input id="pdAmount" type="number" class="rounded-lg border-slate-200" placeholder="–°—É–º–∞ –ª–≤" />
        <select id="pdStatus" class="rounded-lg border-slate-200"><option value="–¥—ä–ª–∂–∏–º–æ">–¥—ä–ª–∂–∏–º–æ</option><option value="–ø–ª–∞—Ç–µ–Ω–æ">–ø–ª–∞—Ç–µ–Ω–æ</option><option value="—á–∞—Å—Ç–∏—á–Ω–æ">—á–∞—Å—Ç–∏—á–Ω–æ</option></select>
        <input id="pdDate" type="date" class="rounded-lg border-slate-200" />
        <div class="text-right"><button id="pdSave" class="px-3 py-2 rounded-lg bg-brand-600 text-white">–ó–∞–ø–∞–∑–∏</button></div>
      </div>
    </dialog>

    <!-- –ê–¥–º–∏–Ω -->
    <section class="tab-pane" id="admin" aria-labelledby="admin-tab">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- –ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–º–∏ / –º–∞—Ç–µ—Ä–∏–∞–ª–∏ -->
        <div class="rounded-2xl bg-white shadow-soft p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold">–ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–º–∏</h3>
            <span class="text-xs text-slate-500">–≤–∏–¥–∏–º–∏ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏ –∫—É—Ä—Å–æ–≤–µ</span>
          </div>
          <form id="uploadForm" class="mt-4 space-y-3">
            <div>
              <label class="text-sm font-medium">–ó–∞–≥–ª–∞–≤–∏–µ</label>
              <input required type="text" id="topicTitle" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–ü—Ä–∏–º–µ—Ä: –õ–∞–≤–∏–Ω–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç ‚Äì –æ—Å–Ω–æ–≤–∏" />
            </div>
            <div>
              <label class="text-sm font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea id="topicDesc" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ"></textarea>
            </div>
            <div>
              <label class="text-sm font-medium">–ó–∞ –∫—É—Ä—Å</label>
              <select id="topicCourse" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500">
                <option value="theory-winter">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</option>
                <option value="practice-summer">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</option>
                <option value="intensive-weekend">–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">–ü—Ä–∏–∫–∞—á–∏ —Ñ–∞–π–ª (–ø–æ –∏–∑–±–æ—Ä)</label>
              <input type="file" id="topicFile" class="mt-1 block w-full text-sm" />
              <p class="text-xs text-slate-500 mt-1">* –ó–∞ —Å–µ–≥–∞ —Å–µ –∑–∞–ø–∞–∑–≤–∞ –ª–æ–∫–∞–ª–Ω–æ (–¥–µ–º–æ). –ú–æ–∂–µ –ª–µ—Å–Ω–æ –¥–∞ —Å–µ –≤—ä—Ä–∂–µ –∫—ä–º Supabase storage.</p>
            </div>
            <button class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–ó–∞–ø–∞–∑–∏ —Ç–µ–º–∞—Ç–∞</button>
          </form>
          <hr class="my-6" />
          <h4 class="font-semibold">–ö–∞—á–µ–Ω–∏ —Ç–µ–º–∏</h4>
          <ul id="topicsList" class="mt-2 text-sm space-y-2"></ul>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫—É—Ä—Å–æ–≤–µ/–¥–∞—Ç–∏/–æ—Ñ–µ—Ä—Ç–∏ -->
        <div class="rounded-2xl bg-white shadow-soft p-6">
          <h3 class="text-xl font-bold">–ö—É—Ä—Å–æ–≤–µ ‚Äì –¥–∞—Ç–∏ –∏ –æ—Ñ–µ—Ä—Ç–∏</h3>
          <form id="courseForm" class="mt-4 grid sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">–ö—É—Ä—Å</label>
              <select id="courseId" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500">
                <option value="theory-winter">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</option>
                <option value="practice-summer">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</option>
                <option value="intensive-weekend">–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">–î–∞—Ç–∏</label>
              <input type="text" id="courseDates" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. 15 –æ–∫—Ç ‚Äì 15 –Ω–æ–µ" />
            </div>
            <div>
              <label class="text-sm font-medium">–ú–µ—Å—Ç–∞</label>
              <input type="number" id="courseSeats" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. 8" />
            </div>
            <div>
              <label class="text-sm font-medium">–¶–µ–Ω–∞ (–ª–≤)</label>
              <input type="number" id="coursePrice" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. 290" />
            </div>
            <div>
              <label class="text-sm font-medium">–°—Ç–∞—Ä–∞ —Ü–µ–Ω–∞ (–ª–≤)</label>
              <input type="number" id="courseOldPrice" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. 350" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">–ë–µ–ª–µ–∂–∫–∞ –∑–∞ –æ—Ñ–µ—Ä—Ç–∞</label>
              <input type="text" id="courseBadge" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–Ω–∞–ø—Ä. –†–∞–Ω–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è –¥–æ 1 –æ–∫—Ç ‚Äì –æ—â–µ -10%" />
            </div>
            <div class="sm:col-span-2">
              <button class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–û–±–Ω–æ–≤–∏ –∫–∞—Ä—Ç–∞—Ç–∞</button>
            </div>
          </form>
          <p class="text-xs text-slate-500 mt-2">* –í—Å–∏—á–∫–∏ –ø—Ä–æ–º–µ–Ω–∏ —Å–µ –ø–∞–∑—è—Ç –≤ <strong>localStorage</strong> –∑–∞ –¥–µ–º–æ. –ú–æ–∂–µ –¥–∞ —Å–µ –≤—ä—Ä–∂–µ –∫—ä–º Supabase —Ç–∞–±–ª–∏—Ü–∏.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm shadow-lg">–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ</div>
  </div>

  <!-- Simple modal for login role selection -->
  <dialog id="loginDialog" class="rounded-xl p-0 w-full max-w-md">
    <form method="dialog">
      <div class="p-5 border-b flex items-center justify-between">
        <h3 class="font-semibold">–í—Ö–æ–¥</h3>
        <button value="cancel" class="text-slate-500">‚úï</button>
      </div>
    </form>
    <div class="p-5 space-y-4">
      <div class="rounded-lg border p-4">
        <h4 class="font-semibold">–ö—É—Ä—Å–∏—Å—Ç</h4>
        <p class="text-sm text-slate-600">–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥ –∑–∞ –¥–æ—Å—Ç—ä–ø, –¥–∞–¥–µ–Ω –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
        <div class="mt-2 flex gap-2">
          <input id="studentAccessCode" class="flex-1 rounded-lg border-slate-200" placeholder="–ö–æ–¥ –∑–∞ –¥–æ—Å—Ç—ä–ø" />
          <button id="studentLoginBtn" class="px-3 py-2 rounded-lg bg-brand-600 text-white">–í—Ö–æ–¥</button>
        </div>
      </div>
      <div class="rounded-lg border p-4">
        <h4 class="font-semibold">–ê–¥–º–∏–Ω</h4>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <input id="adminEmailInput" class="rounded-lg border-slate-200 col-span-2" placeholder="–ò–º–µ–π–ª" />
          <input id="adminTokenInput" class="rounded-lg border-slate-200 col-span-2" placeholder="–ê–¥–º–∏–Ω –∫–ª—é—á" />
          <button id="adminLoginBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white col-span-2">–í—Ö–æ–¥ –∫–∞—Ç–æ –ê–¥–º–∏–Ω</button>
        </div>
      </div>
    </div>
    <div class="p-4 border-t text-right">
      <form method="dialog"><button class="px-3 py-1 rounded-md border">–ó–∞—Ç–≤–æ—Ä–∏</button></form>
    </div>
  </dialog>

  <script>
    // ======= –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ =======
    const ADMIN_TOKEN = '59e62f07-5fab-443f-a0cb-efd988b44b8f';
    const LS = {
      COURSES: 'tmap_courses_cfg',
      TOPICS:  'tmap_topics',
      MYPLAN:  'tmap_myplan',
      RESULTS: 'tmap_results',
      USER:    'tmap_user',
      STUDENTS:'tmap_students'
    };

    // ======= –ü–æ–º–æ—â–Ω–∏ =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const readLS = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
    const writeLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const toast = (msg='–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ') => { const t=$('#toast'); t.firstElementChild.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800); };
    const maskEGN = (egn)=> egn ? `${egn.substring(0,2)}******${egn.substring(8)}` : '';

    // ======= –¢–∞–±–æ–≤–µ =======
    $$('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        $$('.tab-btn').forEach(b=>b.classList.remove('bg-brand-600','text-white'));
        btn.classList.add('bg-brand-600','text-white');
        $$('.tab-pane').forEach(p=>p.classList.remove('active'));
        $('#'+tab).classList.add('active');
      });
    });

    // ======= –î–µ–º–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª =======
    const user = readLS(LS.USER, { email: '–ì–æ—Å—Ç', isAdmin: false, studentId: null });
    $('#userEmail').textContent = user.email;
    if(user.isAdmin) becomeAdmin();
    if(user.studentId) showStudentProfile(user.studentId);

    // ======= –í—Ö–æ–¥/–ò–∑—Ö–æ–¥ =======
    $('#enterBtn').addEventListener('click', ()=> $('#loginDialog').showModal());
    $('#logoutBtn').addEventListener('click', ()=>{
      writeLS(LS.USER, { email:'–ì–æ—Å—Ç', isAdmin:false, studentId:null });
      $('#userEmail').textContent = '–ì–æ—Å—Ç';
      leaveAdmin();
      $('#studentProfile').classList.add('hidden');
      toast('–ò–∑–ª—è–∑–æ—Ö—Ç–µ');
    })

    // –ê–¥–º–∏–Ω –≤—Ö–æ–¥
    $('#adminLoginBtn').addEventListener('click', ()=>{
      const email = $('#adminEmailInput').value || 'admin@tmap.local';
      const token = $('#adminTokenInput').value || '';
      const isAdmin = token === ADMIN_TOKEN;
      if(!isAdmin){ toast('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∞–¥–º–∏–Ω –∫–ª—é—á'); return; }
      writeLS(LS.USER, { email, isAdmin:true, studentId:null });
      $('#userEmail').textContent = email;
      becomeAdmin();
      $('#loginDialog').close();
      toast('–í–ª—è–∑–æ—Ö—Ç–µ –∫–∞—Ç–æ –ê–¥–º–∏–Ω');
    })

    // –ö—É—Ä—Å–∏—Å—Ç –≤—Ö–æ–¥ —Å –∫–æ–¥
    $('#studentLoginBtn').addEventListener('click', ()=>{
      const code = ($('#studentAccessCode').value || '').trim();
      const students = readLS(LS.STUDENTS, []);
      const st = students.find(s=>s.accessCode===code);
      if(!st){ toast('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥'); return; }
      writeLS(LS.USER, { email: st.name, isAdmin:false, studentId: st.id });
      $('#userEmail').textContent = st.name;
      $('#loginDialog').close();
      showStudentProfile(st.id);
      toast('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω');
    })

    function becomeAdmin(){
      $('#adminBadge').classList.remove('hidden');
      $('#adminTabBtn').classList.remove('hidden');
      $('#studentsTabBtn').classList.remove('hidden');
    }
    function leaveAdmin(){
      $('#adminBadge').classList.add('hidden');
      $('#adminTabBtn').classList.add('hidden');
      $('#studentsTabBtn').classList.add('hidden');
    }

    // ======= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∫—É—Ä—Å–æ–≤–µ =======
    const defaultCourses = {
      'theory-winter':   { dates:'15 –æ–∫—Ç ‚Äì 15 –Ω–æ–µ', seats:8,  price:290, old:350, badge:'–†–∞–Ω–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è –¥–æ 1 –æ–∫—Ç ‚Äì –æ—â–µ -10%' },
      'practice-summer': { dates:'10 —é–Ω–∏ ‚Äì 10 —é–ª–∏', seats:12, price:420, old:490, badge:'–ö–æ–º–±–æ —Å –¢–µ–æ—Ä–∏—è: –æ–±—â–æ -15%' },
      'intensive-weekend': { dates:'23‚Äì24 –Ω–æ–µ ¬∑ 30 –Ω–æ–µ‚Äì1 –¥–µ–∫ ¬∑ 7‚Äì8 –¥–µ–∫', seats:5, price:360, old:null, badge:'–ë–æ–Ω—É—Å –∑–∞–ø–∏—Å –æ—Ç –ª–µ–∫—Ü–∏–∏—Ç–µ' }
    };
    const courses = Object.assign({}, defaultCourses, readLS(LS.COURSES, {}));

    function renderCourseCards(){
      $$('#courseCards .course-card').forEach(card=>{
        const id = card.dataset.courseId;
        const cfg = courses[id];
        if(!cfg) return;
        const datesEl = card.querySelector('li:nth-child(1)');
        const seatsEl = card.querySelector('li:nth-child(3) span');
        const priceWrap = card.querySelector('div.mt-4 div');
        const badgeEl = card.lastElementChild;

        datesEl.innerHTML = `üìÖ –î–∞—Ç–∏: ${cfg.dates}`;
        seatsEl.textContent = `${cfg.seats} —Å–≤–æ–±–æ–¥–Ω–∏`;
        priceWrap.innerHTML = `<span class="text-xl font-extrabold">${cfg.price} –ª–≤</span>` + (cfg.old? `<span class=\"ml-2 line-through text-slate-400 text-sm\">${cfg.old} –ª–≤</span>`:'');
        badgeEl.textContent = cfg.badge || '';
      });
    }
    renderCourseCards();

    // ======= –ó–∞–ø–∏—Å –≤ "–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ" =======
    $('#addToMyPlanBtns').addEventListener('click', ()=>{
      const selected = $$('input[data-select-course]:checked').map(ch=>ch.closest('.course-card').dataset.courseId);
      const current = new Set(readLS(LS.MYPLAN, []));
      selected.forEach(id=>current.add(id));
      writeLS(LS.MYPLAN, [...current]);
      renderMyPlan();
      toast('–î–æ–±–∞–≤–µ–Ω–æ –∫—ä–º ‚Äû–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ‚Äú');
    });

    function renderMyPlan(){
      const plan = readLS(LS.MYPLAN, []);
      const map = {
        'theory-winter':   { title:'–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)', color:'from-sky-50', icon:'üìö' },
        'practice-summer': { title:'–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)', color:'from-emerald-50', icon:'üèïÔ∏è' },
        'intensive-weekend': { title:'–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥', color:'from-purple-50', icon:'‚ö°' }
      };
      const wrap = $('#myPlan');
      wrap.innerHTML = '';
      plan.forEach(id=>{
        const m = map[id]; if(!m) return;
        const cfg = courses[id] || {};
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-white shadow-soft border border-slate-100 p-5';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-2xl">${m.icon}</div>
            <button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-remove="${id}">–ü—Ä–µ–º–∞—Ö–Ω–∏</button>
          </div>
          <h4 class="mt-2 font-semibold">${m.title}</h4>
          <p class="text-sm text-slate-600 mt-1">–î–∞—Ç–∏: ${cfg.dates || '-'}</p>
          <div class="mt-3 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-brand-500 rounded-full" style="width:${Math.floor(Math.random()*60+20)}%"></div>
          </div>
        `;
        wrap.appendChild(card);
      });

      $$('button[data-remove]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.remove;
          const plan = readLS(LS.MYPLAN, []).filter(x=>x!==id);
          writeLS(LS.MYPLAN, plan);
          renderMyPlan();
          toast('–ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ');
        })
      })
    }
    renderMyPlan();

    // –ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –æ—Ç —Ç–µ–º–∏ –∑–∞ –º–æ–∏—Ç–µ –∫—É—Ä—Å–æ–≤–µ
    function renderMyMaterials(){
      const topics = readLS(LS.TOPICS, []);
      const my = new Set(readLS(LS.MYPLAN, []));
      const list = $('#myMaterials');
      list.innerHTML = '';
      topics.filter(t=>my.has(t.course)).forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `üìé <span class="font-medium">${t.title}</span> <span class="text-slate-500">(${labelForCourse(t.course)})</span>`;
        list.appendChild(li);
      });
    }

    // ======= –ê–¥–º–∏–Ω: –¢–µ–º–∏ =======
    $('#uploadForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const t = {
        id: crypto.randomUUID(),
        title: $('#topicTitle').value.trim(),
        desc: $('#topicDesc').value.trim(),
        course: $('#topicCourse').value,
        file: $('#topicFile').files[0]?.name || null,
        createdAt: new Date().toISOString()
      };
      const arr = readLS(LS.TOPICS, []);
      arr.unshift(t);
      writeLS(LS.TOPICS, arr);
      e.target.reset();
      renderTopics();
      renderMyMaterials();
      toast('–¢–µ–º–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞');
    });

    function renderTopics(){
      const list = $('#topicsList'); if(!list) return;
      const arr = readLS(LS.TOPICS, []);
      list.innerHTML = '';
      if(arr.length===0){
        list.innerHTML = '<li class="text-slate-500">–ù—è–º–∞ –∫–∞—á–µ–Ω–∏ —Ç–µ–º–∏.</li>';
        return;
      }
      arr.forEach(t=>{
        const li = document.createElement('li');
        li.className = 'p-3 rounded-lg border border-slate-200 hover:bg-slate-50 flex items-start justify-between gap-3';
        li.innerHTML = `
          <div>
            <div class="font-medium">${t.title}</div>
            <div class="text-xs text-slate-500">${labelForCourse(t.course)} ¬∑ ${new Date(t.createdAt).toLocaleString('bg-BG')}</div>
            ${t.desc? `<p class=\"text-sm text-slate-600 mt-1\">${t.desc}</p>`:''}
            ${t.file? `<p class=\"text-xs text-slate-500 mt-1\">–§–∞–π–ª: ${t.file}</p>`:''}
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs px-2 py-1 rounded-md border hover:bg-white" data-topic-edit="${t.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
            <button class="text-xs px-2 py-1 rounded-md border border-red-200 text-red-600 hover:bg-red-50" data-topic-del="${t.id}">–ò–∑—Ç—Ä–∏–π</button>
          </div>
        `;
        list.appendChild(li);
      });

      $$('button[data-topic-del]').forEach(btn=>btn.addEventListener('click', ()=>{
        const id = btn.dataset.topicDel;
        const arr = readLS(LS.TOPICS, []).filter(x=>x.id!==id);
        writeLS(LS.TOPICS, arr);
        renderTopics();
        renderMyMaterials();
        toast('–ò–∑—Ç—Ä–∏—Ç–æ');
      }));

      $$('button[data-topic-edit]').forEach(btn=>btn.addEventListener('click', ()=>{
        const id = btn.dataset.topicEdit;
        const arr = readLS(LS.TOPICS, []);
        const t = arr.find(x=>x.id===id);
        if(!t) return;
        const newTitle = prompt('–ù–æ–≤–æ –∑–∞–≥–ª–∞–≤–∏–µ:', t.title) ?? t.title;
        const newDesc  = prompt('–ù–æ–≤–æ –æ–ø–∏—Å–∞–Ω–∏–µ:', t.desc) ?? t.desc;
        t.title = newTitle.trim();
        t.desc  = newDesc.trim();
        writeLS(LS.TOPICS, arr);
        renderTopics();
        renderMyMaterials();
        toast('–û–±–Ω–æ–≤–µ–Ω–æ');
      }));
    }
    renderTopics();

    // ======= –ê–¥–º–∏–Ω: –ö—É—Ä—Å–æ–≤–µ =======
    $('#courseForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = $('#courseId').value;
      courses[id] = {
        dates: $('#courseDates').value || defaultCourses[id].dates,
        seats: parseInt($('#courseSeats').value || defaultCourses[id].seats, 10),
        price: parseInt($('#coursePrice').value || defaultCourses[id].price, 10),
        old:   $('#courseOldPrice').value ? parseInt($('#courseOldPrice').value, 10) : null,
        badge: $('#courseBadge').value || defaultCourses[id].badge
      };
      writeLS(LS.COURSES, courses);
      renderCourseCards();
      renderMyPlan();
      toast('–ö–∞—Ä—Ç–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞');
      e.target.reset();
    });

    // ======= –†–µ–∑—É–ª—Ç–∞—Ç–∏ (–¥–µ–º–æ) =======
    const defaultResults = [
      { date:'2025-07-02', course:'theory-winter', type:'–¢–µ—Å—Ç', score:'92%' },
      { date:'2025-07-09', course:'theory-winter', type:'–ü—Ä–∏—Å—ä—Å—Ç–≤–∏–µ', score:'OK' },
      { date:'2025-08-18', course:'practice-summer', type:'–ü–æ–ª–µ–≤–æ –∏–∑–ø–∏—Ç–≤–∞–Ω–µ', score:'–ó–∞—á–µ—Ç–µ–Ω–æ' }
    ];
    if(!readLS(LS.RESULTS, null)) writeLS(LS.RESULTS, defaultResults);

    function renderResults(){
      const rows = readLS(LS.RESULTS, []);
      const body = $('#resultsBody');
      body.innerHTML = '';
      const fmt = (d)=> new Date(d + 'T00:00:00').toLocaleDateString('bg-BG');
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${fmt(r.date)}</td>
          <td class="py-2 pr-4">${labelForCourse(r.course)}</td>
          <td class="py-2 pr-4">${r.type}</td>
          <td class="py-2 pr-4">${r.score}</td>
        `;
        body.appendChild(tr);
      });
    }
    renderResults();

    // ======= –ö—É—Ä—Å–∏—Å—Ç–∏ =======
    $('#studentForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const st = {
        id: crypto.randomUUID(),
        name: $('#stName').value.trim(),
        egn: $('#stEGN').value.trim(),
        addr: $('#stAddr').value.trim(),
        qual: $('#stQual').value.trim(),
        completed: ($('#stCompleted').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        grades: [],
        hours: Number($('#stHours').value||0),
        payments: ($('#stFirstPay').value? [{ module:'–ü—ä—Ä–≤–∏ –º–æ–¥—É–ª', amount:Number($('#stFirstPay').value), status:'–¥—ä–ª–∂–∏–º–æ', date:new Date().toISOString().slice(0,10) }] : []),
        accessCode: Math.random().toString(36).slice(2,8).toUpperCase()
      };
      const arr = readLS(LS.STUDENTS, []);
      arr.unshift(st);
      writeLS(LS.STUDENTS, arr);
      e.target.reset();
      renderStudents();

    // ======= –î–µ—Ç–∞–π–ª–∏ –Ω–∞ –∫—É—Ä—Å–∏—Å—Ç (–∞–¥–º–∏–Ω) =======
    let currentDlgStudentId = null;
    function openStudentDetail(id){
      currentDlgStudentId = id;
      const st = readLS(LS.STUDENTS, []).find(s=>s.id===id); if(!st) return;
      $('#dlgStSub').textContent = `${st.name} ¬∑ –ï–ì–ù: ${maskEGN(st.egn)}`;
      // basics
      const basics = [
        ['–ò–º–µ', st.name], ['–ï–ì–ù', maskEGN(st.egn)], ['–ê–¥—Ä–µ—Å', st.addr||'‚Äî'], ['–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è', st.qual||'‚Äî'], ['–ß–∞—Å–æ–≤–µ (–æ–±—â–æ)', String(st.hours||0)], ['–ö–æ–¥ –∑–∞ –¥–æ—Å—Ç—ä–ø', st.accessCode]
      ];
      const basicsDL = $('#dlgBasics'); basicsDL.innerHTML='';
      basics.forEach(([k,v])=>{ basicsDL.insertAdjacentHTML('beforeend', `<dt class="text-slate-500">${k}</dt><dd class="col-span-2">${v}</dd>`); });
      // completed
      const ul = $('#dlgCompleted'); ul.innerHTML='';
      (st.completed?.length? st.completed : ['‚Äî']).forEach(x=> ul.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
      // grades
      const gb = $('#dlgGrades'); gb.innerHTML='';
      (st.grades?.length? st.grades : []).forEach((g,i)=>{
        gb.insertAdjacentHTML('beforeend', `<tr><td class="py-2 pr-4">${g.course}</td><td class="py-2 pr-4">${g.score}</td><td class="py-2 pr-4">${g.hours??'-'}</td><td class="py-2 pr-4"><button class="text-xs px-2 py-1 rounded-md border" data-gedit="${i}">–†–µ–¥.</button> <button class="text-xs px-2 py-1 rounded-md border border-red-200 text-red-600" data-gdel="${i}">–ò–∑—Ç—Ä.</button></td></tr>`);
      });
      if((st.grades?.length||0)===0){ gb.innerHTML = '<tr><td class="py-2 pr-4" colspan="4">‚Äî</td></tr>'; }
      // payments
      const pb = $('#dlgPayments'); pb.innerHTML='';
      (st.payments?.length? st.payments : []).forEach((p,i)=>{
        pb.insertAdjacentHTML('beforeend', `<tr><td class="py-2 pr-4">${p.module}</td><td class="py-2 pr-4">${p.amount} –ª–≤</td><td class="py-2 pr-4">${p.status}</td><td class="py-2 pr-4">${p.date}</td><td class="py-2 pr-4"><button class="text-xs px-2 py-1 rounded-md border" data-pedit="${i}">–†–µ–¥.</button> <button class="text-xs px-2 py-1 rounded-md border border-red-200 text-red-600" data-pdel="${i}">–ò–∑—Ç—Ä.</button></td></tr>`);
      });
      if((st.payments?.length||0)===0){ pb.innerHTML = '<tr><td class="py-2 pr-4" colspan="5">‚Äî</td></tr>'; }

      $('#studentDetailDialog').showModal();

      // wire row actions
      $$('[data-gdel]')?.forEach(b=> b.addEventListener('click', ()=>{ const idx=Number(b.dataset.gdel); const data=readLS(LS.STUDENTS, []); const s=data.find(x=>x.id===currentDlgStudentId); if(!s) return; s.grades.splice(idx,1); writeLS(LS.STUDENTS,data); openStudentDetail(currentDlgStudentId); toast('–ò–∑—Ç—Ä–∏—Ç–æ'); }));
      $$('[data-gedit]')?.forEach(b=> b.addEventListener('click', ()=>{ const idx=Number(b.dataset.gedit); const data=readLS(LS.STUDENTS, []); const s=data.find(x=>x.id===currentDlgStudentId); if(!s) return; const g=s.grades[idx]; $('#gdCourse').value=g.course; $('#gdScore').value=g.score; $('#gdHours').value=g.hours??''; $('#gradeDialog').showModal(); $('#gdSave').onclick=()=>{ g.course=$('#gdCourse').value.trim(); g.score=$('#gdScore').value.trim(); g.hours=Number($('#gdHours').value||0)||null; writeLS(LS.STUDENTS,data); document.getElementById('gradeDialog').close(); openStudentDetail(currentDlgStudentId); toast('–û–±–Ω–æ–≤–µ–Ω–æ'); }; }));
      $$('[data-pdel]')?.forEach(b=> b.addEventListener('click', ()=>{ const idx=Number(b.dataset.pdel); const data=readLS(LS.STUDENTS, []); const s=data.find(x=>x.id===currentDlgStudentId); if(!s) return; s.payments.splice(idx,1); writeLS(LS.STUDENTS,data); openStudentDetail(currentDlgStudentId); toast('–ò–∑—Ç—Ä–∏—Ç–æ'); }));
      $$('[data-pedit]')?.forEach(b=> b.addEventListener('click', ()=>{ const idx=Number(b.dataset.pedit); const data=readLS(LS.STUDENTS, []); const s=data.find(x=>x.id===currentDlgStudentId); if(!s) return; const p=s.payments[idx]; $('#pdModule').value=p.module; $('#pdAmount').value=p.amount; $('#pdStatus').value=p.status; $('#pdDate').value=p.date; $('#paymentDialog').showModal(); $('#pdSave').onclick=()=>{ p.module=$('#pdModule').value.trim(); p.amount=Number($('#pdAmount').value||0); p.status=$('#pdStatus').value; p.date=$('#pdDate').value||new Date().toISOString().slice(0,10); writeLS(LS.STUDENTS,data); document.getElementById('paymentDialog').close(); openStudentDetail(currentDlgStudentId); toast('–û–±–Ω–æ–≤–µ–Ω–æ'); }; }));
    }

    // –±—É—Ç–æ–Ω–∏ –≤ –¥–∏–∞–ª–æ–≥–∞
    $('#addCompletedBtn')?.addEventListener('click', ()=>{ const x=prompt('–î–æ–±–∞–≤–∏ –∑–∞–≤—ä—Ä—à–µ–Ω –∫—É—Ä—Å/–ø–ª–∞–Ω:'); if(!x) return; const data=readLS(LS.STUDENTS, []); const s=data.find(y=>y.id===currentDlgStudentId); if(!s) return; (s.completed ||= []).push(x.trim()); writeLS(LS.STUDENTS,data); openStudentDetail(currentDlgStudentId); toast('–î–æ–±–∞–≤–µ–Ω–æ'); });
    $('#editBasicsBtn')?.addEventListener('click', ()=>{ const data=readLS(LS.STUDENTS, []); const s=data.find(y=>y.id===currentDlgStudentId); if(!s) return; const name=prompt('–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è:', s.name) ?? s.name; const addr=prompt('–ê–¥—Ä–µ—Å:', s.addr) ?? s.addr; const qual=prompt('–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è:', s.qual) ?? s.qual; s.name=name.trim(); s.addr=addr.trim(); s.qual=qual.trim(); writeLS(LS.STUDENTS,data); openStudentDetail(currentDlgStudentId); toast('–û–±–Ω–æ–≤–µ–Ω–æ'); });

    $('#addGradeBtn')?.addEventListener('click', ()=>{ $('#gdCourse').value=''; $('#gdScore').value=''; $('#gdHours').value=''; $('#gradeDialog').showModal(); $('#gdSave').onclick=()=>{ const data=readLS(LS.STUDENTS, []); const s=data.find(y=>y.id===currentDlgStudentId); if(!s) return; (s.grades ||= []).push({ course: $('#gdCourse').value.trim(), score: $('#gdScore').value.trim(), hours: Number($('#gdHours').value||0)||null }); writeLS(LS.STUDENTS,data); document.getElementById('gradeDialog').close(); openStudentDetail(currentDlgStudentId); toast('–ó–∞–ø–∏—Å–∞–Ω–æ'); } });

    $('#addHoursBtn')?.addEventListener('click', ()=>{ $('#hdCourse').value=''; $('#hdHours').value=''; $('#hoursDialog').showModal(); $('#hdSave').onclick=()=>{ const data=readLS(LS.STUDENTS, []); const s=data.find(y=>y.id===currentDlgStudentId); if(!s) return; const h=Number($('#hdHours').value||0); (s.grades ||= []).push({ course: $('#hdCourse').value.trim()||'‚Äî', score: '', hours: h }); s.hours = (Number(s.hours||0) + h); writeLS(LS.STUDENTS,data); document.getElementById('hoursDialog').close(); openStudentDetail(currentDlgStudentId); toast('–ß–∞—Å–æ–≤–µ –¥–æ–±–∞–≤–µ–Ω–∏'); } });

    $('#addPaymentBtn')?.addEventListener('click', ()=>{ $('#pdModule').value=''; $('#pdAmount').value=''; $('#pdStatus').value='–¥—ä–ª–∂–∏–º–æ'; $('#pdDate').value=new Date().toISOString().slice(0,10); $('#paymentDialog').showModal(); $('#pdSave').onclick=()=>{ const data=readLS(LS.STUDENTS, []); const s=data.find(y=>y.id===currentDlgStudentId); if(!s) return; (s.payments ||= []).push({ module: $('#pdModule').value.trim(), amount: Number($('#pdAmount').value||0), status: $('#pdStatus').value, date: $('#pdDate').value||new Date().toISOString().slice(0,10) }); writeLS(LS.STUDENTS,data); document.getElementById('paymentDialog').close(); openStudentDetail(currentDlgStudentId); toast('–ü–ª–∞—â–∞–Ω–µ—Ç–æ –µ –¥–æ–±–∞–≤–µ–Ω–æ'); } });

    $('#exportPaymentsCSV')?.addEventListener('click', ()=>{ const s=readLS(LS.STUDENTS, []).find(y=>y.id===currentDlgStudentId); if(!s) return; const rows = [['–ú–æ–¥—É–ª','–°—É–º–∞','–°—Ç–∞—Ç—É—Å','–î–∞—Ç–∞'], ... (s.payments||[]).map(p=>[p.module,p.amount,p.status,p.date])]; const csv = rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('
'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`payments_${s.name.replaceAll(' ','_')}.csv`; a.click(); URL.revokeObjectURL(url); });

    document.getElementById('printProfileBtn')?.addEventListener('click', ()=>{ const s=readLS(LS.STUDENTS, []).find(y=>y.id===currentDlgStudentId); if(!s) return; const w=window.open('','','width=800,height=900'); const html = `<!doctype html><html><head><meta charset='utf-8'><title>–ü—Ä–æ—Ñ–∏–ª ${s.name}</title><style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px} h1{font-size:20px;margin:0 0 8px} table{border-collapse:collapse;width:100%;margin:12px 0} td,th{border:1px solid #ddd;padding:6px;font-size:12px;text-align:left} .small{color:#666;font-size:12px}</style></head><body>
      <h1>–ü—Ä–æ—Ñ–∏–ª –Ω–∞ –∫—É—Ä—Å–∏—Å—Ç ‚Äî ${s.name}</h1>
      <div class='small'>–ï–ì–ù: ${maskEGN(s.egn)} ¬∑ –ê–¥—Ä–µ—Å: ${s.addr||'‚Äî'} ¬∑ –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: ${s.qual||'‚Äî'} ¬∑ –ß–∞—Å–æ–≤–µ (–æ–±—â–æ): ${s.hours||0}</div>
      <h2>–ú–∏–Ω–∞–ª–∏ –ø–ª–∞–Ω–æ–≤–µ/–∫—É—Ä—Å–æ–≤–µ</h2>
      <ul>${(s.completed||[]).map(x=>`<li>${x}</li>`).join('')||'<li>‚Äî</li>'}</ul>
      <h2>–û—Ü–µ–Ω–∫–∏ –∏ —Ö–æ—Ä–∞—Ä–∏—É–º</h2>
      <table><thead><tr><th>–ö—É—Ä—Å/–º–æ–¥—É–ª</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–ß–∞—Å–æ–≤–µ</th></tr></thead><tbody>${(s.grades||[]).map(g=>`<tr><td>${g.course}</td><td>${g.score||''}</td><td>${g.hours??''}</td></tr>`).join('')||'<tr><td colspan=3>‚Äî</td></tr>'}</tbody></table>
      <h2>–ó–∞–ø–ª–∞—â–∞–Ω–∏—è</h2>
      <table><thead><tr><th>–ú–æ–¥—É–ª</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>${(s.payments||[]).map(p=>`<tr><td>${p.module}</td><td>${p.amount}</td><td>${p.status}</td><td>${p.date}</td></tr>`).join('')||'<tr><td colspan=4>‚Äî</td></tr>'}</tbody></table>
      <script>window.onload=()=>window.print()<\/script>
    </body></html>`; w.document.write(html); w.document.close(); });

    // –î–æ–±–∞–≤–∏ –±—É—Ç–æ–Ω–∏ "–î–µ—Ç–∞–π–ª–∏" –∫—ä–º —Å–ø–∏—Å—ä–∫–∞ —Å –∫—É—Ä—Å–∏—Å—Ç–∏
    function addDetailButtons(){
      $$('#studentsList > li').forEach(li=>{
        if(li.querySelector('[data-detail]')) return;
        const toolbar = li.querySelector('.flex.items-center.justify-between.gap-3 > div + div');
        if(!toolbar) return;
        const id = (function(){ const txt = li.querySelector('button[data-edit]')?.getAttribute('data-edit'); return txt; })();
        if(!id) return;
        const btn = document.createElement('button'); btn.className='text-xs px-2 py-1 rounded-md border'; btn.dataset.detail=id; btn.textContent='–î–µ—Ç–∞–π–ª–∏';
        toolbar.prepend(btn);
        btn.addEventListener('click', ()=> openStudentDetail(id));
      });
    }
    // –∏–∑–≤–∏–∫–∞–π —Å–ª–µ–¥ –≤—Å—è–∫–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞–Ω–µ
    addDetailButtons();
      toast('–ö—É—Ä—Å–∏—Å—Ç—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω');
    });

    function renderStudents(){
      const list = $('#studentsList'); if(!list) return;
      const q = ($('#stSearch')?.value||'').toLowerCase();
      const arr = readLS(LS.STUDENTS, []);
      list.innerHTML = '';
      arr.filter(s=> !q || s.name.toLowerCase().includes(q) || s.egn.includes(q)).forEach(s=>{
        const li = document.createElement('li');
        li.className = 'p-3 rounded-lg border border-slate-200 hover:bg-slate-50';
        li.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-medium">${s.name}</div>
              <div class="text-xs text-slate-500">–ï–ì–ù: ${s.egn} ¬∑ –ö–æ–¥: <span class="font-mono">${s.accessCode}</span></div>
              <div class="text-xs text-slate-500">–ê–¥—Ä–µ—Å: ${s.addr || '‚Äî'} ¬∑ –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: ${s.qual || '‚Äî'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="text-xs px-2 py-1 rounded-md border" data-copy="${s.accessCode}">–ö–æ–ø–∏—Ä–∞–π –∫–æ–¥</button>
              <button class="text-xs px-2 py-1 rounded-md border" data-edit="${s.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
              <button class="text-xs px-2 py-1 rounded-md border border-red-200 text-red-600" data-del="${s.id}">–ò–∑—Ç—Ä–∏–π</button>
            </div>
          </div>`;
        list.appendChild(li);
      });

      $$('button[data-copy]')?.forEach(b=> b.addEventListener('click', async ()=>{
        await navigator.clipboard.writeText(b.dataset.copy);
        toast('–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω');
      }));

      $$('button[data-del]')?.forEach(b=> b.addEventListener('click', ()=>{
        const id = b.dataset.del;
        const arr = readLS(LS.STUDENTS, []).filter(x=>x.id!==id);
        writeLS(LS.STUDENTS, arr);
        renderStudents();
        toast('–ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç');
      }));

      $$('button[data-edit]')?.forEach(b=> b.addEventListener('click', ()=>{
        const id = b.dataset.edit;
        const arr = readLS(LS.STUDENTS, []);
        const s = arr.find(x=>x.id===id); if(!s) return;
        const name = prompt('–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è:', s.name) ?? s.name;
        const addr = prompt('–ê–¥—Ä–µ—Å:', s.addr) ?? s.addr;
        const qual = prompt('–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è:', s.qual) ?? s.qual;
        s.name = name.trim(); s.addr = addr.trim(); s.qual = qual.trim();
        writeLS(LS.STUDENTS, arr);
        renderStudents();
        toast('–û–±–Ω–æ–≤–µ–Ω–æ');
      }));
    }
    renderStudents();

    $('#stSearch')?.addEventListener('input', renderStudents);
    $('#exportStudents')?.addEventListener('click', ()=>{
      const data = readLS(LS.STUDENTS, []);
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='tmap_students.json'; a.click(); URL.revokeObjectURL(url);
    });

    // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª –∑–∞ –ª–æ–≥–Ω–∞—Ç –∫—É—Ä—Å–∏—Å—Ç
    function showStudentProfile(id){
      const st = readLS(LS.STUDENTS, []).find(s=>s.id===id); if(!st) return;
      $('#pfName').textContent = st.name;
      $('#pfEGN').textContent  = maskEGN(st.egn);
      $('#pfAddr').textContent = st.addr || '‚Äî';
      $('#pfQual').textContent = st.qual || '‚Äî';
      const ul = $('#pfCompleted'); ul.innerHTML='';
      (st.completed?.length? st.completed : ['‚Äî']).forEach(x=>{ const li=document.createElement('li'); li.textContent=x; ul.appendChild(li); });
      const gradesBody = $('#pfGrades'); gradesBody.innerHTML='';
      (st.grades?.length? st.grades : []).forEach(g=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2 pr-4">${g.course}</td><td class="py-2 pr-4">${g.score}</td><td class="py-2 pr-4">${g.hours??'-'}</td>`; gradesBody.appendChild(tr);
      });
      if((st.grades?.length||0)===0){ const tr=document.createElement('tr'); tr.innerHTML='<td class="py-2 pr-4" colspan="3">‚Äî</td>'; gradesBody.appendChild(tr); }
      const payBody = $('#pfPayments'); payBody.innerHTML='';
      (st.payments?.length? st.payments : []).forEach(p=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2 pr-4">${p.module}</td><td class="py-2 pr-4">${p.amount} –ª–≤</td><td class="py-2 pr-4">${p.status}</td><td class="py-2 pr-4">${p.date}</td>`; payBody.appendChild(tr);
      });
      if((st.payments?.length||0)===0){ const tr=document.createElement('tr'); tr.innerHTML='<td class="py-2 pr-4" colspan="4">‚Äî</td>'; payBody.appendChild(tr); }
      $('#studentProfile').classList.remove('hidden');
      $('#logoutBtn').classList.remove('hidden');
    }

    // ======= –ü–æ–º–æ—â–Ω–∏ –µ—Ç–∏–∫–µ—Ç–∏ =======
    function labelForCourse(id){
      return id==='theory-winter' ? '–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)'
        : id==='practice-summer' ? '–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)'
        : id==='intensive-weekend' ? '–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥'
        : id;
    }

    window.addEventListener('storage', (e)=>{
      if(e.key===LS.MYPLAN || e.key===LS.TOPICS) renderMyMaterials();
      if(e.key===LS.STUDENTS && readLS(LS.USER, {}).studentId) showStudentProfile(readLS(LS.USER, {}).studentId);
    });
    renderMyMaterials();
  </script>
</body>
</html>
