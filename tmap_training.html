<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ T-MAP</title>
  <meta name="description" content="–û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ T-MAP ‚Äì –¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) –∏ –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)"> 
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üó∫Ô∏è</text></svg>"> 
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eef7ff', 100: '#d9edff', 200: '#b9dbff', 300: '#8fc2ff', 400: '#65a7ff',
              500: '#3a8aff', 600: '#256ee6', 700: '#1e56b4', 800: '#1a4690', 900: '#183b78'
            },
            accent: {
              50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c',800:'#9a3412',900:'#7c2d12'
            }
          },
          boxShadow: { soft: '0 10px 25px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>
  <style>
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    * { scrollbar-width: thin; scrollbar-color: #3a8aff #eef7ff; }
    *::-webkit-scrollbar { height: 8px; width: 8px; }
    *::-webkit-scrollbar-track { background: #eef7ff; }
    *::-webkit-scrollbar-thumb { background-color: #3a8aff; border-radius: 6px; }
    dialog::backdrop { background: rgba(0,0,0,.4); }
  </style>
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body class="bg-gradient-to-b from-brand-50 to-white text-slate-800">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 backdrop-blur border-b border-slate-200/60 bg-white/70">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 grid place-items-center rounded-xl bg-brand-600 text-white shadow-soft">üó∫Ô∏è</div>
          <div>
            <h1 class="font-bold leading-none">–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ <span class="text-brand-700">T-MAP</span></h1>
            <p class="text-xs text-slate-500 -mt-1">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) ¬∑ –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</p>
          </div>
        </div>

        <!-- Right side: Currency + User -->
        <div class="flex items-center gap-4">
          <!-- Currency toggle -->
          <div class="flex items-center gap-2 select-none">
            <span class="text-xs font-medium text-slate-600">BGN</span>
            <button id="currencyToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200">
              <span id="currencyKnob" class="inline-block h-5 w-5 transform rounded-full bg-white translate-x-1 transition"></span>
            </button>
            <span class="text-xs font-medium text-slate-600">EUR</span>
          </div>

          <!-- User box -->
          <div class="flex items-center gap-3">
            <img id="userAvatar" class="hidden h-8 w-8 rounded-full ring-2 ring-white object-cover" alt="avatar" />
            <span id="userEmail" class="text-sm text-slate-600 hidden sm:inline">–ì–æ—Å—Ç</span>
            <span id="adminBadge" class="hidden text-xs font-semibold px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">–ê–¥–º–∏–Ω</span>
            <button id="btnSignIn" class="text-xs sm:text-sm px-3 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700 transition">–í—Ö–æ–¥ —Å Google</button>
            <button id="btnSignOut" class="hidden text-xs px-3 py-2 rounded-lg border hover:bg-slate-50">–ò–∑—Ö–æ–¥</button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="mt-2 border-t border-slate-200/60">
        <ul class="flex flex-wrap gap-2 py-2" role="tablist">
          <li><button data-tab="home" class="tab-btn px-3 py-1.5 rounded-full text-sm bg-brand-600 text-white shadow-soft">–ù–∞—á–∞–ª–æ</button></li>
          <!-- –ü–æ–∫–∞–∑–≤–∞—Ç —Å–µ —Å–∞–º–æ —Å–ª–µ–¥ –≤—Ö–æ–¥ -->
          <li><button data-tab="my" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100 hidden" id="myTabBtn">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</button></li>
          <li><button data-tab="results" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100 hidden" id="resultsTabBtn">–†–µ–∑—É–ª—Ç–∞—Ç–∏</button></li>
          <!-- –°–∞–º–æ –∑–∞ –ê–¥–º–∏–Ω -->
          <li><button data-tab="admin" class="tab-btn px-3 py-1.5 rounded-full text-sm hover:bg-slate-100 hidden" id="adminTabBtn">–ê–¥–º–∏–Ω</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero -->
    <section class="tab-pane active" id="home" aria-labelledby="home-tab">
      <div class="grid lg:grid-cols-3 gap-6 items-stretch">
        <div class="lg:col-span-2">
          <div class="relative overflow-hidden rounded-2xl bg-white shadow-soft p-8">
            <div class="absolute -right-24 -top-24 w-72 h-72 rounded-full bg-brand-100 blur-3xl"></div>
            <div class="relative">
              <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –æ–±—É—á–∏—Ç–µ–ª–Ω–∏—è —Ü–µ–Ω—Ç—ä—Ä <span class="text-brand-700">T-MAP</span></h2>
              <p class="mt-3 text-slate-600">–ü–æ–¥–≥–æ—Ç–≤–µ—Ç–µ —Å–µ –∑–∞ —Å–µ–∑–æ–Ω–∏—Ç–µ —Å –Ω–∞—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–∏: 
                <span class="font-semibold">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</span> –∏ <span class="font-semibold">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</span>. –ì—ä–≤–∫–∞–≤–∏ –≥—Ä–∞—Ñ–∏—Ü–∏, —Ä–µ–∞–ª–Ω–∏ —É–º–µ–Ω–∏—è, –ø–æ–¥–∫—Ä–µ–ø–∞ –æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏.</p>
              <div class="mt-6 flex flex-wrap gap-3">
                <a href="#courses" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–í–∏–∂ –∫—É—Ä—Å–æ–≤–µ—Ç–µ</a>
                <a href="#offers" class="px-4 py-2 rounded-lg bg-accent-500 text-white hover:bg-accent-600">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick info card -->
        <div class="rounded-2xl bg-white shadow-soft p-6">
          <h3 class="font-semibold text-lg">–ë—ä—Ä–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <ul class="mt-3 space-y-2 text-sm text-slate-600">
            <li>‚è±Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: 4‚Äì6 —Å–µ–¥–º–∏—Ü–∏</li>
            <li>üß≠ –§–æ—Ä–º–∞—Ç: –û–Ω–ª–∞–π–Ω + —Ç–µ—Ä–µ–Ω–Ω–∏ –∑–∞–Ω—è—Ç–∏—è</li>
            <li>üéØ –ù–∏–≤–æ: –ù–∞—á–∏–Ω–∞–µ—â–∏ –∏ –Ω–∞–ø—Ä–µ–¥–Ω–∞–ª–∏</li>
            <li>üìú –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–ª–µ–¥ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ</li>
          </ul>
        </div>
      </div>

      <!-- Courses section -->
      <section id="courses" class="mt-10">
        <div class="flex items-end justify-between gap-4">
          <h3 class="text-xl font-bold">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∫—É—Ä—Å–æ–≤–µ</h3>
          <button id="addToMyPlanBtns" class="text-sm px-3 py-2 rounded-lg border border-brand-200 hover:bg-brand-50">–ó–∞–ø–∏—à–∏ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ</button>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="courseCards">
          <!-- –ö–∞—Ä—Ç–∞: –¢–µ–æ—Ä–∏—è (–∑–∏–º–∞) -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="theory-winter">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700">–æ–Ω–ª–∞–π–Ω</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">–ù–∞–≤–∏–≥–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞, –ª–∞–≤–∏–Ω–Ω–∞ –ø—Ä–µ–≤–µ–Ω—Ü–∏—è, –µ–∫–∏–ø–∏—Ä–æ–≤–∫–∞.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: <span data-dates>15 –æ–∫—Ç ‚Äì 15 –Ω–æ–µ</span></li>
                <li>üïí –í–µ—á–µ—Ä–Ω–∏ –∑–∞–Ω—è—Ç–∏—è: –≤—Ç/—á—Ç 19:00</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium" data-seats>8 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold" data-price-bgn="290">290 –ª–≤</span>
                  <span class="ml-2 line-through text-slate-400 text-sm" data-old-bgn="350">350 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-brand-50 to-white p-4 text-xs text-slate-600" data-badge>üéÅ –†–∞–Ω–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è –¥–æ 1 –æ–∫—Ç–æ–º–≤—Ä–∏: –æ—â–µ <span class="font-semibold">-10%</span></div>
          </article>

          <!-- –ö–∞—Ä—Ç–∞: –ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ) -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="practice-summer">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">–Ω–∞ —Ç–µ—Ä–µ–Ω</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">–ú–∞—Ä—à—Ä—É—Ç–∏, —Ä–∞–±–æ—Ç–∞ —Å GPS/GPX, –±–∏–≤–∞–∫—É–≤–∞–Ω–µ, –ø—ä—Ä–≤–∞ –ø–æ–º–æ—â –Ω–∞ —Ç–µ—Ä–µ–Ω.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: <span data-dates>10 —é–Ω–∏ ‚Äì 10 —é–ª–∏</span></li>
                <li>üìç –õ–æ–∫–∞—Ü–∏–∏: –†–∏–ª–∞ ¬∑ –ü–∏—Ä–∏–Ω ¬∑ –°—Ç–∞—Ä–∞ –ø–ª–∞–Ω–∏–Ω–∞</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium" data-seats>12 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold" data-price-bgn="420">420 –ª–≤</span>
                  <span class="ml-2 line-through text-slate-400 text-sm" data-old-bgn="490">490 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-emerald-50 to-white p-4 text-xs text-slate-600" data-badge>üåû –ö–æ–º–±–æ —Å –¢–µ–æ—Ä–∏—è: –æ–±—â–æ <span class="font-semibold">-15%</span></div>
          </article>

          <!-- –ö–∞—Ä—Ç–∞: –ò–Ω—Ç–µ–Ω–∑–∏–≤ -->
          <article class="course-card group rounded-2xl bg-white shadow-soft overflow-hidden border border-slate-100" data-course-id="intensive-weekend">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-lg">–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">—Å–º–µ—Å–µ–Ω–æ</span>
              </div>
              <p class="mt-2 text-sm text-slate-600">2 —É–∏–∫–µ–Ω–¥–∞ —Ç–µ–æ—Ä–∏—è + 1 —É–∏–∫–µ–Ω–¥ –ø—Ä–∞–∫—Ç–∏–∫–∞. –ó–∞ –∑–∞–µ—Ç–∏ —Ö–æ—Ä–∞.</p>
              <ul class="mt-3 text-sm text-slate-600 space-y-1">
                <li>üìÖ –î–∞—Ç–∏: <span data-dates>23‚Äì24 –Ω–æ–µ ¬∑ 30 –Ω–æ–µ‚Äì1 –¥–µ–∫ ¬∑ 7‚Äì8 –¥–µ–∫</span></li>
                <li>üïí –ß–∞—Å–æ–≤–µ: 10:00‚Äì16:00</li>
                <li>üë• –ú–µ—Å—Ç–∞: <span class="font-medium" data-seats>5 —Å–≤–æ–±–æ–¥–Ω–∏</span></li>
              </ul>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <span class="text-xl font-extrabold" data-price-bgn="360">360 –ª–≤</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" class="size-4" data-select-course>
                  –ò–∑–±–æ—Ä
                </label>
              </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-white p-4 text-xs text-slate-600" data-badge>‚ö° –°–ø–µ—Ü–∏–∞–ª–Ω–æ –∑–∞–µ—Ç–∏: –±–æ–Ω—É—Å –∑–∞–ø–∏—Å –æ—Ç –ª–µ–∫—Ü–∏–∏—Ç–µ</div>
          </article>
        </div>
      </section>

      <!-- Offers -->
      <section id="offers" class="mt-10">
        <h3 class="text-xl font-bold">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</h3>
        <div class="mt-4 grid md:grid-cols-3 gap-6">
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–†–∞–Ω–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ</div>
            <div class="text-3xl font-extrabold mt-1">-10%</div>
            <p class="mt-2 text-sm text-slate-600">–ó–∞ –∑–∞–ø–∏—Å –¥–æ 1 –æ–∫—Ç–æ–º–≤—Ä–∏</p>
          </div>
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–ö–æ–º–±–æ –ø–∞–∫–µ—Ç</div>
            <div class="text-3xl font-extrabold mt-1">-15%</div>
            <p class="mt-2 text-sm text-slate-600">–¢–µ–æ—Ä–∏—è + –ü—Ä–∞–∫—Ç–∏–∫–∞</p>
          </div>
          <div class="rounded-2xl bg-white shadow-soft p-6 border border-slate-100">
            <div class="text-sm text-slate-500">–ì—Ä—É–ø–∏ 3+</div>
            <div class="text-3xl font-extrabold mt-1">-10%</</div>
            <p class="mt-2 text-sm text-slate-600">–ó–∞ –≥—Ä—É–ø–æ–≤–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è</p>
          </div>
        </div>
      </section>
    </section>

    <!-- –ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ -->
    <section class="tab-pane" id="my" aria-labelledby="my-tab">
      <div class="rounded-2xl bg-white shadow-soft p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</h3>
        </div>
        <p class="mt-2 text-slate-600 text-sm">–¢—É–∫ –≤–∏–∂–¥–∞—Ç–µ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ –∫—É—Ä—Å–æ–≤–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏.</p>

        <div id="studentProfile" class="mt-4 grid md:grid-cols-2 gap-6 hidden">
          <div class="rounded-xl border border-slate-200 p-5">
            <h4 class="font-semibold mb-3">–ü—Ä–æ—Ñ–∏–ª</h4>
            <dl class="grid grid-cols-3 gap-2 text-sm">
              <dt class="text-slate-500">–ò–º–µ</dt><dd class="col-span-2" id="pfName">‚Äî</dd>
              <dt class="text-slate-500">–ò–º–µ–π–ª</dt><dd class="col-span-2" id="pfEmail">‚Äî</dd>
            </dl>
          </div>
          <div class="rounded-xl border border-slate-200 p-5 md:col-span-2">
            <h4 class="font-semibold mb-3">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏</h4>
            <ul id="myMaterials" class="mt-2 text-sm text-brand-700 list-disc list-inside"></ul>
          </div>
        </div>

        <div id="myPlan" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </section>

    <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏ -->
    <section class="tab-pane" id="results" aria-labelledby="results-tab">
      <div class="rounded-2xl bg-white shadow-soft p-6">
        <h3 class="text-xl font-bold">–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
        <p class="mt-2 text-slate-600 text-sm">–í–∞—à–∏—Ç–µ –∏–∑–ø–∏—Ç–∏ –∏ –ø—Ä–∏—Å—ä—Å—Ç–≤–∏—è (–¥–µ–º–æ).</p>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">–î–∞—Ç–∞</th>
                <th class="py-2 pr-4">–ö—É—Ä—Å</th>
                <th class="py-2 pr-4">–¢–∏–ø</th>
                <th class="py-2 pr-4">–†–µ–∑—É–ª—Ç–∞—Ç</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –ê–¥–º–∏–Ω -->
    <section class="tab-pane" id="admin" aria-labelledby="admin-tab">
      <div class="rounded-2xl bg-white shadow-soft p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">–ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–º–∞ (Supabase)</h3>
          <span class="text-xs text-slate-500">—Ç–∞–±–ª–∏—Ü–∞: <code>training_topics</code></span>
        </div>
        <form id="uploadForm" class="mt-4 grid gap-3">
          <div>
            <label class="text-sm font-medium">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input required type="text" id="topicTitle" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" placeholder="–ü—Ä–∏–º–µ—Ä: –õ–∞–≤–∏–Ω–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç ‚Äì –æ—Å–Ω–æ–≤–∏" />
          </div>
          <div>
            <label class="text-sm font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="topicDesc" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ"></textarea>
          </div>
          <div>
            <label class="text-sm font-medium">–°–µ–∑–æ–Ω</label>
            <select id="topicSeason" class="mt-1 w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500">
              <option value="winter">–ó–∏–º–∞ (–¢–µ–æ—Ä–∏—è)</option>
              <option value="summer">–õ—è—Ç–æ (–ü—Ä–∞–∫—Ç–∏–∫–∞)</option>
            </select>
          </div>
          <button class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">–ó–∞–ø–∞–∑–∏ —Ç–µ–º–∞—Ç–∞</button>
        </form>
        <div id="topicMsg" class="mt-3 text-sm"></div>
        <hr class="my-6" />
        <h4 class="font-semibold">–ü–æ—Å–ª–µ–¥–Ω–æ –¥–æ–±–∞–≤–µ–Ω–∏ —Ç–µ–º–∏</h4>
        <ul id="topicsList" class="mt-2 text-sm space-y-2"></ul>
        <p class="text-xs text-slate-500 mt-3">–ê–∫–æ –ª–∏–ø—Å–≤–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞, —Å—ä–∑–¥–∞–π —è —Å—ä—Å:<br>
        <code>id uuid (pk, default uuid_generate_v4()), title text, description text, season text, created_by text, created_at timestamptz default now()</code></p>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm shadow-lg">–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ</div>
  </div>

  <script>
    // ======= –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ =======
    const ADMIN_USER_ID = '59e62f07-5fab-443f-a0cb-efd988b44b8f'; // –ê–¥–º–∏–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Supabase user.id)
    // –í–ê–ñ–ù–û: Google Client ID/Secret —Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞—Ç –≤ Supabase ‚Üí Providers ‚Üí Google.
    const SUPABASE_URL = "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, detectSessionInUrl: true }
    });

    const LS = { COURSES:'tmap_courses_cfg', MYPLAN:'tmap_myplan', RESULTS:'tmap_results' };

    // ======= –ü–æ–º–æ—â–Ω–∏ =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const readLS = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
    const writeLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const toast = (msg='–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ') => { const t=$('#toast'); t.firstElementChild.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800); };

    // ======= –¢–∞–±–æ–≤–µ =======
    $$('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        $$('.tab-btn').forEach(b=>b.classList.remove('bg-brand-600','text-white'));
        btn.classList.add('bg-brand-600','text-white');
        $$('.tab-pane').forEach(p=>p.classList.remove('active'));
        $('#'+tab).classList.add('active');
      });
    });

    function showTab(key){
      $$('.tab-pane').forEach(p=>p.classList.remove('active'));
      $('#'+key).classList.add('active');
      $$('.tab-btn').forEach(b=>b.classList.remove('bg-brand-600','text-white'));
      document.querySelector(`.tab-btn[data-tab="${key}"]`)?.classList.add('bg-brand-600','text-white');
    }

    // ======= –í–∞–ª—É—Ç–µ–Ω –ø—Ä–µ–≤–∫–ª—é—á–≤–∞—Ç–µ–ª =======
    const EUR_RATE = 1.95583;
    let showEUR = false;
    const currencyToggle = $('#currencyToggle');
    const currencyKnob = $('#currencyKnob');
    function fmtPrice(bgn){ return showEUR ? ('‚Ç¨ ' + (bgn/EUR_RATE).toFixed(2)) : (Number(bgn).toFixed(2)+' –ª–≤'); }
    function refreshPrices(){
      $$('[data-price-bgn]').forEach(el=>{ const bgn = parseFloat(el.getAttribute('data-price-bgn')); el.textContent = fmtPrice(bgn); });
      $$('[data-old-bgn]').forEach(el=>{ const bgn = parseFloat(el.getAttribute('data-old-bgn')); if(!isNaN(bgn)) el.textContent = fmtPrice(bgn); });
    }
    currencyToggle.addEventListener('click', ()=>{ showEUR=!showEUR; currencyKnob.style.transform = showEUR ? 'translateX(22px)' : 'translateX(4px)'; refreshPrices(); });

    // ======= –ö—É—Ä—Å–æ–≤–µ (–¥–µ–º–æ/localStorage) =======
    const defaultCourses = {
      'theory-winter':     { dates:'15 –æ–∫—Ç ‚Äì 15 –Ω–æ–µ', seats:8,  price:290, old:350, badge:'–†–∞–Ω–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è –¥–æ 1 –æ–∫—Ç ‚Äì –æ—â–µ -10%' },
      'practice-summer':   { dates:'10 —é–Ω–∏ ‚Äì 10 —é–ª–∏', seats:12, price:420, old:490, badge:'–ö–æ–º–±–æ —Å –¢–µ–æ—Ä–∏—è: –æ–±—â–æ -15%' },
      'intensive-weekend': { dates:'23‚Äì24 –Ω–æ–µ ¬∑ 30 –Ω–æ–µ‚Äì1 –¥–µ–∫ ¬∑ 7‚Äì8 –¥–µ–∫', seats:5, price:360, old:null, badge:'–ë–æ–Ω—É—Å –∑–∞–ø–∏—Å –æ—Ç –ª–µ–∫—Ü–∏–∏—Ç–µ' }
    };
    const courses = Object.assign({}, defaultCourses, readLS(LS.COURSES, {}));
    function renderCourseCards(){
      $$('#courseCards .course-card').forEach(card=>{
        const id = card.dataset.courseId;
        const cfg = courses[id]; if(!cfg) return;
        card.querySelector('[data-dates]').textContent = cfg.dates;
        card.querySelector('[data-seats]').textContent = `${cfg.seats} —Å–≤–æ–±–æ–¥–Ω–∏`;
        const priceEl = card.querySelector('[data-price-bgn]'); priceEl.setAttribute('data-price-bgn', cfg.price);
        const oldEl = card.querySelector('[data-old-bgn]');
        if(oldEl){ if(cfg.old){ oldEl.setAttribute('data-old-bgn', cfg.old); oldEl.classList.remove('hidden'); } else { oldEl.classList.add('hidden'); } }
        card.querySelector('[data-badge]').textContent = cfg.badge || '';
      });
      refreshPrices();
    }
    renderCourseCards();

    // ======= –ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ (–¥–µ–º–æ) =======
    $('#addToMyPlanBtns').addEventListener('click', ()=>{
      const selected = $$('input[data-select-course]:checked').map(ch=>ch.closest('.course-card').dataset.courseId);
      const current = new Set(readLS(LS.MYPLAN, []));
      selected.forEach(id=>current.add(id));
      writeLS(LS.MYPLAN, [...current]);
      renderMyPlan();
      toast('–î–æ–±–∞–≤–µ–Ω–æ –∫—ä–º ‚Äû–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ‚Äú');
      showTab('my');
    });

    function labelForCourse(id){
      return id==='theory-winter' ? '–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)' : id==='practice-summer' ? '–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)' : id==='intensive-weekend' ? '–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥' : id;
    }
    function courseSeason(id){ return (id==='theory-winter') ? 'winter' : 'summer'; }

    function renderMyPlan(){
      const plan = readLS(LS.MYPLAN, []);
      const map = {
        'theory-winter':   { title:'–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)', icon:'üìö' },
        'practice-summer': { title:'–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)', icon:'üèïÔ∏è' },
        'intensive-weekend': { title:'–ò–Ω—Ç–µ–Ω–∑–∏–≤ ‚Äì —É–∏–∫–µ–Ω–¥', icon:'‚ö°' }
      };
      const wrap = $('#myPlan'); wrap.innerHTML = '';
      plan.forEach(id=>{
        const m = map[id]; if(!m) return; const cfg = courses[id] || {};
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-white shadow-soft border border-slate-100 p-5';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-2xl">${m.icon}</div>
            <button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-remove="${id}">–ü—Ä–µ–º–∞—Ö–Ω–∏</button>
          </div>
          <h4 class="mt-2 font-semibold">${m.title}</h4>
          <p class="text-sm text-slate-600 mt-1">–î–∞—Ç–∏: ${cfg.dates || '-'}</p>
          <div class="mt-3 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-brand-500 rounded-full" style="width:${Math.floor(Math.random()*60+20)}%"></div>
          </div>`;
        wrap.appendChild(card);
      });
      $$('button[data-remove]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ const id = btn.dataset.remove; const plan = readLS(LS.MYPLAN, []).filter(x=>x!==id); writeLS(LS.MYPLAN, plan); renderMyPlan(); toast('–ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ'); });
      });
      loadMyMaterialsFromSupabase();
    }
    renderMyPlan();

    // ======= –†–µ–∑—É–ª—Ç–∞—Ç–∏ (–¥–µ–º–æ) =======
    const defaultResults = [
      { date:'2025-07-02', course:'theory-winter', type:'–¢–µ—Å—Ç', score:'92%' },
      { date:'2025-07-09', course:'theory-winter', type:'–ü—Ä–∏—Å—ä—Å—Ç–≤–∏–µ', score:'OK' },
      { date:'2025-08-18', course:'practice-summer', type:'–ü–æ–ª–µ–≤–æ –∏–∑–ø–∏—Ç–≤–∞–Ω–µ', score:'–ó–∞—á–µ—Ç–µ–Ω–æ' }
    ];
    if(!readLS(LS.RESULTS, null)) writeLS(LS.RESULTS, defaultResults);
    function renderResults(){
      const rows = readLS(LS.RESULTS, []), body = $('#resultsBody'); body.innerHTML = '';
      const fmt = (d)=> new Date(d + 'T00:00:00').toLocaleDateString('bg-BG');
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-2 pr-4">${fmt(r.date)}</td><td class="py-2 pr-4">${labelForCourse(r.course)}</td><td class="py-2 pr-4">${r.type}</td><td class="py-2 pr-4">${r.score}</td>`;
        body.appendChild(tr);
      });
    }
    renderResults();

    // ======= AUTH (Supabase Google OAuth) =======
    const userEmailEl   = $('#userEmail');
    const userAvatarEl  = $('#userAvatar');
    const adminBadge    = $('#adminBadge');
    const btnSignIn     = $('#btnSignIn');
    const btnSignOut    = $('#btnSignOut');
    const myTabBtn      = $('#myTabBtn');
    const resultsTabBtn = $('#resultsTabBtn');
    const adminTabBtn   = $('#adminTabBtn');

    async function updateAuthUI(){
      const { data: { user } } = await supabaseClient.auth.getUser();

      if(user){
        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ —Å–ª–µ–¥ –≤—Ö–æ–¥
        btnSignIn.classList.add('hidden');
        btnSignOut.classList.remove('hidden');
        myTabBtn.classList.remove('hidden');
        resultsTabBtn.classList.remove('hidden');

        userEmailEl.textContent = user.email || '‚Äî';
        userAvatarEl.src = user.user_metadata?.avatar_url || `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(user.email||'T')}`;
        userAvatarEl.classList.remove('hidden');

        $('#pfName').textContent = user.user_metadata?.full_name || (user.email?.split('@')[0]) || '‚Äî';
        $('#pfEmail').textContent = user.email || '‚Äî';
        $('#studentProfile').classList.remove('hidden');

        const isAdmin = (user.id === ADMIN_USER_ID);
        if(isAdmin){
          adminBadge.classList.remove('hidden');
          adminTabBtn.classList.remove('hidden');
        }else{
          adminBadge.classList.add('hidden');
          adminTabBtn.classList.add('hidden');
          if($('#admin').classList.contains('active')) showTab('home');
        }
      }else{
        // –ë–µ–∑ –≤—Ö–æ–¥ ‚Äì –ø–æ–∫–∞–∑–≤–∞–º–µ —Å–∞–º–æ ‚Äû–ù–∞—á–∞–ª–æ‚Äú
        btnSignIn.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        userEmailEl.textContent = '–ì–æ—Å—Ç';
        userAvatarEl.classList.add('hidden');
        adminBadge.classList.add('hidden');
        myTabBtn.classList.add('hidden');
        resultsTabBtn.classList.add('hidden');
        adminTabBtn.classList.add('hidden');
        if(!$('#home').classList.contains('active')) showTab('home');
        $('#studentProfile').classList.add('hidden');
      }
    }

    btnSignIn.addEventListener('click', async ()=>{
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href,
          // –ü–æ –∏–∑–±–æ—Ä: –∏–∑–∏—Å–∫–∞–π –ø—Ä–æ—Ñ–∏–ª/–∏–º–µ–π–ª –∞–∫–æ –∏—Å–∫–∞—à —Ä–∞–∑—à–∏—Ä–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞
          scopes: 'openid email profile'
        }
      });
      if(error){ alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥: ' + (error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞')); }
    });

    btnSignOut.addEventListener('click', async ()=>{
      await supabaseClient.auth.signOut();
      await updateAuthUI();
      toast('–ò–∑–ª—è–∑–æ—Ö—Ç–µ');
    });

    updateAuthUI();
    supabaseClient.auth.onAuthStateChange((_ev,_sess)=>updateAuthUI());

    // ======= –ê–¥–º–∏–Ω: –¢–µ–º–∏ (Supabase: training_topics) =======
    const topicForm  = $('#uploadForm');
    const topicMsg   = $('#topicMsg');
    const topicsList = $('#topicsList');

    topicForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      topicMsg.textContent = '';
      const title = $('#topicTitle').value.trim();
      const description = $('#topicDesc').value.trim();
      const season = $('#topicSeason').value;

      const { data: { user } } = await supabaseClient.auth.getUser();
      if(!user){ topicMsg.className='mt-3 text-sm text-rose-700'; topicMsg.textContent = '–ù—É–∂–µ–Ω –µ –≤—Ö–æ–¥ —Å Google.'; return; }

      const payload = { title, description, season, created_by: user.email || user.id, created_at: new Date().toISOString() };
      const { data, error } = await supabaseClient.from('training_topics').insert(payload).select().single();

      if(error){
        topicMsg.className='mt-3 text-sm text-rose-700';
        topicMsg.textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + error.message +
          ' ‚Ä¢ –°—ä–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü–∞ training_topics —Å—ä—Å schema: id uuid (pk, default uuid_generate_v4()), title text, description text, season text, created_by text, created_at timestamptz default now().';
        return;
      }
      topicMsg.className='mt-3 text-sm text-emerald-700';
      topicMsg.textContent = '–¢–µ–º–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ.';
      topicForm.reset();
      prependTopicItem(data);
    });

    function prependTopicItem(row){
      const li = document.createElement('li');
      li.className = 'p-3 rounded-lg border border-slate-200 hover:bg-slate-50';
      li.innerHTML = `
        <div class="font-medium">${escapeHtml(row.title)}</div>
        <div class="text-xs text-slate-500">${row.season==='winter'?'–ó–∏–º–∞ (–¢–µ–æ—Ä–∏—è)':'–õ—è—Ç–æ (–ü—Ä–∞–∫—Ç–∏–∫–∞)'} ¬∑ ${new Date(row.created_at||Date.now()).toLocaleString('bg-BG')}</div>
        ${row.description? `<p class="text-sm text-slate-600 mt-1">${escapeHtml(row.description)}</p>`:''}
        <div class="text-xs text-slate-400 mt-1">–î–æ–±–∞–≤–µ–Ω–∞ –æ—Ç: ${escapeHtml(row.created_by||'–∞–¥–º–∏–Ω')}</div>`;
      topicsList.prepend(li);
    }
    function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    async function loadRecentTopics(){
      const { data, error } = await supabaseClient.from('training_topics').select('*').order('created_at', { ascending:false }).limit(10);
      topicsList.innerHTML = '';
      if(error){ topicsList.innerHTML = '<li class="text-slate-500">–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ. –£–≤–µ—Ä–∏ —Å–µ, —á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ —Ç–∞–±–ª–∏—Ü–∞ training_topics.</li>'; return; }
      if(!data || data.length===0){ topicsList.innerHTML = '<li class="text-slate-500">–ù—è–º–∞ –∫–∞—á–µ–Ω–∏ —Ç–µ–º–∏.</li>'; return; }
      data.forEach(prependTopicItem);
    }
    loadRecentTopics();

    // ======= –ú–∞—Ç–µ—Ä–∏–∞–ª–∏ —Å–ø–æ—Ä–µ–¥ –º–æ–∏—Ç–µ –∫—É—Ä—Å–æ–≤–µ (–ø–æ season) =======
    async function loadMyMaterialsFromSupabase(){
      const my = new Set(readLS(LS.MYPLAN, []));
      const list = $('#myMaterials');
      if(my.size===0){ if(list) list.innerHTML='<li>‚Äî</li>'; return; }
      const seasons = new Set([...my].map(courseSeason));
      let q = supabaseClient.from('training_topics').select('*').order('created_at', {ascending:false}).limit(50);
      if(seasons.size===1){ q = supabaseClient.from('training_topics').select('*').eq('season', [...seasons][0]).order('created_at',{ascending:false}).limit(50); }
      const { data, error } = await q;
      if(!list) return;
      list.innerHTML = '';
      if(error){ list.innerHTML = '<li class="text-rose-600">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏.</li>'; return; }
      if(!data || data.length===0){ list.innerHTML = '<li>‚Äî</li>'; return; }
      data.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `üìé <span class="font-medium">${escapeHtml(t.title)}</span> <span class="text-slate-500">(${t.season==='winter'?'–¢–µ–æ—Ä–∏—è (–∑–∏–º–∞)':'–ü—Ä–∞–∫—Ç–∏–∫–∞ (–ª—è—Ç–æ)'})</span>`;
        list.appendChild(li);
      });
    }

    // ======= –ê–¥–º–∏–Ω: –ö—É—Ä—Å–æ–≤–µ (–¥–µ–º–æ/localStorage) =======
    $('#courseForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = $('#courseId').value;
      const updated = {
        dates: $('#courseDates').value || defaultCourses[id].dates,
        seats: parseInt($('#courseSeats').value || defaultCourses[id].seats, 10),
        price: parseInt($('#coursePrice').value || defaultCourses[id].price, 10),
        old:   $('#courseOldPrice').value ? parseInt($('#courseOldPrice').value, 10) : null,
        badge: $('#courseBadge').value || defaultCourses[id].badge
      };
      Object.assign(courses[id], updated);
      writeLS(LS.COURSES, courses);
      renderCourseCards();
      renderMyPlan();
      toast('–ö–∞—Ä—Ç–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞');
      e.target.reset();
    });

    // ======= –ù–∞–≤–∏–≥–∞—Ü–∏—è/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =======
    window.addEventListener('storage', (e)=>{ if(e.key===LS.MYPLAN) loadMyMaterialsFromSupabase(); });
    loadMyMaterialsFromSupabase();
  </script>
</body>
</html>
