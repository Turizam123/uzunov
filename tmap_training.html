<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T‚ÄëMAP Academy ‚Äî –û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <meta name="theme-color" content="#0ea5e9" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background: rgba(255,255,255,0.88); backdrop-filter: saturate(140%) blur(8px); border:1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.06); }
    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:10px 16px; font-weight:600; transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active { transform: scale(.98); }
    .btn-primary { background:#0369a1; color:#fff; box-shadow:0 8px 20px rgba(2,132,199,.25); }
    .btn-primary:hover { background:#075985; }
    .btn-ghost { background:#fff; color:#0f172a; border:1px solid #e2e8f0; }
    .btn-ghost:hover { background:#f8fafc; }
    .chip { display:inline-flex; align-items:center; border-radius:999px; border:1px solid #cbd5e1; padding:2px 10px; font-size:12px; font-weight:600; background:#fff; color:#334155; }
    .tab-btn{padding:10px 14px;border-radius:10px;font-weight:600;color:#334155}
    .tab-btn.active{background:#0ea5e9;color:#fff;box-shadow:0 6px 16px rgba(14,165,233,.22)}
    .hero-wrap{ position:relative; overflow:hidden; border-radius:20px; }
    .hero-bg{ position:absolute; inset:0; background-position:center; background-size:cover; transform:scale(1.02); }
    .hero-overlay{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,.55) 0%, rgba(2,6,23,.35) 40%, rgba(2,6,23,.55) 100%); }
    .hero-content{ position:relative; z-index:1; color:#fff; padding:56px 24px; }
  </style>
  <!-- Supabase JS v2 -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="min-h-full bg-gradient-to-br from-sky-50 via-white to-emerald-50 text-slate-800">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="#" class="h-9 w-9 rounded-xl bg-sky-600 text-white grid place-items-center font-black">T</a>
      <div class="flex-1 leading-tight">
        <h1 class="text-lg font-bold">T‚ÄëMAP Academy ‚Ä¢ –û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
        <p class="text-xs text-slate-600">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Ä¢ –ë–∏–≤–∞–∫ ‚Ä¢ –ü—Ä–µ—Ö–æ–¥–∏ ‚Ä¢ –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ ‚Ä¢ –ê–ª–ø–∏–Ω–∏–∑—ä–º ‚Ä¢ –ü—Ä–∏—Ä–æ–¥–∞</p>
      </div>
      <div id="userArea" class="flex items-center gap-3"></div>
    </div>
    <!-- Tabs (—Å–ª–µ–¥ –≤—Ö–æ–¥) -->
    <nav id="tabs" class="hidden border-t border-slate-200 bg-white/70 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4">
        <ul class="flex items-center gap-1 py-2">
          <li><button data-tab="home" class="tab-btn active">–ù–∞—á–∞–ª–æ</button></li>
          <li><button data-tab="catalog" class="tab-btn">–ö–∞—Ç–∞–ª–æ–≥</button></li>
          <li><button data-tab="learning" class="tab-btn">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</button></li>
          <li><button data-tab="results" class="tab-btn">–†–µ–∑—É–ª—Ç–∞—Ç–∏</button></li>
          <li id="adminTab" class="hidden"><button data-tab="admin" class="tab-btn">–ê–¥–º–∏–Ω</button></li>
        </ul>
      </div>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <!-- HERO (–∑–∞ –≥–æ—Å—Ç–∏) -->
    <section id="hero" class="hero-wrap">
      <div class="hero-bg" style="background-image:url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop');"></div>
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <div class="max-w-6xl mx-auto">
          <div class="grid lg:grid-cols-2 gap-8 items-center">
            <div>
              <div class="inline-flex items-center gap-2 mb-3"><span class="chip bg-white/90">T‚ÄëMAP Academy</span><span class="chip bg-white/90">–ù–æ–≤–æ</span></div>
              <h2 class="text-4xl lg:text-5xl font-extrabold leading-tight">–£—á–∏. –¢–µ—Å—Ç–≤–∞–π —Å–µ. –ò–∑–ª–∏–∑–∞–π –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞ –ø–æ‚Äë–ø–æ–¥–≥–æ—Ç–≤–µ–Ω.</h2>
              <p class="mt-3 text-white/90 text-lg">–ö—É—Ä—Å–æ–≤–µ –ø–æ –æ—Ü–µ–ª—è–≤–∞–Ω–µ, –±–∏–≤–∞–∫—É–≤–∞–Ω–µ, –∑–∏–º–Ω–∞ —Ç–µ–æ—Ä–∏—è, –ª–µ—Ç–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—ä—Ç–µ–∫–∏ ‚Äî –≤ –µ–¥–∏–Ω –º–æ–¥—É–ª.</p>
              <div class="mt-6 flex flex-wrap gap-3">
                <button id="btnGoogle" class="btn btn-primary">–í—Ö–æ–¥ —Å Google</button>
                <a href="#homePane" class="btn btn-ghost">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –¥–∞—Ç–∏</a>
              </div>
              <p class="mt-3 text-xs text-white/80">–° –≤–ª–∏–∑–∞–Ω–µ—Ç–æ –ø—Ä–∏–µ–º–∞—à <a class="underline" target="_blank" href="https://turistibg.weebly.com/1055105610401042104810511040.html">–û–±—â–∏—Ç–µ —É—Å–ª–æ–≤–∏—è</a>.</p>
            </div>
            <div class="hidden lg:block">
              <div class="grid grid-cols-2 gap-4">
                <div class="card p-4 bg-white/80">
                  <div class="text-slate-500 text-sm">12‚Äì13 –æ–∫—Ç 2025</div>
                  <h4 class="font-semibold">–ü—Ä–µ—Ö–æ–¥–∏ –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞ ‚Äî –†–∏–ª–∞</h4>
                  <p class="text-slate-600 text-sm mt-1">–û—Ä–∏–µ–Ω—Ç–∏—Ä–∞–Ω–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p>
                </div>
                <div class="card p-4 bg-white/80">
                  <div class="text-slate-500 text-sm">26‚Äì27 –æ–∫—Ç 2025</div>
                  <h4 class="font-semibold">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Äî –æ—Å–Ω–æ–≤–∏ (–æ–Ω–ª–∞–π–Ω)</h4>
                  <p class="text-slate-600 text-sm mt-1">–ó–∏–º–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ —Ä–∏—Å–∫–æ–≤–µ.</p>
                </div>
                <div class="col-span-2 card p-4 bg-gradient-to-r from-sky-600/90 to-emerald-500/90 text-white">
                  <div class="flex items-center justify-between">
                    <h4 class="font-semibold">–°–µ–∑–æ–Ω–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏</h4>
                    <span class="chip bg-white text-slate-800">-20% / -15%</span>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-4 mt-2 text-sm">
                    <div class="card p-4 bg-white/10 border-white/10">
                      <div class="font-bold">–¢–µ–æ—Ä–∏—è ‚Äî –ó–∏–º–∞</div>
                      <div class="opacity-90">3 –º–æ–¥—É–ª–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ª–∞–≤–∏–Ω–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è</div>
                      <div class="mt-2"><span class="line-through opacity-80 mr-2">250 –ª–≤</span><span class="font-bold">200 –ª–≤</span></div>
                    </div>
                    <div class="card p-4 bg-white/10 border-white/10">
                      <div class="font-bold">–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –õ—è—Ç–æ</div>
                      <div class="opacity-90">2 —É–∏–∫–µ–Ω–¥–∞: –±–∏–≤–∞–∫, –º–∞—Ä—à—Ä—É—Ç–∏, –µ–∫–∏–ø–Ω–∞ —Ä–∞–±–æ—Ç–∞</div>
                      <div class="mt-2"><span class="line-through opacity-80 mr-2">360 –ª–≤</span><span class="font-bold">306 –ª–≤</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME pane (—Å–ª–µ–¥ –≤—Ö–æ–¥) -->
    <section id="homePane" class="hidden space-y-8">
      <section id="upcoming">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-xl font-bold">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∫—É—Ä—Å–æ–≤–µ</h3>
          <span class="chip">–¥–µ–º–æ</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <article class="card p-4"><div class="flex items-center justify-between"><div class="text-sm text-slate-500">12‚Äì13 –æ–∫—Ç 2025</div><span class="chip">–ü—Ä–∞–∫—Ç–∏–∫–∞</span></div><h4 class="font-semibold mt-1">–ü—Ä–µ—Ö–æ–¥–∏ ‚Äî –†–∏–ª–∞</h4><p class="text-sm text-slate-600 mt-1">–ú–∞—Ä—à—Ä—É—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p></article>
          <article class="card p-4"><div class="flex items-center justify-between"><div class="text-sm text-slate-500">26‚Äì27 –æ–∫—Ç 2025</div><span class="chip">–¢–µ–æ—Ä–∏—è</span></div><h4 class="font-semibold mt-1">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Äî –æ—Å–Ω–æ–≤–∏</h4><p class="text-sm text-slate-600 mt-1">–ó–∏–º–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞.</p></article>
          <article class="card p-4"><div class="flex items-center justify-between"><div class="text-sm text-slate-500">09‚Äì10 –Ω–æ–µ 2025</div><span class="chip">–ü—Ä–∞–∫—Ç–∏–∫–∞</span></div><h4 class="font-semibold mt-1">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—ä—Ç–µ–∫–∏</h4><p class="text-sm text-slate-600 mt-1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p></article>
          <article class="card p-4"><div class="flex items-center justify-between"><div class="text-sm text-slate-500">23‚Äì24 –Ω–æ–µ 2025</div><span class="chip">–¢–µ–æ—Ä–∏—è</span></div><h4 class="font-semibold mt-1">–í—ä–≤–µ–¥–µ–Ω–∏–µ –≤ –∞–ª–ø–∏–Ω–∏–∑–º–∞</h4><p class="text-sm text-slate-600 mt-1">–í—ä–∑–ª–∏ –∏ —Ç–∞–∫—Ç–∏–∫–∞.</p></article>
        </div>
      </section>
      <section id="offers">
        <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-bold">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</h3><span class="chip">—Å–µ–∑–æ–Ω–Ω–∏</span></div>
        <div class="grid md:grid-cols-2 gap-4">
          <article class="card overflow-hidden"><div class="p-5"><div class="flex items-center justify-between"><h4 class="font-semibold">–ü—Ä–æ–≥—Ä–∞–º–∞ ‚Äû–¢–µ–æ—Ä–∏—è ‚Äî –ó–∏–º–∞‚Äú</h4><span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 text-xs px-2 py-0.5">-20%</span></div><p class="mt-1 text-sm text-slate-600">3 –æ–Ω–ª–∞–π–Ω –º–æ–¥—É–ª–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ª–∞–≤–∏–Ω–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è.</p><div class="mt-3 flex items-center justify-between text-sm"><div><span class="line-through text-slate-400 mr-2">250 –ª–≤</span><span class="font-bold">200 –ª–≤</span></div><button class="btn btn-primary text-sm" id="ctaOfferWinter">–í–∑–µ–º–∏ –æ—Ñ–µ—Ä—Ç–∞—Ç–∞</button></div></div></article>
          <article class="card overflow-hidden"><div class="p-5"><div class="flex items-center justify-between"><h4 class="font-semibold">–ü—Ä–æ–≥—Ä–∞–º–∞ ‚Äû–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –õ—è—Ç–æ‚Äú</h4><span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5">-15%</span></div><p class="mt-1 text-sm text-slate-600">2 —É–∏–∫–µ–Ω–¥ –∏–∑–ª–∏–∑–∞–Ω–∏—è: –±–∏–≤–∞–∫, –º–∞—Ä—à—Ä—É—Ç–∏, –µ–∫–∏–ø–Ω–∞ —Ä–∞–±–æ—Ç–∞.</p><div class="mt-3 flex items-center justify-between text-sm"><div><span class="line-through text-slate-400 mr-2">360 –ª–≤</span><span class="font-bold">306 –ª–≤</span></div><button class="btn btn-primary text-sm" id="ctaOfferSummer">–í–∑–µ–º–∏ –æ—Ñ–µ—Ä—Ç–∞—Ç–∞</button></div></div></article>
        </div>
        <p class="text-xs text-slate-500 mt-2">* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –¥–∞—Ç–∏/—Ü–µ–Ω–∏ ‚Äî —â–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞—Ç –æ—Ç –±–∞–∑–∞.</p>
      </section>
    </section>

    <!-- CATALOG pane -->
    <section id="catalogPane" class="hidden space-y-6">
      <div class="card p-5 space-y-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-xl font-bold">–ö–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤–µ</h2>
          <div class="flex flex-wrap gap-2">
            <select id="filterCategory" class="border rounded-xl px-3 py-2 text-sm"><option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
            <input id="searchCourse" placeholder="–¢—ä—Ä—Å–∏ –∫—É—Ä—Å‚Ä¶" class="border rounded-xl px-3 py-2 text-sm w-64" />
          </div>
        </div>
        <div id="courseList" class="grid sm:grid-cols-2 gap-4"></div>
        <div id="emptyCourses" class="hidden text-sm text-slate-500">–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –∫—É—Ä—Å–æ–≤–µ.</div>
      </div>
    </section>

    <!-- LEARNING pane -->
    <section id="learningPane" class="hidden grid md:grid-cols-3 gap-6">
      <aside class="md:col-span-2 card p-5">
        <h3 class="font-bold mb-2">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</h3>
        <ul id="myEnrollments" class="space-y-3 text-sm"></ul>
      </aside>
      <aside class="card p-5">
        <h3 class="font-bold mb-2">–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
        <ul id="myResults" class="space-y-3 text-sm"></ul>
      </aside>
    </section>

    <!-- RESULTS pane -->
    <section id="resultsPane" class="hidden card p-5">
      <h3 class="font-bold mb-2">–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
      <ul id="myResultsDup" class="space-y-3 text-sm"></ul>
    </section>

    <!-- ADMIN pane -->
    <section id="adminPane" class="hidden card p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">–ê–¥–º–∏–Ω: –ö—É—Ä—Å–æ–≤–µ & –ü–ª–∞—â–∞–Ω–∏—è</h2>
        <span class="chip" id="adminBadge">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
      </div>
      <div class="grid md:grid-cols-2 gap-6 mt-4">
        <div>
          <h3 class="font-semibold mb-2">–ù–æ–≤–∏ –ø–ª–∞—â–∞–Ω–∏—è</h3>
          <ul id="adminPayments" class="space-y-2 text-sm"></ul>
        </div>
        <div>
          <h3 class="font-semibold mb-2">–ó–∞–ø–∏—Å–∞–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h3>
          <ul id="adminEnrollments" class="space-y-2 text-sm"></ul>
        </div>
      </div>
    </section>

    <!-- QUIZ panel (inline) -->
    <section id="quizView" class="card p-5 hidden">
      <div class="flex items-center justify-between gap-3">
        <h3 id="quizTitle" class="text-lg font-bold">–¢–µ—Å—Ç</h3>
        <button id="btnExitQuiz" class="btn btn-ghost">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="quizMeta" class="text-sm text-slate-600"></div>
      <ol id="quizQuestions" class="mt-4 space-y-4 list-decimal list-inside"></ol>
      <div class="mt-4 flex items-center gap-3">
        <button id="btnSubmitQuiz" class="btn btn-primary">–ü—Ä–µ–¥–∞–π —Ç–µ—Å—Ç</button>
        <div id="quizMsg" class="text-sm text-slate-600"></div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-xs text-slate-500">
    ¬© <span id="year"></span> –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è—Ç ‚Ä¢ T‚ÄëMAP
  </footer>

  <!-- Lessons Modal -->
  <div id="lessonsModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-40">
    <div class="absolute inset-0" id="lessonsModalBg"></div>
    <div class="absolute left-1/2 top-10 -translate-x-1/2 w-[min(100%-24px,980px)]">
      <div class="card overflow-hidden">
        <div class="p-4 flex items-center justify-between">
          <h3 class="text-lg font-bold">–£—Ä–æ—Ü–∏ –ø–æ –∫—É—Ä—Å–∞</h3>
          <button id="closeLessons" class="btn btn-ghost">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
        <div class="grid md:grid-cols-3 gap-0 border-t border-slate-200">
          <aside class="md:col-span-1 p-4 border-r border-slate-200">
            <ul id="lessonList" class="space-y-2 text-sm"></ul>
            <div id="lessonEmpty" class="text-sm text-slate-500">–ù—è–º–∞ —É—Ä–æ—Ü–∏.</div>
            <div id="lessonAdminBox" class="mt-4 hidden">
              <button id="btnNewLesson" class="btn btn-primary w-full">+ –ù–æ–≤ —É—Ä–æ–∫</button>
            </div>
          </aside>
          <div class="md:col-span-2 p-4">
            <article id="lessonView" class="max-w-none prose prose-slate">
              <p class="text-slate-600 text-sm">–ò–∑–±–µ—Ä–µ—Ç–µ —É—Ä–æ–∫ –æ—Ç–ª—è–≤–æ‚Ä¶</p>
            </article>

            <!-- Admin editor -->
            <div id="lessonEditor" class="hidden mt-4">
              <div class="grid gap-3">
                <input id="le_title" class="border rounded-xl px-3 py-2" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —É—Ä–æ–∫–∞" />
                <div class="grid grid-cols-3 gap-3">
                  <input id="le_order" type="number" class="border rounded-xl px-3 py-2" placeholder="–ü–æ—Ä–µ–¥–Ω–æ—Å—Ç (—á–∏—Å–ª–æ)" />
                  <label class="flex items-center gap-2 text-sm"><input id="le_published" type="checkbox" class="scale-110"> –ü—É–±–ª–∏–∫—É–≤–∞–Ω</label>
                  <button id="le_save" class="btn btn-primary">–ó–∞–ø–∞–∑–∏ —É—Ä–æ–∫</button>
                </div>
                <textarea id="le_md" rows="10" class="border rounded-xl px-3 py-2 font-mono text-sm" placeholder="# –ó–∞–≥–ª–∞–≤–∏–µ\n–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –≤ Markdown‚Ä¶"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden z-50">
    <div class="bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-lg"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Supabase (T‚ÄëMAP –±–∞–∑–∞) ===
    const SUPABASE_URL = 'https://cmiylzpmpwqbacjoqtkx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // –ê–¥–º–∏–Ω –∏–º–µ–π–ª–∏
    const ADMIN_EMAILS = ['uzunov.ange@gmail.com'];

    // === UI refs ===
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    const tabs = document.getElementById('tabs');
    const adminTab = document.getElementById('adminTab');
    const userArea = document.getElementById('userArea');

    const hero = document.getElementById('hero');
    const homePane = document.getElementById('homePane');
    const catalogPane = document.getElementById('catalogPane');
    const learningPane = document.getElementById('learningPane');
    const resultsPane = document.getElementById('resultsPane');
    const adminPane = document.getElementById('adminPane');

    const toastBox = document.getElementById('toast');
    function toast(msg){ toastBox.firstElementChild.textContent = msg; toastBox.classList.remove('hidden'); setTimeout(()=>toastBox.classList.add('hidden'), 2400); }

    // Global guard for runtime errors (–∑–∞ –¥–∞ –Ω—è–º–∞ –±—è–ª –µ–∫—Ä–∞–Ω –±–µ–∑ –æ–±—è—Å–Ω–µ–Ω–∏–µ)
    window.addEventListener('error', (e) => { console.error(e.error || e.message); alert('–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞. –í–∏–∂ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ (F12) –∑–∞ –¥–µ—Ç–∞–π–ª–∏.'); });

    // === Auth (—Å–∞–º–æ Google) ===
    const btnGoogle = document.getElementById('btnGoogle');
    btnGoogle?.addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.href, queryParams: { prompt: 'consent', access_type: 'offline' } }
      });
      if (error) toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥: ' + error.message);
    });

    supabase.auth.onAuthStateChange((_event, session) => { render(session?.user || null); });

    async function ensureProfile(user){
      if(!user) return null;
      const { data, error } = await supabase
        .from('profiles')
        .upsert({ id: user.id, email: user.email, full_name: user.user_metadata?.full_name || null, avatar_url: user.user_metadata?.avatar_url || null }, { onConflict: 'id' })
        .select('*')
        .maybeSingle();
      if (error) console.warn('profiles upsert:', error.message);
      return data;
    }

    async function render(user){
      userArea.innerHTML = '';
      const showTab = (name) => {
        homePane.classList.toggle('hidden', name !== 'home');
        catalogPane.classList.toggle('hidden', name !== 'catalog');
        learningPane.classList.toggle('hidden', name !== 'learning');
        resultsPane.classList.toggle('hidden', name !== 'results');
        adminPane.classList.toggle('hidden', name !== 'admin');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      };

      if (!user){
        tabs.classList.add('hidden');
        hero.classList.remove('hidden');
        showTab('home'); // –ø–æ–∫–∞–∑–≤–∞–º–µ homePane –∑–∞ –ø—Ä–µ–≤—é
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary'; btn.textContent = '–í—Ö–æ–¥'; btn.onclick = ()=>btnGoogle.click();
        userArea.append(btn);
        return;
      }

      await ensureProfile(user);

      const isAdmin = ADMIN_EMAILS.includes(user.email);
      const chip = document.createElement('div'); chip.className='chip';
      chip.innerHTML = `${user.user_metadata?.avatar_url ? `<img src="${user.user_metadata.avatar_url}" class="w-5 h-5 rounded-full mr-2"/>` : ''}<span class="mr-2">${user.email}</span>${isAdmin ? '<span class="ml-1 px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px] font-bold">–ê–¥–º–∏–Ω</span>' : ''}`;
      const outBtn = document.createElement('button'); outBtn.className='btn btn-ghost'; outBtn.textContent='–ò–∑—Ö–æ–¥'; outBtn.onclick=async()=>{ await supabase.auth.signOut(); window.location.reload(); };
      userArea.append(chip, outBtn);

      hero.classList.add('hidden');
      tabs.classList.remove('hidden');
      adminTab.classList.toggle('hidden', !isAdmin);

      showTab('home');

      await Promise.all([
        loadCourses(),
        loadEnrollments(user.id),
        loadResults(user.id)
      ]);
    }

    // Tabs events
    document.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click', async ()=>{
      const name = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
      homePane.classList.toggle('hidden', name !== 'home');
      catalogPane.classList.toggle('hidden', name !== 'catalog');
      learningPane.classList.toggle('hidden', name !== 'learning');
      resultsPane.classList.toggle('hidden', name !== 'results');
      adminPane.classList.toggle('hidden', name !== 'admin');
      if (name === 'catalog' && !document.getElementById('courseList').children.length) await loadCourses();
      if (name === 'results') document.getElementById('myResultsDup').innerHTML = document.getElementById('myResults').innerHTML;
      if (name === 'admin') await loadAdmin();
    }));

    // === –ö—É—Ä—Å –∫–∞—Ç–∞–ª–æ–≥ ===
    let allCourses = [];

    async function loadCourses(){
      const { data, error } = await supabase
        .from('courses')
        .select('id, title, category, level, price_bgn, duration_min, short_description, cover_url, published')
        .eq('published', true)
        .order('created_at', { ascending: false });
      if (error) { console.warn('courses:', error.message); allCourses=[]; }
      else allCourses = data || [];

      const filterCategory = document.getElementById('filterCategory');
      const searchCourse = document.getElementById('searchCourse');
      const courseList = document.getElementById('courseList');
      const emptyCourses = document.getElementById('emptyCourses');

      const cats = Array.from(new Set(allCourses.map(c=>c.category).filter(Boolean)));
      filterCategory.innerHTML = '<option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + cats.map(c=>`<option>${c}</option>`).join('');

      const renderCards = () => {
        const q = (searchCourse.value||'').toLowerCase();
        const cat = filterCategory.value||'';
        const list = allCourses.filter(c=>(!cat || c.category===cat) && (!q || c.title.toLowerCase().includes(q)));
        courseList.innerHTML='';
        if (!list.length){ emptyCourses.classList.remove('hidden'); return; }
        emptyCourses.classList.add('hidden');
        list.forEach(c=>courseList.appendChild(courseCard(c)));
      };
      filterCategory.onchange = renderCards;
      searchCourse.oninput = renderCards;
      renderCards();
    }

    function courseCard(c){
      const el = document.createElement('article'); el.className='card overflow-hidden';
      el.innerHTML = `
        <div class="aspect-[16/9] bg-slate-100" style="background-image:url('${c.cover_url || ''}'); background-size:cover; background-position:center"></div>
        <div class="p-4 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">${c.title}</h3>
            ${c.category ? `<span class="chip">${c.category}</span>` : ''}
          </div>
          <p class="text-sm text-slate-600">${c.short_description || ''}</p>
          <div class="flex flex-wrap items-center gap-3 text-sm text-slate-700">
            ${c.level ? `<span>–ù–∏–≤–æ: <b>${c.level}</b></span>` : ''}
            ${c.duration_min ? `<span>‚è±Ô∏è ${c.duration_min} –º–∏–Ω</span>` : ''}
            ${typeof c.price_bgn === 'number' && Number(c.price_bgn)>0 ? `<span>üí≥ ${Number(c.price_bgn).toFixed(2)} –ª–≤</span>` : '<span class="text-emerald-700">–ë–µ–∑–ø–ª–∞—Ç–µ–Ω</span>'}
          </div>
          <div class="flex gap-2 pt-1">
            <button class="btn btn-primary" data-enroll>–ó–∞–ø–∏—à–∏ —Å–µ</button>
            <button class="btn btn-ghost" data-lessons>–£—Ä–æ—Ü–∏</button>
          </div>
        </div>`;
      el.querySelector('[data-enroll]').onclick = ()=>enrollInCourse(c);
      el.querySelector('[data-lessons]').onclick = ()=>openLessons(c.id);
      return el;
    }

    async function enrollInCourse(course){
      const { data: session } = await supabase.auth.getSession();
      const user = session?.session?.user; if(!user){ toast('–ú–æ–ª—è, –≤–ª–µ–∑ –ø—ä—Ä–≤–æ.'); return; }
      if (!course.price_bgn || Number(course.price_bgn) === 0){
        const { error } = await supabase.from('enrollments').insert({ user_id: user.id, course_id: course.id, status: 'active' });
        if (error) return toast('–ì—Ä–µ—à–∫–∞: ' + error.message);
        await loadEnrollments(user.id); toast('–£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ!'); return;
      }
      toast('–ü–ª–∞—Ç–µ–Ω –∫—É—Ä—Å ‚Äî –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞ —â–µ –±—ä–¥–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∏ —Å–∫–æ—Ä–æ.');
    }

    // === –ú–æ–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è ===
    async function loadEnrollments(userId){
      const myEnrollments = document.getElementById('myEnrollments');
      const { data, error } = await supabase
        .from('enrollments')
        .select('id, status, course:courses(id,title)')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });
      if (error){ console.warn('enrollments:', error.message); return; }
      myEnrollments.innerHTML='';
      (data||[]).forEach(en=>{
        const li = document.createElement('li'); li.className='flex items-center justify-between gap-3';
        li.innerHTML = `
          <span>${en.course?.title || '–ö—É—Ä—Å'} ‚Äî <b>${en.status}</b></span>
          <div class="flex gap-2">
            <button class="btn btn-ghost text-xs" data-learn>–£—Ä–æ—Ü–∏</button>
            <button class="btn btn-primary text-xs" data-quiz>–ò–∑–ø–∏—Ç</button>
          </div>`;
        li.querySelector('[data-quiz]').onclick = ()=>startQuizForCourse(en.course?.id);
        li.querySelector('[data-learn]').onclick = ()=>openLessons(en.course?.id);
        myEnrollments.appendChild(li);
      });
      if (!(data||[]).length) myEnrollments.innerHTML = '<li class="text-slate-500">–ù—è–º–∞—Ç–µ –∞–∫—Ç–∏–≤–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è.</li>';
    }

    // === –†–µ–∑—É–ª—Ç–∞—Ç–∏ ===
    async function loadResults(userId){
      const myResults = document.getElementById('myResults');
      const { data, error } = await supabase
        .from('quiz_attempts')
        .select('id, score_pct, passed, quiz:quizzes(title), created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false }).limit(20);
      if (error){ console.warn('attempts:', error.message); return; }
      myResults.innerHTML='';
      (data||[]).forEach(a=>{
        const li = document.createElement('li');
        li.innerHTML = `<b>${a.quiz?.title || '–¢–µ—Å—Ç'}</b> ‚Äî ${a.score_pct?.toFixed?.(0) ?? 0}% ${a.passed ? '‚úÖ' : '‚ùå'} <span class="text-slate-500">(${new Date(a.created_at).toLocaleString()})</span>`;
        myResults.appendChild(li);
      });
      if (!(data||[]).length) myResults.innerHTML = '<li class="text-slate-500">–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</li>';
    }

    // === –¢–µ—Å—Ç–æ–≤–µ ===
    let currentQuiz = null; let currentAnswers = {};

    async function startQuizForCourse(courseId){
      const { data: quiz, error } = await supabase
        .from('quizzes')
        .select('id, title, time_limit_min, pass_pct')
        .eq('course_id', courseId)
        .eq('published', true)
        .order('created_at', { ascending: true })
        .maybeSingle();
      if (error || !quiz){ toast('–ù—è–º–∞ –Ω–∞–ª–∏—á–µ–Ω —Ç–µ—Å—Ç –∑–∞ —Ç–æ–∑–∏ –∫—É—Ä—Å.'); return; }
      currentQuiz = quiz; currentAnswers = {};
      const { data: questions, error: qErr } = await supabase
        .from('quiz_questions')
        .select('id, question, options:quiz_options(id, text, is_correct)')
        .eq('quiz_id', quiz.id)
        .order('order_idx', { ascending: true });
      if (qErr){ toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏.'); return; }

      document.getElementById('quizTitle').textContent = quiz.title;
      document.getElementById('quizMeta').textContent = `–í—Ä–µ–º–µ: ${quiz.time_limit_min || '‚Äî'} –º–∏–Ω ‚Ä¢ –£—Å–ø–µ—à–µ–Ω –ø—Ä–∞–≥: ${quiz.pass_pct ?? 70}%`;
      const quizQuestions = document.getElementById('quizQuestions'); quizQuestions.innerHTML='';
      (questions||[]).forEach(q=>{
        const li = document.createElement('li'); li.className='space-y-2';
        li.innerHTML = `<div class="font-medium">${q.question}</div>`;
        const opts = document.createElement('div'); opts.className='space-y-1';
        q.options.forEach(op=>{
          const row = document.createElement('label'); row.className='flex items-center gap-2';
          row.innerHTML = `<input type="radio" name="q_${q.id}" class="scale-110"> <span>${op.text}</span>`;
          row.querySelector('input').addEventListener('change', ()=>{ currentAnswers[q.id] = op.id; });
          opts.appendChild(row);
        });
        li.appendChild(opts); quizQuestions.appendChild(li);
      });

      document.getElementById('quizView').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('quizView').offsetTop - 20, behavior: 'smooth' });
    }

    document.getElementById('btnExitQuiz').addEventListener('click', ()=>{
      document.getElementById('quizView').classList.add('hidden');
      document.getElementById('quizQuestions').innerHTML='';
    });

    document.getElementById('btnSubmitQuiz').addEventListener('click', submitQuiz);

    async function submitQuiz(){
      if (!currentQuiz) return;
      const { data: questions } = await supabase
        .from('quiz_questions')
        .select('id, options:quiz_options(id, is_correct)')
        .eq('quiz_id', currentQuiz.id);
      const total = (questions||[]).length; if (!total) return;
      let correct=0; (questions||[]).forEach(q=>{ const chosen=currentAnswers[q.id]; const right=q.options.find(o=>o.is_correct); if (chosen && right && chosen===right.id) correct++; });
      const pct = Math.round((correct/total)*100); const passed = pct >= (currentQuiz.pass_pct ?? 70);
      const { data: session } = await supabase.auth.getSession(); const userId = session?.session?.user?.id; if(!userId){ toast('–°–µ—Å–∏—è—Ç–∞ –µ –∏–∑—Ç–µ–∫–ª–∞.'); return; }
      const { error } = await supabase.from('quiz_attempts').insert({ user_id: userId, quiz_id: currentQuiz.id, score_pct: pct, passed });
      if (error){ toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç.'); return; }
      document.getElementById('quizMsg').textContent = `–†–µ–∑—É–ª—Ç–∞—Ç: ${pct}% ${passed ? '‚Äî –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è! ‚úÖ' : '‚Äî –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ. ‚ùå'}`;
      await loadResults(userId);
    }

    // === –£—Ä–æ—Ü–∏ ===
    async function openLessons(courseId){
      const modal = document.getElementById('lessonsModal');
      const listEl = document.getElementById('lessonList');
      const emptyEl = document.getElementById('lessonEmpty');
      const viewEl = document.getElementById('lessonView');
      const adminBox = document.getElementById('lessonAdminBox');
      const editor = document.getElementById('lessonEditor');
      const isAdmin = ADMIN_EMAILS.includes((await supabase.auth.getUser()).data?.user?.email || '');

      adminBox.classList.toggle('hidden', !isAdmin);
      editor.classList.add('hidden');

      listEl.innerHTML = '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶';
      const { data: lessons, error } = await supabase
        .from('lessons')
        .select('id, course_id, title, content_md, order_idx, published')
        .eq('course_id', courseId)
        .order('order_idx', { ascending: true });
      if (error){ listEl.innerHTML=''; emptyEl.textContent='–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.'; emptyEl.classList.remove('hidden'); }
      else {
        listEl.innerHTML='';
        (lessons||[]).forEach(ls=>{
          const li = document.createElement('li');
          li.innerHTML = `<button class="w-full text-left hover:underline">${ls.title}</button>`;
          li.querySelector('button').addEventListener('click', ()=>{ viewEl.innerHTML = marked.parse(ls.content_md || ''); });
          listEl.appendChild(li);
        });
        emptyEl.classList.toggle('hidden', (lessons||[]).length>0);
        if ((lessons||[])[0]) viewEl.innerHTML = marked.parse(lessons[0].content_md || '');
      }

      const newBtn = document.getElementById('btnNewLesson');
      if (newBtn) newBtn.onclick = () => {
        if (!isAdmin) return;
        editor.classList.remove('hidden');
        document.getElementById('le_title').value='';
        document.getElementById('le_order').value = (listEl.children.length+1).toString();
        document.getElementById('le_published').checked = true;
        document.getElementById('le_md').value = '# –ù–æ–≤ —É—Ä–æ–∫\n–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ...';
        document.getElementById('le_save').onclick = async ()=>{
          const title = document.getElementById('le_title').value.trim();
          const order_idx = Number(document.getElementById('le_order').value||0);
          const published = document.getElementById('le_published').checked;
          const content_md = document.getElementById('le_md').value;
          if (!title) return toast('–í—ä–≤–µ–¥–∏ –∑–∞–≥–ª–∞–≤–∏–µ');
          const { error: insErr } = await supabase.from('lessons').insert({ course_id: courseId, title, content_md, order_idx, published });
          if (insErr) return toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + insErr.message);
          toast('–£—Ä–æ–∫—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω'); openLessons(courseId);
        };
      };

      modal.classList.remove('hidden');
    }

    document.getElementById('lessonsModalBg')?.addEventListener('click', ()=>document.getElementById('lessonsModal').classList.add('hidden'));
    document.getElementById('closeLessons')?.addEventListener('click', ()=>document.getElementById('lessonsModal').classList.add('hidden'));

    // === –ê–¥–º–∏–Ω ===
    async function loadAdmin(){
      const paymentsEl = document.getElementById('adminPayments');
      const enrollsEl = document.getElementById('adminEnrollments');
      paymentsEl.innerHTML = '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶'; enrollsEl.innerHTML = '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶';
      const [pay, enr] = await Promise.all([
        supabase.from('payments').select('id, amount_bgn, status, user_email, course:courses(title)').order('created_at', { ascending: false }).limit(10),
        supabase.from('enrollments').select('id, status, user:profiles(email), course:courses(title)').order('created_at', { ascending: false }).limit(10)
      ]);
      const payments = pay.data || []; const enrolls = enr.data || [];
      paymentsEl.innerHTML = payments.length ? '' : '<li class="text-slate-500">–ù—è–º–∞ –ø–ª–∞—â–∞–Ω–∏—è.</li>';
      payments.forEach(p=>{ const li=document.createElement('li'); li.innerHTML=`${p.user_email || ''} ‚Üí <b>${p.course?.title || '–ö—É—Ä—Å'}</b> ‚Äî ${p.amount_bgn?.toFixed?.(2) ?? '‚Äî'} –ª–≤ ‚Äî <b>${p.status}</b>`; paymentsEl.appendChild(li); });
      enrollsEl.innerHTML = enrolls.length ? '' : '<li class="text-slate-500">–ù—è–º–∞ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è.</li>';
      enrolls.forEach(e=>{ const li=document.createElement('li'); li.innerHTML=`${e.user?.email || ''} ‚Üí <b>${e.course?.title || '–ö—É—Ä—Å'}</b> ‚Äî <b>${e.status}</b>`; enrollsEl.appendChild(li); });
    }

    // === Init ===
    (async ()=>{ const { data } = await supabase.auth.getUser(); render(data?.user || null); })();
  </script>
</body>
</html>
