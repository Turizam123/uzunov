<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#16a34a">
  <title>Заявка – Програма за Планински водачи</title>
  <meta name="description" content="Подай заявка за обучение за планински водачи: онлайн теория, теренни модули, оцеляване и първа помощ, бивакуване, алпинизъм, въжета и Виа Ферата, организиране на преходи." />

  <!-- Fonts & Tailwind (CDN) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon / Logo -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />

  <style>
    :root{ --brand:#16a34a; --brand-2:#22c55e; --ring:#16a34a; }
    html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    .card{ position:relative; border-radius:1rem; border:1px solid rgb(226 232 240); background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.06); transition:all .2s; overflow:hidden; }
    .card:hover{ box-shadow:0 20px 40px rgba(0,0,0,.08); transform:translateY(-2px); }
    .card-head{ display:flex; align-items:flex-start; justify-content:space-between; padding:1.25rem; background:linear-gradient(90deg,#f0fdf4,#dcfce7); }
    .card-title{ font-size:1.125rem; font-weight:800; letter-spacing:-.01em; color:#0f172a; }
    .card-body{ padding:1.25rem; font-size:.925rem; color:#334155; }
    .card-foot{ padding:1.25rem; padding-top:.75rem; display:flex; align-items:center; justify-content:space-between; }
    .chip{ display:inline-flex; align-items:center; border-radius:999px; border:1px solid rgb(226 232 240); padding:.125rem .625rem; font-size:.69rem; font-weight:700; }
    .chip-green{ border-color:#bbf7d0; color:#166534; background:#f0fdf4; }
    .chip-red{ border-color:#fecaca; color:#991b1b; background:#fef2f2; }
    .chip-amber{ border-color:#fde68a; color:#92400e; background:#fffbeb; }
    .chip-blue{ border-color:#bfdbfe; color:#1d4ed8; background:#eff6ff; }
    .chip-purple{ border-color:#e9d5ff; color:#6b21a8; background:#faf5ff; }
    .price-xl{ font-size:1.375rem; font-weight:800; }
    .muted{ font-size:.8rem; color:#64748b; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; border-radius:.875rem; padding:.5rem 1rem; font-weight:700; border:1px solid rgb(226 232 240); background:#fff; color:#334155; transition:all .15s; }
    .btn:focus-visible{ outline:2px solid var(--ring); outline-offset:2px; }
    .btn-primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent; }
    .btn-primary:active{ transform:translateY(1px); }
    .tap-area{ gap:.5rem; padding:.375rem .5rem; border-radius:.75rem; }
    .safe-bottom{ padding-bottom:max(env(safe-area-inset-bottom),1rem); }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:.001ms !important; animation-iteration-count:1 !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- HERO -->
  <header class="relative">
    <div class="absolute inset-0 -z-10 pointer-events-none opacity-25 select-none" aria-hidden="true">
      <svg viewBox="0 0 1440 320" class="w-full h-full" preserveAspectRatio="none">
        <path fill="#16a34a" d="M0,224L48,229.3C96,235,192,245,288,229.3C384,213,480,171,576,170.7C672,171,768,213,864,229.3C960,245,1056,235,1152,197.3C1248,160,1344,96,1392,64L1440,32L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path>
      </svg>
    </div>
    <div class="max-w-7xl mx-auto px-4 pt-10 pb-6 sm:pt-12 sm:pb-8">
      <div class="text-center">
        <!-- Лого + име на центъра -->
        <a href="https://turizam123.github.io/uzunov/tmap_home.html" class="inline-flex items-center gap-3 justify-center">
          <span class="chip chip-green">Обучителен център „Туристически свят“</span>
        </a>

        <h1 class="mt-3 text-3xl sm:text-5xl font-extrabold tracking-tight">
          Заявка за включване – <span class="text-green-700">Планински водачи</span>
        </h1>
        <p class="mt-3 text-slate-600 max-w-3xl mx-auto">
          Избери онлайн и теренни модули. Задължителни: „Онлайн теория“, „Оцеляване & Медицински ситуации“,
          <strong>+ избор</strong> „Лято“ или „Зима“, и „Организиране на мероприятия“.
        </p>

        <!-- Превключване на валута -->
        <div class="mt-6 inline-flex items-center gap-2 rounded-full border bg-white px-2 py-2 shadow-sm" role="group" aria-label="Превключване на валута">
          <span class="text-xs uppercase tracking-wider text-slate-500 pl-2">Валута</span>
          <button id="btnBGN" class="btn px-3 py-1 rounded-full bg-green-600 text-white" aria-pressed="true" type="button">BGN</button>
          <button id="btnEUR" class="btn px-3 py-1 rounded-full text-green-700 hover:bg-green-50" aria-pressed="false" type="button">EUR</button>
          <span class="text-[11px] text-slate-400 pr-2" aria-hidden="true">1 EUR = 1.95583 BGN</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-28 lg:pb-24">
    <div class="grid lg:grid-cols-3 gap-6 lg:gap-8">
      <!-- LEFT: PROGRAMS -->
      <section class="lg:col-span-2">
        <h2 class="text-2xl font-bold">Модули</h2>
        <div class="mt-5 grid sm:grid-cols-2 gap-5" id="modulesGrid">

          <!-- ONLINE THEORY (mandatory) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ОНЛАЙН ОБУЧЕНИЕ – ТЕОРИЯ</h3>
              <div class="flex gap-1">
                <span class="chip chip-green">онлайн</span>
                <span class="chip chip-red">задължителен</span>
              </div>
            </div>
            <div class="card-body">
              <p>Интензивна теоретична подготовка: <strong>6 дни × 4 часа</strong>. Теоретичен изпит след всеки модул.</p>
            </div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="180">180 BGN</span></div>
                <div class="muted">еднократно</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb mandatory accent-green-600 scale-125" data-name="ОНЛАЙН ОБУЧЕНИЕ – ТЕОРИЯ" data-bgn="180" checked disabled>
                <span class="text-sm font-medium">Включен</span>
              </label>
            </div>
          </article>

          <!-- SURVIVAL & MEDICAL (mandatory) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ОЦЕЛЯВАНЕ / МЕДИЦИНСКИ СИТУАЦИИ</h3>
              <div class="flex gap-1">
                <span class="chip chip-amber">терен</span>
                <span class="chip chip-blue">онлайн</span>
                <span class="chip chip-red">задължителен</span>
              </div>
            </div>
            <div class="card-body">
              <ul class="list-disc pl-5 space-y-1">
                <li><strong>Теория:</strong> 2 дни × 4 часа онлайн</li>
                <li><strong>Практика:</strong> изпит на терен – извеждане на контузен; оказване на първа помощ</li>
                <li>Оценка на риска, евакуация, бивак</li>
              </ul>
            </div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="320">320 BGN</span></div>
                <div class="muted">комбиниран модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb mandatory need-insurance accent-green-600 scale-125" data-name="ОЦЕЛЯВАНЕ / МЕДИЦИНСКИ СИТУАЦИИ" data-bgn="320" checked disabled>
                <span class="text-sm font-medium">Включен</span>
              </label>
            </div>
          </article>

          <!-- ORIENTEERING (mandatory) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ОРИЕНТИРАНЕ (компас, карта, GPS)</h3>
              <div class="flex gap-1">
                <span class="chip chip-blue">теория</span>
                <span class="chip chip-amber">терен</span>
                <span class="chip chip-red">задължителен</span>
              </div>
            </div>
            <div class="card-body">
              <ul class="list-disc pl-5 space-y-1">
                <li><strong>Теория:</strong> 2 дни × 6 часа – компас, работа с карта, трак устройства (GPS); <em>изпит без поправка</em>.</li>
                <li><strong>Терен:</strong> 3 дни – ориентиране и водене в реална среда, <em>изпит в реална среда</em>.</li>
              </ul>
            </div>
            <div class="card-foot">
              <div>
                <!-- Смени цената при нужда чрез data-bgn -->
                <div class="price-xl"><span class="price" data-bgn="290">0 BGN</span></div>
                <div class="muted">комбиниран модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb mandatory need-insurance accent-green-600 scale-125"
                       data-name="ОРИЕНТИРАНЕ (компас, карта, GPS)" data-bgn="290" checked disabled>
                <span class="text-sm font-medium">Включен</span>
              </label>
            </div>
          </article>

          <!-- TERRAIN – SUMMER (required choice: season) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">НА ТЕРЕН – ЛЯТО</h3>
              <div class="flex gap-1">
                <span class="chip chip-amber">терен</span>
                <span class="chip chip-red">избери</span>
              </div>
            </div>
            <div class="card-body">Реална среда: ориентиране, карта/компас, водене на група.</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="290">290 BGN</span></div>
                <div class="muted">двудневен модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb need-insurance required-season accent-green-600 scale-125" data-group="season" data-name="НА ТЕРЕН – ЛЯТО" data-bgn="290">
                <span class="text-sm font-medium">Избирам</span>
              </label>
            </div>
          </article>

          <!-- TERRAIN – WINTER (required choice: season) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">НА ТЕРЕН – ЗИМА</h3>
              <div class="flex gap-1">
                <span class="chip chip-amber">терен</span>
                <span class="chip chip-red">избери</span>
              </div>
            </div>
            <div class="card-body">Лавинна безопасност, зимна екипировка и техники за придвижване.</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="340">340 BGN</span></div>
                <div class="muted">двудневен модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb need-insurance required-season accent-green-600 scale-125" data-group="season" data-name="НА ТЕРЕН – ЗИМА" data-bgn="340">
                <span class="text-sm font-medium">Избирам</span>
              </label>
            </div>
          </article>

          <!-- BIVOUACKING -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">БИВАКУВАНЕ</h3>
              <span class="chip chip-amber">терен</span>
            </div>
            <div class="card-body">Изграждане на бивак, избор на място, Leave No Trace, нощни рискове.</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="200">200 BGN</span></div>
                <div class="muted">еднодневен/нощен модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb need-insurance accent-green-600 scale-125" data-name="БИВАКУВАНЕ" data-bgn="200">
                <span class="text-sm font-medium">Избирам</span>
              </label>
            </div>
          </article>

          <!-- ONLINE – GEAR & PROTECTION (mandatory) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ЕКИПИРОВКА, БЕЗОПАСНОСТ / ОПАЗВАНЕ НА ПРИРОДАТА</h3>
              <div class="flex gap-1">
                <span class="chip chip-green">онлайн</span>
                <span class="chip chip-red">задължителен</span>
              </div>
            </div>
            <div class="card-body">Сезонна екипировка и оборудване за преходи, защита от диви животни, опазване на природата. 1 ден теория (4 часа) + изпит.</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="150">150 BGN</span></div>
                <div class="muted">онлайн модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb mandatory accent-green-600 scale-125"
                       data-name="ЕКИПИРОВКА, БЕЗОПАСНОСТ / ОПАЗВАНЕ НА ПРИРОДАТА"
                       data-bgn="150" checked disabled>
                <span class="text-sm font-medium">Включен</span>
              </label>
            </div>
          </article>

          <!-- ALPINISM THEORY -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">АЛПИНИЗЪМ – ТЕОРИЯ</h3>
              <span class="chip chip-blue">теория</span>
            </div>
            <div class="card-body">Теоретични основи, възли, техники, планиране и безопасност.</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="260">260 BGN</span></div>
                <div class="muted">еднодневен модул (4 ч)</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb accent-green-600 scale-125" data-name="АЛПИНИЗЪМ – ТЕОРИЯ" data-bgn="260">
                <span class="text-sm font-medium">Избирам</span>
              </label>
            </div>
          </article>

          <!-- ROPES & VIA FERRATA THEORY -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ВЪЖЕТА / ВИА ФЕРАТА – ТЕОРИЯ</h3>
              <span class="chip chip-blue">теория</span>
            </div>
            <div class="card-body">Работа с осигурителни въжета и осигуряване на Виа Ферата (теория).</div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="160">160 BGN</span></div>
                <div class="muted">полудневен модул</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb accent-green-600 scale-125" data-name="ВЪЖЕТА / ВИА ФЕРАТА – ТЕОРИЯ" data-bgn="160">
                <span class="text-sm font-medium">Избирам</span>
              </label>
            </div>
          </article>

          <!-- ORGANISING EVENTS (mandatory) -->
          <article class="card">
            <div class="card-head">
              <h3 class="card-title">ОРГАНИЗИРАНЕ НА МЕРОПРИЯТИЯ</h3>
              <div class="flex gap-1">
                <span class="chip chip-green">онлайн</span>
                <span class="chip chip-blue">теория</span>
                <span class="chip chip-red">задължителен</span>
              </div>
            </div>
            <div class="card-body">
              Онлайн + теория и практика: 1 ден, 4 часа обучение. Отчитане и провеждане на преходи – планиране, документиране, логистика.
            </div>
            <div class="card-foot">
              <div>
                <div class="price-xl"><span class="price" data-bgn="300">300 BGN</span></div>
                <div class="muted">еднодневен модул (4 ч)</div>
              </div>
              <label class="inline-flex items-center tap-area cursor-pointer select-none">
                <input type="checkbox" class="module cb mandatory accent-green-600 scale-125"
                       data-name="ОРГАНИЗИРАНЕ НА МЕРОПРИЯТИЯ"
                       data-bgn="300" checked disabled>
                <span class="text-sm font-medium">Включен</span>
              </label>
            </div>
          </article>

        </div>
      </section>

      <!-- RIGHT: SUMMARY + FORM -->
      <aside>
        <div class="lg:sticky lg:top-6 space-y-6">
          <!-- SUMMARY -->
          <div class="card">
            <div class="card-head">
              <h4 class="card-title">Обобщение</h4>
              <span class="chip">BGN/EUR</span>
            </div>
            <div class="card-body">
              <ul id="summaryList" class="space-y-2 text-sm"></ul>
              <div class="mt-3 border-t pt-3 flex items-center justify-between">
                <span class="muted">Междинна сума</span>
                <span id="subtotal" class="font-bold">0 BGN</span>
              </div>
              <div class="mt-1 flex items-center justify-between">
                <span class="muted">Такса кандидатстване</span>
                <span id="fee">0</span>
              </div>
              <div class="mt-3 border-t pt-3 flex items-center justify-between">
                <span class="text-sm font-semibold">Крайна цена</span>
                <span id="grandTotal" class="text-2xl font-extrabold">0 BGN</span>
              </div>
              <p class="muted mt-2">Цените се показват в избраната валута. Курс: 1 EUR = 1.95583 BGN.</p>
            </div>
          </div>

          <!-- FORM -->
          <form id="applyForm" action="https://formsubmit.co/uzunov.ange@gmail.com" method="POST" enctype="multipart/form-data" class="card" novalidate>
            <div class="card-head">
              <h4 class="card-title">Заявка</h4>
            </div>
            <div class="card-body">
              <!-- FormSubmit -->
              <input type="hidden" name="_subject" value="Нова заявка – Програма за Планински водачи">
              <input type="hidden" name="_captcha" value="false">
              <input type="hidden" name="_template" value="table">
              <!-- Пренасочване след изпращане -->
              <input type="hidden" name="_next" value="https://turizam123.github.io/uzunov/tmap_home.html" />
              <!-- Автоотговор -->
              <input type="hidden" name="_autoresponse" value="Благодарим за заявката! При одобрение ще се свържем за насрочване на входен изпит. За включване в изпита се заплаща такса кандидатстване 370 лв. / 189.18 EUR.">

              <!-- Данни за изборите -->
              <input type="hidden" name="Избрани модули" id="chosenModulesField" value="">
              <input type="hidden" name="Валута" id="currencyField" value="BGN">
              <input type="hidden" name="Такса кандидатстване" id="appFeeField" value="370 BGN">
              <input type="hidden" name="Процедура" value="При одобрение ще се свържем за насрочване на входен изпит. За включване в изпита се заплаща такса кандидатстване 370 лв. / 189.18 EUR.">

              <label class="block mb-3">
                <span class="text-sm font-medium">Име и фамилия <span class="text-red-600">*</span></span>
                <input required name="Име" type="text" autocomplete="name" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="напр. Иван Петров" />
              </label>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="block">
                  <span class="text-sm font-medium">Имейл <span class="text-red-600">*</span></span>
                  <input required name="Имейл" type="email" inputmode="email" autocomplete="email" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="name@example.com" />
                </label>
                <label class="block">
                  <span class="text-sm font-medium">Телефон <span class="text-red-600">*</span></span>
                  <input required name="Телефон" type="tel" inputmode="tel" autocomplete="tel" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="+359 ..." />
                </label>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                <label class="block">
                  <span class="text-sm font-medium">Опит в планината</span>
                  <select name="Опит" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option>Начинаещ</option>
                    <option>Средно напреднал</option>
                    <option>Напреднал</option>
                  </select>
                </label>
                <label class="block">
                  <span class="text-sm font-medium">Тип заявка</span>
                  <select name="Тип заявка" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option>Лично</option>
                    <option>От организатор</option>
                  </select>
                </label>
              </div>

              <!-- Insurance (conditional) -->
              <div id="insuranceWrap" class="hidden mt-4 rounded-xl border p-4 bg-green-50">
                <p class="text-sm font-semibold text-green-800">Застраховка за планина</p>
                <p class="text-sm text-green-700 mt-1">За модулите „на терен“ е необходима валидна застраховка.</p>
                <div class="mt-3 grid sm:grid-cols-2 gap-4">
                  <label class="inline-flex items-center gap-2 select-none">
                    <input type="checkbox" id="hasInsurance" class="accent-green-600">
                    <span class="text-sm">Имам валидна застраховка</span>
                  </label>
                  <label class="block">
                    <span class="text-sm">Качване на полица (PDF/JPG, по избор)</span>
                    <input name="Застраховка файл" type="file" accept=".pdf,.jpg,.jpeg,.png" class="mt-1 w-full rounded-xl border px-3 py-2" />
                  </label>
                </div>
              </div>

              <!-- Такса кандидатстване -->
              <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
                <p class="text-sm">
                  При одобрение ще се свържем за насрочване на входен изпит. За включване в изпита се заплаща
                  <strong>такса кандидатстване 370 лв. / 189.18 EUR</strong>.
                </p>
              </div>
              <div class="mt-3 text-sm flex items-start gap-2">
                <input type="checkbox" required class="mt-1 accent-green-600">
                <span>Потвърждавам, че приемам заплащането на таксата кандидатстване 370 лв. / 189.18 EUR при включване във входния изпит.</span>
              </div>

              <label class="block mt-4">
                <span class="text-sm font-medium">Допълнителни бележки</span>
                <textarea name="Бележки" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Специфични нужди, дати, въпроси..."></textarea>
              </label>

              <div class="mt-5 text-xs text-slate-600 flex items-start gap-2">
                <input type="checkbox" required class="mt-1 accent-green-600">
                <span>С изпращането приемам <a href="https://turistibg.weebly.com/1055105610401042104810511040.html" target="_blank" rel="noopener" class="underline decoration-dotted text-green-700">Общите условия</a>.</span>
              </div>
            </div>
            <div class="card-foot">
              <button type="submit" class="btn btn-primary w-full">Изпрати заявката</button>
            </div>
          </form>
        </div>
      </aside>
    </div>
  </main>

  <!-- Sticky mobile summary -->
  <div class="lg:hidden fixed bottom-0 inset-x-0 px-4 z-40 pb-4 safe-bottom">
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg border flex items-center justify-between px-4 py-3">
      <div>
        <div class="text-xs text-slate-500">Крайна цена</div>
        <div id="mobileTotal" class="text-xl font-extrabold">0 BGN</div>
      </div>
      <a href="#applyForm" class="btn btn-primary">Попълни заявка</a>
    </div>
  </div>

  <script>
    const EUR_RATE = 1.95583;
    const APPLICATION_FEE_BGN = 370; // такса кандидатстване
    let currency = localStorage.getItem('currency') || 'BGN';
    const fmt = (bgn) => currency === 'BGN' ? `${bgn.toFixed(0)} BGN` : `${(bgn / EUR_RATE).toFixed(2)} EUR`;

    function updatePrices(){
      document.querySelectorAll('.price').forEach(el => {
        const bgn = parseFloat(el.dataset.bgn);
        el.textContent = fmt(bgn);
      });
      updateSummary();
    }

    function updateSummary(){
      const checked = [...document.querySelectorAll('.module:checked')];
      const list = document.getElementById('summaryList');
      list.innerHTML = '';
      let subtotal = 0; let terrain = false;
      checked.forEach(cb => {
        const name = cb.dataset.name; const bgn = parseFloat(cb.dataset.bgn);
        subtotal += bgn; if(cb.classList.contains('need-insurance')) terrain = true;
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between';
        li.innerHTML = `<span>${name}</span><span class='font-semibold'>${fmt(bgn)}</span>`;
        list.appendChild(li);
      });
      const feeBGN = APPLICATION_FEE_BGN;
      const feeRow = document.createElement('li');
      feeRow.className = 'flex items-center justify-between border-t pt-2 mt-2';
      feeRow.innerHTML = `<span>Такса кандидатстване</span><span class='font-semibold'>${fmt(feeBGN)}</span>`;
      list.appendChild(feeRow);

      const total = subtotal + feeBGN;
      document.getElementById('subtotal').textContent = fmt(subtotal);
      document.getElementById('fee').textContent = fmt(feeBGN);
      document.getElementById('grandTotal').textContent = fmt(total);
      document.getElementById('mobileTotal').textContent = fmt(total);
      document.getElementById('insuranceWrap').classList.toggle('hidden', !terrain);

      const chosen = checked.map(cb => `${cb.dataset.name} (${fmt(parseFloat(cb.dataset.bgn))})`);
      document.getElementById('chosenModulesField').value = chosen.join(', ');
      document.getElementById('appFeeField').value = fmt(feeBGN);

      localStorage.setItem('selectedModules', JSON.stringify(checked.map(cb => cb.dataset.name)));
    }

    // currency toggle
    const btnBGN = document.getElementById('btnBGN');
    const btnEUR = document.getElementById('btnEUR');
    function setCurrency(cur){
      currency = cur; localStorage.setItem('currency', cur);
      document.getElementById('currencyField').value = cur;
      const isBGN = cur === 'BGN';
      btnBGN.setAttribute('aria-pressed', isBGN);
      btnEUR.setAttribute('aria-pressed', !isBGN);
      btnBGN.classList.toggle('bg-green-600', isBGN);
      btnBGN.classList.toggle('text-white', isBGN);
      btnEUR.classList.toggle('bg-green-600', !isBGN);
      btnEUR.classList.toggle('text-white', !isBGN);
      updatePrices();
    }
    btnBGN.addEventListener('click', () => setCurrency('BGN'));
    btnEUR.addEventListener('click', () => setCurrency('EUR'));

    // module change
    document.querySelectorAll('.module').forEach(cb => cb.addEventListener('change', updateSummary));

    // submit guard: at least one module + required season choice
    document.getElementById('applyForm').addEventListener('submit', (e) => {
      const any = document.querySelector('.module:checked');
      const seasonPicked = document.querySelector('.required-season:checked');
      if(!any){
        e.preventDefault(); alert('Моля, избери поне един модул.');
        return;
      }
      if(!seasonPicked){
        e.preventDefault();
        alert('Изборът на поне един сезонен модул е задължителен: „НА ТЕРЕН – ЛЯТО“ или „НА ТЕРЕН – ЗИМА“.');
        return;
      }
    });

    // Restore on load
    window.addEventListener('DOMContentLoaded', () => {
      setCurrency(currency);
      try{
        const stored = JSON.parse(localStorage.getItem('selectedModules')||'[]');
        if(Array.isArray(stored) && stored.length){
          document.querySelectorAll('.module:not(.mandatory)').forEach(cb => {
            cb.checked = stored.includes(cb.dataset.name);
          });
        }
      }catch(err){}
      updatePrices();
    });
  </script>
</body>
</html>
