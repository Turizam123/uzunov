<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T‚ÄëMAP –û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <meta name="theme-color" content="#0ea5e9" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --tmap: #0ea5e9; }
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    /* –ü—Ä–æ—Å—Ç CSS (–±–µ–∑ @apply), —Ä–∞–±–æ—Ç–∏ —Å CDN Tailwind */
    .card { background: rgba(255,255,255,0.85); backdrop-filter: saturate(140%) blur(8px); border:1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.06); }
    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:10px 16px; font-weight:600; transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active { transform: scale(.98); }
    .btn-primary { background:#0369a1; color:#fff; box-shadow:0 8px 20px rgba(2,132,199,.25); }
    .btn-primary:hover { background:#075985; }
    .btn-ghost { background:#fff; color:#0f172a; border:1px solid #e2e8f0; }
    .btn-ghost:hover { background:#f8fafc; }
    .chip { display:inline-flex; align-items:center; border-radius:999px; border:1px solid #cbd5e1; padding:2px 10px; font-size:12px; font-weight:600; background:#fff; color:#334155; }
    .hero-wrap { position:relative; overflow:hidden; border-radius:20px; }
    .hero-bg { position:absolute; inset:0; background-position:center; background-size:cover; transform:scale(1.02); }
    .hero-overlay { position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,.55) 0%, rgba(2,6,23,.35) 40%, rgba(2,6,23,.55) 100%); }
    .hero-content { position:relative; z-index:1; color:#fff; padding:56px 24px; }
  </style>
  <!-- Supabase JS v2 -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-full bg-gradient-to-br from-sky-50 via-white to-emerald-50 text-slate-800">
  <!-- HEADER -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="#" class="h-9 w-9 rounded-xl bg-sky-600 text-white grid place-items-center font-black">T</a>
      <div class="flex-1">
        <h1 class="text-lg font-bold">T‚ÄëMAP ‚Ä¢ –û–±—É—á–∏—Ç–µ–ª–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
        <p class="text-xs text-slate-600">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Ä¢ –ë–∏–≤–∞–∫ ‚Ä¢ –ü—Ä–µ—Ö–æ–¥–∏ ‚Ä¢ –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ ‚Ä¢ –ê–ª–ø–∏–Ω–∏–∑—ä–º ‚Ä¢ –ü—Ä–∏—Ä–æ–¥–∞</p>
      </div>
      <div id="userArea" class="flex items-center gap-3"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <!-- AUTH/HERO -->
    <section id="hero" class="hero-wrap hidden">
      <div class="hero-bg" style="background-image:url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop');"></div>
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <div class="max-w-6xl mx-auto">
          <div class="grid lg:grid-cols-2 gap-8 items-center">
            <div>
              <div class="inline-flex items-center gap-2 mb-3"><span class="chip bg-white/90">T‚ÄëMAP Academy</span><span class="chip bg-white/90">–ù–æ–≤–æ</span></div>
              <h2 class="text-4xl lg:text-5xl font-extrabold leading-tight">–£—á–∏. –¢–µ—Å—Ç–≤–∞–π —Å–µ. –ò–∑–ª–∏–∑–∞–π –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞ –ø–æ‚Äë–ø–æ–¥–≥–æ—Ç–≤–µ–Ω.</h2>
              <p class="mt-3 text-white/90 text-lg">–ö—É—Ä—Å–æ–≤–µ –ø–æ –æ—Ü–µ–ª—è–≤–∞–Ω–µ, –±–∏–≤–∞–∫—É–≤–∞–Ω–µ, –∑–∏–º–Ω–∞ —Ç–µ–æ—Ä–∏—è, –ª–µ—Ç–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—ä—Ç–µ–∫–∏ ‚Äî –≤ –µ–¥–∏–Ω –º–æ–¥—É–ª.</p>
              <div class="mt-6 flex flex-wrap gap-3">
                <button id="btnGoogle" class="btn btn-primary">–í—Ö–æ–¥ —Å Google</button>
                <a href="#upcoming" class="btn btn-ghost">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –¥–∞—Ç–∏</a>
              </div>
              <div class="mt-6 grid grid-cols-3 gap-3 text-sm text-white/90">
                <div class="card p-3 bg-white/10 border-white/10"><div class="font-bold">–ó–∏–º–Ω–∞ —Ç–µ–æ—Ä–∏—è</div><div>–æ–Ω–ª–∞–π–Ω –º–æ–¥—É–ª–∏</div></div>
                <div class="card p-3 bg-white/10 border-white/10"><div class="font-bold">–õ–µ—Ç–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏</div><div>—É–∏–∫–µ–Ω–¥ –∏–∑–ª–∏–∑–∞–Ω–∏—è</div></div>
                <div class="card p-3 bg-white/10 border-white/10"><div class="font-bold">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</div><div>—Å–ª–µ–¥ –∏–∑–ø–∏—Ç</div></div>
              </div>
              <p class="mt-3 text-xs text-white/80">–° –≤–ª–∏–∑–∞–Ω–µ—Ç–æ –ø—Ä–∏–µ–º–∞—à <a class="underline" target="_blank" href="https://turistibg.weebly.com/1055105610401042104810511040.html">–û–±—â–∏—Ç–µ —É—Å–ª–æ–≤–∏—è</a>.</p>
            </div>
            <div class="hidden lg:block">
              <div class="grid grid-cols-2 gap-4">
                <div class="card p-4 bg-white/80">
                  <div class="text-slate-500 text-sm">12‚Äì13 –æ–∫—Ç 2025</div>
                  <h4 class="font-semibold">–ü—Ä–µ—Ö–æ–¥–∏ –≤ –ø–ª–∞–Ω–∏–Ω–∞—Ç–∞ ‚Äî –†–∏–ª–∞</h4>
                  <p class="text-slate-600 text-sm mt-1">–û—Ä–∏–µ–Ω—Ç–∏—Ä–∞–Ω–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p>
                  <div class="mt-3 flex items-center justify-between text-sm">
                    <span>–ú–µ—Å—Ç–∞: <b>12/20</b></span>
                    <button class="btn btn-ghost text-xs" onclick="document.getElementById('btnGoogle').click()">–ó–∞–ø–∏—à–∏ —Å–µ</button>
                  </div>
                </div>
                <div class="card p-4 bg-white/80">
                  <div class="text-slate-500 text-sm">26‚Äì27 –æ–∫—Ç 2025</div>
                  <h4 class="font-semibold">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Äî –æ—Å–Ω–æ–≤–∏ (–æ–Ω–ª–∞–π–Ω)</h4>
                  <p class="text-slate-600 text-sm mt-1">–ó–∏–º–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ —Ä–∏—Å–∫–æ–≤–µ.</p>
                  <div class="mt-3 flex items-center justify-between text-sm">
                    <span>–ú–µ—Å—Ç–∞: <b>8/25</b></span>
                    <button class="btn btn-ghost text-xs" onclick="document.getElementById('btnGoogle').click()">–ó–∞–ø–∏—à–∏ —Å–µ</button>
                  </div>
                </div>
                <div class="col-span-2 card p-4 bg-gradient-to-r from-sky-600/90 to-emerald-500/90 text-white">
                  <div class="flex items-center justify-between">
                    <h4 class="font-semibold">–°–µ–∑–æ–Ω–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏</h4>
                    <span class="chip bg-white text-slate-800">-20% / -15%</span>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-4 mt-2 text-sm">
                    <div class="card p-4 bg-white/10 border-white/10">
                      <div class="font-bold">–¢–µ–æ—Ä–∏—è ‚Äî –ó–∏–º–∞</div>
                      <div class="opacity-90">3 –º–æ–¥—É–ª–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ª–∞–≤–∏–Ω–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è</div>
                      <div class="mt-2"><span class="line-through opacity-80 mr-2">250 –ª–≤</span><span class="font-bold">200 –ª–≤</span></div>
                    </div>
                    <div class="card p-4 bg-white/10 border-white/10">
                      <div class="font-bold">–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –õ—è—Ç–æ</div>
                      <div class="opacity-90">2 —É–∏–∫–µ–Ω–¥–∞: –±–∏–≤–∞–∫, –º–∞—Ä—à—Ä—É—Ç–∏, –µ–∫–∏–ø–Ω–∞ —Ä–∞–±–æ—Ç–∞</div>
                      <div class="mt-2"><span class="line-through opacity-80 mr-2">360 –ª–≤</span><span class="font-bold">306 –ª–≤</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- –ü–æ–¥ –≥–µ—Ä–æ—è: –∫–æ–º–ø–∞–∫—Ç–Ω–∏ —Å–µ–∫—Ü–∏–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ -->
    <section id="upcoming" class="mt-8 lg:mt-10">
      <div class="max-w-6xl mx-auto px-0">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-xl font-bold">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∫—É—Ä—Å–æ–≤–µ</h3>
          <span class="chip">–¥–µ–º–æ</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <article class="card p-4">
            <div class="flex items-center justify-between"><div class="text-sm text-slate-500">12‚Äì13 –æ–∫—Ç 2025</div><span class="chip">–ü—Ä–∞–∫—Ç–∏–∫–∞</span></div>
            <h4 class="font-semibold mt-1">–ü—Ä–µ—Ö–æ–¥–∏ ‚Äî –†–∏–ª–∞</h4>
            <p class="text-sm text-slate-600 mt-1">–ú–∞—Ä—à—Ä—É—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p>
          </article>
          <article class="card p-4">
            <div class="flex items-center justify-between"><div class="text-sm text-slate-500">26‚Äì27 –æ–∫—Ç 2025</div><span class="chip">–¢–µ–æ—Ä–∏—è</span></div>
            <h4 class="font-semibold mt-1">–û—Ü–µ–ª—è–≤–∞–Ω–µ ‚Äî –æ—Å–Ω–æ–≤–∏</h4>
            <p class="text-sm text-slate-600 mt-1">–ó–∏–º–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞.</p>
          </article>
          <article class="card p-4">
            <div class="flex items-center justify-between"><div class="text-sm text-slate-500">09‚Äì10 –Ω–æ–µ 2025</div><span class="chip">–ü—Ä–∞–∫—Ç–∏–∫–∞</span></div>
            <h4 class="font-semibold mt-1">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—ä—Ç–µ–∫–∏</h4>
            <p class="text-sm text-slate-600 mt-1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç.</p>
          </article>
          <article class="card p-4">
            <div class="flex items-center justify-between"><div class="text-sm text-slate-500">23‚Äì24 –Ω–æ–µ 2025</div><span class="chip">–¢–µ–æ—Ä–∏—è</span></div>
            <h4 class="font-semibold mt-1">–í—ä–≤–µ–¥–µ–Ω–∏–µ –≤ –∞–ª–ø–∏–Ω–∏–∑–º–∞</h4>
            <p class="text-sm text-slate-600 mt-1">–í—ä–∑–ª–∏ –∏ —Ç–∞–∫—Ç–∏–∫–∞.</p>
          </article>
        </div>
      </div>
    </section>

    <section id="offers" class="mt-8">
      <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-xl font-bold">–û—Ñ–µ—Ä—Ç–∏ –∏ –Ω–∞–º–∞–ª–µ–Ω–∏—è</h3>
          <span class="chip">—Å–µ–∑–æ–Ω–Ω–∏</span>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <article class="card overflow-hidden">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold">–ü—Ä–æ–≥—Ä–∞–º–∞ ‚Äû–¢–µ–æ—Ä–∏—è ‚Äî –ó–∏–º–∞‚Äú</h4>
                <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 text-xs px-2 py-0.5">-20%</span>
              </div>
              <p class="mt-1 text-sm text-slate-600">3 –æ–Ω–ª–∞–π–Ω –º–æ–¥—É–ª–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ª–∞–≤–∏–Ω–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –∏ –∑–∏–º–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è.</p>
              <div class="mt-3 flex items-center justify-between text-sm">
                <div><span class="line-through text-slate-400 mr-2">250 –ª–≤</span><span class="font-bold">200 –ª–≤</span></div>
                <button class="btn btn-primary text-sm" onclick="document.getElementById('btnGoogle').click()">–í–∑–µ–º–∏ –æ—Ñ–µ—Ä—Ç–∞—Ç–∞</button>
              </div>
            </div>
          </article>
          <article class="card overflow-hidden">
            <div class="p-5">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold">–ü—Ä–æ–≥—Ä–∞–º–∞ ‚Äû–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –õ—è—Ç–æ‚Äú</h4>
                <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5">-15%</span>
              </div>
              <p class="mt-1 text-sm text-slate-600">2 —É–∏–∫–µ–Ω–¥ –∏–∑–ª–∏–∑–∞–Ω–∏—è: –±–∏–≤–∞–∫—É–≤–∞–Ω–µ, –º–∞—Ä—à—Ä—É—Ç–∏ –∏ –µ–∫–∏–ø–Ω–∞ —Ä–∞–±–æ—Ç–∞.</p>
              <div class="mt-3 flex items-center justify-between text-sm">
                <div><span class="line-through text-slate-400 mr-2">360 –ª–≤</span><span class="font-bold">306 –ª–≤</span></div>
                <button class="btn btn-primary text-sm" onclick="document.getElementById('btnGoogle').click()">–í–∑–µ–º–∏ –æ—Ñ–µ—Ä—Ç–∞—Ç–∞</button>
              </div>
            </div>
          </article>
        </div>
        <p class="text-xs text-slate-500 mt-2">* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –¥–∞—Ç–∏/—Ü–µ–Ω–∏ ‚Äî —â–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞—Ç –æ—Ç –±–∞–∑–∞.</p>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden space-y-6">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 card p-5 space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <h2 class="text-xl font-bold">–ö–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤–µ</h2>
            <div class="flex flex-wrap gap-2">
              <select id="filterCategory" class="border rounded-xl px-3 py-2 text-sm">
                <option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              </select>
              <input id="searchCourse" placeholder="–¢—ä—Ä—Å–∏ –∫—É—Ä—Å‚Ä¶" class="border rounded-xl px-3 py-2 text-sm" />
            </div>
          </div>
          <div id="courseList" class="grid sm:grid-cols-2 gap-4"></div>
          <div id="emptyCourses" class="hidden text-sm text-slate-500">–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –∫—É—Ä—Å–æ–≤–µ.</div>
        </div>
        <aside class="card p-5 space-y-4">
          <h3 class="font-bold">–ú–æ–µ—Ç–æ –æ–±—É—á–µ–Ω–∏–µ</h3>
          <ul id="myEnrollments" class="space-y-3 text-sm"></ul>
          <hr/>
          <h3 class="font-bold">–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
          <ul id="myResults" class="space-y-3 text-sm"></ul>
        </aside>
      </div>

      <div id="quizView" class="card p-5 hidden">
        <div class="flex items-center justify-between gap-3">
          <h3 id="quizTitle" class="text-lg font-bold">–¢–µ—Å—Ç</h3>
          <button id="btnExitQuiz" class="btn btn-ghost">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="quizMeta" class="text-sm text-slate-600"></div>
        <ol id="quizQuestions" class="mt-4 space-y-4 list-decimal list-inside"></ol>
        <div class="mt-4 flex items-center gap-3">
          <button id="btnSubmitQuiz" class="btn btn-primary">–ü—Ä–µ–¥–∞–π —Ç–µ—Å—Ç</button>
          <div id="quizMsg" class="text-sm text-slate-600"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-xs text-slate-500">
    ¬© <span id="year"></span> –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è—Ç ‚Ä¢ T‚ÄëMAP
  </footer>

  <!-- Toasts -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden z-50">
    <div class="bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-lg"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Supabase (T‚ÄëMAP –±–∞–∑–∞) ===
    const SUPABASE_URL = 'https://cmiylzpmpwqbacjoqtkx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === UI refs ===
    const yearEl = document.getElementById('year');
    const hero = document.getElementById('hero');
    const dashboard = document.getElementById('dashboard');
    const userArea = document.getElementById('userArea');
    const courseList = document.getElementById('courseList');
    const emptyCourses = document.getElementById('emptyCourses');
    const filterCategory = document.getElementById('filterCategory');
    const searchCourse = document.getElementById('searchCourse');
    const myEnrollments = document.getElementById('myEnrollments');
    const myResults = document.getElementById('myResults');
    const quizView = document.getElementById('quizView');
    const quizTitle = document.getElementById('quizTitle');
    const quizMeta = document.getElementById('quizMeta');
    const quizQuestions = document.getElementById('quizQuestions');
    const quizMsg = document.getElementById('quizMsg');

    yearEl.textContent = new Date().getFullYear();

    // === Toast helper ===
    const toastBox = document.getElementById('toast');
    function toast(msg) {
      toastBox.firstElementChild.textContent = msg;
      toastBox.classList.remove('hidden');
      setTimeout(() => toastBox.classList.add('hidden'), 2400);
    }

    // === Auth (—Å–∞–º–æ Google) ===
    document.getElementById('btnGoogle').addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href,
          queryParams: { prompt: 'consent', access_type: 'offline' }
        }
      });
      if (error) toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥: ' + error.message);
    });

    supabase.auth.onAuthStateChange((_event, session) => {
      render(session?.user || null);
    });

    async function ensureProfile(user) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .upsert({ id: user.id, email: user.email, full_name: user.user_metadata?.full_name || null, avatar_url: user.user_metadata?.avatar_url || null }, { onConflict: 'id' })
          .select('*')
          .single();
        if (error) console.warn('profiles upsert:', error.message);
        return data;
      } catch (e) { console.warn(e); }
      return null;
    }

    async function render(user) {
      userArea.innerHTML = '';
      if (!user) {
        hero.classList.remove('hidden');
        dashboard.classList.add('hidden');
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.textContent = '–í—Ö–æ–¥';
        btn.onclick = () => document.getElementById('btnGoogle').click();
        userArea.append(btn);
        return;
      }

      await ensureProfile(user);

      // header chip
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = `${user.user_metadata?.avatar_url ? `<img src="${user.user_metadata.avatar_url}" class="w-5 h-5 rounded-full mr-2"/>` : ''}<span class="mr-2">${user.email}</span>`;
      const out = document.createElement('button');
      out.className = 'btn btn-ghost';
      out.textContent = '–ò–∑—Ö–æ–¥';
      out.onclick = async () => { await supabase.auth.signOut(); window.location.reload(); };
      userArea.append(chip, out);

      hero.classList.add('hidden');
      dashboard.classList.remove('hidden');

      await Promise.all([
        loadCourses(),
        loadEnrollments(user.id),
        loadResults(user.id)
      ]);
    }

    // === –ö–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤–µ ===
    let allCourses = [];

    async function loadCourses() {
      const { data, error } = await supabase
        .from('courses')
        .select('id, title, category, level, price_bgn, duration_min, short_description, cover_url, published')
        .eq('published', true)
        .order('created_at', { ascending: false });
      if (error) { console.warn('courses:', error.message); allCourses = []; }
      else allCourses = data || [];

      const cats = Array.from(new Set(allCourses.map(c => c.category).filter(Boolean)));
      filterCategory.innerHTML = '<option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + cats.map(c => `<option>${c}</option>`).join('');
      renderCourseCards();
    }

    function renderCourseCards() {
      const q = (searchCourse.value || '').toLowerCase();
      const cat = filterCategory.value || '';
      const list = allCourses.filter(c => (!cat || c.category === cat) && (!q || c.title.toLowerCase().includes(q)));
      courseList.innerHTML = '';
      if (!list.length) { emptyCourses.classList.remove('hidden'); return; }
      emptyCourses.classList.add('hidden');
      list.forEach(c => courseList.appendChild(courseCard(c)));
    }

    filterCategory.addEventListener('change', renderCourseCards);
    searchCourse.addEventListener('input', renderCourseCards);

    function courseCard(c) {
      const el = document.createElement('article');
      el.className = 'card overflow-hidden';
      el.innerHTML = `
        <div class="aspect-[16/9] bg-slate-100" style="background-image:url('${c.cover_url || ''}'); background-size:cover; background-position:center"></div>
        <div class="p-4 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">${c.title}</h3>
            ${c.category ? `<span class=\"chip\">${c.category}</span>` : ''}
          </div>
          <p class="text-sm text-slate-600">${c.short_description || ''}</p>
          <div class="flex flex-wrap items-center gap-3 text-sm text-slate-700">
            ${c.level ? `<span>–ù–∏–≤–æ: <b>${c.level}</b></span>` : ''}
            ${c.duration_min ? `<span>‚è±Ô∏è ${c.duration_min} –º–∏–Ω</span>` : ''}
            ${typeof c.price_bgn === 'number' && c.price_bgn > 0 ? `<span>üí≥ ${Number(c.price_bgn).toFixed(2)} –ª–≤</span>` : '<span class="text-emerald-700">–ë–µ–∑–ø–ª–∞—Ç–µ–Ω</span>'}
          </div>
          <div class="flex gap-2 pt-1">
            <button class="btn btn-primary" data-course="${c.id}">–ó–∞–ø–∏—à–∏ —Å–µ</button>
            <button class="btn btn-ghost" data-preview="${c.id}">–ü—Ä–µ–≥–ª–µ–¥</button>
          </div>
        </div>`;

      el.querySelector('[data-course]')?.addEventListener('click', () => enrollInCourse(c));
      el.querySelector('[data-preview]')?.addEventListener('click', () => openPreview(c));
      return el;
    }

    function openPreview(c) {
      alert(`${c.title}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${c.short_description || '–ù—è–º–∞ –æ–ø–∏—Å–∞–Ω–∏–µ.'}`);
    }

    // === –ó–∞–ø–∏—Å–≤–∞–Ω–µ –≤ –∫—É—Ä—Å ===
    async function enrollInCourse(course) {
      const { data: session } = await supabase.auth.getSession();
      const user = session?.session?.user;
      if (!user) { toast('–ú–æ–ª—è, –≤–ª–µ–∑ –ø—ä—Ä–≤–æ.'); return; }

      if (!course.price_bgn || Number(course.price_bgn) === 0) {
        const { error } = await supabase.from('enrollments').insert({ user_id: user.id, course_id: course.id, status: 'active' });
        if (error) return toast('–ì—Ä–µ—à–∫–∞: ' + error.message);
        await loadEnrollments(user.id);
        toast('–£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ!');
        return;
      }

      // –ü–ª–∞—Ç–µ–Ω –∫—É—Ä—Å ‚Äî placeholder (Stripe –ø–æ-–∫—ä—Å–Ω–æ)
      toast('–ü–ª–∞—Ç–µ–Ω –∫—É—Ä—Å ‚Äî –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞ —â–µ –±—ä–¥–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∏ —Å–∫–æ—Ä–æ.');
    }

    // === –ú–æ–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è ===
    async function loadEnrollments(userId) {
      const { data, error } = await supabase
        .from('enrollments')
        .select('id, status, course:courses(id,title)')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });
      if (error) { console.warn('enrollments:', error.message); return; }
      myEnrollments.innerHTML = '';
      (data || []).forEach(en => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-3';
        li.innerHTML = `
          <span>${en.course?.title || '–ö—É—Ä—Å'} ‚Äî <b>${en.status}</b></span>
          <div class="flex gap-2">
            <button class="btn btn-ghost text-xs" data-learn="${en.course?.id}">–£—Ä–æ—Ü–∏</button>
            <button class="btn btn-primary text-xs" data-quiz="${en.course?.id}">–ò–∑–ø–∏—Ç</button>
          </div>`;
        li.querySelector('[data-quiz]')?.addEventListener('click', () => startQuizForCourse(en.course?.id));
        li.querySelector('[data-learn]')?.addEventListener('click', () => openLessons(en.course?.id));
        myEnrollments.appendChild(li);
      });
      if (!(data || []).length) myEnrollments.innerHTML = '<li class="text-slate-500">–ù—è–º–∞—Ç–µ –∞–∫—Ç–∏–≤–Ω–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–∏—è.</li>';
    }

    function openLessons(courseId) {
      alert('–°—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ —Å —É—Ä–æ—Ü–∏ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–∞. Course ID: ' + courseId);
    }

    // === –†–µ–∑—É–ª—Ç–∞—Ç–∏ ===
    async function loadResults(userId) {
      const { data, error } = await supabase
        .from('quiz_attempts')
        .select('id, score_pct, passed, quiz:quizzes(title), created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(10);
      if (error) { console.warn('attempts:', error.message); return; }
      myResults.innerHTML = '';
      (data || []).forEach(a => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${a.quiz?.title || '–¢–µ—Å—Ç'}</b> ‚Äî ${a.score_pct?.toFixed?.(0) ?? 0}% ${a.passed ? '‚úÖ' : '‚ùå'} <span class="text-slate-500">(${new Date(a.created_at).toLocaleString()})</span>`;
        myResults.appendChild(li);
      });
      if (!(data || []).length) myResults.innerHTML = '<li class="text-slate-500">–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</li>';
    }

    // === –¢–µ—Å—Ç–æ–≤–µ ===
    let currentQuiz = null;
    let currentAnswers = {};

    async function startQuizForCourse(courseId) {
      const { data: quiz, error } = await supabase
        .from('quizzes')
        .select('id, title, time_limit_min, pass_pct')
        .eq('course_id', courseId)
        .eq('published', true)
        .order('created_at', { ascending: true })
        .maybeSingle();
      if (error || !quiz) { toast('–ù—è–º–∞ –Ω–∞–ª–∏—á–µ–Ω —Ç–µ—Å—Ç –∑–∞ —Ç–æ–∑–∏ –∫—É—Ä—Å.'); return; }
      currentQuiz = quiz;

      const { data: questions, error: qErr } = await supabase
        .from('quiz_questions')
        .select('id, question, options:quiz_options(id, text, is_correct)')
        .eq('quiz_id', quiz.id)
        .order('order_idx', { ascending: true });
      if (qErr) { toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏.'); return; }

      quizTitle.textContent = quiz.title;
      quizMeta.textContent = `–í—Ä–µ–º–µ: ${quiz.time_limit_min || '‚Äî'} –º–∏–Ω ‚Ä¢ –£—Å–ø–µ—à–µ–Ω –ø—Ä–∞–≥: ${quiz.pass_pct ?? 70}%`;
      quizQuestions.innerHTML = '';
      currentAnswers = {};
      (questions || []).forEach((q) => {
        const li = document.createElement('li');
        li.className = 'space-y-2';
        li.innerHTML = `<div class=\"font-medium\">${q.question}</div>`;
        const opts = document.createElement('div');
        opts.className = 'space-y-1';
        q.options.forEach(op => {
          const id = `q${q.id}_${op.id}`;
          const row = document.createElement('label');
          row.className = 'flex items-center gap-2';
          row.innerHTML = `<input type=\"radio\" name=\"q_${q.id}\" id=\"${id}\" class=\"scale-110\"> <span>${op.text}</span>`;
          row.querySelector('input').addEventListener('change', () => { currentAnswers[q.id] = op.id; });
          opts.appendChild(row);
        });
        li.appendChild(opts);
        quizQuestions.appendChild(li);
      });

      quizView.classList.remove('hidden');
      window.scrollTo({ top: quizView.offsetTop - 20, behavior: 'smooth' });
    }

    document.getElementById('btnExitQuiz').addEventListener('click', () => {
      quizView.classList.add('hidden');
      quizQuestions.innerHTML = '';
    });

    document.getElementById('btnSubmitQuiz').addEventListener('click', submitQuiz);

    async function submitQuiz() {
      if (!currentQuiz) return;
      const { data: questions } = await supabase
        .from('quiz_questions')
        .select('id, options:quiz_options(id, is_correct)')
        .eq('quiz_id', currentQuiz.id);
      const total = (questions || []).length;
      if (!total) return;

      let correct = 0;
      (questions || []).forEach(q => {
        const chosen = currentAnswers[q.id];
        const right = q.options.find(o => o.is_correct);
        if (chosen && right && chosen === right.id) correct++;
      });

      const pct = Math.round((correct / total) * 100);
      const passed = pct >= (currentQuiz.pass_pct ?? 70);

      const { data: session } = await supabase.auth.getSession();
      const userId = session?.session?.user?.id;
      if (!userId) return toast('–°–µ—Å–∏—è—Ç–∞ –µ –∏–∑—Ç–µ–∫–ª–∞.');

      const { error } = await supabase.from('quiz_attempts').insert({ user_id: userId, quiz_id: currentQuiz.id, score_pct: pct, passed });
      if (error) { toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç.'); return; }

      quizMsg.textContent = `–†–µ–∑—É–ª—Ç–∞—Ç: ${pct}% ${passed ? '‚Äî –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è! ‚úÖ' : '‚Äî –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ. ‚ùå'}`;
      await loadResults(userId);
    }

    // === Init ===
    (async () => {
      const { data } = await supabase.auth.getUser();
      render(data?.user || null);
    })();
  </script>
</body>
</html>
