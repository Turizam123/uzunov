<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T-MAP Календар</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
  <style>
    :root{
      --tmap-blue:#0ea5e9; --tmap-dark:#0b1220; --text:#0b1220; --muted:#667085;
      --bg:#f5f7fb; --card:#ffffff; --ring:rgba(14,165,233,.45); --radius:18px;
      --shadow:0 10px 30px rgba(16,24,40,.08), 0 2px 10px rgba(16,24,40,.05);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
      background: radial-gradient(1200px 700px at 80% -10%, #c0f0ff66, transparent 60%),
                  radial-gradient(800px 600px at -10% 110%, #e2c8ff55, transparent 60%), var(--bg);
      background-image:
        radial-gradient(1200px 700px at 80% -10%, #c0f0ff66, transparent 60%),
        radial-gradient(800px 600px at -10% 110%, #e2c8ff55, transparent 60%),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='320' viewBox='0 0 320 320' opacity='.18'><defs><pattern id='p' width='160' height='160' patternUnits='userSpaceOnUse'><path d='M0 80c40-40 80-40 120 0s80 40 120 0' fill='none' stroke='%2388a' stroke-width='0.8'/><path d='M-40 120c40-40 80-40 120 0s80 40 120 0' fill='none' stroke='%2388a' stroke-width='0.6' opacity='.6'/></pattern></defs><rect width='100%' height='100%' fill='url(%23p)'/></svg>");
      background-attachment: fixed;
    }
    .app{max-width:1200px;margin:20px auto;padding:0 14px}
    .shell{background:rgba(255,255,255,.72);backdrop-filter:blur(10px) saturate(120%);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid rgba(14,165,233,.08)}
    .toolbar{display:flex;gap:12px;align-items:center;padding:14px 16px;background:#ffffffb0;border-bottom:1px solid rgba(2,6,23,.06)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#e6f9ff,#e9d7ff);border:1px solid rgba(14,165,233,.25)}
    .brand .title{font-weight:800;letter-spacing:.2px;font-size:20px}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid rgba(2,6,23,.08);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;transition:.2s;box-shadow: inset 0 1px 0 rgba(255,255,255,.7)}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,#5dd7ff,#0ea5e9);color:#001a26;font-weight:800}
    .btn.icon{padding:10px}
    .calendar{display:grid;grid-template-columns:1fr 360px;min-height:640px}
    @media(max-width:980px){.calendar{grid-template-columns:1fr}}
    .left{background:transparent}
    .panel{padding:16px}
    @media(max-width:980px){ .panel{display:none} } /* дясната колона е скрита на мобилно */

    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(2,6,23,.06)}
    .header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:12px 16px}
    .dow{opacity:.7;font-size:12px;text-transform:uppercase;letter-spacing:.12em}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:16px}
    .cell{position:relative;aspect-ratio:1/1;border-radius:14px;padding:10px;background:#fff;border:1px solid rgba(2,6,23,.08);cursor:pointer;transition:.15s;overflow:hidden}
    .cell:hover{box-shadow:0 0 0 2px var(--ring) inset}
    .cell.out{opacity:.45;background:#fff}
    .cell.today{outline:2px solid var(--ring)}
    .num{font-weight:900}
    .marks{position:absolute;inset:auto 8px 8px 8px;display:flex;gap:6px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:999px;background:#98a2b3;box-shadow:0 0 0 2px #00000010}
    .badge{position:absolute;top:6px;right:6px;font-size:11px;padding:3px 6px;border-radius:999px;background:#0b1220;opacity:.75;color:#fff}
    .footerbar{position:sticky;bottom:0;display:flex;gap:10px;padding:10px}
    .section-title{opacity:.8;text-transform:uppercase;font-size:12px;letter-spacing:.18em;margin:6px 0 8px}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .chip{position:relative;display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#fff;border:1px solid rgba(2,6,23,.06);font-size:13px}
    .chip[aria-pressed="true"]{box-shadow:0 0 0 2px var(--ring) inset}
    .chip .sw{width:12px;height:12px;border-radius:999px}
    .chip .count{margin-left:8px;padding:2px 8px;font-size:12px;font-weight:800;border-radius:999px;background:#f3f4f6;border:1px solid rgba(2,6,23,.06)}

    .invisible-scroll{overflow:auto;scrollbar-width:none;-ms-overflow-style:none}
    .invisible-scroll::-webkit-scrollbar{width:0;height:0}

    .events{display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 260px);padding-right:6px}
    .empty{opacity:.7;padding:6px}

    .event-card{
      display:grid; grid-template-columns:1fr; gap:10px;
      padding:12px; border-radius:16px; background:#fff;
      border:1px solid rgba(2,6,23,.06); box-shadow:var(--shadow); cursor:pointer
    }
    .event-card .thumb{position:relative;width:100%;height:180px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,#e6f9ff,#efe7ff);border:1px solid rgba(2,6,23,.06)}
    .event-card .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .event-card .date-badge{
      position:absolute;top:8px;left:8px;background:#fff;color:#0b1220;
      padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;
      box-shadow:0 6px 18px rgba(16,24,40,.15);border:1px solid rgba(2,6,23,.08)
    }
    .event-card .title{font-weight:900;font-size:16px}
    .event-card .meta{font-size:12px;opacity:.9}
    .event-card .desc{font-size:13px;color:#475467}
    .event-card .actions{display:flex;gap:6px}
    .event-card a.button{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:linear-gradient(180deg,#5dd7ff,#0ea5e9);color:#001a26;text-decoration:none;font-weight:800;border:0}

    /* ===== Mobile: лента с карти под календара ===== */
    #mobileEventsBar{display:none}
    @media(max-width:980px){
      #mobileEventsBar{display:block;padding:10px 12px}
      #mobileEventsToggle{
        width:100%; display:inline-flex; align-items:center; justify-content:space-between;
        gap:10px; border-radius:14px; border:1px solid rgba(2,6,23,.08); padding:10px 12px;
        background:#fff; box-shadow:var(--shadow); font-weight:800;
      }
      #mobileStripWrap{
        margin-top:8px; border-radius:16px; border:1px solid rgba(2,6,23,.06);
        background:#fff; box-shadow:var(--shadow);
        max-height:0; overflow:hidden; transition:max-height .25s ease;
      }
      #mobileStripWrap.open{ max-height:260px; }
      #mobileStrip{
        display:flex; gap:10px; padding:10px; overflow-x:auto;
        scrollbar-width:none; -ms-overflow-style:none;
      }
      #mobileStrip::-webkit-scrollbar{height:0}
      .mcard{
        flex:0 0 auto; width:240px; border-radius:14px; overflow:hidden;
        background:#fff; border:1px solid rgba(2,6,23,.06); box-shadow:var(--shadow);
      }
      .mcard .thumb{ position:relative; aspect-ratio:4/3; background:#eef2f7 }
      .mcard .thumb img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
      .mcard .pill{ position:absolute; top:8px; left:8px; background:#fff; border:1px solid rgba(2,6,23,.08); font-size:12px; font-weight:800; padding:4px 8px; border-radius:999px; box-shadow:0 6px 18px rgba(16,24,40,.15) }
      .mcard .body{ padding:10px }
      .mcard .title{ font-weight:900; font-size:14px; line-height:1.2 }
      .mcard .meta{ font-size:12px; opacity:.85 }
    }

    .sheet{position:fixed;inset:auto 0 0 0;background:#ffffffee;border-top-left-radius:24px;border-top-right-radius:24px;box-shadow:0 -12px 40px rgba(16,24,40,.18);transform:translateY(110%);transition:.3s ease transform;z-index:40}
    .sheet.open{transform:translateY(0)}
    .sheet .grip{width:60px;height:6px;background:#98a2b3;border-radius:999px;margin:10px auto}
    .sheet .content{padding:12px 16px 16px}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.35);z-index:60}
    .modal.open{display:grid}
    .card.modal-card{width:min(720px,92vw);padding:16px}

    .card.info-card{
      width:min(720px,92vw);padding:16px;
      display:grid;grid-template-columns:110px 1fr;gap:14px
    }
    .info-left{display:grid;align-content:start}
    .info-left img{width:110px;height:110px;object-fit:cover;border-radius:12px;border:1px solid rgba(2,6,23,.08)}
    @media(max-width:560px){
      .card.info-card{grid-template-columns:1fr}
      .info-left img{width:100%;height:160px}
    }

    .adminOnly{display:none}
    .is-admin .adminOnly{display:inline-flex}
    .is-admin .adminOnly.block{display:block}

    .field{display:grid;gap:6px;margin:10px 0}
    label{font-size:13px;opacity:.9}
    input[type="text"], select, textarea{background:#fff;border:1px solid rgba(2,6,23,.12);color:#0b1220;border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;padding-top:8px}
    .hint{font-size:12px;opacity:.75}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b1220;color:#fff;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.15);z-index:70;display:none}
    .toast.show{display:block}

    /* Mobile drawer (вдясно) */
    .drawer-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;z-index:55}
    .drawer{position:fixed;top:0;right:0;height:100dvh;width:min(86vw,380px);background:#fff;box-shadow:-12px 0 40px rgba(16,24,40,.18);transform:translateX(110%);transition:.28s ease transform;z-index:56;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer-backdrop.open{display:block}
    .drawer .drawer-head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(2,6,23,.06)}
    .drawer .drawer-body{padding:14px;gap:12px;display:flex;flex-direction:column}

    @media (min-width:981px){ #menuBtn{ display:none !important; } .drawer, .drawer-backdrop{ display:none !important; } }
    @media (max-width:980px){ #menuBtn{ display:inline-flex; } }

    .drawer-open #todayBtn, .drawer-open #adminBtn{ display:none !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">
      <div class="toolbar">
        <div class="brand">
          <div class="logo"><img src="favicon-96x96.png" alt="T-MAP" width="32" height="32" style="display:block;border-radius:10px"></div>
          <div class="title">Календар</div>
        </div>
        <div class="spacer"></div>
        <button class="btn icon" id="menuBtn" title="Меню">&#9776;</button>
        <button class="btn icon" id="prevBtn" title="Предишен месец" aria-label="Предишен месец">&#x276E;</button>
        <div class="btn" id="title" style="pointer-events:none"></div>
        <button class="btn icon" id="nextBtn" title="Следващ месец" aria-label="Следващ месец">&#x276F;</button>
        <button class="btn" id="todayBtn">Днес</button>
        <button class="btn primary adminOnly" id="newEventBtn">+ Ново събитие</button>
        <button class="btn" id="adminBtn" title="Админ вход">Вход (админ)</button>
      </div>

      <div class="calendar">
        <section class="left card">
          <div class="header">
            <div class="dow">Пон</div><div class="dow">Вто</div><div class="dow">Сря</div><div class="dow">Чет</div><div class="dow">Пет</div><div class="dow">Съб</div><div class="dow">Нед</div>
          </div>
          <div class="grid" id="grid"></div>
          <div class="footerbar">
            <button class="btn adminOnly" id="selectRangeBtn">Избор на диапазон</button>
            <button class="btn adminOnly" id="clearSelectionBtn">Изчисти избора</button>
          </div>
        </section>

        <aside class="panel">
          <div class="card" style="padding:16px">
            <div class="section-title">Филтри</div>
            <div class="legend" id="legend"></div>
          </div>

          <div class="section-title" style="margin-top:12px">Предстоящи събития</div>
          <div class="events invisible-scroll" id="eventsList"></div>
          <div class="empty" id="emptyEvents" hidden>Няма предстоящи събития.</div>

          <div class="section-title">Експорт / Импорт</div>
          <div class="legend">
            <button class="btn" id="exportJson">Експорт .JSON</button>
            <button class="btn" id="exportIcs">Експорт .ICS</button>
            <label class="btn adminOnly" for="importJson" style="cursor:pointer">Импорт .JSON
              <input id="importJson" type="file" accept="application/json" hidden>
            </label>
          </div>
          <p class="hint">Данните се пазят в Supabase. Локални филтри/режим админ – в браузъра.</p>
        </aside>
      </div>

      <!-- ===== Мобилна лента под календара ===== -->
      <div id="mobileEventsBar" aria-hidden="true">
        <button id="mobileEventsToggle" type="button">
          <span>Предстоящи събития</span>
          <span id="mobileCount" class="chip" style="margin:0"><span class="count">0</span></span>
        </button>
        <div id="mobileStripWrap" class="">
          <div id="mobileStrip">
            <!-- попълва се динамично -->
          </div>
        </div>
      </div>
      <!-- ===== край мобилна лента ===== -->

    </div>
  </div>

  <!-- Drawer (mobile, вдясно) -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <strong style="font-weight:800">Меню</strong>
      <div class="spacer"></div>
      <button id="drawerClose" class="btn icon" title="Затвори">✕</button>
    </div>
    <div class="drawer-body invisible-scroll">
      <div class="card" style="padding:16px">
        <div class="section-title">Филтри</div>
        <div class="legend" id="legendMobile"></div>
      </div>

      <div class="section-title" style="margin-top:12px">Предстоящи събития</div>
      <div class="events" id="eventsListMobile"></div>
      <div class="empty" id="emptyEventsMobile" hidden>Няма предстоящи събития.</div>

      <div class="card" style="padding:16px;margin-top:10px">
        <div class="section-title">Експорт / Импорт</div>
        <div class="legend">
          <button class="btn" id="exportJson2">Експорт .JSON</button>
          <button class="btn" id="exportIcs2">Експорт .ICS</button>
          <label class="btn adminOnly" for="importJson2" style="cursor:pointer">Импорт .JSON
            <input id="importJson2" type="file" accept="application/json" hidden>
          </label>
        </div>
      </div>
    </div>
  </aside>

  <!-- Modal: Събитие (админ) -->
  <div class="modal" id="eventModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="card modal-card">
      <h2 style="margin:0 0 6px">Събитие</h2>
      <p class="hint" id="eventDatesHint"></p>

      <div class="field adminOnly">
        <label for="evTitle">Заглавие</label>
        <input id="evTitle" type="text" placeholder="напр. Преход до Мальовица" />
      </div>
      <div class="field adminOnly">
        <label for="evCategory">Категория</label>
        <select id="evCategory">
          <option value="hike">Преход</option>
          <option value="festival">Фестивал</option>
          <option value="culture">Култура</option>
          <option value="other">Друго</option>
        </select>
      </div>
      <div class="field adminOnly">
        <label>Цвят</label>
        <div id="colorPicker" class="legend"></div>
      </div>
      <div class="field adminOnly">
        <label for="evUrl">Линк към събитие (URL)</label>
        <input id="evUrl" type="text" placeholder="https://..." />
      </div>
      <div class="field adminOnly">
        <label for="evImage">URL на снимка</label>
        <input id="evImage" type="text" placeholder="https://.../image.jpg" />
      </div>
      <div class="field adminOnly">
        <label for="evNotes">Описание / Бележки</label>
        <textarea id="evNotes" rows="3" placeholder="Описание на маршрута, среща, GPS, застраховка..."></textarea>
      </div>

      <div class="actions">
        <button class="btn" id="cancelEvent">Откажи</button>
        <button class="btn primary adminOnly" id="saveEvent">Запази</button>
      </div>
    </div>
  </div>

  <!-- Modal: Инфо (pop-up за всички) -->
  <div class="modal" id="infoModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="card info-card invisible-scroll">
      <div class="info-left"><img id="infoImg" alt="" style="display:none"></div>
      <div class="info-body">
        <h2 id="infoTitle" style="margin:0 0 6px"></h2>
        <p class="hint" id="infoDates" style="margin:0 0 6px"></p>
        <p id="infoDesc" style="margin:.2rem 0 .6rem"></p>
        <div class="actions" style="justify-content:flex-start">
          <a id="infoLink" class="btn primary" href="#" target="_blank" rel="noopener" style="display:none">Виж повече</a>
          <button class="btn" id="infoClose">Затвори</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom sheet (мобилни детайли за ден) -->
  <div class="sheet" id="daySheet" aria-hidden="true">
    <div class="grip"></div>
    <div class="content invisible-scroll">
      <h3 id="sheetTitle" style="margin:0 0 8px"></h3>
      <div id="sheetEvents"></div>
      <div class="actions" style="justify-content:flex-start">
        <button class="btn adminOnly" id="addEventFromSheet">+ Добави събитие</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  ;(()=>{
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const pad = n => String(n).padStart(2,'0');
    const iso = d => [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');
    const parseISO = s => { const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D) };
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? f }catch{ return f } };
    const toast = m=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800) };

    /* ---------- Supabase ---------- */
    const SUPABASE_URL = 'https://cmiylzpmpwqbacjoqtkx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8';
    const TABLE = 'tmap_calendar_events';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function db_list(){
      const { data, error } = await sb.from(TABLE).select('*').order('created_at', { ascending:true });
      if(error){ console.warn(error); toast('Грешка при зареждане'); return [] }
      return (data||[]).map(r=>({
        id:r.id, title:r.title, category:r.category||'other', color:r.color||null,
        notes:r.notes||'', url:r.url||'', image:r.image||'',
        dates:(r.dates||[]).map(String)
      }));
    }
    async function db_upsert(ev){
      const code = localStorage.getItem('tmap.adminId');
      if(code !== ADMIN_ID) throw new Error('not admin');
      const { data, error } = await sb.rpc('tmap_admin_upsert_event', {
        p_code: code, p_id: ev.id || null, p_title: ev.title, p_category: ev.category,
        p_color: ev.color, p_notes: ev.notes || null, p_url: ev.url || null, p_image: ev.image || null,
        p_dates: ev.dates
      });
      if(error) throw error;
      if(!ev.id && data) ev.id = data;
    }
    async function db_delete(id){
      const code = localStorage.getItem('tmap.adminId');
      if(code !== ADMIN_ID) throw new Error('not admin');
      const { error } = await sb.rpc('tmap_admin_delete_event', { p_code: code, p_id: id });
      if(error) throw error;
    }
    async function db_bulk_upsert(list){
      for(const ev of list){
        await db_upsert({
          id: ev.id || null,
          title: ev.title, category: ev.category || 'other',
          color: ev.color || null, notes: ev.notes || null,
          url: ev.url || null, image: ev.image || null,
          dates: ev.dates || []
        });
      }
    }

    /* ---------- Admin gate ---------- */
    const ADMIN_ID = '59e62f07-5fab-443f-a0cb-efd988b44b8f';
    const adminBtn = $('#adminBtn');
    const isAdmin = ()=> localStorage.getItem('tmap.adminId')===ADMIN_ID;
    const setAdminMode = on => { document.body.classList.toggle('is-admin', !!on); adminBtn.textContent = on? 'Изход (админ)' : 'Вход (админ)'; };
    adminBtn.addEventListener('click', ()=>{
      if(isAdmin()){ localStorage.removeItem('tmap.adminId'); setAdminMode(false); toast('Излязохте от админ режим'); return }
      const code = prompt('Въведете админ идентификатор:');
      if(code===ADMIN_ID){ localStorage.setItem('tmap.adminId', ADMIN_ID); setAdminMode(true); toast('Добре дошли, админ!') }
      else if(code){ toast('Невалиден идентификатор') }
    });

    /* ---------- State ---------- */
    const state = {
      cursor: new Date(),
      selection: new Set(),
      events: [], // ще се зареди от Supabase
      filters: new Set(load('tmap.filters', ['hike','festival','culture','other'])),
      colors: ['#0ea5e9','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#e11d48']
    };
    const categories = {
      hike:{name:'Преход', color:'#22c55e'},
      festival:{name:'Фестивал', color:'#f59e0b'},
      culture:{name:'Култура', color:'#0ea5e9'},
      other:{name:'Друго', color:'#a855f7'}
    };
    const catName = c => categories[c]?.name || 'Друго';

    /* ---------- Header / Nav ---------- */
    const title = $('#title'), prevBtn=$('#prevBtn'), nextBtn=$('#nextBtn'), todayBtn=$('#todayBtn');
    function setCursor(date){ state.cursor = new Date(date.getFullYear(), date.getMonth(), 1); render() }
    function changeMonth(delta){ const d=new Date(state.cursor); d.setMonth(d.getMonth()+delta); setCursor(d) }
    prevBtn.onclick=()=>changeMonth(-1);
    nextBtn.onclick=()=>changeMonth(1);
    todayBtn.onclick=()=>setCursor(new Date());

    /* ---------- Drawer (mobile) ---------- */
    const menuBtn=$('#menuBtn'), drawer=$('#drawer'), drawerBackdrop=$('#drawerBackdrop'), drawerClose=$('#drawerClose');
    function openDrawer(){ drawer.classList.add('open'); drawerBackdrop.classList.add('open'); drawer.setAttribute('aria-hidden','false'); document.body.classList.add('drawer-open'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); document.body.classList.remove('drawer-open'); }
    menuBtn.onclick=openDrawer; drawerClose.onclick=closeDrawer; drawerBackdrop.onclick=closeDrawer;
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer() });
    window.addEventListener('resize', ()=>{ if(window.innerWidth>=981) closeDrawer() });

    /* ---------- Legend / filters ---------- */
    const legend = $('#legend'), legendMobile = $('#legendMobile');
    function getUpcomingCounts(){
      const todayIso = iso(new Date());
      const counts = {hike:0, festival:0, culture:0, other:0};
      state.events.forEach(ev=>{ const first=ev.dates?.[0]; if(first && first>=todayIso){ counts[ev.category||'other']=(counts[ev.category||'other']||0)+1 }});
      return counts;
    }
    function renderLegend(){
      const counts = getUpcomingCounts();
      [legend, legendMobile].forEach(container=>{
        if(!container) return; container.innerHTML='';
        Object.entries(categories).forEach(([key,val])=>{
          const chip=document.createElement('button');
          chip.className='chip';
          chip.setAttribute('aria-pressed', state.filters.has(key));
          chip.title='Клик: само тази • Ctrl/⌘ или Shift: многoизбор';
          chip.innerHTML = `<span class="sw" style="background:${val.color}"></span>${val.name}<span class="count">${counts[key] ?? 0}</span>`;
          chip.onclick=(e)=>{
            const multi = e.ctrlKey||e.metaKey||e.shiftKey;
            if(multi){ state.filters.has(key)?state.filters.delete(key):state.filters.add(key) }
            else{ state.filters = new Set([key]) }
            save('tmap.filters', Array.from(state.filters));
            renderLegend(); renderEventsList(); renderGridDots(); renderMobileStrip(); injectJsonLdFromState();
          };
          container.appendChild(chip);
        });
      });
      // обнови броя в мобилния бутон
      const sum = Object.values(counts).reduce((a,b)=>a+b,0);
      const cnt = document.querySelector('#mobileCount .count'); if(cnt) cnt.textContent = sum;
    }

    /* ---------- Calendar grid ---------- */
    const grid = $('#grid');
    function monthMatrix(year,month){
      const first=new Date(year,month,1);
      const firstDow=(first.getDay()+6)%7; // Mon=0
      const start=new Date(year,month,1-firstDow);
      const days=[];
      for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); days.push(d) }
      return days;
    }
    let dragging=false, dragAdd=true;
    function render(){
      const d=state.cursor, monthName=d.toLocaleDateString('bg-BG',{month:'long',year:'numeric'});
      title.textContent = monthName.charAt(0).toUpperCase()+monthName.slice(1);
      grid.innerHTML='';
      const days=monthMatrix(d.getFullYear(), d.getMonth());
      days.forEach(day=>{
        const dayIso=iso(day);
        const cell=document.createElement('div'); cell.className='cell'; cell.dataset.date=dayIso;
        if(day.getMonth()!==d.getMonth()) cell.classList.add('out');
        if(dayIso===iso(new Date())) cell.classList.add('today');
        cell.innerHTML=`<div class="num">${day.getDate()}</div><div class="badge" hidden></div><div class="marks"></div>`;
        grid.appendChild(cell);
      });
      renderGridDots();
      $$('.cell',grid).forEach(cell=>{
        cell.addEventListener('pointerdown', ()=>{ dragging=true; dragAdd=!state.selection.has(cell.dataset.date); toggleSelect(cell.dataset.date, dragAdd); });
        cell.addEventListener('pointerenter', ()=>{ if(dragging) toggleSelect(cell.dataset.date, dragAdd, true) });
        cell.addEventListener('click', ()=>{ if(window.matchMedia('(max-width:980px)').matches) openDaySheet(cell.dataset.date) });
      });
      window.addEventListener('pointerup', ()=> dragging=false, {once:true});
      paintSelection();
    }
    function visibleEvents(){ return state.events.filter(ev=> state.filters.has(ev.category)) }
    function renderGridDots(){
      $$('.cell',grid).forEach(cell=>{
        const dIso=cell.dataset.date; const box=$('.marks',cell); box.innerHTML='';
        const list = visibleEvents().filter(ev=> ev.dates.includes(dIso));
        list.slice(0,5).forEach(ev=>{ const dot=document.createElement('span'); dot.className='dot'; dot.style.background=ev.color||categories[ev.category]?.color||'#98a2b3'; dot.title=ev.title; box.appendChild(dot) });
        const more=list.length-5; const b=$('.badge',cell); if(more>0){ b.hidden=false; b.textContent=`+${more}` } else b.hidden=true;
      });
    }

    /* ---------- Selection ---------- */
    const clearSelectionBtn=$('#clearSelectionBtn'), selectRangeBtn=$('#selectRangeBtn');
    clearSelectionBtn.onclick=()=>{ state.selection.clear(); paintSelection() }
    selectRangeBtn.onclick=()=>{ const sel=[...state.selection].sort(); if(sel.length<1){ toast('Изберете начална дата'); return } const start=parseISO(sel[0]); const end=prompt('Край (ГГГГ-ММ-ДД):', iso(start)); if(!end) return; const e=parseISO(end); if(isNaN(e)){ toast('Невалидна дата'); return } const cur=new Date(start); while(cur<=e){ state.selection.add(iso(cur)); cur.setDate(cur.getDate()+1) } paintSelection() };
    function toggleSelect(isoDate, on, silent=false){ if(on) state.selection.add(isoDate); else state.selection.delete(isoDate); paintCell(isoDate,on); if(!silent) updateDatesHint() }
    function paintCell(isoDate,on){ const c=$(`.cell[data-date="${isoDate}"]`,grid); if(!c) return; c.style.boxShadow = on? `0 0 0 3px var(--ring) inset` : '' }
    function paintSelection(){ $$('.cell',grid).forEach(c=> c.style.boxShadow = state.selection.has(c.dataset.date)? `0 0 0 3px var(--ring) inset` : '') ; updateDatesHint() }
    function compressDates(dates){
      const ds=dates.slice().sort(); if(!ds.length) return '';
      const ranges=[]; let start=ds[0], prev=ds[0];
      for(let i=1;i<ds.length;i++){ const cur=ds[i]; const p=parseISO(prev); p.setDate(p.getDate()+1); if(iso(p)===cur){ prev=cur; continue } ranges.push([start,prev]); start=prev=cur }
      ranges.push([start,prev]);
      const fmt=s=>{ const d=parseISO(s); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}` };
      return ranges.map(([a,b])=> a===b? fmt(a): `${fmt(a)}–${fmt(b)}`).join(', ')
    }

    /* ---------- Events lists (side + drawer) ---------- */
    const eventsList=$('#eventsList'), emptyEvents=$('#emptyEvents');
    const eventsListMobile=$('#eventsListMobile'), emptyEventsMobile=$('#emptyEventsMobile');
    function renderEventsInto(container, emptyEl, list){
      if(!container) return; container.innerHTML=''; emptyEl.hidden = list.length>0;
      list.forEach(ev=>{
        const item=document.createElement('div'); item.className='event-card';
        const datesShort = compressDates(ev.dates);
        item.innerHTML = `
          <div class="thumb">
            ${ev.image?`<img src="${ev.image}" alt="${escapeHtml(ev.title)}">`:''}
            <div class="date-badge">${datesShort}</div>
          </div>
          <div class="title">${escapeHtml(ev.title)}</div>
          <div class="meta">${catName(ev.category)}</div>
          ${ev.notes?`<div class="desc">${escapeHtml(ev.notes)}</div>`:''}
          <div class="actions">
            ${ev.url?`<a class="button" href="${ev.url}" target="_blank" rel="noopener">Виж повече</a>`:''}
            <button class="btn icon adminOnly" title="Редакция">✎</button>
            <button class="btn icon adminOnly" title="Изтриване">🗑️</button>
          </div>`;
        item.addEventListener('click', e=>{ if(e.target.closest('a,button')) return; openInfoModal(ev); });
        const [moreBtn, editBtn, delBtn] = item.querySelectorAll('a.button, button');
        editBtn?.addEventListener('click', e=>{ e.stopPropagation(); isAdmin()? openEventModal(ev) : toast('Само админ') });
        delBtn?.addEventListener('click', async e=>{
          e.stopPropagation();
          if(!isAdmin()){ toast('Само админ'); return }
          if(confirm('Да изтрия ли това събитие?')){
            try{ await db_delete(ev.id); await refreshEvents(); toast('Изтрито') }catch{ toast('Грешка при изтриване') }
          }
        });
        container.appendChild(item);
      });
    }
    function renderEventsList(){
      const todayIso=iso(new Date());
      const list = visibleEvents()
        .map(ev=>({...ev, first: ev.dates[0]}))
        .filter(ev=> ev.first >= todayIso)
        .sort((a,b)=> a.first.localeCompare(b.first));
      renderEventsInto(eventsList, emptyEvents, list);
      renderEventsInto(eventsListMobile, emptyEventsMobile, list);
      renderMobileStrip(list);
      // обнови броя в мобилния бутон
      const cnt = document.querySelector('#mobileCount .count'); if(cnt) cnt.textContent = list.length;
    }

    /* ---------- Mobile strip (под календара) ---------- */
    const mobileBar = $('#mobileEventsBar');
    const mobileToggle = $('#mobileEventsToggle');
    const mobileWrap = $('#mobileStripWrap');
    const mobileStrip = $('#mobileStrip');

    function renderMobileStrip(listParam){
      if(!mobileStrip) return;
      const todayIso=iso(new Date());
      const list = listParam || visibleEvents()
        .map(ev=>({...ev, first: ev.dates[0]}))
        .filter(ev=> ev.first >= todayIso)
        .sort((a,b)=> a.first.localeCompare(b.first));

      mobileStrip.innerHTML = list.map(ev=>{
        const first = ev.dates[0];
        const last  = ev.dates[ev.dates.length-1] || first;
        const dates = compressDates([first,last].filter(Boolean));
        return `
          <article class="mcard" data-id="${ev.id}">
            <div class="thumb">
              ${ev.image?`<img src="${ev.image}" alt="${escapeHtml(ev.title)}">`:''}
              <span class="pill">${dates}</span>
            </div>
            <div class="body">
              <div class="title">${escapeHtml(ev.title)}</div>
              <div class="meta">${catName(ev.category)}</div>
            </div>
          </article>`;
      }).join('');
      // click -> инфо
      $$('.mcard', mobileStrip).forEach(card=>{
        card.addEventListener('click', ()=>{
          const id = card.getAttribute('data-id');
          const ev = state.events.find(e=>e.id===id);
          if(ev) openInfoModal(ev);
        });
      });
    }

    function openMobileStrip(){ mobileWrap.classList.add('open'); document.addEventListener('click', closeOnOutsideClick, {capture:true}); }
    function closeMobileStrip(){ mobileWrap.classList.remove('open'); document.removeEventListener('click', closeOnOutsideClick, {capture:true}); }
    function closeOnOutsideClick(e){
      if(mobileWrap.contains(e.target) || mobileToggle.contains(e.target)) return;
      closeMobileStrip();
    }
    mobileToggle?.addEventListener('click', ()=>{
      if(mobileWrap.classList.contains('open')) closeMobileStrip(); else openMobileStrip();
    });
    // ако се смени размера към десктоп – затвори
    window.addEventListener('resize', ()=>{ if(window.innerWidth>980) closeMobileStrip(); });

    /* ---------- Info modal ---------- */
    const infoModal=$('#infoModal'), infoTitle=$('#infoTitle'), infoDates=$('#infoDates'), infoDesc=$('#infoDesc'), infoImg=$('#infoImg'), infoLink=$('#infoLink');
    $('#infoClose').onclick=()=> infoModal.classList.remove('open');
    infoModal.addEventListener('click', e=>{ if(e.target===infoModal) infoModal.classList.remove('open') });
    function openInfoModal(ev){
      infoTitle.textContent = ev.title;
      infoDates.textContent = compressDates(ev.dates);
      infoDesc.textContent  = ev.notes || '';
      if(ev.image){ infoImg.src = ev.image; infoImg.style.display='block' } else { infoImg.style.display='none' }
      if(ev.url){ infoLink.href = ev.url; infoLink.style.display='inline-flex' } else { infoLink.style.display='none' }
      infoModal.classList.add('open');
    }

    /* ---------- Event modal (admin) ---------- */
    const eventModal=$('#eventModal'), newEventBtn=$('#newEventBtn'), saveEventBtn=$('#saveEvent'), cancelEventBtn=$('#cancelEvent']);
    const evTitle=$('#evTitle'), evCategory=$('#evCategory'), evNotes=$('#evNotes'), evUrl=$('#evUrl'), evImage=$('#evImage'), colorPicker=$('#colorPicker');
    let editing=null, selectedColor='#0ea5e9';

    function openEventModal(ev=null){
      if(!isAdmin()){ toast('Само админ може да редактира'); return }
      editing=ev; updateDatesHint();
      if(ev){
        evTitle.value=ev.title; evCategory.value=ev.category; evNotes.value=ev.notes||''; evUrl.value=ev.url||''; evImage.value=ev.image||'';
        selectedColor=ev.color||state.colors[0]; selectColor(selectedColor);
        state.selection = new Set(ev.dates); paintSelection();
      } else {
        evTitle.value=''; evCategory.value='hike'; evNotes.value=''; evUrl.value=''; evImage.value='';
        selectedColor=state.colors[0]; selectColor(selectedColor);
        if(state.selection.size===0){ state.selection.add(iso(new Date())); paintSelection() }
      }
      eventModal.classList.add('open'); eventModal.setAttribute('aria-hidden','false');
    }
    function closeEventModal(){ eventModal.classList.remove('open'); eventModal.setAttribute('aria-hidden','true') }
    newEventBtn?.addEventListener('click', ()=>{
      if(!isAdmin()){ toast('Само админ може да добавя'); return }
      if(state.selection.size===0){ state.selection.add(iso(new Date())); paintSelection() }
      openEventModal();
    });
    cancelEventBtn.onclick=closeEventModal;
    eventModal.addEventListener('click', e=>{ if(e.target===eventModal) closeEventModal() });

    function renderColorPicker(){ colorPicker.innerHTML=''; state.colors.forEach(c=>{ const b=document.createElement('button'); b.className='chip'; b.dataset.color=c; b.innerHTML=`<span class="sw" style="background:${c}"></span>${c}`; b.onclick=()=>selectColor(c); colorPicker.appendChild(b) }) }
    function selectColor(c){ selectedColor=c; $$('[data-color]',colorPicker).forEach(x=>x.style.outline=''); const btn=$(`[data-color="${c}"]`,colorPicker); if(btn) btn.style.outline='2px solid var(--ring)' }

    function updateDatesHint(){ const el=$('#eventDatesHint'); if(!el) return; const ds=[...state.selection].sort(); el.textContent = ds.length? `Избрани дати: ${compressDates(ds)}` : 'Няма избрани дати' }

    saveEventBtn?.addEventListener('click', async ()=>{
      const title=evTitle.value.trim(); if(!title){ toast('Добавете заглавие'); return }
      const dates=[...state.selection].sort(); if(dates.length===0){ toast('Изберете поне една дата'); return }
      const obj = editing || { id: crypto.randomUUID() };
      Object.assign(obj, { title, category: evCategory.value, color: selectedColor, dates, notes: evNotes.value.trim(), url: evUrl.value.trim(), image: evImage.value.trim() });
      try{
        await db_upsert(obj);
        closeEventModal(); await refreshEvents(); toast('Събитието е записано');
      }catch(e){ console.warn(e); toast('Грешка при запис') }
    });

    /* ---------- Day Sheet (mobile) ---------- */
    const daySheet=$('#daySheet'), sheetTitle=$('#sheetTitle'), sheetEvents=$('#sheetEvents'), addEventFromSheet=$('#addEventFromSheet');
    function openDaySheet(isoDate){
      const d=parseISO(isoDate);
      sheetTitle.textContent = d.toLocaleDateString('bg-BG',{weekday:'long', day:'2-digit', month:'long', year:'numeric'});
      state.selection = new Set([isoDate]); paintSelection(); renderSheet(isoDate);
      daySheet.classList.add('open');
      addEventFromSheet.onclick = ()=> isAdmin()? openEventModal() : toast('Само админ');
      let startY=null; daySheet.onpointerdown=e=>{ startY=e.clientY }; daySheet.onpointerup=e=>{ if(startY && e.clientY-startY>80) closeDaySheet(); startY=null };
    }
    function closeDaySheet(){ daySheet.classList.remove('open') }
    daySheet.addEventListener('click', e=>{ if(e.target===daySheet) closeDaySheet() });
    function renderSheet(isoDate){
      const list = visibleEvents().filter(ev=> ev.dates.includes(isoDate));
      sheetEvents.innerHTML = list.length? '' : '<div class="empty">Няма събития за този ден.</div>';
      list.forEach(ev=>{
        const row=document.createElement('div'); row.className='event-card';
        row.innerHTML = `
          <div class="thumb">
            ${ev.image?`<img src="${ev.image}" alt="${escapeHtml(ev.title)}">`:''}
            <div class="date-badge">${compressDates(ev.dates)}</div>
          </div>
          <div class="title">${escapeHtml(ev.title)}</div>
          <div class="meta">${catName(ev.category)}</div>
          ${ev.notes?`<div class="desc">${escapeHtml(ev.notes)}</div>`:''}
          <div class="actions">${ev.url?`<a class="button" href="${ev.url}" target="_blank" rel="noopener">Виж повече</a>`:''}</div>`;
        row.addEventListener('click', e=>{ if(e.target.closest('a,button')) return; openInfoModal(ev) });
        sheetEvents.appendChild(row);
      });
    }

    /* ---------- Export / Import ---------- */
    function download(name,text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=name; document.body.appendChild(a); a.click(); a.remove() }
    function exportJson(){ const data={events:state.events}; download('tmap-calendar.json', JSON.stringify(data,null,2)); }
    function exportIcs(){ const ics=toICS(state.events); download('tmap-calendar.ics', ics); }
    $('#exportJson').onclick=exportJson; $('#exportIcs').onclick=exportIcs;
    $('#exportJson2').onclick=exportJson; $('#exportIcs2').onclick=exportIcs;

    function hookImport(input){
      if(!input) return;
      input.addEventListener('change', async (e)=>{
        if(!isAdmin()){ toast('Само админ може да импортира'); e.target.value=''; return }
        const f=e.target.files[0]; if(!f) return; const text=await f.text();
        try{
          const obj=JSON.parse(text);
          if(obj.events){ await db_bulk_upsert(obj.events); await refreshEvents(); toast('Импорт успешно') }
        }catch{ toast('Грешен JSON') }
        e.target.value='';
      });
    }
    hookImport($('#importJson')); hookImport($('#importJson2'));

    function toICS(events){
      const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//T-MAP//Tour Calendar//BG'];
      const esc=s=> String(s||'').replace(/[\\,;\n]/g,m=>({'\\':'\\\\',',':'\\,',';':'\\;','\n':'\\n'}[m]));
      events.forEach(ev=>{
        ev.dates.forEach(dISO=>{
          const d=parseISO(dISO), y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate());
          const nextDay=new Date(d); nextDay.setDate(d.getDate()+1);
          lines.push('BEGIN:VEVENT');
          lines.push('UID:'+(ev.id||crypto.randomUUID())+'-'+dISO);
          lines.push('DTSTAMP:'+y+m+da+'T090000Z');
          lines.push('DTSTART;VALUE=DATE:'+y+m+da);
          lines.push('DTEND;VALUE=DATE:'+nextDay.getFullYear()+pad(nextDay.getMonth()+1)+pad(nextDay.getDate()));
          lines.push('SUMMARY:'+esc(ev.title));
          if(ev.notes) lines.push('DESCRIPTION:'+esc(ev.notes));
          if(ev.url) lines.push('URL:'+esc(ev.url));
          lines.push('CATEGORIES:'+esc(catName(ev.category)));
          lines.push('END:VEVENT');
        });
      });
      lines.push('END:VCALENDAR'); return lines.join('\r\n');
    }

    /* ---------- JSON-LD ---------- */
    function injectJsonLdFromState(){
      const old=document.getElementById('ldjson-events'); if(old) old.remove();
      const todayIso=iso(new Date());
      const data = state.events
        .map(ev=>({ title:ev.title, date:ev.dates[0], endDate: ev.dates[ev.dates.length-1], desc:ev.notes||'', link:ev.url||location.href, img:ev.image }))
        .filter(e=> e.date >= todayIso)
        .sort((a,b)=> a.date.localeCompare(b.date))
        .map(ev=>({
          "@context":"https://schema.org",
          "@type":"Event",
          name: ev.title, startDate: ev.date, endDate: ev.endDate || ev.date,
          eventStatus: "https://schema.org/EventScheduled",
          description: ev.desc, url: ev.link,
          image: ev.img ? [ev.img] : undefined,
          organizer: {"@type":"Organization","name":"T-MAP"},
          location: {"@type":"VirtualLocation","url": ev.link}
        }));
      const s=document.createElement('script'); s.type='application/ld+json'; s.id='ldjson-events'; s.textContent=JSON.stringify(data); document.head.appendChild(s);
    }

    /* ---------- Helpers / Init ---------- */
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

    async function refreshEvents(){
      state.events = await db_list();
      renderEventsList(); renderGridDots(); renderLegend(); injectJsonLdFromState();
    }

    function init(){
      renderLegend();
      setCursor(new Date());
      setAdminMode(isAdmin());
      refreshEvents();
      window.addEventListener('keydown', e=>{
        if(e.key==='ArrowLeft') changeMonth(-1);
        else if(e.key==='ArrowRight') changeMonth(1);
        else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); if(isAdmin()) openEventModal(); }
      });
    }
    init();
  })();
  </script>
</body>
</html>
