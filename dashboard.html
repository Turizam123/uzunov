<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î–æ–±–∞–≤–∏ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ –æ–±–µ–∫—Ç</title>
  <link
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .form-container {
      background: white;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #0f4636;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #0f4636;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0d3e30;
    }
    #mapModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }
    #mapContainer {
      position: relative;
      width: 90%;
      height: 80vh;
      margin: 5vh auto;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .close-btn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: #c00;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>–î–æ–±–∞–≤–∏ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ –æ–±–µ–∫—Ç</h2>
    <form id="placeForm">
      <label for="title">–ó–∞–≥–ª–∞–≤–∏–µ</label>
      <input type="text" id="title" required />

      <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea id="description" rows="4" required></textarea>

      <label for="mountain">–ü–ª–∞–Ω–∏–Ω–∞ / –†–µ–≥–∏–æ–Ω</label>
      <input type="text" id="mountain" required />

      <label for="type">–¢–∏–ø –Ω–∞ –æ–±–µ–∫—Ç–∞</label>
      <select id="type" required onchange="toggleCustomType()">
        <option value="">–ò–∑–±–µ—Ä–∏ —Ç–∏–ø</option>
        <option value="üèî –í—Ä—ä—Ö">üèî –í—Ä—ä—Ö</option>
        <option value="üí¶ –í–æ–¥–æ–ø–∞–¥">üí¶ –í–æ–¥–æ–ø–∞–¥</option>
        <option value="üßó –§–µ—Ä–∞—Ç–∞">üßó –§–µ—Ä–∞—Ç–∞</option>
        <option value="üè∞ –ö—Ä–µ–ø–æ—Å—Ç">üè∞ –ö—Ä–µ–ø–æ—Å—Ç</option>
        <option value="üï≥Ô∏è –ü–µ—â–µ—Ä–∞">üï≥Ô∏è –ü–µ—â–µ—Ä–∞</option>
        <option value="üó∫Ô∏è –î—Ä—É–≥–æ">üó∫Ô∏è –î—Ä—É–≥–æ</option>
      </select>

      <div id="customTypeContainer" style="display: none;">
        <label for="custom_type">–í—ä–≤–µ–¥–∏ –¥—Ä—É–≥ —Ç–∏–ø</label>
        <input type="text" id="custom_type" placeholder="–ü—Ä–∏–º–µ—Ä: –ú–æ—Å—Ç, –ò–∑–≤–æ—Ä..." />
      </div>

      <label for="location">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
      <input type="text" id="location" readonly required />
      <button type="button" onclick="openMap()">–ò–∑–±–µ—Ä–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –∫–∞—Ä—Ç–∞</button>

      <label for="image_url">URL –Ω–∞ —Å–Ω–∏–º–∫–∞ (–ø–æ –∏–∑–±–æ—Ä)</label>
      <input type="text" id="image_url" placeholder="https://example.com/image.jpg" />

      <button type="submit">–ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>
    </form>
  </div>

  <div id="mapModal">
    <div id="mapContainer">
      <button class="close-btn" onclick="closeMap()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let marker;

    function openMap() {
      document.getElementById('mapModal').style.display = 'block';
      setTimeout(() => {
        if (!map) {
          map = L.map('map').setView([42.7, 25.4], 7);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap'
          }).addTo(map);

          map.on('click', function (e) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('location').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            closeMap();
          });
        }
        map.invalidateSize();
      }, 300);
    }

    function closeMap() {
      document.getElementById('mapModal').style.display = 'none';
    }

    function toggleCustomType() {
      const type = document.getElementById('type').value;
      const customContainer = document.getElementById('customTypeContainer');
      customContainer.style.display = type === 'üó∫Ô∏è –î—Ä—É–≥–æ' ? 'block' : 'none';
    }

    document.getElementById('placeForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const mountain = document.getElementById('mountain').value;
      let type = document.getElementById('type').value;
      const customType = document.getElementById('custom_type').value;
      if (type === 'üó∫Ô∏è –î—Ä—É–≥–æ' && customType.trim() !== '') {
        type = customType;
      }
      const image_url = document.getElementById('image_url').value;
      const location = document.getElementById('location').value;
      const [latitude, longitude] = location.split(',').map(s => parseFloat(s.trim()));

      const response = await fetch('https://cmiylzpmpwqbacjoqtkx.supabase.co/rest/v1/pending_places', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({ title, description, mountain, image_url, latitude, longitude, type })
      });

      const result = await response.json();

      if (response.ok) {
        alert('–û–±–µ–∫—Ç—ä—Ç –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ!');
        document.getElementById('placeForm').reset();
        document.getElementById('location').value = '';
        document.getElementById('customTypeContainer').style.display = 'none';
      } else {
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + JSON.stringify(result));
      }
    });
  </script>
</body>
</html>
