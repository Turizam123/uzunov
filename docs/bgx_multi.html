<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BGX · Мулти‑маршрути (Leaflet)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{ --bg:#0b1420; --text:#dbe7ff; --muted:#b3c7ff; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14); --accent:#00e5ff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:600 16px/1.25 system-ui,Segoe UI,Roboto}
header{position:fixed;left:0;right:0;top:0;z-index:20;display:flex;gap:.6rem;align-items:center;padding:.55rem .8rem;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent)}
.badge{padding:.5rem .8rem;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
.btn{padding:.6rem .8rem;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer;color:var(--text)}
.btn.primary{outline:1.5px solid var(--accent)}

#map{position:fixed;inset:0}
#tray{position:fixed;left:0;right:0;bottom:0;z-index:25;padding:10px}
#tray.hidden{display:none}
.sheet{margin:0 auto;max-width:1100px;background:rgba(10,20,36,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
.sheet h3{margin:0 0 8px 0;font-size:15px;color:var(--muted);display:flex;gap:8px;align-items:center}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.controls input[type=search]{flex:1;min-width:180px;padding:.6rem .7rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text)}
.list{max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:12px;border-bottom:1px dashed rgba(255,255,255,.08)}
.item:last-child{border-bottom:none}
.item input[type=checkbox]{transform:scale(1.1);margin-right:6px}
.item .meta{font:600 12px/1.2 system-ui;color:var(--muted)}
.color{width:14px;height:14px;border-radius:50%;border:1px solid rgba(255,255,255,.45)}
.counter{margin-left:auto;color:var(--muted);font-size:13px}

.leaflet-overlay-pane svg path.route{stroke:#00e5ff;stroke-width:3.5;fill:none;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 4px rgba(0,229,255,.45))}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:30;background:rgba(10,20,36,.95);border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem;opacity:0;transition:.25s}
.toast.show{opacity:1}

/* бърза търсачка в хедъра */
.qs-wrap{ position:relative; min-width:260px; }
#qs{ width:100%; padding:.5rem .6rem; border:1px solid var(--border);
     border-radius:10px; background:rgba(255,255,255,.06); color:var(--text); }
.qs-drop{
  position:absolute; left:0; right:0; top: calc(100% + 6px);
  background:rgba(10,20,36,.98); border:1px solid var(--border); border-radius:10px;
  max-height:46vh; overflow:auto; z-index:9999; box-shadow:0 12px 34px rgba(0,0,0,.45);
}
.qs-item{ padding:.5rem .6rem; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.08); outline:none }
.qs-item:last-child{ border-bottom:none; }
.qs-item:hover, .qs-item:focus{ background:rgba(255,255,255,.06); }
.qs-name{ font-weight:700 }
.qs-meta{ font-size:12px; color:var(--muted) }
mark{background:transparent;color:var(--accent)}
@media (min-width: 1200px){
  .sheet{max-width:1250px}
}

/* икона/стрелка за посоката */
.heading{ width:30px;height:30px; transform-origin:15px 15px; filter:drop-shadow(0 0 4px rgba(0,229,255,.6)); }
.heading svg{ width:30px;height:30px; display:block; }
</style>
</head>
<body>
<header>
  <div class="badge"><strong>BGX</strong> · Мулти‑маршрути</div>
  <div class="badge">Заредени: <span id="loaded">0</span> / <span id="total">0</span></div>
  <div class="badge">Офлайн: <span id="offline">не</span></div>

  <button class="btn" id="btnToggleTray" title="Покажи/скрий панела">Маршрути</button>
  <button class="btn" id="btnFollow" title="Следвай ме (F)">Следвай</button>

  <div class="qs-wrap">
    <input id="qs" type="search" placeholder="Търси… (Enter = покажи)" />
    <div id="qsDrop" class="qs-drop" hidden></div>
  </div>
</header>

<div id="map"></div>

<div id="tray">
  <div class="sheet">
    <h3>Маршрути <span class="counter" id="counter"></span></h3>
    <div class="controls">
      <input id="q" type="search" placeholder="Търси по име / id …" />
      <button class="btn primary" id="btnLoadSel">Зареди избраните</button>
      <button class="btn" id="btnClear">Премахни всички</button>
      <button class="btn" id="btnSelectAll">Избери всички на екрана</button>
      <button class="btn" id="btnUnselectAll">Премахни избора</button>
    </div>
    <div class="list" id="list"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const DATA_PREFIX = './data/';
const DEFAULT_BASE = 'routes/';
const COLOR_DEFAULT = '#00e5ff';

const toast = (m,ms=2200)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);};

const map = L.map('map',{zoomControl:true}).setView([42.75,25.35],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(map);
const routesGroup = L.layerGroup().addTo(map);

const state = {
  manifest: null,
  base: DEFAULT_BASE,
  items: [],
  layers: new Map(), // id -> {layer, meta}
  loadedCount: 0
};

document.getElementById('offline').textContent = navigator.onLine ? 'не' : 'да';
window.addEventListener('online', ()=> document.getElementById('offline').textContent='не');
window.addEventListener('offline', ()=> document.getElementById('offline').textContent='да');

// ------- Tray show/hide (remember) -------
const tray = document.getElementById('tray');
const btnToggleTray = document.getElementById('btnToggleTray');
const TRAY_KEY = 'bgx_tray_visible';
const wasVisible = localStorage.getItem(TRAY_KEY);
if (wasVisible === '0') tray.classList.add('hidden');
btnToggleTray.addEventListener('click', ()=>{
  tray.classList.toggle('hidden');
  localStorage.setItem(TRAY_KEY, tray.classList.contains('hidden') ? '0' : '1');
});
window.addEventListener('keydown', (e)=>{
  if (e.key === 'm' || e.key === 'M') btnToggleTray.click();
  else if (e.key === 'Escape') tray.classList.add('hidden');
  else if (e.key === '/') { e.preventDefault(); qs.focus(); }
});

init().catch(e=>{ console.error(e); toast('Грешка при инициализация'); });

async function init(){
  await ensureToGeoJSON(); // локален vendor/togeojson.min.js (ако има)
  const m = await fetchJson(DATA_PREFIX+'tracks.json').catch(()=>null);
  if(!m || !Array.isArray(m.tracks)){
    toast('Липсва tracks.json или е празен.');
    state.manifest = { base: DEFAULT_BASE, tracks: [] };
  } else state.manifest = m;
  state.base = (state.manifest.base || DEFAULT_BASE).replace(/^\.?\/*/,'') + (state.manifest.base?.endsWith('/')? '' : '/');
  state.items = state.manifest.tracks.map(n=>({...n}));
  document.getElementById('total').textContent = state.items.length.toString();
  renderList(state.items);
  updateCounter();
}

function renderList(arr){
  const list = document.getElementById('list');
  list.innerHTML = '';
  if(!arr.length){ list.innerHTML = '<div class="item"><em>Няма записи</em></div>'; return; }
  for(const t of arr){
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.id = t.id || t.file;

    const left = document.createElement('div');
    left.style.display='flex'; left.style.alignItems='center';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !!t.visible;
    cb.addEventListener('change', ()=> t.visible = cb.checked);

    const color = document.createElement('div');
    color.className = 'color';
    color.style.background = t.color || COLOR_DEFAULT;
    color.style.marginLeft = '8px';

    left.appendChild(cb);
    left.appendChild(color);

    const main = document.createElement('div');
    const name = document.createElement('div');
    name.textContent = t.name || t.id || t.file;
    main.appendChild(name);

    // показваме само километри, без името на файла
    if (t.km) {
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${t.km} км`;
      main.appendChild(meta);
    }

    const btn = document.createElement('button');
    btn.textContent = 'Покажи';
    btn.className = 'btn';
    btn.addEventListener('click', async()=>{
      await toggleTrack(t, true);
      tray.classList.add('hidden');
    });

    row.appendChild(left);
    row.appendChild(main);
    row.appendChild(btn);
    list.appendChild(row);
  }
}

function updateCounter(){
  document.getElementById('loaded').textContent = state.loadedCount.toString();
  document.getElementById('counter').textContent = `${state.loadedCount} заредени · ${state.items.length} общо`;
}

// Панелна търсачка
document.getElementById('q').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const res = !q ? state.manifest.tracks : state.manifest.tracks.filter(t=> (t.name||'').toLowerCase().includes(q) || (t.id||'').toLowerCase().includes(q) || (t.file||'').toLowerCase().includes(q));
  state.items = res;
  renderList(state.items);
  updateCounter();
});

document.getElementById('btnSelectAll').onclick = ()=>{
  for(const el of document.querySelectorAll('.list .item input[type=checkbox]')) el.checked = true;
  for(const t of state.items) t.visible = true;
};
document.getElementById('btnUnselectAll').onclick = ()=>{
  for(const el of document.querySelectorAll('.list .item input[type=checkbox]')) el.checked = false;
  for(const t of state.items) t.visible = false;
};
document.getElementById('btnClear').onclick = ()=>{
  routesGroup.clearLayers(); state.layers.clear(); state.loadedCount = 0; updateCounter();
};
document.getElementById('btnLoadSel').onclick = async()=>{
  const sel = state.items.filter(t=> t.visible);
  if(!sel.length) return toast('Няма избрани.');
  for(const t of sel) await toggleTrack(t, true);
  updateCounter();
};

async function toggleTrack(t, forceShow=false){
  const id = t.id || t.file;
  if(state.layers.has(id)){
    const entry = state.layers.get(id);
    if(forceShow) try{ map.fitBounds(entry.layer.getBounds(), {padding:[32,32]}); }catch(e){}
    return entry.layer;
  }
  const url = DATA_PREFIX + state.base + t.file;
  let gj = null;
  if(/\.(geo)?json$/i.test(t.file)){
    gj = await fetchJson(url).catch(()=>null);
  } else if(/\.(gpx|kml)$/i.test(t.file)){
    if(typeof window.toGeoJSON === 'undefined'){
      toast('За GPX/KML качи vendor/togeojson.min.js и презареди. Засега се зареждат само GeoJSON файлове.');
      return null;
    }
    const txt = await fetchText(url).catch(()=>'');
    if(!txt) return null;
    const xml = new DOMParser().parseFromString(txt, 'text/xml');
    try{
      gj = /\.gpx$/i.test(t.file) ? window.toGeoJSON.gpx(xml) : window.toGeoJSON.kml(xml);
    }catch(e){ console.warn('toGeoJSON error', e); }
  }
  if(!gj || !gj.features || !gj.features.length) return null;

  const color = t.color || COLOR_DEFAULT;
  const layer = L.geoJSON(gj, {
    style: f => f.geometry && f.geometry.type && f.geometry.type.includes('Line') ? {color, weight:3.5, opacity:1, className:'route'} : undefined,
    pointToLayer: (f,latlng) => L.circleMarker(latlng, {radius:4, color})
  }).addTo(routesGroup);

  state.layers.set(id, { layer, meta: t });
  state.loadedCount = state.layers.size;
  updateCounter();

  if(forceShow){
    try{ map.fitBounds(layer.getBounds(), {padding:[32,32]}); }catch(e){}
  }
  return layer;
}

// ------- Бърза търсачка в хедъра -------
const qs     = document.getElementById('qs');
const qsDrop = document.getElementById('qsDrop');

qs.addEventListener('input', ()=>{
  const q = qs.value.trim().toLowerCase();
  if (!q) { qsDrop.hidden = true; qsDrop.innerHTML=''; return; }
  const matches = state.manifest?.tracks?.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.id||'').toLowerCase().includes(q) ||
    (t.file||'').toLowerCase().includes(q)
  ).slice(0,5) || [];
  renderQuickResults(matches, q);
});

qs.addEventListener('keydown', async (e)=>{
  if (e.key === 'Enter') {
    const q = qs.value.trim().toLowerCase();
    if (!q) return;
    const best = state.manifest?.tracks?.find(t =>
      (t.name||'').toLowerCase().includes(q) ||
      (t.id||'').toLowerCase().includes(q) ||
      (t.file||'').toLowerCase().includes(q)
    );
    if (best) {
      await toggleTrack(best, true);
      tray.classList.add('hidden');
      qsDrop.hidden = true;
    } else {
      toast('Няма съвпадение.');
    }
  } else if (e.key === 'ArrowDown') {
    const first = qsDrop.querySelector('.qs-item');
    if (first) first.focus();
  }
});

function renderQuickResults(items, q){
  qsDrop.innerHTML = '';
  if (!items.length) { qsDrop.hidden = true; return; }
  for (const t of items) {
    const el = document.createElement('div');
    el.tabIndex = 0;
    el.className = 'qs-item';
    el.innerHTML = `
      <div class="qs-name">${highlight(t.name||t.id||t.file, q)}</div>
      <div class="qs-meta">${t.km ? `${t.km} км` : ''}</div>`;
    el.addEventListener('click', async ()=>{
      await toggleTrack(t, true);
      tray.classList.add('hidden');
      qsDrop.hidden = true;
    });
    el.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') el.click();
    });
    qsDrop.appendChild(el);
  }
  qsDrop.hidden = false;
}

function highlight(txt, q){
  if (!txt) return '';
  const i = txt.toLowerCase().indexOf(q);
  if (i<0) return txt;
  return txt.slice(0,i) + '<mark>'+ txt.slice(i,i+q.length) +'</mark>' + txt.slice(i+q.length);
}

// --------- Следване с геолокация + стрелка ---------
const btnFollow = document.getElementById('btnFollow');
let followActive = false;
let watchId = null;
let meMarker = null;
let prevPos = null;
let lastBearing = 0;

btnFollow.addEventListener('click', ()=> followActive ? stopFollow() : startFollow());
window.addEventListener('keydown', (e)=>{ if(e.key==='f' || e.key==='F') btnFollow.click(); });

function createHeadingIcon(angle){
  const html = `<div class="heading" style="transform:rotate(${angle||0}deg)">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2 L21 22 L12 17 L3 22 Z" fill="${COLOR_DEFAULT}" stroke="white" stroke-width="1"/>
    </svg>
  </div>`;
  return L.divIcon({ html, className:'', iconSize:[30,30], iconAnchor:[15,15] });
}
function rotateIcon(marker, angle){
  const el = marker?.getElement();
  if(!el) return;
  const n = el.querySelector('.heading');
  if(n) n.style.transform = `rotate(${angle||0}deg)`;
}
function computeBearing(a,b){
  const toRad = x=>x*Math.PI/180, toDeg=x=>x*180/Math.PI;
  const dLon = toRad(b[1]-a[1]);
  const y = Math.sin(dLon)*Math.cos(toRad(b[0]));
  const x = Math.cos(toRad(a[0]))*Math.sin(toRad(b[0])) - Math.sin(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.cos(dLon);
  let br = toDeg(Math.atan2(y,x)); br=(br+360)%360; return br;
}
function startFollow(){
  if(watchId) return;
  followActive = true;
  btnFollow.classList.add('primary'); btnFollow.textContent = 'Следвам…';
  if(!meMarker) meMarker = L.marker(map.getCenter(), { icon:createHeadingIcon(0), zIndexOffset:1000 }).addTo(map);
  try{
    watchId = navigator.geolocation.watchPosition(onPos, onPosErr, { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
  }catch(e){ toast('Геолокацията не е достъпна.'); stopFollow(); }
}
function stopFollow(){
  followActive = false;
  btnFollow.classList.remove('primary'); btnFollow.textContent = 'Следвай';
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
}
function onPos(p){
  const { latitude:lat, longitude:lng, heading } = p.coords;
  const ll = [lat,lng];
  meMarker.setLatLng(ll);
  let br = (heading!=null && !isNaN(heading)) ? heading : (prevPos ? computeBearing(prevPos,ll) : lastBearing);
  lastBearing = br||0;
  rotateIcon(meMarker, lastBearing);
  if(followActive){ map.panTo(ll, {animate:true}); }
  prevPos = ll;
}
function onPosErr(e){ toast('Геолокация: '+e.message); stopFollow(); }

// Utils
async function ensureToGeoJSON(){
  try{
    const resp = await fetch('./vendor/togeojson.min.js', {cache:'no-store'});
    if(!resp.ok) return;
    const js = await resp.text();
    const s = document.createElement('script'); s.textContent = js; document.head.appendChild(s);
    console.log('Loaded local vendor/togeojson.min.js');
  }catch(e){}
}
const fetchJson = (u)=> fetch(u, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); });
const fetchText = (u)=> fetch(u, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.text(); });
</script>
</body>
</html>
