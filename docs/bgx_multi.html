<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BGX · Маршрути (търсене)</title>

<!-- ====== FAVICONS (T-MAP) ====== -->
<link rel="icon" href="./favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<meta name="theme-color" content="#0b1420">

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0b1420; --text:#dbe7ff; --muted:#b3c7ff; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
  --accent:#00e5ff; --header-h:56px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:600 16px/1.25 system-ui,Segoe UI,Roboto}

/* ===== Header (mobile-first) ===== */
header{
  position:fixed; inset:0 0 auto 0; z-index:1000;
  display:flex; gap:.6rem; align-items:center;
  padding:.55rem .8rem; padding-top:calc(.55rem + env(safe-area-inset-top));
  background:linear-gradient(180deg,rgba(0,0,0,.55),transparent);
}
.badge{padding:.5rem .8rem;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
.btn{padding:.6rem .8rem;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer;color:var(--text)}
.btn.primary{outline:1.5px solid var(--accent)}

/* ЛОГОТО – между „Следвай“ и търсачката */
.brand{display:flex;align-items:center;justify-content:center;
       width:40px;height:40px;border:1px solid var(--border);border-radius:10px;background:var(--panel)}
.brand img{height:26px;width:auto;display:block}

#map{position:fixed; inset:0}

/* Премести zoom контролите под header-а */
.leaflet-top.leaflet-left{ top: calc(var(--header-h) + env(safe-area-inset-top) + 6px); }

/* ==== Долен панел ==== */
#tray{ position:fixed; left:0; right:0; bottom:0; z-index:25; padding:10px;
       padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
#tray.hidden{display:none}
.sheet{margin:0 auto;max-width:1100px;background:rgba(10,20,36,.9);backdrop-filter:blur(6px);
       border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
.sheet h3{margin:0 0 8px 0;font-size:15px;color:var(--muted);display:flex;gap:8px;align-items:center}
.list{max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:12px;border-bottom:1px dashed rgba(255,255,255,.08)}
.item:last-child{border-bottom:none}
.item input[type=checkbox]{transform:scale(1.1);margin-right:6px}
.item .meta{font:600 12px/1.2 system-ui;color:var(--muted)}
.color{width:14px;height:14px;border-radius:50%;border:1px solid rgba(255,255,255,.45)}
.counter{margin-left:auto;color:var(--muted);font-size:13px}

.leaflet-overlay-pane svg path.route{stroke:#00e5ff;stroke-width:3.5;fill:none;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 4px rgba(0,229,255,.45))}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:30;background:rgba(10,20,36,.95);border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem;opacity:0;transition:.25s}
.toast.show{opacity:1}

/* Търсачка */
.qs-wrap{ position:relative; min-width:260px; flex:1; }
#qs{ width:100%; padding:.5rem .6rem; border:1px solid var(--border);
     border-radius:10px; background:rgba(255,255,255,.06); color:var(--text); }
.qs-drop{
  position:absolute; left:0; right:0; top: calc(100% + 6px);
  background:rgba(10,20,36,.98); border:1px solid var(--border); border-radius:10px;
  max-height:46vh; overflow:auto; z-index:9999; box-shadow:0 12px 34px rgba(0,0,0,.45);
}
.qs-item{ padding:.5rem .6rem; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.08); outline:none }
.qs-item:last-child{ border-bottom:none; }
.qs-item:hover, .qs-item:focus{ background:rgba(255,255,255,.06); }
.qs-name{ font-weight:700 }
.qs-meta{ font-size:12px; color:var(--muted) }
mark{background:transparent;color:var(--accent)}

/* Desktop по-голямо лого */
@media (min-width: 1200px){ .sheet{max-width:1250px} .brand img{height:30px} }

/* Компактен мобилен вид */
@media (max-width: 640px){
  :root{ --header-h:52px; }
  header{ gap:.45rem; padding:.45rem .55rem; padding-top:calc(.45rem + env(safe-area-inset-top)); }
  header .badge{ display:none; }           /* скрий „тежките“ бейджове на телефони */
  .btn{ padding:.5rem .55rem; border-radius:9px; }
  .brand{ width:38px;height:38px }
  .brand img{height:24px}
  .qs-wrap{ min-width:0; flex:1; }
  #qs{ padding:.45rem .55rem; font-size:15px; }
  .qs-drop{ top: calc(100% + 4px); max-height:48vh; }
}

/* Heading arrow */
.heading{ width:30px;height:30px; transform-origin:15px 15px; filter:drop-shadow(0 0 4px rgba(0,229,255,.6)); }
.heading svg{ width:30px;height:30px; display:block; }
</style>
</head>
<body>
<header>
  <div class="badge"><strong>BGX</strong> · Търсене на маршрути</div>
  <div class="badge">Заредени: <span id="loaded">0</span></div>

  <button class="btn" id="btnToggleTray" title="Покажи/скрий панела">Маршрути</button>
  <button class="btn" id="btnFollow" title="Следвай ме (F)">Следвай</button>

  <!-- ЛОГО ТУК (между „Следвай“ и търсачката) -->
  <a class="brand" href="https://t-map.bg" target="_blank" rel="noopener" title="T-MAP">
    <img src="./logo-header-40.png" alt="T-MAP">
  </a>

  <!-- Търсачка -->
  <div class="qs-wrap">
    <input id="qs" type="search" placeholder="Търси… (пример: Боровец, Шипка) – Enter = зареди" />
    <div id="qsDrop" class="qs-drop" hidden></div>
  </div>
</header>

<div id="map"></div>

<!-- Долен панел: текущи заредени маршрути -->
<div id="tray">
  <div class="sheet">
    <h3>Заредени маршрути <span class="counter" id="counter"></span></h3>
    <div class="list" id="list"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const DATA_PREFIX = './data/';
const DEFAULT_BASE = 'routes/';
const COLOR_DEFAULT = '#00e5ff';
const AUTO_LOAD_VISIBLE = false;

const toast = (m,ms=2200)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);};

const map = L.map('map',{zoomControl:true}).setView([42.75,25.35],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(map);
const routesGroup = L.layerGroup().addTo(map);

const state = {
  manifest: {base:DEFAULT_BASE, tracks:[]},
  base: DEFAULT_BASE,
  items: [],
  layers: new Map(),
};

const tray = document.getElementById('tray');
document.getElementById('btnToggleTray').addEventListener('click', ()=> tray.classList.toggle('hidden'));

init().catch(e=>{ console.error(e); toast('Грешка при инициализация'); });

async function init(){
  await ensureToGeoJSON();
  const m = await fetchJson(DATA_PREFIX+'tracks.json').catch(()=>null);
  if(m && Array.isArray(m.tracks)){ state.manifest = m; }
  state.base = (state.manifest.base || DEFAULT_BASE).replace(/^\.?\/*/,'') + (state.manifest.base?.endsWith('/')? '' : '/');
  if (AUTO_LOAD_VISIBLE) {
    for (const t of state.manifest.tracks) if (t.visible) await addAndShow(t);
  }
  renderList();
  updateCounter();
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  if(!state.items.length){ list.innerHTML = '<div class="item"><em>Няма заредени маршрути</em></div>'; return; }
  for(const t of state.items){
    const row = document.createElement('div'); row.className='item'; row.dataset.id=t.id||t.file;
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';

    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true;
    const color = document.createElement('div'); color.className='color'; color.style.background=t.color||COLOR_DEFAULT; color.style.marginLeft='8px';
    left.appendChild(cb); left.appendChild(color);

    const main = document.createElement('div');
    const name = document.createElement('div'); name.textContent = t.name || t.id || t.file; main.appendChild(name);
    if (t.km){ const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${t.km} км`; main.appendChild(meta); }

    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Центрирай';
    btn.addEventListener('click', ()=>{ const e=state.layers.get(t.id||t.file); if(e) try{ map.fitBounds(e.layer.getBounds(), {padding:[32,32]}); }catch(x){} });

    cb.addEventListener('change', ()=>{ if(!cb.checked){ removeTrack(t); } });

    row.appendChild(left); row.appendChild(main); row.appendChild(btn);
    list.appendChild(row);
  }
  updateCounter();
}

function updateCounter(){
  document.getElementById('loaded').textContent = String(state.items.length);
  const c = document.getElementById('counter');
  c.textContent = `${state.items.length} заредени`;
}

async function addAndShow(t){
  if (state.items.find(x => (x.id||x.file) === (t.id||t.file))) return;

  const id = t.id || t.file;
  const url = DATA_PREFIX + state.base + t.file;
  let gj = null;
  if(/\.(geo)?json$/i.test(t.file)){
    gj = await fetchJson(url).catch(()=>null);
  } else if(/\.(gpx|kml)$/i.test(t.file)){
    if(typeof window.toGeoJSON === 'undefined'){ toast('Зареждане GPX/KML изисква vendor/togeojson.min.js'); return; }
    const txt = await fetchText(url).catch(()=>'');
    if(!txt) return; const xml = new DOMParser().parseFromString(txt,'text/xml');
    try{ gj = /\.gpx$/i.test(t.file) ? window.toGeoJSON.gpx(xml) : window.toGeoJSON.kml(xml); }catch(e){}
  }
  if(!gj || !gj.features || !gj.features.length) return;

  const color = t.color || COLOR_DEFAULT;
  const layer = L.geoJSON(gj, {
    style: f => f.geometry && f.geometry.type && f.geometry.type.includes('Line') ? {color, weight:3.5, opacity:1, className:'route'} : undefined,
    pointToLayer: (f,latlng) => L.circleMarker(latlng, {radius:4, color})
  }).addTo(routesGroup);
  state.layers.set(id, { layer, meta: t });
  state.items.push({...t});
  try{ map.fitBounds(layer.getBounds(), {padding:[32,32]}); }catch(e){}

  renderList();
}

function removeTrack(t){
  const id = t.id || t.file;
  const idx = state.items.findIndex(x => (x.id||x.file) === id);
  if (idx >= 0) state.items.splice(idx,1);
  const e = state.layers.get(id);
  if (e){ routesGroup.removeLayer(e.layer); state.layers.delete(id); }
  renderList();
}

/* ====== Търсачка (по tracks.json) ====== */
const qs     = document.getElementById('qs');
const qsDrop = document.getElementById('qsDrop');

qs.addEventListener('input', ()=>{
  const q = qs.value.trim().toLowerCase();
  if (!q) { qsDrop.hidden = true; qsDrop.innerHTML=''; return; }
  const matches = state.manifest.tracks.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.id||'').toLowerCase().includes(q) ||
    (t.file||'').toLowerCase().includes(q)
  ).slice(0,8);
  renderQuickResults(matches, q);
});

qs.addEventListener('keydown', async (e)=>{
  if (e.key === 'Enter') {
    const q = qs.value.trim().toLowerCase();
    if (!q) return;
    const best = state.manifest.tracks.find(t =>
      (t.name||'').toLowerCase().includes(q) ||
      (t.id||'').toLowerCase().includes(q) ||
      (t.file||'').toLowerCase().includes(q)
    );
    if (best) { await addAndShow(best); qsDrop.hidden = true; qs.blur(); tray.classList.add('hidden'); }
    else toast('Няма съвпадение.');
  } else if (e.key === 'ArrowDown') {
    const first = qsDrop.querySelector('.qs-item'); if (first) first.focus();
  }
});

function renderQuickResults(items, q){
  qsDrop.innerHTML = '';
  if (!items.length) { qsDrop.hidden = true; return; }
  for (const t of items) {
    const el = document.createElement('div'); el.tabIndex=0; el.className='qs-item';
    el.innerHTML = `<div class="qs-name">${highlight(t.name||t.id||t.file, q)}</div>
                    <div class="qs-meta">${t.km ? `${t.km} км` : ''}</div>`;
    el.addEventListener('click', async ()=>{ await addAndShow(t); qsDrop.hidden=true; tray.classList.add('hidden'); });
    el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') el.click(); });
    qsDrop.appendChild(el);
  }
  qsDrop.hidden = false;
}

function highlight(txt, q){
  if (!txt) return '';
  const i = txt.toLowerCase().indexOf(q);
  if (i<0) return txt;
  return txt.slice(0,i) + '<mark>'+ txt.slice(i,i+q.length) +'</mark>' + txt.slice(i+q.length);
}

/* ====== Follow (геолокация + стрелка) ====== */
const btnFollow = document.getElementById('btnFollow');
let followActive = false;
let watchId = null;
let meMarker = null;
let prevPos = null;
let lastBearing = 0;

btnFollow.addEventListener('click', ()=> followActive ? stopFollow() : startFollow());
window.addEventListener('keydown', (e)=>{ if(e.key==='f' || e.key==='F') btnFollow.click(); });

function createHeadingIcon(angle){
  const html = `<div class="heading" style="transform:rotate(${angle||0}deg)">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2 L21 22 L12 17 L3 22 Z" fill="${COLOR_DEFAULT}" stroke="white" stroke-width="1"/>
    </svg>
  </div>`;
  return L.divIcon({ html, className:'', iconSize:[30,30], iconAnchor:[15,15] });
}
function rotateIcon(marker, angle){
  const el = marker?.getElement(); if(!el) return;
  const n = el.querySelector('.heading'); if(n) n.style.transform = `rotate(${angle||0}deg)`;
}
function computeBearing(a,b){
  const toRad = x=>x*Math.PI/180;
  const dLon = toRad(b[1]-a[1]);
  const y = Math.sin(dLon)*Math.cos(toRad(b[0]));
  const x = Math.cos(toRad(a[0]))*Math.sin(toRad(b[0])) - Math.sin(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.cos(dLon);
  let br = Math.atan2(y,x); br = (br*180/Math.PI+360)%360; return br;
}
function startFollow(){
  if(watchId) return;
  followActive = true; btnFollow.classList.add('primary'); btnFollow.textContent='Следвам…';
  if(!meMarker) meMarker = L.marker(map.getCenter(), { icon:createHeadingIcon(0), zIndexOffset:1000 }).addTo(map);
  try{
    watchId = navigator.geolocation.watchPosition(onPos, onPosErr, { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
  }catch(e){ toast('Геолокацията не е достъпна.'); stopFollow(); }
}
function stopFollow(){
  followActive = false; btnFollow.classList.remove('primary'); btnFollow.textContent='Следвай';
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
}
function onPos(p){
  const { latitude:lat, longitude:lng, heading } = p.coords;
  const ll = [lat,lng];
  if(!meMarker) meMarker = L.marker(ll, { icon:createHeadingIcon(0), zIndexOffset:1000 }).addTo(map);
  meMarker.setLatLng(ll);
  let br = (heading!=null && !isNaN(heading)) ? heading : (prevPos ? computeBearing(prevPos,ll) : lastBearing);
  lastBearing = br||0; rotateIcon(meMarker, lastBearing);
  if(followActive){ map.panTo(ll, {animate:true}); }
  prevPos = ll;
}
function onPosErr(e){ toast('Геолокация: '+e.message); stopFollow(); }

/* Vendor loader (за GPX/KML) */
async function ensureToGeoJSON(){
  try{
    const resp = await fetch('./vendor/togeojson.min.js', {cache:'no-store'});
    if(!resp.ok) return;
    const js = await resp.text();
    const s = document.createElement('script'); s.textContent = js; document.head.appendChild(s);
  }catch(e){}
}

/* Fetch helpers */
const fetchJson = (u)=> fetch(u, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); });
const fetchText = (u)=> fetch(u, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.text(); });
</script>
</body>
</html>
