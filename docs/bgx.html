<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BGX · Вариант 1 (Leaflet + маршрут, togeojson)</title>
<meta name="theme-color" content="#0b1420" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- Robust GPX/KML parser -->
<script src="https://cdn.jsdelivr.net/npm/@mapbox/togeojson@0.16.0/dist/togeojson.min.js"></script>

<style>
:root{ --bg:#0b1420; --text:#dbe7ff; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14); --accent:#00e5ff; --ok:#62ffa6; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:600 16px/1.25 system-ui,Segoe UI,Roboto}
#app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
header{display:flex;gap:.6rem;align-items:center;padding:.55rem .8rem;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent);z-index:5}
.badge{padding:.5rem .8rem;border:1px solid var(--border);border-radius:14px;background:var(--panel)} button.badge{cursor:pointer}
#map{position:relative} .leaflet-container{background:#06121b}
footer{padding:.6rem;display:flex;gap:.6rem;background:linear-gradient(0deg,rgba(0,0,0,.45),transparent)}
.tab{flex:1;padding:.9rem;border-radius:14px;border:1px solid var(--border);background:var(--panel);text-align:center;cursor:pointer}
.tab.active{outline:1.5px solid var(--accent);box-shadow:0 0 0 1px rgba(0,229,255,.35) inset}
.toast{position:fixed;left:50%;bottom:1rem;transform:translateX(-50%);padding:.65rem 1rem;border:1px solid var(--border);border-radius:12px;background:var(--panel);opacity:0;transition:opacity .25s;z-index:30}
.toast.show{opacity:1}
.leaflet-overlay-pane svg path.route-main{stroke:#00e5ff; stroke-width:4; fill:none; stroke-linecap:round; stroke-linejoin:round; filter: drop-shadow(0 0 5px rgba(0,229,255,.5));}
.leaflet-overlay-pane svg path.route-alt{stroke:#ff9a5a; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round; filter: drop-shadow(0 0 4px rgba(255,154,90,.45));}
.marker-hut{background:#0e241a;border:1px solid rgba(88,255,155,.6);box-shadow:0 0 10px rgba(88,255,155,.35);width:11px;height:11px;border-radius:50%}
.marker-nto{background:#24120e;border:1px solid rgba(255,120,70,.6);box-shadow:0 0 10px rgba(255,120,70,.35);width:11px;height:11px;border-radius:2px;transform:rotate(45deg)}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="badge"><strong>BGX</strong> · Вариант 1 (Leaflet)</div>
    <button id="rec" class="badge">◉ Старт</button>
    <div class="badge"><span id="km">0.00 км</span> · <span id="tm">0:00</span></div>
    <div class="badge">Офлайн: <span id="offline">не</span></div>
  </header>
  <main id="map"></main>
  <footer>
    <div class="tab active" data-tab="routes">Маршрут</div>
    <div class="tab" data-tab="nto">100 НТО</div>
    <div class="tab" data-tab="huts">Хижи</div>
  </footer>
</div>
<div class="toast" id="toast"></div>

<script>
const toast = (m,ms=2200)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);};

const map = L.map('map',{zoomControl:true}).setView([42.75,25.35],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

const routesLayer = L.layerGroup().addTo(map);
const ntoCluster = L.markerClusterGroup({chunkedLoading:true});
const hutsCluster = L.markerClusterGroup({chunkedLoading:true});
const icon = cls => L.divIcon({className:cls, iconSize:[12,12]});

document.querySelectorAll('.tab').forEach(el=>el.onclick=()=>{
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
  const which = el.dataset.tab;
  if(which==='routes'){ map.addLayer(routesLayer); map.removeLayer(ntoCluster); map.removeLayer(hutsCluster); }
  if(which==='nto'){ map.removeLayer(routesLayer); map.addLayer(ntoCluster); map.removeLayer(hutsCluster); }
  if(which==='huts'){ map.removeLayer(routesLayer); map.removeLayer(ntoCluster); map.addLayer(hutsCluster); }
});

function lengthMeters(latlngs){
  if(!latlngs || latlngs.length < 2) return 0;
  let d = 0; for (let i = 1; i < latlngs.length; i++) d += map.distance(latlngs[i-1], latlngs[i]);
  return d;
}

const DATA_PREFIX = './data/';
loadRoutes();

async function loadRoutes(){
  let added = false;
  try{ added = await addViaToGeoJSON(DATA_PREFIX+'route.gpx','gpx') || added; }catch(e){}
  try{ added = await addViaToGeoJSON(DATA_PREFIX+'route.kml','kml') || added; }catch(e){}
  try{ await addGeoJSON(DATA_PREFIX+'route.json'); added = true; }catch(e){}
  if(!added) toast('Не открих валиден маршрут (GPX/KML/GeoJSON).');
}

// Parse GPX/KML to GeoJSON using togeojson (most robust)
async function addViaToGeoJSON(url, type){
  const res = await fetch(url); if(!res.ok) return false;
  const txt = await res.text();
  const xml = new DOMParser().parseFromString(txt, "text/xml");
  let gj = null;
  try{
    gj = (type==='gpx') ? toGeoJSON.gpx(xml) : toGeoJSON.kml(xml);
  }catch(e){ return false; }
  if(!gj || !gj.features || !gj.features.length) return false;

  const layer = L.geoJSON(gj, {
    style: f=> f.geometry.type.includes('Line') ? {color:'#00e5ff', weight:4, opacity:1} : undefined,
    pointToLayer: (f,latlng)=> L.circleMarker(latlng, {radius:5, color:'#00e5ff'})
  }).addTo(routesLayer);
  map.fitBounds(layer.getBounds(), {padding:[40,40]});
  // Try get total length if first feature is LineString
  const f0 = gj.features.find(f=>f.geometry && (f.geometry.type==='LineString'||f.geometry.type==='MultiLineString'));
  if(f0 && f0.geometry.type==='LineString'){
    const pts = f0.geometry.coordinates.map(([lng,lat])=> L.latLng(lat,lng));
    const km = (lengthMeters(pts)/1000).toFixed(2);
    layer.bindPopup(`<b>Маршрут</b><br>${km} км`);
  }
  return true;
}

async function addGeoJSON(url){
  const res = await fetch(url); if(!res.ok) return;
  const gj = await res.json();
  if(!gj || !gj.features || !gj.features.length) return;
  const layer = L.geoJSON(gj, {
    style: {color:'#00e5ff', weight:4, opacity:1},
    pointToLayer: (f,latlng)=> L.circleMarker(latlng, {radius:5, color:'#00e5ff'})
  }).addTo(routesLayer);
  map.fitBounds(layer.getBounds(), {padding:[40,40]});
}

if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
window.addEventListener('online', ()=> document.getElementById('offline').textContent='не');
window.addEventListener('offline', ()=> document.getElementById('offline').textContent='да');

let watchId=null, path=[], dist=0, startTs=0, last=null, recording=false;
const km = m => (m/1000).toFixed(2), hhmm = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
document.getElementById('rec').onclick=()=>{
  recording=!recording; document.getElementById('rec').textContent = recording?'■ Стоп':'◉ Старт';
  if(recording){ dist=0; path=[]; last=null; startTs=Date.now(); if(!watchId) watchId = navigator.geolocation?.watchPosition?.(onPos, console.warn, {enableHighAccuracy:true}); toast('Запис започна'); }
  else { if(watchId) {navigator.geolocation.clearWatch(watchId); watchId=null;} toast('Запис спрян'); }
};
function onPos(p){
  const ll=[p.coords.latitude, p.coords.longitude];
  if(!last){ map.setView(ll,15,{animate:true}); }
  if(recording){ path.push(ll); if(last){ dist+=map.distance(last,ll); } last=ll; document.getElementById('km').textContent = km(dist)+' км'; document.getElementById('tm').textContent = hhmm(Math.floor((Date.now()-startTs)/1000)); }
}
</script>
</body>
</html>
