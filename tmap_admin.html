
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <title>Админ панел – Заявки за нови обекти</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f7f7f7; margin: 0; padding: 20px; }
        h1 { color: #004d40; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
        th { background: #004d40; color: white; }
        button { padding: 5px 10px; margin: 0 2px; }
        .status { font-weight: bold; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
<h1>Админ панел – Заявки за нови обекти</h1>
<table id="requests-table">
    <thead>
        <tr>
            <th>Заглавие</th>
            <th>Описание</th>
            <th>Координати</th>
            <th>Планина</th>
            <th>Снимка</th>
            <th>Действия</th>
            <th>Статус</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<div id="error" class="error"></div>

<script>
  const supabase = window.supabasejs.createClient(
    'https://cmiylzpmpwqbacjoqtkx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
  );

  async function loadRequests() {
    const table = document.querySelector('#requests-table tbody');
    table.innerHTML = '';
    const { data, error } = await supabase.from('pending_places').select('*').order('created_at', { ascending: false });
    if (error) {
      document.getElementById('error').textContent = 'Грешка при зареждане: ' + error.message;
      return;
    }

    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true">${row.title || ''}</td>
        <td contenteditable="true">${row.description || ''}</td>
        <td contenteditable="true">${row.latitude || ''}, ${row.longitude || ''}</td>
        <td contenteditable="true">${row.mountain || ''}</td>
        <td><img src="${row.image_url || ''}" alt="" style="max-height:50px;"></td>
        <td>
            <button onclick="updateRow('${row.id}', this)">Редактирай</button>
        </td>
        <td class="status">–</td>
      `;
      table.appendChild(tr);
    });
  }

  async function updateRow(id, btn) {
    const tr = btn.closest('tr');
    const title = tr.children[0].textContent.trim();
    const description = tr.children[1].textContent.trim();
    const coords = tr.children[2].textContent.split(',').map(x => parseFloat(x.trim()));
    const mountain = tr.children[3].textContent.trim();

    const { error } = await supabase
      .from('pending_places')
      .update({
        title,
        description,
        latitude: coords[0],
        longitude: coords[1],
        mountain
      })
      .eq('id', id);

    const statusTd = tr.querySelector('.status');
    if (error) {
      statusTd.textContent = 'Грешка';
      statusTd.style.color = 'red';
    } else {
      statusTd.textContent = 'Обновено';
      statusTd.style.color = 'green';
    }
  }

  loadRequests();
</script>
</body>
</html>
