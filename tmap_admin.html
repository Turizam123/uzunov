
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª ‚Äì –ó–∞—è–≤–∫–∏</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f3;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #263238;
      text-align: center;
    }
    input[type="text"] {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 100%;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background: #00695c;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f1f1f1;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      margin: 2px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    button:nth-child(1) { background: #ffa000; color: white; }
    button:nth-child(2) { background: #4caf50; color: white; }
    button:nth-child(3) { background: #f44336; color: white; }

    .status { font-weight: bold; margin-top: 10px; text-align: center; }
    .error { color: red; }
    .success { color: green; }

    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #modal img {
      max-width: 80%;
      max-height: 80%;
      border-radius: 10px;
    }

    #notification {
      display: none;
      background: #43a047;
      color: white;
      padding: 10px 20px;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      animation: fadeInOut 4s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body>

<h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–µ–Ω –ø–∞–Ω–µ–ª ‚Äì –ù–æ–≤–∏ –∑–∞—è–≤–∫–∏</h1>
<input type="text" id="search" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ –∏–ª–∏ –ø–ª–∞–Ω–∏–Ω–∞..." oninput="loadData()"/>

<div id="notification">üîî –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!</div>

<table id="places-table">
  <thead>
    <tr>
      <th>–ó–∞–≥–ª–∞–≤–∏–µ</th>
      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
      <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏</th>
      <th>–ü–ª–∞–Ω–∏–Ω–∞</th>
      <th>–°–Ω–∏–º–∫–∞</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="modal" onclick="this.style.display='none'">
  <img id="modal-img" src="" alt="–°–Ω–∏–º–∫–∞">
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://cmiylzpmpwqbacjoqtkx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
  );

  let lastRowCount = 0;

  async function loadData(showNotify = false) {
    const query = document.getElementById('search').value.toLowerCase();
    const { data, error } = await supabase.from('pending_places').select('*').order('created_at', { ascending: false });

    const table = document.querySelector('#places-table tbody');
    table.innerHTML = '';

    if (error) return;

    const filtered = data.filter(row =>
      row.title.toLowerCase().includes(query) || (row.mountain || '').toLowerCase().includes(query)
    );

    if (showNotify && filtered.length > lastRowCount) {
      document.getElementById('notification').style.display = 'block';
      setTimeout(() => {
        document.getElementById('notification').style.display = 'none';
      }, 4000);
    }

    lastRowCount = filtered.length;

    filtered.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true">${row.title}</td>
        <td contenteditable="true">${row.description}</td>
        <td contenteditable="true">${row.latitude}, ${row.longitude}</td>
        <td contenteditable="true">${row.mountain || ""}</td>
        <td><img src="${row.image_url}" style="height:50px;cursor:pointer" onclick="showImage('${row.image_url}')"/></td>
        <td>
          <button onclick="updateRow('${row.id}', this)">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
          <button onclick="approveRow('${row.id}', this)">–û–¥–æ–±—Ä–∏</button>
          <button onclick="deleteRow('${row.id}', this)">–û—Ç—Ö–≤—ä—Ä–ª–∏</button>
        </td>
        <td id="status-${row.id}">‚Äì</td>
      `;
      table.appendChild(tr);
    });
  }

  function showImage(url) {
    document.getElementById('modal-img').src = url;
    document.getElementById('modal').style.display = 'flex';
  }

  async function updateRow(id, btn) {
    const tr = btn.closest('tr');
    const cells = tr.querySelectorAll('td');
    const [title, description, coords, mountain] = [
      cells[0].innerText.trim(),
      cells[1].innerText.trim(),
      cells[2].innerText.trim().split(','),
      cells[3].innerText.trim()
    ];
    const latitude = parseFloat(coords[0]);
    const longitude = parseFloat(coords[1]);

    const { error } = await supabase.from('pending_places').update({ title, description, latitude, longitude, mountain }).eq('id', id);
    const statusCell = document.getElementById('status-' + id);
    statusCell.innerHTML = error ? '<span class="error">–ì—Ä–µ—à–∫–∞</span>' : '<span class="success">–û–±–Ω–æ–≤–µ–Ω–æ</span>';
  }

  async function approveRow(id) {
    const { data, error } = await supabase.from('pending_places').select('*').eq('id', id).single();
    if (error) return alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–µ");

    const insert = await supabase.from('objects').insert({ ...data });
    if (!insert.error) {
      await supabase.from('pending_places').delete().eq('id', id);
      loadData();
    }
  }

  async function deleteRow(id) {
    await supabase.from('pending_places').delete().eq('id', id);
    loadData();
  }

  loadData(true);
  setInterval(() => loadData(true), 10000); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–æ–≤–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫.
</script>

</body>
</html>
