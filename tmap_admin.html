
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Админ панел – Заявки</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { color: #004d40; }
    input[type="text"] { padding: 6px; width: 100%; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
    th, td { border: 1px solid #004d40; padding: 8px; text-align: left; }
    th { background-color: #004d40; color: white; }
    button { padding: 4px 10px; margin: 2px; cursor: pointer; }
    .status { font-weight: bold; }
    .error { color: red; }
    .success { color: green; }
    #modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    #modal img { max-width: 80%; max-height: 80%; }
  </style>
</head>
<body>

<h1>Админ панел – Заявки</h1>
<input type="text" id="search" placeholder="Търси по заглавие или планина..." oninput="loadData()"/>

<table id="places-table">
  <thead>
    <tr>
      <th>Заглавие</th>
      <th>Описание</th>
      <th>Координати</th>
      <th>Планина</th>
      <th>Снимка</th>
      <th>Действия</th>
      <th>Статус</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="status" class="status"></div>

<!-- Модал за снимка -->
<div id="modal" onclick="this.style.display='none'">
  <img id="modal-img" src="" alt="Преглед на снимка">
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://cmiylzpmpwqbacjoqtkx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
  );

  async function loadData() {
    const query = document.getElementById('search').value.toLowerCase();
    const { data, error } = await supabase
      .from('pending_places')
      .select('*')
      .order('created_at', { ascending: false });

    const table = document.querySelector('#places-table tbody');
    table.innerHTML = '';

    if (error) {
      document.getElementById('status').innerHTML = '<span class="error">Грешка при зареждане: ' + error.message + '</span>';
      return;
    }

    const filtered = data.filter(row =>
      row.title.toLowerCase().includes(query) || (row.mountain || '').toLowerCase().includes(query)
    );

    if (filtered.length === 0) {
      table.innerHTML = '<tr><td colspan="7">Няма резултати</td></tr>';
    }

    filtered.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true">${row.title}</td>
        <td contenteditable="true">${row.description}</td>
        <td contenteditable="true">${row.latitude}, ${row.longitude}</td>
        <td contenteditable="true">${row.mountain || ""}</td>
        <td><img src="${row.image_url}" style="height:50px;cursor:pointer" onclick="showImage('${row.image_url}')"/></td>
        <td>
          <button onclick="updateRow('${row.id}', this)">Редактирай</button>
          <button onclick="approveRow('${row.id}', this)">Одобри</button>
          <button onclick="deleteRow('${row.id}', this)">Отхвърли</button>
        </td>
        <td id="status-${row.id}">–</td>
      `;
      table.appendChild(tr);
    });
  }

  function showImage(url) {
    document.getElementById('modal-img').src = url;
    document.getElementById('modal').style.display = 'flex';
  }

  async function updateRow(id, btn) {
    const tr = btn.closest('tr');
    const cells = tr.querySelectorAll('td');
    const title = cells[0].innerText.trim();
    const description = cells[1].innerText.trim();
    const coords = cells[2].innerText.trim().split(',');
    const latitude = parseFloat(coords[0]);
    const longitude = parseFloat(coords[1]);
    const mountain = cells[3].innerText.trim();

    if (!confirm("Сигурни ли сте, че искате да запишете редакцията?")) return;

    const { error } = await supabase
      .from('pending_places')
      .update({ title, description, latitude, longitude, mountain })
      .eq('id', id);

    const statusCell = document.getElementById('status-' + id);
    statusCell.innerHTML = error ? '<span class="error">Грешка</span>' : '<span class="success">Обновено</span>';
  }

  async function approveRow(id, btn) {
    if (!confirm("Одобрявате ли този обект?")) return;
    const { data, error } = await supabase.from('pending_places').select('*').eq('id', id).single();
    if (error) return alert("Грешка при одобрение");

    const insert = await supabase.from('objects').insert({
      title: data.title,
      description: data.description,
      latitude: data.latitude,
      longitude: data.longitude,
      mountain: data.mountain,
      image_url: data.image_url
    });

    if (!insert.error) {
      await supabase.from('pending_places').delete().eq('id', id);
      loadData();
    }
  }

  async function deleteRow(id, btn) {
    if (!confirm("Сигурни ли сте, че искате да отхвърлите заявката?")) return;
    await supabase.from('pending_places').delete().eq('id', id);
    loadData();
  }

  loadData();
</script>

</body>
</html>
