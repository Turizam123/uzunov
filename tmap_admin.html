
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–µ–Ω –ø–∞–Ω–µ–ª</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #1d5c4d; }
    input[type="text"] {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 300px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #1d5c4d;
      color: white;
    }
    td img {
      border-radius: 6px;
      max-width: 100px;
    }
    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.9;
    }
    button:nth-child(1) { background-color: #ffc107; color: black; }  /* –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π */
    button:nth-child(2) { background-color: #28a745; color: white; }  /* –û–¥–æ–±—Ä–∏ */
    button:nth-child(3) { background-color: #dc3545; color: white; }  /* –û—Ç—Ö–≤—ä—Ä–ª–∏ */
    .status { font-weight: bold; }

    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #eee; }
    .status { font-weight: bold; }
    button { margin: 2px; padding: 6px 12px; }
  </style>
  <script src="favicon-injector.js"></script>
</head>
<body>

<audio id="notificationSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  –í–∞—à–∏—è—Ç –±—Ä–∞—É–∑—ä—Ä –Ω–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –∞—É–¥–∏–æ.
</audio>

  <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏ –ø–∞–Ω–µ–ª</h1>
  <input type="text" id="searchInput" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ –∏–ª–∏ –ø–ª–∞–Ω–∏–Ω–∞" oninput="filterRows()"/>

  <table id="requestsTable">
    <thead>
      <tr>
        <th>–ó–∞–≥–ª–∞–≤–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏</th>
        <th>–ü–ª–∞–Ω–∏–Ω–∞</th>
        <th>–°–Ω–∏–º–∫–∞</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const supabase = window.supabase.createClient(
      'https://cmiylzpmpwqbacjoqtkx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8'
    );

    async function loadPendingRequests() {
      const { data, error } = await supabase.from("pending_places").select("*").order("created_at", { ascending: false });
      if (error) return console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:", error);
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      data.forEach(place => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${place.title}</td>
          <td>${place.description}</td>
          <td>${place.latitude}, ${place.longitude}</td>
          <td>${place.mountain}</td>
          <td><img src="${place.image_url}" width="80"/></td>
          <td>
            <button onclick="editPlace(${place.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
            <button onclick="approvePlace(${place.id}, this.closest('tr'))">–û–¥–æ–±—Ä–∏</button>
            <button onclick="rejectPlace(${place.id}, this.closest('tr'))">–û—Ç—Ö–≤—ä—Ä–ª–∏</button>
          </td>
          <td class="status">‚Äî</td>
        `;
        tbody.appendChild(row);
      });
    }

    
    async function approvePlace(id, rowElement) {
      try {
        const { data: placeData, error: fetchError } = await supabase
          .from('pending_places')
          .select('*')
          .eq('id', id)
          .single();

        if (fetchError || !placeData) {
          rowElement.querySelector('.status').innerText = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ';
          return;
        }

        const newObject = {
          title: placeData.title,
          description: placeData.description,
          latitude: parseFloat(placeData.latitude),
          longitude: parseFloat(placeData.longitude),
          image_url: placeData.image_url,
          mountain: placeData.mountain,
          created_at: new Date().toISOString()
        };

        console.log("üì§ –î–∞–Ω–Ω–∏ –∑–∞ –∑–∞–ø–∏—Å:", newObject);

        const { error: insertError } = await supabase
          .from('objects')
          .insert([newObject]);

        if (insertError) {
          console.error("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ insert:", insertError);
          rowElement.querySelector('.status').innerText = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + insertError.message;
          rowElement.querySelector('.status').style.color = 'red';
          return;
        }

        const { error: deleteError } = await supabase
          .from('pending_places')
          .delete()
          .eq('id', id);

        if (deleteError) {
          rowElement.querySelector('.status').innerText = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ';
          rowElement.querySelector('.status').style.color = 'orange';
          return;
        }

        rowElement.querySelector('.status').innerText = '‚úÖ –î–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ';
        rowElement.querySelector('.status').style.color = 'green';
        setTimeout(() => rowElement.remove(), 2000);

      } catch (err) {
        console.error("‚ö† –ù–µ–æ—á–∞–∫–≤–∞–Ω–∞ –≥—Ä–µ—à–∫–∞:", err);
        rowElement.querySelector('.status').innerText = '‚ö† –ù–µ–æ—á–∞–∫–≤–∞–Ω–∞ –≥—Ä–µ—à–∫–∞';
        rowElement.querySelector('.status').style.color = 'red';
      }
    }


    async function rejectPlace(id, rowElement) {
      const { error } = await supabase.from("pending_places").delete().eq("id", id);
      const statusCell = rowElement.querySelector(".status");
      if (error) {
        statusCell.innerText = "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ";
        statusCell.style.color = "red";
      } else {
        statusCell.innerText = "–ó–∞—è–≤–∫–∞—Ç–∞ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–∞";
        statusCell.style.color = "gray";
        setTimeout(() => rowElement.remove(), 2000);
      }
    }

    function editPlace(id) {
      alert("–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ—Ç–æ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–æ —Å–∫–æ—Ä–æ.");
    }

    function filterRows() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#tableBody tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    loadPendingRequests();

let lastIds = [];

async function checkForNewRequests() {
  const { data, error } = await supabase.from("pending_places").select("id");
  if (error || !data) return;

  const newIds = data.map(p => p.id);
  const newOnes = newIds.filter(id => !lastIds.includes(id));
  if (newOnes.length > 0) {
    document.getElementById("notificationSound").play();
    loadPendingRequests(); // –ø—Ä–µ–∑–∞—Ä–µ–¥–∏ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
  }
  lastIds = newIds;
}

setInterval(checkForNewRequests, 15000);

  </script>

  <!-- Popup —Ä–µ–¥–∞–∫—Ü–∏—è -->
  <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#00000066; z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:400px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –æ–±–µ–∫—Ç–∞</h3>
      <input type="hidden" id="edit-id">
      <label>–ó–∞–≥–ª–∞–≤–∏–µ:</label>
      <input type="text" id="edit-title" style="width:100%;"><br><br>
      <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
      <textarea id="edit-description" style="width:100%; height:80px;"></textarea><br><br>
      <label>–ü–ª–∞–Ω–∏–Ω–∞ / –†–µ–≥–∏–æ–Ω:</label>
      <input type="text" id="edit-mountain" style="width:100%;"><br><br>
      <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</label>
      <input type="text" id="edit-lat" placeholder="–®–∏—Ä–∏–Ω–∞">
      <input type="text" id="edit-lng" placeholder="–î—ä–ª–∂–∏–Ω–∞"><br><br>
      <label>URL –Ω–∞ —Å–Ω–∏–º–∫–∞:</label>
      <input type="text" id="edit-img" style="width:100%;"><br><br>
      <button onclick="saveEdit()">–ó–∞–ø–∞–∑–∏</button>
      <button onclick="document.getElementById('editModal').style.display='none'">–û—Ç–∫–∞–∑</button>
    </div>
  </div>

  <script>
    let currentEditRow = null;

    function editPlace(id) {
      const row = [...document.querySelectorAll("#tableBody tr")].find(r => r.innerHTML.includes('editPlace(' + id));
      if (!row) return;

      const cells = row.querySelectorAll("td");
      document.getElementById("edit-id").value = id;
      document.getElementById("edit-title").value = cells[0].innerText;
      document.getElementById("edit-description").value = cells[1].innerText;
      document.getElementById("edit-lat").value = cells[2].innerText.split(",")[0].trim();
      document.getElementById("edit-lng").value = cells[2].innerText.split(",")[1].trim();
      document.getElementById("edit-mountain").value = cells[3].innerText;
      document.getElementById("edit-img").value = cells[4].querySelector("img")?.src || "";
      document.getElementById("editModal").style.display = "flex";
      currentEditRow = row;
    }

    async function saveEdit() {
      const id = document.getElementById("edit-id").value;
      const updated = {
        title: document.getElementById("edit-title").value,
        description: document.getElementById("edit-description").value,
        mountain: document.getElementById("edit-mountain").value,
        latitude: parseFloat(document.getElementById("edit-lat").value),
        longitude: parseFloat(document.getElementById("edit-lng").value),
        image_url: document.getElementById("edit-img").value,
      };

      const { error } = await supabase
        .from("pending_places")
        .update(updated)
        .eq("id", id);

      if (error) {
        alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–≤–∞–Ω–µ");
      } else {
        document.getElementById("editModal").style.display = "none";
        loadPendingRequests();

let lastIds = [];

async function checkForNewRequests() {
  const { data, error } = await supabase.from("pending_places").select("id");
  if (error || !data) return;

  const newIds = data.map(p => p.id);
  const newOnes = newIds.filter(id => !lastIds.includes(id));
  if (newOnes.length > 0) {
    document.getElementById("notificationSound").play();
    loadPendingRequests(); // –ø—Ä–µ–∑–∞—Ä–µ–¥–∏ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
  }
  lastIds = newIds;
}

setInterval(checkForNewRequests, 15000);

      }
    }
  </script>

</body>
</html>
