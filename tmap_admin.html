
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Администраторски панел - T-MAP</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4 text-center">Администраторски панел – Заявки за обекти</h2>
    <div id="pending-list" class="table-responsive"></div>
  </div>

<script>
const supabaseUrl = 'https://cmiylzpmpwqbacjoqtkx.supabase.co';
const supabaseKey = 'YOUR_ANON_KEY'; // Сложи тук реалния ключ
const adminEmail = '59e62f07-5fab-443f-a0cb-efd988b44b8f';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

async function loadPending() {
  const { data, error } = await supabase.from('pending_places').select('*').order('created_at', { ascending: false });

  if (error) {
    document.getElementById('pending-list').innerHTML = '<p class="text-danger">Грешка при зареждане.</p>';
    return;
  }

  if (data.length === 0) {
    document.getElementById('pending-list').innerHTML = '<p class="text-muted">Няма чакащи заявки.</p>';
    return;
  }

  let html = '<table class="table table-bordered table-hover table-striped"><thead><tr><th>Заглавие</th><th>Описание</th><th>Координати</th><th>Снимка</th><th>Действия</th></tr></thead><tbody>';

  data.forEach(place => {
    html += `
      <tr>
        <td>${place.title}</td>
        <td>${place.description}</td>
        <td>${place.latitude}, ${place.longitude}</td>
        <td><img src="${place.image_url}" alt="Снимка" width="100"/></td>
        <td>
          <button class="btn btn-success btn-sm mb-1" onclick="approvePlace('${place.id}')">Одобри</button><br>
          <button class="btn btn-danger btn-sm" onclick="deletePlace('${place.id}')">Изтрий</button>
        </td>
      </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('pending-list').innerHTML = html;
}

async function approvePlace(id) {
  const { data, error } = await supabase.from('pending_places').select('*').eq('id', id).single();
  if (error || !data) return alert('Грешка при намиране на заявката.');

  const insert = await supabase.from('objects').insert([{
    title: data.title,
    description: data.description,
    image_url: data.image_url,
    latitude: data.latitude,
    longitude: data.longitude
  }]);

  if (insert.error) return alert('Грешка при одобрение.');

  await supabase.from('pending_places').delete().eq('id', id);
  alert('Одобрено успешно.');
  loadPending();
}

async function deletePlace(id) {
  const { error } = await supabase.from('pending_places').delete().eq('id', id);
  if (error) return alert('Грешка при изтриване.');
  alert('Заявката е изтрита.');
  loadPending();
}

loadPending();
</script>
</body>
</html>
